<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Your Smart Health Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
    :root {
      --primary: #04364A;
      --secondary: #176B87;
      --accent: #64CCC5;
      --chat-bg: #F8F9FA;
      --bubble-user: #DCF8C6;
      --bubble-ai: #fff;
    }
    html.dark {
      --primary: #1F2937;
      --secondary: #374151;
      --accent: #10B981;
      --chat-bg: #111827;
      --bubble-user: #4B5563;
      --bubble-ai: #374151;
    }
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--chat-bg);
      color: #333;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark body {
      color: #E5E7EB;
    }
    .chat-container {
      max-width: 600px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: var(--chat-bg);
      box-shadow: 0 0 25px rgba(0,0,0,0.1);
      border-radius: 1rem;
      overflow: hidden;
      position: relative;
    }
    .dark .chat-container {
      box-shadow: 0 0 25px rgba(255,255,255,0.05);
    }
    .chat-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-messages {
      flex-grow: 1;
      padding: 1rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 5rem;
    }
    .message-bubble {
      padding: 0.8rem 1.2rem;
      border-radius: 1.5rem;
      max-width: 80%;
      margin-bottom: 0.75rem;
      position: relative;
      animation: fadeIn 0.3s ease-in-out;
    }
    .message-bubble.user {
      background-color: var(--bubble-user);
      margin-left: auto;
      border-bottom-right-radius: 0.2rem;
    }
    .message-bubble.ai {
      background-color: var(--bubble-ai);
      margin-right: auto;
      border-bottom-left-radius: 0.2rem;
    }
    .dark .message-bubble.ai {
      color: #E5E7EB;
    }
    .input-area {
      display: flex;
      padding: 0.75rem;
      background-color: #F8F9FA;
      border-top: 1px solid #E0E0E0;
      position: sticky;
      bottom: 0;
      z-index: 10;
      align-items: center;
    }
    .dark .input-area {
      background-color: #1F2937;
      border-top-color: #374151;
    }
    .input-area input {
      flex-grow: 1;
      border-radius: 2rem;
      padding: 0.75rem 1.5rem;
      border: 1px solid #CCC;
      outline: none;
      background-color: white;
      transition: all 0.3s;
    }
    .dark .input-area input {
      background-color: #374151;
      border-color: #4B5563;
      color: #E5E7EB;
    }
    .input-area input:focus {
      border-color: var(--accent);
    }
    .input-area button {
      background-color: transparent;
      color: var(--secondary);
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      transition: all 0.3s;
    }
    .input-area button.send-btn {
      background-color: var(--accent);
      color: white;
      margin-right: 0.5rem;
    }
    .input-area button:hover {
      background-color: rgba(0,0,0,0.05);
    }
    .dark .input-area button {
      color: #9CA3AF;
    }
    .dark .input-area button.send-btn {
      background-color: var(--accent);
    }
    .welcome-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      transition: all 0.5s;
    }
    .cta-btn {
      background-color: var(--accent);
      transition: all 0.3s ease;
      font-weight: 700;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .cta-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }
    .theme-toggle button {
        background-color: transparent;
        border: 1px solid white;
        color: white;
        padding: 0.5rem;
        border-radius: 0.5rem;
        font-weight: bold;
        transition: all 0.3s;
    }
    .theme-toggle button:hover {
        background-color: rgba(255,255,255,0.2);
    }
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 1rem;
      border-radius: 0.5rem;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .user-data-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      transition: all 0.5s;
    }
    .user-data-input {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      width: 100%;
      margin-bottom: 1rem;
      transition: all 0.3s;
    }
    .user-data-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    .user-data-input:focus {
      background: rgba(255, 255, 255, 0.25);
      border-color: white;
    }
    .user-data-title {
      font-weight: 700;
      font-size: 2.25rem;
    }
    .user-data-subtitle {
      font-weight: 300;
      font-size: 1.125rem;
      color: rgba(255,255,255,0.9);
    }
    .plan-button-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin-top: 1rem;
        animation: fadeIn 0.5s ease-in-out;
    }
    .plan-button {
        background-color: var(--accent);
        color: white;
        font-weight: 700;
        padding: 1rem 2rem;
        border-radius: 2rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: all 0.3s;
        cursor: pointer;
    }
    .plan-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }
    .plan-button:disabled {
        background-color: #9CA3AF;
        cursor: not-allowed;
    }
    .plan-button-note {
        font-size: 0.875rem;
        color: #6B7280;
        margin-top: 0.5rem;
    }
    .plan-page {
      padding: 2rem;
      display: none;
      height: 100vh;
      width: 100%;
      overflow-y: auto;
    }
    .plan-page h1, .plan-page h2, .plan-page h3 {
        font-weight: 700;
        color: var(--primary);
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
    .dark .plan-page h1, .dark .plan-page h2, .dark .plan-page h3 {
        color: var(--accent);
    }
    .plan-page h1 { font-size: 2.5rem; text-align: center; }
    .plan-page h2 { font-size: 2rem; border-bottom: 2px solid var(--secondary); padding-bottom: 0.5rem; }
    .plan-page h3 { font-size: 1.5rem; }
    .plan-page p { margin-bottom: 1rem; line-height: 1.6; }
    .plan-page ul, .plan-page ol { margin-bottom: 1rem; padding-right: 1.5rem; }
    .plan-page li { margin-bottom: 0.5rem; }
    .plan-page table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        margin-bottom: 2rem;
    }
    .plan-page th, .plan-page td {
        border: 1px solid #E0E0E0;
        padding: 0.75rem;
        text-align: right;
    }
    .dark .plan-page th, .dark .plan-page td {
        border-color: #374151;
    }
    .plan-page th {
        background-color: #F0F4F8;
        font-weight: 700;
        color: var(--primary);
    }
    .dark .plan-page th {
        background-color: #374151;
        color: #E5E7EB;
    }
    .plan-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
      padding: 1rem;
    }
    .plan-button {
      background-color: var(--accent);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 700;
      cursor: pointer;
      display: block;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }
    .back-button {
      background-color: #6B7280;
    }
    .typewriter-text {
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--primary);
      text-align: center;
    }
    .dark .typewriter-text {
      color: var(--accent);
    }
    .typing-cursor {
      display: inline-block;
      width: 2px;
      height: 1.5em;
      background-color: currentColor;
      animation: blink-caret .75s step-end infinite;
    }
    @keyframes blink-caret {
      from, to { background-color: transparent }
      50% { background-color: currentColor }
    }
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">
  <div class="welcome-screen" id="welcomeScreen">
    <img src="https://placehold.co/150x150/ffffff/0D47A1?text=AI+Coach" alt="AI Coach Avatar" class="rounded-full mb-6 shadow-xl"/>
    <h1 class="text-4xl font-bold mb-2" id="welcomeTitle">Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h1>
    <p class="text-xl font-light text-white/90 mb-8" id="welcomeSubtitle">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø¢Ù†</p>
    <button id="startBtn" class="cta-btn text-white font-bold py-4 px-8 rounded-full shadow-lg hover:shadow-2xl transition-all duration-300" id="startButtonText">
      Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    </button>
  </div>

  <div class="user-data-screen hidden" id="userDataScreen">
    <h2 class="user-data-title mb-4" id="userDataTitle">Ù„Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ</h2>
    <p class="user-data-subtitle mb-6" id="userDataSubtitle">Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¹Ù† Ù†ÙØ³Ùƒ Ù„ØªØ¨Ø¯Ø£</p>
    <div class="w-full max-w-xs">
      <input type="text" id="userName" class="user-data-input" placeholder="Ø§Ø³Ù…Ùƒ" dir="rtl">
      <input type="number" id="userAge" class="user-data-input" placeholder="Ø¹Ù…Ø±Ùƒ" dir="ltr">
      <input type="text" id="userCountry" class="user-data-input" placeholder="Ø¯ÙˆÙ„ØªÙƒ" dir="rtl">
      <button id="nextBtn" class="cta-btn w-full text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-2xl transition-all duration-300 mt-4">
        Ø§Ù„ØªØ§Ù„ÙŠ
      </button>
    </div>
  </div>

  <div class="chat-container hidden" id="chatContainer">
    <div class="chat-header">
      <div class="flex items-center space-x-2 space-x-reverse">
        <img src="https://placehold.co/40x40/ffffff/0D47A1?text=AI" alt="Coach AI Avatar" class="rounded-full"/>
        <span class="text-xl font-bold" id="chatTitle">Coach AI</span>
      </div>
      <div class="theme-toggle">
        <button id="btnTheme">â˜€ï¸</button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages" role="region" aria-label="Chat messages"></div>
    <div class="input-area" id="inputArea">
      <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." dir="rtl"/>
      <input type="file" id="imageInput" accept="image/*" class="hidden"/>
      <button id="sendBtn" class="send-btn" aria-label="Ø£Ø±Ø³Ù„">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </button>
      <button id="plusBtn" class="plus-btn" aria-label="Ø£Ø±Ø³Ù„ Ù…Ù„Ù">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </button>
    </div>
    <div id="planButtonArea" class="plan-button-container hidden">
      <button id="generatePlanBtn" class="plan-button" disabled>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</button>
      <p id="planButtonNote" class="plan-button-note">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰.</p>
    </div>
  </div>

  <div id="planPage" class="plan-page hidden">
    <div id="planOutput"></div>
  </div>

  <footer class="footer">
    Â© 2024 Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ
  </footer>

  <script type="module">
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const userDataScreen = document.getElementById('userDataScreen');
    const chatContainer = document.getElementById('chatContainer');
    const userNameInput = document.getElementById('userName');
    const userAgeInput = document.getElementById('userAge');
    const userCountryInput = document.getElementById('userCountry');
    const btnTheme = document.getElementById('btnTheme');
    const plusBtn = document.getElementById('plusBtn');
    const imageInput = document.getElementById('imageInput');
    const planButtonArea = document.getElementById('planButtonArea');
    const generatePlanBtn = document.getElementById('generatePlanBtn');
    const planPage = document.getElementById('planPage');
    const planOutput = document.getElementById('planOutput');

    let userState = { step: 0, data: {} };
    let LANG = 'ar';
    let chatHistory = [];
    
    const i18n = {
      ar: {
        welcomeTitle: 'Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ',
        welcomeSubtitle: 'Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø¢Ù†',
        startButtonText: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
        userDataTitle: 'Ù„Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ',
        userDataSubtitle: 'Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¹Ù† Ù†ÙØ³Ùƒ Ù„ØªØ¨Ø¯Ø£',
        namePlaceholder: 'Ø§Ø³Ù…Ùƒ',
        agePlaceholder: 'Ø¹Ù…Ø±Ùƒ',
        countryPlaceholder: 'Ø¯ÙˆÙ„ØªÙƒ',
        nextButtonText: 'Ø§Ù„ØªØ§Ù„ÙŠ',
        chatTitle: 'Coach AI',
        inputPlaceholder: 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...',
        emptyFields: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ¹Ù…Ø±Ùƒ ÙˆØ¯ÙˆÙ„ØªÙƒ Ù„Ù„Ø¨Ø¯Ø¡.",
        imageUpload: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©. Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø¨ÙŠØ­Ù„Ù„Ù‡Ø§ Ø§Ù„Ø¢Ù†...',
        generationStart: 'ØªÙ…Ø§Ù… ÙŠØ§ Ø¨Ø·Ù„ØŒ Ù„Ø­Ø¸Ø§Øª ÙˆÙ‡ØªÙƒÙˆÙ† Ø®Ø·ØªÙƒ Ø¬Ø§Ù‡Ø²Ø©. Ø£Ù†Ø§ Ø¨Ø¬Ù‡Ø²Ù‡Ø§ Ù‚Ø³Ù… Ø¨Ù‚Ø³Ù… Ø¯Ù„ÙˆÙ‚ØªÙŠ.',
        generationDone: 'ØªÙ… ÙŠØ§ Ø¨Ø·Ù„! Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø© Ø¹Ù†Ø¯Ùƒ. Ù„Ùˆ ÙÙŠÙ‡ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø³Ø¤Ø§Ù„ØŒ Ø£Ù†Ø§ Ù…ÙˆØ¬ÙˆØ¯.',
        initialPrompt: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ {name}! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ. ÙƒÙ† Ù…Ø³ØªØ¹Ø¯Ø§Ù‹ Ù„Ø±Ø­Ù„Ø© ØªØ­ÙˆÙŠÙ„ÙŠØ©ØŒ ÙÙ†Ø­Ù† Ù†Ø¹Ø¯Ùƒ Ø¨Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© 100%ØŒ Ù…ØµÙ…Ù…Ø© Ø®ØµÙŠØµØ§Ù‹ Ù„Ùƒ. ÙƒÙ„ Ù…Ø§ Ø¹Ù„ÙŠÙƒ Ù‡Ùˆ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ù…Ø¯Ø±Ø¨Ùƒ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ Ù‡Ù†Ø§.",
        planButtonText: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†",
        planButtonNote: "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰."
      },
      en: {
        welcomeTitle: 'Your Personal Health Coach',
        welcomeSubtitle: 'Start your journey to a better you now',
        startButtonText: 'Start Chat',
        userDataTitle: 'Letâ€™s start your journey',
        userDataSubtitle: 'Tell us about yourself to begin',
        namePlaceholder: 'Your Name',
        agePlaceholder: 'Your Age',
        countryPlaceholder: 'Your Country',
        nextButtonText: 'Next',
        chatTitle: 'Coach AI',
        inputPlaceholder: 'Type your message...',
        emptyFields: "Please enter your name, age, and country to get started.",
        imageUpload: 'Image sent. The coach is analyzing it now...',
        generationStart: 'Okay, champ! Your plan will be ready in a few moments. I\'m preparing it section by section now.',
        generationDone: 'Done, champ! Your complete plan is ready. If you have any questions or need to make changes, I\'m here for you.',
        initialPrompt: "Hello, my friend! I'm here to help you. Get ready for a transformative journey; we promise you a 100% accurate plan, tailored specifically for you. All you have to do is talk to your coach Mustafa Elsafy here.",
        planButtonText: "Get Your Plan Now",
        planButtonNote: "You can continue talking if you have any further questions."
      },
    };

    function setLang(lang) {
      LANG = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

      const L = i18n[LANG];

      const welcomeTitle = document.getElementById('welcomeTitle');
      if (welcomeTitle) welcomeTitle.textContent = L.welcomeTitle;
      const welcomeSubtitle = document.getElementById('welcomeSubtitle');
      if (welcomeSubtitle) welcomeSubtitle.textContent = L.welcomeSubtitle;
      const startButtonText = document.getElementById('startButtonText');
      if (startButtonText) startButtonText.textContent = L.startButtonText;

      const userDataTitle = document.getElementById('userDataTitle');
      if (userDataTitle) userDataTitle.textContent = L.userDataTitle;
      const userDataSubtitle = document.getElementById('userDataSubtitle');
      if (userDataSubtitle) userDataSubtitle.textContent = L.userDataSubtitle;
      const userName = document.getElementById('userName');
      if (userName) userName.placeholder = L.namePlaceholder;
      const userAge = document.getElementById('userAge');
      if (userAge) userAge.placeholder = L.agePlaceholder;
      const userCountry = document.getElementById('userCountry');
      if (userCountry) userCountry.placeholder = L.countryPlaceholder;
      const nextBtn = document.getElementById('nextBtn');
      if (nextBtn) nextBtn.textContent = L.nextButtonText;

      const chatTitle = document.getElementById('chatTitle');
      if (chatTitle) chatTitle.textContent = L.chatTitle;
      const userInput = document.getElementById('userInput');
      if (userInput) userInput.placeholder = L.inputPlaceholder;
      
      const planButtonText = document.getElementById('generatePlanBtn');
      if(planButtonText) planButtonText.textContent = L.planButtonText;
      const planButtonNote = document.getElementById('planButtonNote');
      if(planButtonNote) planButtonNote.textContent = L.planButtonNote;
    }

    function setTheme() {
      document.documentElement.classList.toggle('dark');
      const isDarkMode = document.documentElement.classList.contains('dark');
      if (btnTheme) btnTheme.textContent = isDarkMode ? 'ğŸŒ™' : 'â˜€ï¸';
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    function showToast(msg) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => {
          t.style.opacity = 1;
        }, 10);
        setTimeout(() => {
          t.style.opacity = 0;
          setTimeout(() => t.remove(), 500);
        }, 3000);
    }

    function displayMessage(message, sender) {
      const bubble = document.createElement('div');
      bubble.classList.add('message-bubble', sender);
      bubble.innerHTML = marked.parse(message);
      chatMessages.appendChild(bubble);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
      const message = userInput.value.trim();
      if (message === '') return;
      displayMessage(message, 'user');
      chatHistory.push({role: "user", parts: [{text: message}]});
      processAIResponse(message);
      userInput.value = '';
    }

    function isDataComplete() {
      const requiredData = ['name', 'age', 'country'];
      return requiredData.every(field => userState.data[field]);
    }

    function togglePlanButton() {
      const isComplete = isDataComplete();
      if (isComplete) {
        planButtonArea.classList.remove('hidden');
        generatePlanBtn.disabled = false;
        generatePlanBtn.classList.remove('bg-gray-400');
      } else {
        planButtonArea.classList.add('hidden');
        generatePlanBtn.disabled = true;
        generatePlanBtn.classList.add('bg-gray-400');
      }
    }

    async function processAIResponse(message) {
      userInput.disabled = true;
      sendBtn.disabled = true;
      plusBtn.disabled = true;

      const L = i18n[LANG];
      
      const aiPrompt = `
You are "Mustafa Elsafy", a friendly, empathetic, and highly knowledgeable health coach, nutritionist, and doctor from Egypt.
Your persona is a friendly human coach on a WhatsApp-style chat app, speaking in a conversational Egyptian Arabic dialect.
Your goal is to guide the user to provide all the necessary information to generate a comprehensive health plan.
The user's name is ${userState.data.name || 'Ø§Ù„Ø¹Ù…ÙŠÙ„'}.
Your communication should be a natural, step-by-step conversation. Ask one or two simple, non-intrusive questions at a time.
Do not ask for all the data at once.
You must be able to understand greetings like "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…" or "Ù‡Ù„Ø§" and respond appropriately and then gently guide the conversation towards the required data.
The required data points are:
- The user's main goal (e.g., fat loss, muscle building, strength, general health).
- Age, gender, height, and weight.
- Body fat percentage or waist circumference (optional).
- Number of workout days per week and session duration.
- Workout location (home/gym) and available equipment.
- Preferred diet type, number of meals, preferred cuisine, prep time, and monthly budget.
- Allergies or foods to avoid.
- Past challenges with diet or workout plans.
- Lifestyle details (work activity, daily steps, sleep, stress, caffeine).
- Injuries or medical constraints, current medical conditions, and current medications/supplements.
- Specific muscles needing focus.

When you have gathered all the data, summarize it for the user in a clear, bulleted list and ask for confirmation before generating the plan.

If the user's input is unclear or a greeting, respond naturally and politely, and re-guide the conversation. Do not respond with fixed prompts.
Your response must be in conversational Egyptian Arabic.

Chat History:
${chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}
`;
      
      const response = await callAI(aiPrompt);

      chatHistory.push({role: "assistant", parts: [{text: response}]});
      displayMessage(response, 'ai');

      userInput.disabled = false;
      sendBtn.disabled = false;
      plusBtn.disabled = false;
      togglePlanButton();
    }

    async function callAI(prompt) {
      try {
        const response = await fetch('/.netlify/functions/gemini-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt }),
        });
        const data = await response.json();
        return data.text;
      } catch (error) {
        console.error('API call failed:', error);
        return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      startBtn.addEventListener('click', () => {
        welcomeScreen.classList.add('hidden');
        userDataScreen.classList.remove('hidden');
        setLang(LANG);
      });

      nextBtn.addEventListener('click', () => {
        const name = userNameInput.value.trim();
        const age = userAgeInput.value.trim();
        const country = userCountryInput.value.trim();
        
        if (!name || !age || !country) {
          showToast(i18n[LANG].emptyFields);
          return;
        }

        userState.data.name = name;
        userState.data.age = age;
        userState.data.country = country;
        
        userDataScreen.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        
        const welcomeMessage = i18n[LANG].initialPrompt.replace('{name}', name);
        chatHistory.push({role: "assistant", parts: [{text: welcomeMessage}]});
        displayMessage(welcomeMessage, 'ai');
        togglePlanButton();
      });

      btnTheme.addEventListener('click', setTheme);

      plusBtn.addEventListener('click', () => {
        imageInput.click();
      });

      imageInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                  const img = document.createElement('img');
                  img.src = event.target.result;
                  img.classList.add('max-w-xs', 'rounded-lg', 'my-2');
                  displayMessage(img.outerHTML, 'user');
                  showToast(i18n[LANG].imageUpload);
              };
              reader.readAsDataURL(file);
          }
      });

      sendBtn.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      generatePlanBtn.addEventListener('click', async () => {
        const L = i18n[LANG];
        userInput.disabled = true;
        sendBtn.disabled = true;
        plusBtn.disabled = true;
        planButtonArea.classList.add('hidden');
        
        const planPrompt = `
        You are "Mustafa Elsafy", a certified international health coach, nutritionist, and doctor from Egypt.
        Based on the following chat history with the user, please generate a comprehensive health plan.
        Chat History:
        ${chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}
        
        Please structure your response with the following sections in Markdown:
        ## Ø§Ù„ØªØ­Ù„ÙŠÙ„
        ## Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹
        ## Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)
        ## Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)
        ## Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª
        ## Ø§Ù„Ø³Ù„Ø§Ù…Ø©
        ## Ø§Ù„Ø®ØªØ§Ù…
        `;
        const aiResponse = await callAI(planPrompt);

        if (aiResponse) {
            chatContainer.classList.add('hidden');
            planPage.classList.remove('hidden');
            planOutput.innerHTML = marked.parse(aiResponse);
        } else {
            planOutput.innerHTML = `<p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>`;
        }
      });

      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark');
        if (btnTheme) btnTheme.textContent = 'ğŸŒ™';
      }
      setLang('ar');
    });
  </script>
</body>
</html>
