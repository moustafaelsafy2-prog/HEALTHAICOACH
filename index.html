<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Your Smart Health Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
    :root {
      --primary: #04364A;
      --secondary: #176B87;
      --accent: #64CCC5;
      --chat-bg: #F8F9FA;
      --bubble-user: #DCF8C6;
      --bubble-ai: #fff;
      --backdrop: rgba(2, 6, 23, 0.55);
    }
    html.dark {
      --primary: #1F2937;
      --secondary: #374151;
      --accent: #10B981;
      --chat-bg: #111827;
      --bubble-user: #4B5563;
      --bubble-ai: #374151;
      --backdrop: rgba(0,0,0,0.7);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--chat-bg);
      color: #333;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark body { color: #E5E7EB; }

    /* Chat shell */
    .chat-container {
      max-width: 720px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: var(--chat-bg);
      box-shadow: 0 0 25px rgba(0,0,0,0.08);
      border-radius: 1rem;
      overflow: hidden;
      position: relative;
    }
    .chat-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 0.875rem 1rem;
      position: sticky; top: 0; z-index: 10;
      display: flex; justify-content: space-between; align-items: center;
    }
    .chat-messages {
      flex: 1; padding: 1rem; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 6rem;
    }
    .message-bubble {
      padding: 0.85rem 1.15rem; border-radius: 1.25rem; max-width: 82%; margin-bottom: 0.75rem; position: relative; animation: fadeIn 0.25s ease-in-out;
    }
    .message-bubble.user { background-color: var(--bubble-user); margin-left: auto; border-bottom-right-radius: 0.25rem; }
    .message-bubble.ai { background-color: var(--bubble-ai); margin-right: auto; border-bottom-left-radius: 0.25rem; }
    .dark .message-bubble.ai { color: #E5E7EB; }

    .input-area { display: flex; gap: 0.5rem; padding: 0.75rem; background-color: #F8F9FA; border-top: 1px solid #E0E0E0; position: sticky; bottom: 0; z-index: 10; align-items: center; }
    .dark .input-area { background-color: #1F2937; border-top-color: #374151; }
    .input-area input[type="text"] { flex: 1; border-radius: 2rem; padding: 0.75rem 1.2rem; border: 1px solid #CCC; outline: none; background-color: white; transition: all 0.3s; }
    .dark .input-area input[type="text"] { background-color: #374151; border-color: #4B5563; color: #E5E7EB; }
    .input-area input[type="text"]:focus { border-color: var(--accent); }
    .icon-btn { background: transparent; color: var(--secondary); border-radius: 999px; width: 44px; height: 44px; display: grid; place-items: center; transition: 0.25s; }
    .icon-btn:hover { background-color: rgba(0,0,0,0.06); }
    .send-btn { background-color: var(--accent); color: white; }

    .welcome-screen,.user-data-screen{ display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; text-align:center; background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; }
    .cta-btn{ background-color: var(--accent); font-weight:700; box-shadow:0 6px 16px rgba(0,0,0,0.25); padding:1rem 2rem; border-radius:999px; }

    .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 0.85rem 1rem; border-radius: 0.5rem; z-index: 60; opacity: 0; transition: opacity 0.4s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0);} }

    /* Plan Modal */
    .plan-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: var(--backdrop); z-index: 50; }
    .plan-modal.open { display: flex; }
    .plan-modal-content { width: min(920px, 96vw); max-height: 86vh; overflow: hidden; background: white; border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.25); display: flex; flex-direction: column; }
    .dark .plan-modal-content{ background:#0f172a; color:#E5E7EB; }
    .plan-modal-header{ display:flex; justify-content:space-between; align-items:center; padding: 0.85rem 1rem; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; }
    .plan-modal-body{ padding: 1rem 1rem 0.5rem; overflow-y:auto; }
    .close-button{ background: transparent; color: #fff; font-size: 1.75rem; line-height: 1; padding: 0 0.25rem; }
    .skeleton{ display:block; height:1rem; width:100%; background: linear-gradient(90deg,#eee,#f5f5f5,#eee); background-size:200% 100%; animation: shimmer 1.2s infinite; border-radius:0.35rem; }
    .dark .skeleton{ background: linear-gradient(90deg,#374151,#4b5563,#374151); }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .plan-actions{ display:flex; justify-content:flex-start; gap:0.5rem; padding: 0.85rem 1rem 1rem; border-top: 1px solid #e5e7eb; }
    .btn{ padding: 0.6rem 1rem; border-radius: 0.6rem; font-weight:700; cursor:pointer; }
    .btn-primary{ background: var(--accent); color:white; }
    .btn-secondary{ background:#6B7280; color:white; }

    .typewriter-text { font-size: 1.05rem; font-weight: 600; color: var(--primary); }
    .dark .typewriter-text { color: var(--accent); }

    /* Footer */
    .footer{ text-align:center; padding: 0.75rem; font-size: 0.9rem; color:#6b7280; }
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">
  <!-- Welcome -->
  <div class="welcome-screen" id="welcomeScreen">
    <img src="https://placehold.co/150x150/ffffff/0D47A1?text=AI+Coach" alt="AI Coach Avatar" class="rounded-full mb-6 shadow-xl"/>
    <h1 class="text-4xl font-bold mb-2" id="welcomeTitle">Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h1>
    <p class="text-xl font-light text-white/90 mb-8" id="welcomeSubtitle">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø¢Ù†</p>
    <button id="startBtn" class="cta-btn" id="startButtonText">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
  </div>

  <!-- Basic user data -->
  <div class="user-data-screen hidden" id="userDataScreen">
    <h2 class="text-3xl font-extrabold mb-4" id="userDataTitle">Ù„Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ</h2>
    <p class="text-white/90 mb-6" id="userDataSubtitle">Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¹Ù† Ù†ÙØ³Ùƒ Ù„ØªØ¨Ø¯Ø£</p>
    <div class="w-full max-w-sm">
      <input type="text" id="userName" class="block w-full mb-3 rounded-md px-4 py-3 text-right bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="Ø§Ø³Ù…Ùƒ" dir="rtl">
      <input type="number" id="userAge" class="block w-full mb-3 rounded-md px-4 py-3 text-left bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="Ø¹Ù…Ø±Ùƒ" dir="ltr">
      <input type="text" id="userCountry" class="block w-full mb-3 rounded-md px-4 py-3 text-right bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="Ø¯ÙˆÙ„ØªÙƒ" dir="rtl">
      <button id="nextBtn" class="cta-btn w-full mt-2">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </div>

  <!-- Chat -->
  <div class="chat-container hidden" id="chatContainer">
    <div class="chat-header">
      <div class="flex items-center gap-2">
        <img src="https://placehold.co/40x40/ffffff/0D47A1?text=AI" alt="Coach AI Avatar" class="rounded-full"/>
        <span class="text-xl font-bold" id="chatTitle">Coach AI</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLang" class="icon-btn text-white border border-white/30 px-3 w-auto h-9 rounded-md">AR</button>
        <button id="btnTheme" class="icon-btn text-white border border-white/30 w-9 h-9 rounded-md">â˜€ï¸</button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages" role="region" aria-label="Chat messages"></div>

    <!-- Smart CTA appears when data complete -->
    <div id="planButtonArea" class="px-4 py-3 hidden">
      <div class="rounded-xl bg-white shadow dark:bg-slate-800 p-3 flex items-center justify-between">
        <div class="typewriter-text"><span id="prepStatus">Ø¬Ø§Ù‡Ø² Ù†Ø¨Ù†ÙŠ Ø®Ø·ØªÙƒ Ø§Ù„Ù…Ø®ØµØµØ©ØŸ</span></div>
        <button id="generatePlanBtn" class="btn btn-primary" disabled>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</button>
      </div>
      <p id="planButtonNote" class="text-gray-500 text-sm mt-2">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰.</p>
    </div>

    <div class="input-area" id="inputArea">
      <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." dir="rtl" />
      <input type="file" id="imageInput" accept="image/*" class="hidden" />
      <button id="plusBtn" class="icon-btn" aria-label="Ø£Ø±Ø³Ù„ Ù…Ù„Ù">â•</button>
      <button id="sendBtn" class="icon-btn send-btn" aria-label="Ø£Ø±Ø³Ù„">ğŸ“¤</button>
    </div>
  </div>

  <!-- Plan Modal (overlay above chat) -->
  <div id="planModal" class="plan-modal" aria-modal="true" aria-hidden="true" role="dialog" aria-labelledby="planModalTitle">
    <div class="plan-modal-content">
      <div class="plan-modal-header">
        <h3 id="planModalTitle" class="text-lg font-extrabold">Ø®Ø·ØªÙƒ Ø§Ù„Ù…Ø®ØµØµØ©</h3>
        <button id="closePlanBtn" class="close-button" title="Ø¥ØºÙ„Ø§Ù‚" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </div>
      <div id="planOutput" class="plan-modal-body">
        <!-- Progressive sections will stream here -->
        <div class="mb-4">
          <p class="typewriter-text">Ø¬Ø§Ø±Ù ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ù‚Ø³Ù…Ù‹Ø§â€¦</p>
          <span class="skeleton" style="height:12px;width:85%"></span>
          <span class="skeleton mt-2" style="height:12px;width:92%"></span>
          <span class="skeleton mt-2" style="height:12px;width:75%"></span>
        </div>
      </div>
      <div class="plan-actions">
        <button id="printBtn" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø·Ø©</button>
        <button id="expandAllBtn" class="btn btn-secondary">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
      </div>
    </div>
  </div>

  <footer class="footer">Â© 2025 Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</footer>

  <script type="module">
    /* ==========================
       State & i18n
    ===========================*/
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const userDataScreen = document.getElementById('userDataScreen');
    const chatContainer = document.getElementById('chatContainer');
    const userNameInput = document.getElementById('userName');
    const userAgeInput = document.getElementById('userAge');
    const userCountryInput = document.getElementById('userCountry');
    const btnTheme = document.getElementById('btnTheme');
    const btnLang = document.getElementById('btnLang');
    const plusBtn = document.getElementById('plusBtn');
    const imageInput = document.getElementById('imageInput');
    const planButtonArea = document.getElementById('planButtonArea');
    const generatePlanBtn = document.getElementById('generatePlanBtn');
    const planModal = document.getElementById('planModal');
    const closePlanBtn = document.getElementById('closePlanBtn');
    const planOutput = document.getElementById('planOutput');
    const printBtn = document.getElementById('printBtn');
    const expandAllBtn = document.getElementById('expandAllBtn');

    let userState = { step: 0, data: {} };
    let LANG = 'ar';
    let chatHistory = [];

    const i18n = {
      ar: {
        welcomeTitle: 'Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ',
        welcomeSubtitle: 'Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø¢Ù†',
        startButtonText: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
        userDataTitle: 'Ù„Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ',
        userDataSubtitle: 'Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¹Ù† Ù†ÙØ³Ùƒ Ù„ØªØ¨Ø¯Ø£',
        namePlaceholder: 'Ø§Ø³Ù…Ùƒ',
        agePlaceholder: 'Ø¹Ù…Ø±Ùƒ',
        countryPlaceholder: 'Ø¯ÙˆÙ„ØªÙƒ',
        nextButtonText: 'Ø§Ù„ØªØ§Ù„ÙŠ',
        chatTitle: 'Coach AI',
        inputPlaceholder: 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...',
        emptyFields: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ¹Ù…Ø±Ùƒ ÙˆØ¯ÙˆÙ„ØªÙƒ Ù„Ù„Ø¨Ø¯Ø¡.',
        imageUpload: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©. Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø¨ÙŠØ­Ù„Ù„Ù‡Ø§ Ø§Ù„Ø¢Ù†...',
        generationStart: 'ØªÙ…Ø§Ù… ÙŠØ§ Ø¨Ø·Ù„ØŒ Ù„Ø­Ø¸Ø§Øª ÙˆÙ‡ØªÙƒÙˆÙ† Ø®Ø·ØªÙƒ Ø¬Ø§Ù‡Ø²Ø©. Ø£Ù†Ø§ Ø¨Ø¬Ù‡Ø²Ù‡Ø§ Ù‚Ø³Ù… Ø¨Ù‚Ø³Ù… Ø¯Ù„ÙˆÙ‚ØªÙŠ.',
        generationDone: 'ØªÙ… ÙŠØ§ Ø¨Ø·Ù„! Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø© Ø¹Ù†Ø¯Ùƒ. Ù„Ùˆ ÙÙŠÙ‡ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø³Ø¤Ø§Ù„ØŒ Ø£Ù†Ø§ Ù…ÙˆØ¬ÙˆØ¯.',
        initialPrompt: 'Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ {name}! Ù…Ø¹Ø§Ùƒ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€“ Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ. Ù‡Ù†ØªÙƒÙ„Ù… Ø¨Ø¨Ø³Ø§Ø·Ø© ÙˆØ¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø´Ø±ÙŠØ© 100% Ø¹Ù„Ø´Ø§Ù† Ù†ØµÙ…Ù…Ù„Ùƒ Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ø®ØµØµØ© Ù„ÙŠÙƒ.',
        planButtonText: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†',
        planButtonNote: 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰.',
        planPreparingInModal: 'ØªÙ…ØŒ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø®Ø·Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© ÙÙˆÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.'
      },
      en: {
        welcomeTitle: 'Your Personal Health Coach',
        welcomeSubtitle: 'Start your journey to a better you now',
        startButtonText: 'Start Chat',
        userDataTitle: 'Letâ€™s start your journey',
        userDataSubtitle: 'Tell us about yourself to begin',
        namePlaceholder: 'Your Name',
        agePlaceholder: 'Your Age',
        countryPlaceholder: 'Your Country',
        nextButtonText: 'Next',
        chatTitle: 'Coach AI',
        inputPlaceholder: 'Type your message...',
        emptyFields: 'Please enter your name, age, and country to get started.',
        imageUpload: 'Image sent. The coach is analyzing it now...',
        generationStart: "Okay! Your plan will be ready in moments. I'm preparing it section by section.",
        generationDone: "Done! Your complete plan is ready. If you need changes, I'm here.",
        initialPrompt: 'Hello {name}, this is your friendly coach Mustafa Elsafy. We will build a precise, human, fully-personalized plan for you.',
        planButtonText: 'Get Your Plan Now',
        planButtonNote: 'You can keep chatting if you have questions.',
        planPreparingInModal: 'Working on your plan in a modal above the chat.'
      }
    };

    function setLang(lang) {
      LANG = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      const L = i18n[LANG];
      (document.getElementById('welcomeTitle')||{}).textContent = L.welcomeTitle;
      (document.getElementById('welcomeSubtitle')||{}).textContent = L.welcomeSubtitle;
      (document.getElementById('startButtonText')||{}).textContent = L.startButtonText;
      (document.getElementById('userDataTitle')||{}).textContent = L.userDataTitle;
      (document.getElementById('userDataSubtitle')||{}).textContent = L.userDataSubtitle;
      (document.getElementById('userName')||{}).placeholder = L.namePlaceholder;
      (document.getElementById('userAge')||{}).placeholder = L.agePlaceholder;
      (document.getElementById('userCountry')||{}).placeholder = L.countryPlaceholder;
      (document.getElementById('nextBtn')||{}).textContent = L.nextButtonText;
      (document.getElementById('chatTitle')||{}).textContent = L.chatTitle;
      (document.getElementById('userInput')||{}).placeholder = L.inputPlaceholder;
      (document.getElementById('generatePlanBtn')||{}).textContent = L.planButtonText;
      (document.getElementById('planButtonNote')||{}).textContent = L.planButtonNote;
      btnLang.textContent = lang === 'ar' ? 'AR' : 'EN';
    }

    function setTheme() {
      document.documentElement.classList.toggle('dark');
      const isDarkMode = document.documentElement.classList.contains('dark');
      btnTheme.textContent = isDarkMode ? 'ğŸŒ™' : 'â˜€ï¸';
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.className = 'toast'; t.textContent = msg; document.body.appendChild(t);
      setTimeout(()=> t.style.opacity = 1, 10);
      setTimeout(()=> { t.style.opacity = 0; setTimeout(()=> t.remove(), 400); }, 2600);
    }

    function displayMessage(message, sender) {
      const bubble = document.createElement('div');
      bubble.classList.add('message-bubble', sender);
      bubble.innerHTML = marked.parse(message);
      chatMessages.appendChild(bubble);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function isDataComplete() {
      const required = ['name','age','country'];
      return required.every(k => !!userState.data[k]);
    }

    function togglePlanCTA() {
      const isReady = isDataComplete();
      planButtonArea.classList.toggle('hidden', !isReady);
      generatePlanBtn.disabled = !isReady;
    }

    /* ==========================
       AI Orchestration
    ===========================*/
    function buildCoachSystemPrompt(){
      return `
Ø§ÙƒØªØ¨ Ø±Ø¯ÙˆØ¯ Ø¯Ø±Ø¯Ø´Ø© Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆÙ…Ø­ØªØ±ÙØ©ØŒ Ø¯ÙˆÙ† Ù…Ø¨Ø§Ù„ØºØ© Ø£Ùˆ Ù…Ø¯ÙŠØ­ Ø²Ø§Ø¦Ø¯ØŒ ÙˆØ¯ÙˆÙ† Ø°ÙƒØ± Ø£Ù†Ùƒ Ù†Ø¸Ø§Ù… Ø£Ùˆ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø¹Ø¨Ø§Ø±Ø§Øª Ù…Ø«Ù„: Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø´Ø±ÙŠØ©/Ø£Ù†Ø§ Ù†Ù…ÙˆØ°Ø¬/Ø±ÙˆØ¨ÙˆØª.
\nØ§Ù„Ø¯ÙˆØ±: Ù…Ø¯Ø±Ø¨ ØµØ­ÙŠ ÙˆØ£Ø®ØµØ§Ø¦ÙŠ ØªØºØ°ÙŠØ© ÙˆØ·Ø¨ÙŠØ¨.
Ø§Ù„Ù‡Ø¯Ù: Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§ Ø¨ØªØ³Ù„Ø³Ù„ Ù…Ù†Ø·Ù‚ÙŠØŒ ÙˆØªÙ‚Ø¯ÙŠÙ… ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ø®ØªØµØ±Ø© Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø£Ù…Ø±Ø§Ø¶/Ø¥ØµØ§Ø¨Ø§Øª/Ø£Ø¯ÙˆÙŠØ©ØŒ Ø«Ù… ØªÙ„Ø®ÙŠØµ Ù…Ø§ Ø¬ÙÙ…ÙØ¹ ÙˆØ·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©.
\nØ§Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø­Ù„ (Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø³Ø¤Ø§Ù„Ø§Ù† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ ÙÙŠ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©):
- Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø®Ø³Ø§Ø±Ø© Ø¯Ù‡ÙˆÙ†/Ø¨Ù†Ø§Ø¡ Ø¹Ø¶Ù„/ØµØ­Ø© Ø¹Ø§Ù…Ø©/Ù‚ÙˆØ©).
- Ø§Ù„Ø¹Ù…Ø±ØŒ Ø§Ù„Ø¬Ù†Ø³ØŒ Ø§Ù„Ø·ÙˆÙ„ØŒ Ø§Ù„ÙˆØ²Ù†.
- Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© (Ù…Ø­ÙŠØ· Ø®ØµØ± Ø£Ùˆ Ù†Ø³Ø¨Ø© Ø¯Ù‡ÙˆÙ† Ø¥Ù† ÙˆÙØ¬Ø¯Øª).
- Ø£ÙŠØ§Ù… Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ø¨Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŒ Ù…Ø¯Ø© Ø§Ù„Ø­ØµØ©ØŒ Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª.
- Ø§Ù„ØªØºØ°ÙŠØ©: Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§ØªØŒ Ø§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ù…ÙØ¶Ù„ØŒ ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ±ØŒ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.
- Ø­Ø³Ø§Ø³ÙŠØ§Øª/Ø£Ø·Ø¹Ù…Ø© Ù…Ù…Ù†ÙˆØ¹Ø©ØŒ ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©.
- Ù†Ù…Ø· Ø­ÙŠØ§Ø©: Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ø®Ø·ÙˆØ§Øª/Ø§Ù„Ù†ÙˆÙ…/Ø§Ù„Ø¶ØºØ·/Ø§Ù„ÙƒØ§ÙÙŠÙŠÙ†.
- Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª/Ø§Ù„Ø£Ù…Ø±Ø§Ø¶/Ø§Ù„Ø£Ø¯ÙˆÙŠØ©/Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª.
- Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¹Ø¶Ù„ÙŠØ© ØªØ­ØªØ§Ø¬ ØªØ±ÙƒÙŠØ².
\Ù†Ø§Ù„Ø£Ø³Ù„ÙˆØ¨: Ù…Ù‡Ù†ÙŠØŒ ÙˆØ§Ø¶Ø­ØŒ Ù…Ø¨Ø§Ø´Ø±ØŒ Ø£Ø³Ø¦Ù„Ø© Ù‚ØµÙŠØ±Ø©. Ø¹Ù†Ø¯ Ø°ÙƒØ± Ù…Ø´ÙƒÙ„Ø© ØµØ­ÙŠØ© Ø¬Ø¯ÙŠØ©ØŒ Ø§Ù†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¯ÙˆÙ† ØªÙ‡ÙˆÙŠÙ„.
`;}

    function buildPlanJSONPrompt(){
      return `
Ø£Ø¹Ø¯ Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ø¨ØµÙŠØºØ© JSON ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ Ø£Ùˆ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø£Ùˆ Ø´ÙŠÙØ±Ø§Øª Markdown). Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ§Ù„ÙŠØ© Ø­ØµØ±Ø§Ù‹:
{
  "analysis": string | string[],
  "allowed": {"allowed": string[] | string, "forbidden": string[] | string} | string,
  "nutrition": [
    {"day": 1, "meals": [{"name": string, "items": string[] | string, "kcal": number | string, "protein_g": number | string}]}
  ],
  "training": [
    {"day": 1, "session": [{"exercise": string, "sets": number | string, "reps": number | string, "notes": string}]}
  ],
  "supplements": string | string[],
  "safety": string | string[],
  "closing": string
}
- Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
- Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù…Ù„ÙŠØ© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©.
- Ù„Ø§ ØªØ¶Ø¹ Ø£ÙŠ Ù†Øµ Ø®Ø§Ø±Ø¬ JSON.
\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:
${chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}
`;}

function buildPlanMarkdownPrompt(){
      return `
Ø§ÙƒØªØ¨ Ø®Ø·Ø© Ù…Ø®ØµØµØ© 100% Ø¨ØµÙŠØºØ© Markdown Ø¯ÙˆÙ† Ø£ÙŠ ØªÙ„Ù…ÙŠØ­ Ù„ÙˆØ¬ÙˆØ¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙƒÙ† Ù…Ù‡Ù†ÙŠÙ‹Ø§ ÙˆÙ…Ø¨Ø§Ø´Ø±Ù‹Ø§.
\nØ§Ù„ØªØ²Ù… Ø¨Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠØ© Ø­Ø±ÙÙŠÙ‹Ø§ (H2):
## Ø§Ù„ØªØ­Ù„ÙŠÙ„
## Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹
## Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)
## Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)
## Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª
## Ø§Ù„Ø³Ù„Ø§Ù…Ø©
## Ø§Ù„Ø®ØªØ§Ù…
\nØ§Ù„ØªÙØ§ØµÙŠÙ„:
- Ø§Ù„ØªØºØ°ÙŠØ©: 3 ÙˆØ¬Ø¨Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ã— 7 Ø£ÙŠØ§Ù…ØŒ Ù…Ù‚Ø§Ø¯ÙŠØ± ÙˆØ§Ø¶Ø­Ø© ÙˆØªÙˆØ²ÙŠØ¹ Ø³Ø¹Ø±Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØŒ Ø¨Ø¯Ø§Ø¦Ù„ Ø³Ø±ÙŠØ¹Ø© Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù„Ø²ÙˆÙ….
- Ø§Ù„ØªØ¯Ø±ÙŠØ¨: ÙˆÙÙ‚ Ù…Ø¹Ø·ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¬ÙŠÙ…/Ù…Ù†Ø²Ù„)ØŒ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª/ØªÙƒØ±Ø§Ø±Ø§ØªØŒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ù…Ø§Ù† ÙˆØªÙ‚Ø¯Ù‘Ù… Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ.
- Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª: ÙÙ‚Ø· Ø¥Ù† Ù„Ø²Ù…ØŒ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆÙ…ÙˆØ§Ù†Ø¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ù„ØªØ¯Ø§Ø®Ù„Ø§Øª.
- Ø§Ù„Ø³Ù„Ø§Ù…Ø©: ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶/Ø§Ù„Ø£Ø¯ÙˆÙŠØ©/Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª.
\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:
${chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}
`;}: ${m.parts[0].text}`).join('\n')}
`;
    }

    async function callAI(prompt){
      try{
        const res = await fetch('/.netlify/functions/gemini-proxy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt }) });
        const data = await res.json();
        return data.text || 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯.';
      }catch(e){ console.error(e); return 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'; }
    }

    async function processAIResponse(message){
      lockInputs(true);
      const coachPrompt = `${buildCoachSystemPrompt()}\n\nØ³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:\n${chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}\n\nØ±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø®ÙŠØ±Ø©: ${message}`;
      const response = await callAI(coachPrompt);
      chatHistory.push({ role:'assistant', parts:[{text: response}] });
      displayMessage(response, 'ai');
      lockInputs(false);
      togglePlanCTA();
    }

    /* ==========================
       Input enrichment & safety notes
    ===========================*/
    const MED_FLAGS = /(Ø³ÙƒØ±ÙŠ|Ø¶ØºØ·|Ù‚Ù„Ø¨|ÙƒÙˆØ±ÙˆÙ†Ø§|Ø³Ø±Ø·Ø§Ù†|Ø­Ø§Ù…Ù„|Ø­Ù…Ù„|Ø±Ø¶Ø§Ø¹Ø©|ØºØ¯Ø©|ÙƒØ¨Ø¯|ÙƒÙ„Ùˆ[ÙŠØ©]|kidney|liver|thyroid|injury|Ø¥ØµØ§Ø¨Ø©|Ø¹Ù…Ù„ÙŠØ©|Ø¯ÙˆØ§Ø¡|Ø£Ø¯ÙˆÙŠØ©|Ù…Ø¶Ø§Ø¯|ÙƒÙˆØ±ØªÙŠØ²ÙˆÙ†|Ù…Ø¶Ø§Ø¯Ø§Øª|Ø¶ØºØ· Ø§Ù„Ø¯Ù…|Ø³ÙƒØ± Ø§Ù„Ø¯Ù…)/i;

    function analyzeUserMessage(msg){
      const flags = MED_FLAGS.test(msg);
      if(flags){
        displayMessage('ğŸ‘€ Ù„Ø§Ø­Ø¸Øª Ø¥Ù†Ùƒ Ø°ÙƒØ±Øª Ø­Ø§Ù„Ø© ØµØ­ÙŠØ©/Ø¯ÙˆØ§Ø¡. Ù‡Ù†Ø±Ø§Ø¹ÙŠ Ø¯Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·Ø© ÙˆÙ†Ø¶ÙŠÙ Ø§Ø­ØªÙŠØ§Ø·Ø§Øª Ø®Ø§ØµØ©. Ù„Ùˆ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡/Ø§Ù„Ø¬Ø±Ø¹Ø©/Ø§Ù„ØªØ´Ø®ÙŠØµ) Ø§ÙƒØªØ¨Ù‡Ø§ Ù„ÙŠØ§.', 'ai');
      }
    }

    /* ==========================
       Modal plan generation (progressive)
    ===========================*/
    function openPlanModal(){
      planModal.classList.add('open');
      planModal.setAttribute('aria-hidden','false');
    }
    function closePlanModal(){
      planModal.classList.remove('open');
      planModal.setAttribute('aria-hidden','true');
    }

    function lockInputs(state){
      userInput.disabled = state; sendBtn.disabled = state; plusBtn.disabled = state; generatePlanBtn.disabled = state && !isDataComplete();
    }

    function sectionBlock(title, contentHTML = '', collapsed = false){
      const wrapper = document.createElement('section');
      wrapper.className = 'mb-4 border border-gray-200 rounded-lg overflow-hidden dark:border-slate-700';
      const hdr = document.createElement('button');
      hdr.className = 'w-full text-right font-bold px-3 py-2 bg-gray-50 dark:bg-slate-800 flex items-center justify-between';
      hdr.innerHTML = `<span>${title}</span><span aria-hidden="true">${collapsed ? 'ï¼‹' : 'âˆ’'}</span>`;
      const body = document.createElement('div');
      body.className = 'p-3';
      body.innerHTML = contentHTML || '<span class="skeleton" style="height:12px;width:90%"></span><span class="skeleton mt-2" style="height:12px;width:80%"></span>';
      if(collapsed) body.style.display = 'none';
      hdr.addEventListener('click', ()=>{
        const hidden = body.style.display === 'none';
        body.style.display = hidden ? 'block' : 'none';
        hdr.lastElementChild.textContent = hidden ? 'âˆ’' : 'ï¼‹';
      });
      wrapper.appendChild(hdr); wrapper.appendChild(body);
      return { wrapper, body };
    }

    async function generatePlanProgressive(){
      openPlanModal();
      planOutput.innerHTML = '';

      const sections = [
        { key:'analysis', title:'Ø§Ù„ØªØ­Ù„ÙŠÙ„' },
        { key:'allowed', title:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹' },
        { key:'nutrition', title:'Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)' },
        { key:'training', title:'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)' },
        { key:'supps', title:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª' },
        { key:'safety', title:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©' },
        { key:'closing', title:'Ø§Ù„Ø®ØªØ§Ù…' },
      ];

      const blocks = sections.map(s => sectionBlock(s.title));
      blocks.forEach(b => planOutput.appendChild(b.wrapper));

      const delay = ms => new Promise(r => setTimeout(r, ms));

      // ===== JSON First (structured plan) =====
      async function fetchJSONPlan(retry=0){
        let raw = await callAI(buildPlanJSONPrompt());
        if(typeof raw !== 'string') return null;
        let clean = raw.trim();
        // Ø¥Ø²Ø§Ù„Ø© Ø£Ø³ÙˆØ§Ø± Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù† ÙˆÙØ¬Ø¯Øª
        if (clean.startsWith('```')){
          clean = clean.replace(/^```json/i,'').replace(/^```/i,'');
          if (clean.endsWith('```')) clean = clean.slice(0, -3);
          clean = clean.trim();
        }
        try { return JSON.parse(clean); } catch(e){}
        const start = clean.indexOf('{');
        const end = clean.lastIndexOf('}');
        if(start !== -1 && end !== -1 && end > start){
          try { return JSON.parse(clean.slice(start, end+1)); } catch(e){}
        }
        if(retry < 1) return await fetchJSONPlan(retry+1);
        return null;
      }

      const plan = await fetchJSONPlan();
      if(!plan){
        for (let i=0;i<sections.length;i++){ await delay(i===0?250:150); blocks[i].body.innerHTML = '<p>â€”</p>'; }
        blocks[0].body.innerHTML = '<p class="text-red-600">ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>';
        return;
      }

      const toMD = v => Array.isArray(v) ? v.map(x=>`- ${x}`).join('
') : (typeof v==='string'? v : JSON.stringify(v, null, 2));

      const buildNutritionMD = (arr)=>{
        if(!Array.isArray(arr)) return toMD(arr);
        return arr.map((d,i)=>{
          const meals = Array.isArray(d.meals)? d.meals : [];
          const lines = meals.map(m=>{
            const items = Array.isArray(m.items)? m.items.join(', ') : (m.items||'');
            const kcal = m.kcal? ` â€” ${m.kcal} Ùƒ.Ø³` : '';
            const pr = m.protein_g? ` | Ø¨Ø±ÙˆØªÙŠÙ†: ${m.protein_g}Øº` : '';
            return `- **${m.name||'ÙˆØ¬Ø¨Ø©'}**: ${items}${kcal}${pr}`;
          }).join('
');
          return `### Ø§Ù„ÙŠÙˆÙ… ${d.day||i+1}
${lines}`;
        }).join('

');
      };

      const buildTrainingMD = (arr)=>{
        if(!Array.isArray(arr)) return toMD(arr);
        return arr.map((d,i)=>{
          const sess = Array.isArray(d.session)? d.session : [];
          const lines = sess.map(ex=>`- **${ex.exercise||'ØªÙ…Ø±ÙŠÙ†'}** â€” ${ex.sets||''}Ã—${ex.reps||''}${ex.notes?` (${ex.notes})`:''}`).join('
');
          return `### Ø§Ù„ÙŠÙˆÙ… ${d.day||i+1}
${lines}`;
        }).join('

');
      };

      const allowedMD = (()=>{
        if(typeof plan.allowed === 'string') return plan.allowed;
        if(plan.allowed && (plan.allowed.allowed || plan.allowed.forbidden)){
          const a = toMD(plan.allowed.allowed||[]);
          const f = toMD(plan.allowed.forbidden||[]);
          return `**Ù…Ø³Ù…ÙˆØ­:**
${a}

**Ù…Ù…Ù†ÙˆØ¹:**
${f}`;
        }
        return toMD(plan.allowed||'');
      })();

      const mdMap = {
        analysis: toMD(plan.analysis||''),
        allowed: allowedMD,
        nutrition: buildNutritionMD(plan.nutrition||[]),
        training: buildTrainingMD(plan.training||[]),
        supps: toMD(plan.supplements||''),
        safety: toMD(plan.safety||''),
        closing: toMD(plan.closing||'')
      };

      for (let i=0;i<sections.length;i++){
        await delay(i===0?250:200);
        const k = sections[i].key; const b = blocks[i].body;
        const content = mdMap[k] && String(mdMap[k]).trim().length ? mdMap[k] : 'â€”';
        b.innerHTML = marked.parse(content);
      }
    },
        { key:'allowed', title:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹' },
        { key:'nutrition', title:'Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)' },
        { key:'training', title:'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)' },
        { key:'supps', title:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª' },
        { key:'safety', title:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©' },
        { key:'closing', title:'Ø§Ù„Ø®ØªØ§Ù…' },
      ];

      const blocks = sections.map(s => sectionBlock(s.title));
      blocks.forEach(b => planOutput.appendChild(b.wrapper));

      // Single full prompt for accuracy; then split into sections client-side
      const full = await callAI(buildPlanPrompt());
      if(!full || typeof full !== 'string'){ planOutput.innerHTML += '<p class="text-red-600">ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>'; return; }

      // Render progressively (simulate stream by slicing headings)
      const md = full;

      const map = {
        analysis: /##\s*Ø§Ù„ØªØ­Ù„ÙŠÙ„([\s\S]*?)(?=##\s*Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹|$)/,
        allowed: /##\s*Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹([\s\S]*?)(?=##\s*Ø§Ù„ØªØºØ°ÙŠØ©|$)/,
        nutrition: /##\s*Ø§Ù„ØªØºØ°ÙŠØ©\s*\(7\s*Ø£ÙŠØ§Ù…\)([\s\S]*?)(?=##\s*Ø§Ù„ØªØ¯Ø±ÙŠØ¨|$)/,
        training: /##\s*Ø§Ù„ØªØ¯Ø±ÙŠØ¨\s*\(7\s*Ø£ÙŠØ§Ù…\)([\s\S]*?)(?=##\s*Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª|$)/,
        supps: /##\s*Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª([\s\S]*?)(?=##\s*Ø§Ù„Ø³Ù„Ø§Ù…Ø©|$)/,
        safety: /##\s*Ø§Ù„Ø³Ù„Ø§Ù…Ø©([\s\S]*?)(?=##\s*Ø§Ù„Ø®ØªØ§Ù…|$)/,
        closing: /##\s*Ø§Ù„Ø®ØªØ§Ù…([\s\S]*$)/,
      };

      const delay = ms => new Promise(r => setTimeout(r, ms));

      for (let i=0; i<sections.length; i++){
        const k = sections[i].key; const b = blocks[i].body; const match = md.match(map[k]);
        await delay(i===0?300:250); // snappy staged reveal
        b.innerHTML = match ? marked.parse(match[1].trim()) : '<p>â€”</p>';
      }
    }

    /* ==========================
       Events
    ===========================*/
    document.addEventListener('DOMContentLoaded', ()=>{
      startBtn.addEventListener('click', ()=>{ welcomeScreen.classList.add('hidden'); userDataScreen.classList.remove('hidden'); setLang(LANG); });

      nextBtn.addEventListener('click', ()=>{
        const name = (userNameInput.value||'').trim();
        const age = (userAgeInput.value||'').trim();
        const country = (userCountryInput.value||'').trim();
        if(!name || !age || !country){ toast(i18n[LANG].emptyFields); return; }
        userState.data = { ...userState.data, name, age, country };
        userDataScreen.classList.add('hidden'); chatContainer.classList.remove('hidden');
        const welcomeMsg = i18n[LANG].initialPrompt.replace('{name}', name);
        chatHistory.push({ role:'assistant', parts:[{text: welcomeMsg}] });
        displayMessage(welcomeMsg, 'ai');
        togglePlanCTA();
      });

      btnTheme.addEventListener('click', setTheme);
      btnLang.addEventListener('click', ()=> setLang(LANG==='ar' ? 'en' : 'ar'));

      plusBtn.addEventListener('click', ()=> imageInput.click());
      imageInput.addEventListener('change', (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const img = `<img src="${ev.target.result}" class="max-w-[180px] rounded-lg my-2" alt="uploaded"/>`;
          displayMessage(img, 'user');
          toast(i18n[LANG].imageUpload);
        };
        reader.readAsDataURL(file);
      });

      function sendMessage(){
        const message = (userInput.value||'').trim(); if(!message) return;
        displayMessage(message, 'user'); chatHistory.push({ role:'user', parts:[{text: message}] });
        analyzeUserMessage(message);
        if (/(Ø§Ù„Ø®Ø·Ø©|Ø®Ø·Ø©|Ø®Ø·Ù‡|Ø§Ø¹Ù…Ù„\s*Ø®Ø·Ø©|Ø¬Ù‡Ø²\s*Ø§Ù„Ø®Ø·Ø©|Ø¹Ø§ÙŠØ²\s*Ø§Ù„Ø®Ø·Ø©|generate\s*plan|my\s*plan)/i.test(message)){
          displayMessage(i18n[LANG].planPreparingInModal, 'ai');
          generatePlanProgressive();
          userInput.value = '';
          return;
        }
        processAIResponse(message);
        userInput.value = '';
      }] });
        analyzeUserMessage(message);
        processAIResponse(message);
        userInput.value = '';
      }
      sendBtn.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', e => { if(e.key==='Enter'){ sendMessage(); }});

      generatePlanBtn.addEventListener('click', async ()=>{
        // Confirm user has validated data via a brief summary request first
        displayMessage(i18n[LANG].generationStart, 'ai');
        await generatePlanProgressive();
        displayMessage(i18n[LANG].generationDone, 'ai');
      });

      closePlanBtn.addEventListener('click', ()=> closePlanModal());
      planModal.addEventListener('click', (e)=>{ if(e.target === planModal) closePlanModal(); });
      printBtn.addEventListener('click', ()=> window.print());
      expandAllBtn.addEventListener('click', ()=>{
        planOutput.querySelectorAll('section > button + div').forEach(d => d.style.display='block');
        planOutput.querySelectorAll('section > button span:last-child').forEach(ic => ic.textContent='âˆ’');
      });

      // Theme restore
      const savedTheme = localStorage.getItem('theme');
      if(savedTheme === 'dark'){ document.documentElement.classList.add('dark'); btnTheme.textContent = 'ğŸŒ™'; }
      setLang('ar');
    });
  </script>
</body>
</html>
