<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø°ÙƒÙŠ | Your Smart Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
    :root { --primary:#04364A; --secondary:#176B87; --accent:#64CCC5; --chat-bg:#F8F9FA; --bubble-user:#DCF8C6; --bubble-ai:#fff; --backdrop:rgba(2,6,23,.55); }
    html.dark { --primary:#1F2937; --secondary:#374151; --accent:#10B981; --chat-bg:#111827; --bubble-user:#4B5563; --bubble-ai:#374151; --backdrop:rgba(0,0,0,.7); }
    *{box-sizing:border-box}
    body{font-family:'Tajawal',sans-serif;background:var(--chat-bg);color:#333;transition:background-color .3s,color .3s}
    .dark body{color:#E5E7EB}

    /* Chat shell */
    .chat-container{max-width:720px;margin:0 auto;height:100vh;display:flex;flex-direction:column;background:var(--chat-bg);box-shadow:0 0 25px rgba(0,0,0,.08);border-radius:1rem;overflow:hidden}
    .chat-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:.875rem 1rem;position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center}
    .chat-messages{flex:1;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:6rem}
    .message-bubble{padding:.85rem 1.15rem;border-radius:1.25rem;max-width:82%;margin-bottom:.75rem;animation:fadeIn .25s ease-in-out}
    .message-bubble.user{background:var(--bubble-user);margin-left:auto;border-bottom-right-radius:.25rem}
    .message-bubble.ai{background:var(--bubble-ai);margin-right:auto;border-bottom-left-radius:.25rem}

    .input-area{display:flex;gap:.5rem;padding:.75rem;background:#F8F9FA;border-top:1px solid #E0E0E0;position:sticky;bottom:0;z-index:10;align-items:center}
    .dark .input-area{background:#1F2937;border-top-color:#374151}
    .input-area input[type=text]{flex:1;border-radius:2rem;padding:.75rem 1.2rem;border:1px solid #CCC;background:#fff}
    .dark .input-area input[type=text]{background:#374151;border-color:#4B5563;color:#E5E7EB}
    .input-area input[type=text]:focus{border-color:var(--accent)}
    .icon-btn{background:transparent;color:var(--secondary);border-radius:999px;width:44px;height:44px;display:grid;place-items:center;transition:.25s}
    .icon-btn:hover{background:rgba(0,0,0,.06)}
    .send-btn{background:var(--accent);color:#fff}

    .welcome-screen,.user-data-screen{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .cta-btn{background:var(--accent);font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.25);padding:1rem 2rem;border-radius:999px}

    .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:.85rem 1rem;border-radius:.5rem;z-index:60;opacity:0;transition:.4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--backdrop);z-index:50}
    .modal.open{display:flex}
    .modal-content{width:min(920px,96vw);max-height:86vh;overflow:hidden;background:#fff;border-radius:1rem;box-shadow:0 20px 60px rgba(0,0,0,.25);display:flex;flex-direction:column}
    .dark .modal-content{background:#0f172a;color:#E5E7EB}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:.85rem 1rem;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .modal-body{padding:1rem 1rem .5rem;overflow-y:auto}
    .modal-actions{display:flex;gap:.5rem;padding:.85rem 1rem 1rem;border-top:1px solid #e5e7eb}
    .close-button{background:transparent;color:#fff;font-size:1.75rem;line-height:1;padding:0 .25rem}

    .skeleton{display:block;height:1rem;width:100%;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:shimmer 1.2s infinite;border-radius:.35rem}
    .dark .skeleton{background:linear-gradient(90deg,#374151,#4b5563,#374151)}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    .btn{padding:.6rem 1rem;border-radius:.6rem;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:#6B7280;color:#fff}

    .typewriter-text{font-size:1.05rem;font-weight:600;color:var(--primary)}
    .dark .typewriter-text{color:var(--accent)}

    /* Section cards (plan) */
    .section-card{border:1px solid #e5e7eb;border-radius:.75rem;overflow:hidden;margin-bottom:1rem}
    .section-head{display:flex;justify-content:space-between;align-items:center;background:#f9fafb;padding:.6rem .8rem;font-weight:800}
    .dark .section-head{background:#111827;color:#E5E7EB}
    .section-body{padding:.8rem}

    /* Contact options */
    .contact-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:520px){ .contact-grid{grid-template-columns:1fr 1fr} }
    .contact-card{border:1px solid #e5e7eb;border-radius:.9rem;padding:1rem;display:flex;align-items:center;gap:.9rem;background:#fff;transition:.2s}
    .dark .contact-card{background:#0b1220;border-color:#1f2a44}
    .contact-card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .icon{width:28px;height:28px;display:inline-block}
    .wa{color:#25D366}
    .ph{color:#0ea5e9}

    .footer{text-align:center;padding:.75rem;font-size:.9rem;color:#6b7280}
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">
  <!-- Welcome -->
  <div class="welcome-screen" id="welcomeScreen">
    <img src="https://placehold.co/150x150/ffffff/0D47A1?text=AI+Coach" alt="AI Coach Avatar" class="rounded-full mb-6 shadow-xl"/>
    <h1 class="text-4xl font-bold mb-2" id="welcomeTitle">Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ</h1>
    <p class="text-xl font-light text-white/90 mb-8" id="welcomeSubtitle">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø¢Ù†</p>
    <button id="startBtn" class="cta-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
  </div>

  <!-- Basic user data -->
  <div class="user-data-screen hidden" id="userDataScreen">
    <h2 class="text-3xl font-extrabold mb-4" id="userDataTitle">Ù„Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ</h2>
    <p class="text-white/90 mb-6" id="userDataSubtitle">Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¹Ù† Ù†ÙØ³Ùƒ Ù„ØªØ¨Ø¯Ø£</p>
    <div class="w-full max-w-sm">
      <input type="text" id="userName" class="block w-full mb-3 rounded-md px-4 py-3 text-right bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="Ø§Ø³Ù…Ùƒ" dir="rtl">
      <input type="number" id="userAge" class="block w-full mb-3 rounded-md px-4 py-3 text-left bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="Ø¹Ù…Ø±Ùƒ" dir="ltr">
      <input type="text" id="userCountry" class="block w-full mb-3 rounded-md px-4 py-3 text-right bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="Ø¯ÙˆÙ„ØªÙƒ" dir="rtl">
      <button id="nextBtn" class="cta-btn w-full mt-2">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </div>

  <!-- Chat -->
  <div class="chat-container hidden" id="chatContainer">
    <div class="chat-header">
      <div class="flex items-center gap-2">
        <img src="https://placehold.co/40x40/ffffff/0D47A1?text=AI" alt="Coach AI Avatar" class="rounded-full"/>
        <span class="text-xl font-bold" id="chatTitle">Coach AI</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLang" class="icon-btn text-white border border-white/30 px-3 w-auto h-9 rounded-md">AR</button>
        <button id="btnTheme" class="icon-btn text-white border border-white/30 w-9 h-9 rounded-md">â˜€ï¸</button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages" role="region" aria-label="Chat messages"></div>

    <!-- CTA becomes contact options trigger -->
    <div id="planButtonArea" class="px-4 py-3 hidden">
      <div class="rounded-xl bg-white shadow dark:bg-slate-800 p-3 flex items-center justify-between">
        <div class="typewriter-text"><span id="prepStatus">Ø¬Ø§Ù‡Ø² Ù†Ø¨Ù†ÙŠ Ø®Ø·ØªÙƒØŸ</span></div>
        <button id="generatePlanBtn" class="btn btn-primary" disabled>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</button>
      </div>
      <p id="planButtonNote" class="text-gray-500 text-sm mt-2">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰.</p>
    </div>

    <div class="input-area" id="inputArea">
      <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." dir="rtl" />
      <input type="file" id="imageInput" accept="image/*" class="hidden" />
      <button id="plusBtn" class="icon-btn" aria-label="Ø£Ø±Ø³Ù„ Ù…Ù„Ù">â•</button>
      <button id="sendBtn" class="icon-btn send-btn" aria-label="Ø£Ø±Ø³Ù„"> â†ª </button>
    </div>
  </div>

  <!-- Plan Modal -->
  <div id="planModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog" aria-labelledby="planModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="planModalTitle" class="text-lg font-extrabold">Ø®Ø·ØªÙƒ Ø§Ù„Ù…Ø®ØµØµØ©</h3>
        <button id="closePlanBtn" class="close-button" title="Ø¥ØºÙ„Ø§Ù‚" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </div>
      <div id="planOutput" class="modal-body">
        <div class="mb-4">
          <p class="typewriter-text">Ø¬Ø§Ø±Ù ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ù‚Ø³Ù…Ù‹Ø§â€¦</p>
          <span class="skeleton" style="height:12px;width:85%"></span>
          <span class="skeleton mt-2" style="height:12px;width:92%"></span>
          <span class="skeleton mt-2" style="height:12px;width:75%"></span>
        </div>
      </div>
      <div class="modal-actions">
        <button id="printBtn" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø·Ø©</button>
        <button id="expandAllBtn" class="btn btn-secondary">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
      </div>
    </div>
  </div>

  <!-- Contact Modal (NEW) -->
  <div id="contactModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="contactTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="contactTitle" class="text-lg font-extrabold">Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
        <button id="closeContactBtn" class="close-button" title="Ø¥ØºÙ„Ø§Ù‚" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="contact-grid">
          <a class="contact-card" href="https://wa.me/971502061209" target="_blank" rel="noopener" aria-label="ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
            <svg class="icon wa" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M20.52 3.48A11.77 11.77 0 0 0 12.06 0C5.47 0 .1 5.37.1 12c0 2.11.55 4.2 1.6 6.03L0 24l6.17-1.62A11.9 11.9 0 0 0 12.06 24c6.6 0 11.97-5.38 11.97-12s-5.37-12-11.97-12Zm0 0" opacity=".1"/>
              <path d="M12.06 2.1C6.62 2.1 2.2 6.52 2.2 12c0 1.9.5 3.77 1.45 5.42l-.96 3.55 3.64-.95A9.88 9.88 0 0 0 12.06 21.9c5.44 0 9.86-4.42 9.86-9.9s-4.42-9.9-9.86-9.9Zm5.66 14.18c-.24.68-1.41 1.29-1.96 1.38-.5.08-1.15.11-1.86-.12-.43-.14-1-.32-1.7-.63-2.99-1.3-4.94-4.38-5.09-4.59-.15-.21-1.21-1.6-1.21-3.05 0-1.45.76-2.17 1.02-2.47.26-.3.57-.38.76-.38.18 0 .37 0 .54.01.17.01.4-.07.62.47.24.58.82 2 .9 2.14.07.14.12.3.02.49-.1.2-.15.32-.3.49-.15.17-.31.38-.44.51-.15.15-.3.32-.13.62.17.3.77 1.27 1.66 2.06 1.14 1.02 2.1 1.34 2.4 1.5.3.15.48.13.66-.08.18-.2.76-.89.97-1.2.21-.3.41-.25.68-.15.26.09 1.65.78 1.93.92.29.14.48.21.55.33.07.12.07.7-.17 1.38Z"/>
            </svg>
            <div>
              <div class="font-extrabold">ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±</div>
              <div class="text-sm text-gray-500">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
            </div>
          </a>
          <a class="contact-card" href="tel:+971502061209" aria-label="Ø§ØªØµØ§Ù„ Ù‡Ø§ØªÙÙŠ">
            <svg class="icon ph" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M6.62 10.79a15.053 15.053 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.11.37 2.31.57 3.58.57.55 0 1 .45 1 1v3.5a1 1 0 0 1-1 1C10.85 21 3 13.15 3 3.99a1 1 0 0 1 1-1H7.5a1 1 0 0 1 1 1c0 1.27.2 2.47.57 3.58.1.33.03.69-.23.95l-2.22 2.27Z"/>
            </svg>
            <div>
              <div class="font-extrabold">Ø§ØªØµØ§Ù„ Ù‡Ø§ØªÙÙŠ</div>
              <div class="text-sm text-gray-500">+971502061209</div>
            </div>
          </a>
        </div>
        <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">ØªÙØ¶Ù„ Ø®ÙŠØ§Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ØŒ Ø£Ùˆ <button id="continueInChatBtn" class="underline">ØªØ§Ø¨Ø¹ Ù‡Ù†Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>.</div>
      </div>
    </div>
  </div>

  <footer class="footer">Â© 2025 Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</footer>

  <script type="module">
    /* Elements */
    const $ = id => document.getElementById(id);
    const chatMessages = $('chatMessages');
    const userInput = $('userInput');
    const sendBtn = $('sendBtn');
    const startBtn = $('startBtn');
    const nextBtn = $('nextBtn');
    const welcomeScreen = $('welcomeScreen');
    const userDataScreen = $('userDataScreen');
    const chatContainer = $('chatContainer');
    const userNameInput = $('userName');
    const userAgeInput = $('userAge');
    const userCountryInput = $('userCountry');
    const btnTheme = $('btnTheme');
    const btnLang = $('btnLang');
    const plusBtn = $('plusBtn');
    const imageInput = $('imageInput');
    const planButtonArea = $('planButtonArea');
    const generatePlanBtn = $('generatePlanBtn');
    const planModal = $('planModal');
    const closePlanBtn = $('closePlanBtn');
    const planOutput = $('planOutput');
    const printBtn = $('printBtn');
    const expandAllBtn = $('expandAllBtn');
    const contactModal = $('contactModal');
    const closeContactBtn = $('closeContactBtn');
    const continueInChatBtn = $('continueInChatBtn');

    let userState = { step: 0, data: {} };
    let LANG = 'ar';
    let chatHistory = [];

    /* i18n */
    const i18n = {
      ar: {
        welcomeTitle: 'Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ', welcomeSubtitle: 'Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø¢Ù†', startButtonText: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
        userDataTitle: 'Ù„Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ', userDataSubtitle: 'Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¹Ù† Ù†ÙØ³Ùƒ Ù„ØªØ¨Ø¯Ø£', namePlaceholder:'Ø§Ø³Ù…Ùƒ', agePlaceholder:'Ø¹Ù…Ø±Ùƒ', countryPlaceholder:'Ø¯ÙˆÙ„ØªÙƒ', nextButtonText:'Ø§Ù„ØªØ§Ù„ÙŠ',
        chatTitle:'Coach AI', inputPlaceholder:'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...', emptyFields:'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ¹Ù…Ø±Ùƒ ÙˆØ¯ÙˆÙ„ØªÙƒ Ù„Ù„Ø¨Ø¯Ø¡.', imageUpload:'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØµÙˆØ±Ø©.',
        generationStart:'Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø®Ø·Ø©â€¦ Ù‚Ø³Ù…Ù‹Ø§ Ù‚Ø³Ù…Ù‹Ø§.', generationDone:'Ø§Ù„Ø®Ø·Ø© Ø¬Ø§Ù‡Ø²Ø©. Ù„Ùˆ Ù…Ø­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¨Ù„ØºÙ†ÙŠ.',
        initialPrompt:'Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ {name}. Ù‡Ù†ØªØ­Ø±Ùƒ Ø¨Ø®Ø·ÙˆØ§Øª Ù…Ù†Ø¸Ù…Ø© ÙˆÙ†Ø¨Ù†ÙŠ Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.',
        planButtonText:'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†', planButtonNote:'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰.',
        planPreparingInModal:'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø®Ø·Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© ÙÙˆÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.'
      },
      en: {
        welcomeTitle:'Your Personal Health Coach', welcomeSubtitle:'Start your journey to a better you now', startButtonText:'Start Chat',
        userDataTitle:'Letâ€™s start your journey', userDataSubtitle:'Tell us about yourself to begin', namePlaceholder:'Your Name', agePlaceholder:'Your Age', countryPlaceholder:'Your Country', nextButtonText:'Next',
        chatTitle:'Coach AI', inputPlaceholder:'Type your messageâ€¦', emptyFields:'Please enter your name, age, and country to get started.', imageUpload:'Image received.',
        generationStart:'Preparing your planâ€¦ section by section.', generationDone:'Plan ready. Tell me if you need changes.',
        initialPrompt:'Hi {name}. Weâ€™ll move step by step and build a precise plan around your data.',
        planButtonText:'Get Your Plan Now', planButtonNote:'You can keep chatting if you have questions.',
        planPreparingInModal:'Working on your plan in a modal above the chat.'
      }
    };
    function setLang(lang){
      LANG = lang; document.documentElement.lang = lang; document.documentElement.dir = lang==='ar'?'rtl':'ltr';
      const L = i18n[LANG];
      $('welcomeTitle').textContent=L.welcomeTitle; $('welcomeSubtitle').textContent=L.welcomeSubtitle;
      $('userDataTitle').textContent=L.userDataTitle; $('userDataSubtitle').textContent=L.userDataSubtitle;
      $('userName').placeholder=L.namePlaceholder; $('userAge').placeholder=L.agePlaceholder; $('userCountry').placeholder=L.countryPlaceholder; $('nextBtn').textContent=L.nextButtonText;
      $('chatTitle').textContent=L.chatTitle; $('userInput').placeholder=L.inputPlaceholder; $('generatePlanBtn').textContent=L.planButtonText; $('planButtonNote').textContent=L.planButtonNote;
      btnLang.textContent = lang==='ar'?'AR':'EN';
    }

    /* Utilities */
    function setTheme(){ document.documentElement.classList.toggle('dark'); btnTheme.textContent = document.documentElement.classList.contains('dark') ? 'ğŸŒ™' : 'â˜€ï¸'; localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light') }
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.style.opacity=1,10); setTimeout(()=>{t.style.opacity=0; setTimeout(()=>t.remove(),400)},2600) }
    function displayMessage(message,sender){ const b=document.createElement('div'); b.classList.add('message-bubble',sender); b.innerHTML=marked.parse(message); chatMessages.appendChild(b); chatMessages.scrollTop=chatMessages.scrollHeight }
    function isDataComplete(){ return ['name','age','country'].every(k=>!!userState.data[k]) }
    function togglePlanCTA(){ const ready=isDataComplete(); planButtonArea.classList.toggle('hidden',!ready); generatePlanBtn.disabled=!ready }

    /* Professional coach prompts */
    function buildCoachSystemPrompt(){
      return `
Ø§ÙƒØªØ¨ Ø±Ø¯ÙˆØ¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù‚ØµÙŠØ±Ø© ÙˆÙ…Ø­ØªØ±ÙØ©ØŒ Ø¨Ù„Ø§ Ù…Ø¨Ø§Ù„ØºØ© ÙˆÙ„Ø§ Ø«Ù†Ø§Ø¡ Ø²Ø§Ø¦Ø¯. Ù„Ø§ ØªØ°ÙƒØ± Ø£Ù†Ø¸Ù…Ø© Ø£Ùˆ Ø±ÙˆØ¨ÙˆØªØ§Øª. Ø§Ù„Ø£Ø³Ù„ÙˆØ¨: ÙˆØ§Ø¶Ø­ØŒ ÙˆØ§Ø«Ù‚ØŒ Ø¹Ù…Ù„ÙŠ.
Ø§Ù„Ø¯ÙˆØ±: Ø®Ø¨ÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ ÙÙŠ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØºØ°ÙŠØ© ÙˆØ·Ø¨ÙŠØ¨ Ø§Ø³ØªØ´Ø§Ø±ÙŠ.
Ø§Ù„Ù…Ù‡Ù…Ø©: Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø­Ù„ (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ø³Ø¤Ø§Ù„Ø§Ù† ÙƒÙ„ Ù…Ø±Ø©)ØŒ Ø«Ù… ØªÙ„Ø®ÙŠØµÙ‡Ø§ ÙˆØ·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯.
Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø£Ù…Ø±Ø§Ø¶/Ø£Ø¯ÙˆÙŠØ©/Ø¥ØµØ§Ø¨Ø§Øª: Ù‚Ø¯Ù‘Ù… Ø§Ø­ØªÙŠØ§Ø·Ø§Øª Ù…Ø­Ø¯Ø¯Ø© ÙˆÙÙ‘Ø±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø§Øª.
Ø§Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø¬Ø© Ø¹Ø±Ø¨ÙŠØ© Ù…ÙÙ‡ÙˆÙ…Ø© (ÙØµØ­Ù‰ Ø¨Ø³ÙŠØ·Ø© Ù…Ø¹ Ù„Ù…Ø³Ø© Ù…ØµØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù„Ø²ÙˆÙ…) Ø¯ÙˆÙ† ØªØ¹Ù‚ÙŠØ¯.
`}

    function buildPlanJSONPrompt(){
      return `Ø£Ø¹ÙØ¯ ÙÙ‚Ø· JSON ØµØ§Ù„Ø­Ù‹Ø§ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¢Ø®Ø± Ø£Ùˆ Ø£Ø³ÙˆØ§Ø± ÙƒÙˆØ¯.
{
  "analysis": string | string[],
  "allowed": { "allowed": string[], "forbidden": string[] } | string,
  "nutrition": [ { "day": number, "meals": [ { "name": string, "items": string[], "kcal": number, "protein_g": number } ] } ],
  "training": [ { "day": number, "session": [ { "exercise": string, "sets": number, "reps": string, "notes": string } ], "duration_min": number, "location": "gym"|"home", "equipment": string[] } ],
  "supplements": string | [ { "name": string, "dose": string, "timing": string, "notes": string } ],
  "safety": string[] | string,
  "closing": string
}
Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:
${chatHistory.map(m=>`${m.role}: ${m.parts[0].text}`).join('\n')}`}

    function buildPlanMDPrompt(){
      return `Ø§ÙƒØªØ¨ Ø®Ø·Ø© Markdown ÙˆØ§Ø¶Ø­Ø© Ø¨Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙ‚Ø·:
## Ø§Ù„ØªØ­Ù„ÙŠÙ„
## Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹
## Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)
## Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)
## Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª
## Ø§Ù„Ø³Ù„Ø§Ù…Ø©
## Ø§Ù„Ø®ØªØ§Ù…
Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:
${chatHistory.map(m=>`${m.role}: ${m.parts[0].text}`).join('\n')}`}

    async function callAI(prompt){
      try{ const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})}); const data=await res.json(); return data.text||'' }catch(e){ console.error(e); return '' }
    }

    /* Flags & triggers */
    const MED_FLAGS=/(Ø³ÙƒØ±ÙŠ|Ø¶ØºØ·|Ù‚Ù„Ø¨|Ø³Ø±Ø·Ø§Ù†|Ø­Ø§Ù…Ù„|Ø­Ù…Ù„|Ø±Ø¶Ø§Ø¹Ø©|ØºØ¯Ø©|Ø¯Ø±Ù‚|ÙƒØ¨Ø¯|ÙƒÙ„Ùˆ[ÙŠØ©]|kidney|liver|thyroid|injury|Ø¥ØµØ§Ø¨Ø©|Ø¹Ù…Ù„ÙŠØ©|Ø¯ÙˆØ§Ø¡|Ø£Ø¯ÙˆÙŠØ©|ÙƒÙˆØ±ØªÙŠØ²ÙˆÙ†|Ø¶ØºØ· Ø§Ù„Ø¯Ù…|Ø³ÙƒØ± Ø§Ù„Ø¯Ù…)/i;
    function analyzeUserMessage(msg){ if(MED_FLAGS.test(msg)){ displayMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© ØµØ­ÙŠØ© ÙˆØ³ÙŠØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø®Ø·Ø© ÙˆÙÙ‚Ù‹Ø§ Ù„Ù‡Ø§. Ù„Ùˆ ÙÙŠÙ‡ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ø°ÙƒØ±Ù‡Ø§.', 'ai') } }

    /* Plan modal helpers */
    function openPlanModal(){ planModal.classList.add('open'); planModal.setAttribute('aria-hidden','false') }
    function closePlanModal(){ planModal.classList.remove('open'); planModal.setAttribute('aria-hidden','true') }
    function lockInputs(state){ userInput.disabled=state; sendBtn.disabled=state; plusBtn.disabled=state; generatePlanBtn.disabled=state && !isDataComplete() }

    function sectionBlock(title,html=''){
      const s=document.createElement('section'); s.className='section-card';
      const h=document.createElement('div'); h.className='section-head'; h.innerHTML=`<span>${title}</span><span aria-hidden="true">âˆ’</span>`;
      const b=document.createElement('div'); b.className='section-body'; b.innerHTML=html||'<span class="skeleton" style="height:12px;width:90%"></span>';
      h.addEventListener('click',()=>{ const hidden=b.style.display==='none'; b.style.display=hidden?'block':'none'; h.lastElementChild.textContent=hidden?'âˆ’':'ï¼‹' })
      s.appendChild(h); s.appendChild(b); return {wrapper:s, body:b}
    }

    const toMD=v=>Array.isArray(v)?v.map(x=>`- ${x}`).join('\n'):(typeof v==='string'?v:JSON.stringify(v,null,2));
    function buildNutritionMD(days){ if(!Array.isArray(days)) return toMD(days); return days.map((d,i)=>{ const meals=(d.meals||[]).map(m=>`- **${m.name||'ÙˆØ¬Ø¨Ø©'}**: ${(m.items||[]).join(', ')}${m.kcal?` â€” ${m.kcal} Ùƒ.Ø³`:''}${m.protein_g?` | Ø¨Ø±ÙˆØªÙŠÙ†: ${m.protein_g}Øº`:''}`).join('\n'); return `### Ø§Ù„ÙŠÙˆÙ… ${d.day||i+1}\n${meals}` }).join('\n\n') }
    function buildTrainingMD(days){ if(!Array.isArray(days)) return toMD(days); return days.map((d,i)=>{ const exs=(d.session||[]).map(ex=>`- **${ex.exercise||'ØªÙ…Ø±ÙŠÙ†'}** â€” ${ex.sets||''}Ã—${ex.reps||''}${ex.notes?` (${ex.notes})`:''}`).join('\n'); const meta=[]; if(d.duration_min) meta.push(`Ø§Ù„Ù…Ø¯Ø©: ${d.duration_min} Ø¯`); if(d.location) meta.push(`Ø§Ù„Ù…ÙƒØ§Ù†: ${d.location}`); return `### Ø§Ù„ÙŠÙˆÙ… ${d.day||i+1}${meta.length?` â€” ${meta.join(' | ')}`:''}\n${exs}` }).join('\n\n') }
    function buildSuppsMD(s){ if(Array.isArray(s)) return s.map(x=>`- **${x.name}** â€” ${x.dose}${x.timing?` (${x.timing})`:''}${x.notes?` â€” ${x.notes}`:''}`).join('\n'); return toMD(s) }

    async function fetchJSONPlan(){ let raw=await callAI(buildPlanJSONPrompt()); if(!raw) return null; let txt=raw.trim(); if(txt.startsWith('```')){ txt=txt.replace(/^```json/i,'').replace(/^```/i,''); if(txt.endsWith('```')) txt=txt.slice(0,-3); txt=txt.trim() } try{ return JSON.parse(txt) }catch(_){ const s=txt.indexOf('{'); const e=txt.lastIndexOf('}'); if(s>-1&&e>-1&&e>s){ try{ return JSON.parse(txt.slice(s,e+1)) }catch(__){} } } return null }

    async function generatePlanProgressive(){
      openPlanModal(); planOutput.innerHTML='';
      const sections=[{key:'analysis',title:'Ø§Ù„ØªØ­Ù„ÙŠÙ„'},{key:'allowed',title:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹'},{key:'nutrition',title:'Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)'},{key:'training',title:'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)'},{key:'supps',title:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª'},{key:'safety',title:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©'},{key:'closing',title:'Ø§Ù„Ø®ØªØ§Ù…'}];
      const blocks=sections.map(s=>sectionBlock(s.title)); blocks.forEach(b=>planOutput.appendChild(b.wrapper));
      const plan=await fetchJSONPlan();
      if(plan){ const allowedMD=(()=>{ if(typeof plan.allowed==='string') return plan.allowed; if(plan.allowed&&(plan.allowed.allowed||plan.allowed.forbidden)){ const a=toMD(plan.allowed.allowed||[]); const f=toMD(plan.allowed.forbidden||[]); return `**Ù…Ø³Ù…ÙˆØ­:**\n${a}\n\n**Ù…Ù…Ù†ÙˆØ¹:**\n${f}` } return toMD(plan.allowed||'') })(); const mdMap={ analysis:toMD(plan.analysis||''), allowed:allowedMD, nutrition:buildNutritionMD(plan.nutrition||[]), training:buildTrainingMD(plan.training||[]), supps:buildSuppsMD(plan.supplements||''), safety:toMD(plan.safety||''), closing:toMD(plan.closing||'') }; for(let i=0;i<sections.length;i++){ await new Promise(r=>setTimeout(r,i===0?250:180)); const k=sections[i].key; const b=blocks[i].body; const content=(mdMap[k]||'').trim()||'â€”'; b.innerHTML=marked.parse(content) } return }
      const mdFull=await callAI(buildPlanMDPrompt()); if(!mdFull){ blocks[0].body.innerHTML='<p class="text-red-600">ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¢Ù†.</p>'; for(let i=1;i<blocks.length;i++){ blocks[i].body.innerHTML='<p>â€”</p>' } return }
      const map={ analysis:/##\s*Ø§Ù„ØªØ­Ù„ÙŠÙ„\b([\s\S]*?)(?=##\s*(?:Ø§Ù„Ù…Ø³Ù…ÙˆØ­\s*Ùˆ?\s*Ø§Ù„Ù…Ù…Ù†ÙˆØ¹)|$)/, allowed:/##\s*Ø§Ù„Ù…Ø³Ù…ÙˆØ­\s*Ùˆ?\s*Ø§Ù„Ù…Ù…Ù†ÙˆØ¹\b([\s\S]*?)(?=##\s*(?:Ø§Ù„ØªØºØ°ÙŠØ©|Ø§Ù„ØªØ¯Ø±ÙŠØ¨|Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª|Ø§Ù„Ø³Ù„Ø§Ù…Ø©|Ø§Ù„Ø®ØªØ§Ù…)|$)/, nutrition:/##\s*Ø§Ù„ØªØºØ°ÙŠØ©\s*(?:[-â€“]\s*)?(?:\(\s*7\s*Ø£ÙŠØ§Ù…\s*\)|7\s*Ø£ÙŠØ§Ù…)?\b([\s\S]*?)(?=##\s*(?:Ø§Ù„ØªØ¯Ø±ÙŠØ¨|Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª|Ø§Ù„Ø³Ù„Ø§Ù…Ø©|Ø§Ù„Ø®ØªØ§Ù…)|$)/, training:/##\s*Ø§Ù„ØªØ¯Ø±ÙŠØ¨\s*(?:[-â€“]\s*)?(?:\(\s*7\s*Ø£ÙŠØ§Ù…\s*\)|7\s*Ø£ÙŠØ§Ù…)?\b([\s\S]*?)(?=##\s*(?:Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª|Ø§Ù„Ø³Ù„Ø§Ù…Ø©|Ø§Ù„Ø®ØªØ§Ù…)|$)/, supps:/##\s*Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª\b([\s\S]*?)(?=##\s*(?:Ø§Ù„Ø³Ù„Ø§Ù…Ø©|Ø§Ù„Ø®ØªØ§Ù…)|$)/, safety:/##\s*Ø§Ù„Ø³Ù„Ø§Ù…Ø©\b([\s\S]*?)(?=##\s*Ø§Ù„Ø®ØªØ§Ù…|$)/, closing:/##\s*Ø§Ù„Ø®ØªØ§Ù…\b([\s\S]*$)/ };
      let matched=0; for(let i=0;i<sections.length;i++){ const k=sections[i].key; const b=blocks[i].body; const m=mdFull.match(map[k]); await new Promise(r=>setTimeout(r,i===0?250:180)); if(m&&m[1]&&m[1].trim()){ matched++; b.innerHTML=marked.parse(m[1].trim()) } else { b.innerHTML='<p>â€”</p>' } } if(!matched){ blocks[0].body.innerHTML=marked.parse(mdFull) }
    }

    /* Contact modal helpers */
    function openContactModal(){ contactModal.classList.add('open'); contactModal.setAttribute('aria-hidden','false') }
    function closeContactModal(){ contactModal.classList.remove('open'); contactModal.setAttribute('aria-hidden','true') }

    /* Events */
    document.addEventListener('DOMContentLoaded',()=>{
      startBtn.addEventListener('click',()=>{ welcomeScreen.classList.add('hidden'); userDataScreen.classList.remove('hidden'); setLang(LANG) })
      nextBtn.addEventListener('click',()=>{ const name=(userNameInput.value||'').trim(); const age=(userAgeInput.value||'').trim(); const country=(userCountryInput.value||'').trim(); if(!name||!age||!country){ toast(i18n[LANG].emptyFields); return } userState.data={...userState.data,name,age,country}; userDataScreen.classList.add('hidden'); chatContainer.classList.remove('hidden'); const welcomeMsg=i18n[LANG].initialPrompt.replace('{name}',name); chatHistory.push({role:'assistant',parts:[{text:welcomeMsg}]}); displayMessage(welcomeMsg,'ai'); togglePlanCTA() })
      btnTheme.addEventListener('click',setTheme); btnLang.addEventListener('click',()=>setLang(LANG==='ar'?'en':'ar'))
      plusBtn.addEventListener('click',()=>imageInput.click()); imageInput.addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ displayMessage(`<img src="${ev.target.result}" class="max-w-[180px] rounded-lg my-2" alt="uploaded"/>`,'user'); toast(i18n[LANG].imageUpload) }; r.readAsDataURL(f) })

      async function processAIResponse(message){ lockInputs(true); const prompt=`${buildCoachSystemPrompt()}\n\nØ³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:\n${chatHistory.map(m=>`${m.role}: ${m.parts[0].text}`).join('\n')}\n\nØ±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø®ÙŠØ±Ø©: ${message}`; const response=await callAI(prompt); chatHistory.push({role:'assistant',parts:[{text:response}]}); displayMessage(response||'â€¦','ai'); lockInputs(false); togglePlanCTA() }
      function sendMessage(){ const message=(userInput.value||'').trim(); if(!message) return; displayMessage(message,'user'); chatHistory.push({role:'user',parts:[{text:message}]}); analyzeUserMessage(message); processAIResponse(message); userInput.value='' }
      sendBtn.addEventListener('click',sendMessage); userInput.addEventListener('keypress',e=>{ if(e.key==='Enter') sendMessage() })

      // NEW: CTA opens contact options instead of generating plan
      generatePlanBtn.addEventListener('click',()=>{ openContactModal() })
      closeContactBtn.addEventListener('click',()=>closeContactModal()); contactModal.addEventListener('click',e=>{ if(e.target===contactModal) closeContactModal() })
      continueInChatBtn.addEventListener('click',()=>{ closeContactModal(); displayMessage('ØªÙ…Ø§Ù…. Ù‡Ù†ÙƒÙ…Ù„ Ù‡Ù†Ø§ØŒ ÙˆØ¨Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ø£ÙŠ ÙˆÙ‚Øª ØªØ­Øª Ø£Ù…Ø±Ùƒ Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.', 'ai') })

      // Plan modal controls (still available via function call if needed)
      closePlanBtn.addEventListener('click',()=>closePlanModal()); planModal.addEventListener('click',e=>{ if(e.target===planModal) closePlanModal() })
      printBtn.addEventListener('click',()=>window.print());
      expandAllBtn.addEventListener('click',()=>{ planOutput.querySelectorAll('.section-body').forEach(d=>d.style.display='block'); planOutput.querySelectorAll('.section-head span:last-child').forEach(ic=>ic.textContent='âˆ’') })

      const savedTheme=localStorage.getItem('theme'); if(savedTheme==='dark'){ document.documentElement.classList.add('dark'); btnTheme.textContent='ğŸŒ™' } setLang('ar')
    })
  </script>
</body>
</html>
