<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>مدربك الشخصي الذكي | Smart Personal Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');

    :root{
      --primary:#04364A; --secondary:#176B87; --accent:#64CCC5;
      --chat-bg:#F5F7FA; --bubble-user:#E8F7D4; --bubble-ai:#FFFFFF;
      --backdrop:rgba(2,6,23,.55);
      --text:#0B1220; --muted:#64748B;
      --surface:#FFFFFF; --border:#E5E7EB
    }
    html.dark{
      --primary:#0f172a; --secondary:#334155; --accent:#10B981;
      --chat-bg:#0B1220; --bubble-user:#394150; --bubble-ai:#111827;
      --backdrop:rgba(0,0,0,.7); --text:#E5E7EB; --muted:#94A3B8;
      --surface:#0f172a; --border:#334155
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Tajawal',sans-serif;background:var(--chat-bg);color:var(--text);transition:background-color .3s,color .3s}

    /* Shell / App look */
    .chat-container{max-width:780px;margin:0 auto;height:100vh;display:flex;flex-direction:column;background:var(--chat-bg);box-shadow:0 0 25px rgba(0,0,0,.08);border-radius:1rem;overflow:hidden}
    @supports (height: 100dvh){ .chat-container{height:100dvh} }
    @media (max-width:768px){ .chat-container{border-radius:0;box-shadow:none} }

    .chat-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:.875rem 1rem;position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center}
    .brand{display:flex;align-items:center;gap:.6rem}
    .brand img{width:40px;height:40px;border-radius:999px;object-fit:cover}

    .chat-messages{flex:1;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:6rem}
    .message-bubble{padding:.85rem 1.15rem;border-radius:1.25rem;max-width:85%;margin-bottom:.75rem;animation:fadeIn .25s ease-in-out;position:relative}
    .message-bubble.user{background:var(--bubble-user);margin-left:auto;border-bottom-right-radius:.25rem;color:#0B1220}
    .message-bubble.ai{background:var(--bubble-ai);margin-right:auto;border-bottom-left-radius:.25rem;color:var(--text)}

    .msg-meta{display:flex;gap:.35rem;opacity:0;transition:.2s;position:absolute;bottom:.35rem;inset-inline-end:.6rem}
    .message-bubble:hover .msg-meta{opacity:.95}
    .meta-btn{background:transparent;border:none;font-size:.85rem;cursor:pointer;color:var(--muted);padding:.15rem .35rem;border-radius:.35rem}
    .meta-btn:hover{color:#0ea5e9;background:rgba(0,0,0,.05)}

    /* New Input Area styles */
    .input-area {
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--chat-bg);
        border-top: 1px solid var(--border);
        padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
    }
    html[dir="rtl"] .input-area { flex-direction: row-reverse; }
    
    .input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        border-radius: 22px;
        background: var(--surface);
        border: 1px solid var(--border);
    }
    .input-wrapper:focus-within { border-color: var(--accent); }
    html.dark .input-wrapper { background: #1e293b; }

    .input-area input[type=text] {
        flex: 1;
        border: none;
        background: transparent;
        padding: 0.65rem 1rem;
        min-height: 44px;
        color: var(--text);
        outline: none;
    }
    .input-area input[type=text]::placeholder{color:var(--muted)}
    
    .icon-btn {
        background: transparent;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: grid;
        place-items: center;
        transition: all 0.25s;
        cursor: pointer;
        flex-shrink: 0;
        color: var(--muted);
    }
    .icon-btn:hover { background: rgba(0,0,0,.06); }
    html.dark .icon-btn:hover { background: rgba(255,255,255,.08); }
    html.dark .icon-btn { color: #94a3b8; }
    .icon-btn svg { width: 24px; height: 24px; }

    .send-btn {
        background: var(--accent);
        color: #fff;
    }
    .send-btn:hover { background: color-mix(in srgb, var(--accent) 90%, black); }
    .hidden { display: none !important; }

    .welcome-screen,.user-data-screen{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .cta-btn{background:var(--accent);font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.25);padding:1rem 2rem;border-radius:999px}

    .toast{position:fixed;bottom:1.2rem;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:.7rem 1rem;border-radius:.6rem;z-index:60;opacity:0;transition:.35s}

    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    .typing{display:inline-flex;gap:6px;align-items:center}
    .dot{width:6px;height:6px;border-radius:999px;background:#9CA3AF;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

    .mic-btn{position:relative}
    .mic-live::after{content:'';position:absolute;inset:-2px;border:2px solid #ef4444;border-radius:999px;animation:pulse 1s infinite}
    @keyframes pulse{0%{transform:scale(.95);opacity:.9}70%{transform:scale(1.05);opacity:.2}100%{transform:scale(.95);opacity:.9}}
    .rec-hint{font-size:.8rem;color:#ef4444;margin-inline-end:.35rem}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--backdrop);z-index:50}
    .modal.open{display:flex}
    .modal-content{width:min(560px,96vw);max-height:86vh;overflow:hidden;background:#fff;border-radius:1rem;box-shadow:0 20px 60px rgba(0,0,0,.25);display:flex;flex-direction:column}
    html.dark .modal-content{background:#0f172a;color:#E5E7EB}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:.85rem 1rem;border-bottom:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .modal-body{padding:1rem}
    .close-button{background:transparent;color:#fff;font-size:1.75rem;line-height:1;padding:0 .25rem}
    .contact-actions{display:grid;grid-template-columns:1fr;gap:.8rem}
    @media (min-width:520px){.contact-actions{grid-template-columns:1fr 1fr}}
    .contact-btn{display:flex;align-items:center;gap:.75rem;padding:1rem;border-radius:.9rem;font-weight:800;justify-content:center}
    .contact-btn svg{width:22px;height:22px}
    .contact-whatsapp{background:#25D366;color:#fff}
    .contact-phone{background:#0ea5e9;color:#fff}

    .footer{text-align:center;padding:.75rem;font-size:.9rem;color:var(--muted);padding-bottom:calc(.75rem + env(safe-area-inset-bottom))}

    .reply-bar{display:none;align-items:center;gap:.5rem;padding:.5rem .75rem;border:1px dashed var(--border);border-radius:.6rem;margin:.25rem .75rem 0}
    .reply-bar.show{display:flex}
    .reply-bar .x{margin-inline-start:auto;background:transparent;border:none;font-size:1.1rem}

    /* CTA card */
    .card-cta{display:flex;align-items:center;gap:.75rem}
    .badge{font-size:.75rem;padding:.2rem .5rem;border-radius:.5rem;background:color-mix(in srgb,var(--accent) 18%, white)}
    @media (max-width:420px){.brand span{display:none}}
    
    /* New styles for user data form */
    .form-field { position: relative; }
    .form-field svg { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.5); }
    html[dir="rtl"] .form-field svg { left: auto; right: 0.75rem; }
    .form-field input { padding-left: 2.5rem; }
    html[dir="rtl"] .form-field input { padding-left: 1rem; padding-right: 2.5rem; }
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

  <!-- Welcome -->
  <div class="welcome-screen" id="welcomeScreen">
    <img id="welcomeAvatar" src="https://images.unsplash.com/photo-1605296867304-46d5465a13f1?auto=format&fit=crop&w=200&q=60" alt="Coach Avatar" class="rounded-full mb-6 shadow-xl object-cover"/>
    <h1 class="text-4xl font-bold mb-2" id="welcomeTitle">مدربك الشخصي الذكي</h1>
    <p class="text-xl font-light text-white/90 mb-6" id="welcomeSubtitle">جاهز للتغيير؟ خطتك مصممة خصيصًا لك — تنفيذ محكم، متابعة دقيقة، ونتيجة ملموسة.</p>
    <button id="startBtn" class="cta-btn">ابدأ الآن</button>
  </div>

  <!-- Profile -->
  <div class="user-data-screen hidden" id="userDataScreen">
    <h2 class="text-3xl font-extrabold mb-4" id="userDataTitle">لنبني ملفك السريع</h2>
    <p class="text-white/90 mb-8" id="userDataSubtitle">اسمك وعُمرك ودولتك كبداية</p>
    <div class="w-full max-w-2xl px-4">
      <div class="flex flex-col md:flex-row items-start gap-4 mb-6">
        <!-- Name -->
        <div class="w-full md:flex-1">
          <label for="userName" id="nameLabel" class="block text-sm font-medium text-white/80 mb-1.5 text-right">الاسم</label>
          <div class="form-field">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <input type="text" id="userName" class="block w-full rounded-md px-4 py-3 bg-white/10 border border-white/30 text-white placeholder-white/70 focus:bg-white/20" placeholder="اسمك" dir="auto">
          </div>
        </div>
        <!-- Age -->
        <div class="w-full md:w-32">
          <label for="userAge" id="ageLabel" class="block text-sm font-medium text-white/80 mb-1.5 text-right">العمر</label>
           <div class="form-field">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <input type="text" id="userAge" inputmode="numeric" pattern="\d*" class="block w-full rounded-md px-4 py-3 text-center bg-white/10 border border-white/30 text-white placeholder-white/70 focus:bg-white/20" placeholder="عمرك" dir="ltr">
          </div>
        </div>
        <!-- Country -->
        <div class="w-full md:flex-1">
          <label for="userCountry" id="countryLabel" class="block text-sm font-medium text-white/80 mb-1.5 text-right">الدولة</label>
          <div class="form-field">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <input type="text" id="userCountry" class="block w-full rounded-md px-4 py-3 bg-white/10 border border-white/30 text-white placeholder-white/70 focus:bg-white/20" placeholder="دولتك" dir="auto">
          </div>
        </div>
      </div>
      <button id="nextBtn" class="cta-btn w-full max-w-md mx-auto">ابدأ المحادثة</button>
    </div>
  </div>


  <!-- Chat -->
  <div class="chat-container hidden" id="chatContainer">
    <div class="chat-header">
      <div class="brand">
        <img id="chatAvatar" src="https://images.unsplash.com/photo-1605296867304-46d5465a13f1?auto=format&fit=crop&w=80&q=60" alt="Coach Avatar"/>
        <span class="text-xl font-bold" id="chatTitle">مدربك الشخصي الذكي</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLang" class="icon-btn text-white border border-white/30 px-3 w-auto h-9 !rounded-md">AR</button>
        <button id="btnTheme" class="icon-btn text-white border border-white/30 w-9 h-9 !rounded-md">☀️</button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages" role="region" aria-label="Chat messages" aria-live="polite"></div>

    <!-- CTA: opens contact modal -->
    <div id="planButtonArea" class="px-4 py-3 hidden">
      <div class="rounded-xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-3 card-cta justify-between">
        <div>
          <div id="ctaTitle" class="text-[.98rem] font-bold text-slate-800 dark:text-slate-100">جاهز لنتيجة ملموسة؟</div>
          <div id="ctaSubtitle" class="text-sm text-slate-600 dark:text-slate-300 mt-1">تسليم خطة مُحكمة + متابعة أسبوعية + دعم مباشر.</div>
        </div>
        <span id="ctaBadge" class="badge">خصم اليوم</span>
        <button id="generatePlanBtn" class="btn send-btn font-bold px-4 py-2 rounded-lg" disabled>احصل على خطتك الآن</button>
      </div>
      <p id="planButtonNote" class="text-gray-700 dark:text-gray-300 text-sm mt-2">بالضغط، ستفتح طرق التواصل. باقة البدء تشمل: تقييم دقيق، خطة وجبات وتمرين، متابعة أول أسبوع.</p>
    </div>

    <!-- Reply bar -->
    <div id="replyBar" class="reply-bar" aria-live="polite">
      <strong id="replyingToText">رد على:</strong>
      <span id="replySnippet" class="truncate"></span>
      <button id="replyClear" class="x" title="إلغاء">×</button>
    </div>

    <div class="input-area" id="inputArea">
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="اكتب رسالتك..." dir="auto"
                    autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" />
            <button id="plusBtn" class="icon-btn" aria-label="أرسل صورة/ملف" title="صورة/ملف">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
            </button>
        </div>
        
        <button id="micBtn" class="icon-btn mic-btn" aria-label="تسجيل صوتي" title="اضغط مطولاً للتسجيل">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
        </button>
        <button id="sendBtn" class="icon-btn send-btn hidden" aria-label="أرسل" title="إرسال">
            <svg xmlns="http://www.w3.org/2000/svg" class="transform" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3.4 20.4l17.45-7.48a1 1 0 0 0 0-1.84L3.4 3.6a1 1 0 0 0-1.39 1.39L4.43 12 2 15.41a1 1 0 0 0 1.4 1.4z"/></svg>
        </button>
        
        <input type="file" id="imageInput" accept="image/*" class="hidden" />
        <input type="file" id="fileInput" accept=".txt,.csv,application/pdf" class="hidden" />
    </div>

    <div class="px-4 pb-2 -mt-2 hidden" id="recHintWrap"><span class="rec-hint" id="recHint">● جاري التسجيل…</span></div>
  </div>

  <!-- Contact Modal -->
  <div id="contactModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog" aria-labelledby="contactModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="contactModalTitle" class="text-lg font-extrabold">احصل على خطتك الآن بضغطة زر</h3>
        <button id="closeContactBtn" class="close-button" title="إغلاق" aria-label="إغلاق">×</button>
      </div>
      <div class="modal-body">
        <p id="contactModalSubtitle" class="mb-3 text-sm text-gray-600 dark:text-gray-300">اختر الطريقة المناسبة للتواصل المباشر مع المدرب.
          <span id="contactModalNote" class="block mt-2 text-[12px] text-gray-500">يمكنك الاستمرار في الحديث إذا كانت لديك أسئلة.</span>
        </p>
        <div class="contact-actions">
          <a class="contact-btn contact-whatsapp" href="https://wa.me/971502061209" target="_blank" rel="noopener" title="واتساب مباشر">
            <svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M19.11 17.18c-.28-.14-1.65-.81-1.9-.9-.26-.1-.44-.14-.62.14-.18.27-.71.9-.87 1.09-.16.18-.32.2-.6.07-.28-.14-1.18-.44-2.25-1.4-.83-.74-1.39-1.66-1.55-1.94-.16-.27-.02-.42.12-.56.12-.12.28-.3.42-.46.14-.16.18-.27.28-.46.1-.18.06-.34-.02-.48-.08-.14-.62-1.5-.84-2.06-.22-.52-.44-.45-.62-.46h-.54c-.18 0-.48.07-.74.34-.26.27-1 1-1 2.42s1.03 2.8 1.18 2.99c.14.2 2.03 3.1 4.93 4.33.69.3 1.22.48 1.64.62.69.22 1.32.19 1.82.12.56-.08 1.65-.68 1.88-1.35.24-.67.24-1.24.16-1.35-.06-.1-.24-.16-.52-.3z"/><path d="M26.9 5.1A13.9 13.9 0 0 0 16 .1C7.3.1.2 7.1.2 15.8c0 2.7.7 5.2 2 7.4L.1 31.9l8.9-2.3c2.1 1.1 4.5 1.7 7 1.7h.1c8.7 0 15.8-7 15.8-15.7 0-4.2-1.6-8.1-4.9-10.9z"/></svg>
            <span id="whatsappBtnText">واتساب مباشر</span>
          </a>
          <a class="contact-btn contact-phone" href="tel:+971502061209" title="اتصال هاتفي">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 0 1 1 1V21a1 1 0 0 1-1 1C10.61 22 2 13.39 2 3a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.27.2 2.47.57 3.58a1 1 0 0 1-.24 1.01l-2.21 2.2z"/></svg>
            <span id="callBtnText">اتصال هاتفي</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">© Powered by Mustafa Elsafy | مصطفى الصافي</footer>

  <script type="module">
    /* =========================
       Elements
    ========================= */
    const $ = id => document.getElementById(id);
    const chatMessages = $('chatMessages');
    const userInput = $('userInput');
    const sendBtn = $('sendBtn');
    const startBtn = $('startBtn');
    const nextBtn = $('nextBtn');
    const welcomeScreen = $('welcomeScreen');
    const userDataScreen = $('userDataScreen');
    const chatContainer = $('chatContainer');
    const userNameInput = $('userName');
    const userAgeInput = $('userAge');
    const userCountryInput = $('userCountry');
    const btnTheme = $('btnTheme');
    const btnLang = $('btnLang');
    const plusBtn = $('plusBtn');
    const imageInput = $('imageInput');
    const fileInput = $('fileInput');
    const micBtn = $('micBtn');
    const recHintWrap = $('recHintWrap');
    const planButtonArea = $('planButtonArea');
    const generatePlanBtn = $('generatePlanBtn');
    const contactModal = $('contactModal');
    const closeContactBtn = $('closeContactBtn');
    const replyBar = $('replyBar');
    const replySnippet = $('replySnippet');
    const replyClear = $('replyClear');

    /* =========================
       State
    ========================= */
    let userState = { step: 0, data: {}, persona:'neutral' };
    let LANG = 'ar';
    let chatHistory = [];
    const MAX_TURNS = 12;
    const MAX_PROMPT_CHARS = 14000;

    /* =========================
       i18n (Internationalization)
    ========================= */
    const i18n = {
      ar: {
        appName: 'مدربك الشخصي الذكي',
        welcomeSubtitle: 'جاهز للتغيير؟ خطتك مصممة خصيصًا لك — تنفيذ محكم، متابعة دقيقة، ونتيجة ملموسة.',
        startButtonText: 'ابدأ الآن',
        userDataTitle: 'لنبني ملفك السريع',
        userDataSubtitle: 'اسمك وعُمرك ودولتك كبداية',
        nameLabel: 'الاسم', ageLabel: 'العمر', countryLabel: 'الدولة',
        namePlaceholder:'اسمك', agePlaceholder:'عمرك', countryPlaceholder:'دولتك',
        nextButtonText:'ابدأ المحادثة',
        inputPlaceholder:'اكتب رسالتك...',
        emptyFields:'أدخل الاسم والعمر والدولة للمتابعة.',
        invalidAge: 'الرجاء إدخال عمر صحيح.',
        imageUpload:'تم استلام الصورة — يتم التحليل الآن.',
        typing:'… يتم الرد الآن',
        langTitle: 'تبديل اللغة', themeTitle: 'تبديل المظهر',
        attachTitle: 'صورة/ملف', micTitle: 'اضغط مطولاً للتسجيل', sendTitle: 'إرسال',
        recStart:'● جاري التسجيل… ارفع إصبعك للنسخ',
        recDenied:'تعذّر الوصول للميكروفون.', recTooShort:'التسجيل قصير جدًا.', recSaved:'تم نسخ الكلام إلى خانة الكتابة — أرسله يدويًا.',
        copied:'تم النسخ',
        ctaTitle: 'جاهز لنتيجة ملموسة؟',
        ctaSubtitle: 'تسليم خطة مُحكمة + متابعة أسبوعية + دعم مباشر.',
        ctaBadge: 'خصم اليوم', ctaButton: 'احصل على خطتك الآن',
        ctaNote: 'بالضغط، ستفتح طرق التواصل. باقة البدء تشمل: تقييم دقيق، خطة وجبات وتمرين، متابعة أول أسبوع.',
        replyingTo: 'رد على:', cancelReply: 'إلغاء',
        copyMsg: 'نسخ الرسالة', replyMsg: 'رد', copyBtn: 'نسخ', replyBtn: 'رد',
        contactModalTitle: 'احصل على خطتك الآن بضغطة زر',
        contactModalSubtitle: 'اختر الطريقة المناسبة للتواصل المباشر مع المدرب.',
        contactModalNote: 'يمكنك الاستمرار في الحديث إذا كانت لديك أسئلة.',
        contactModalClose: 'إغلاق',
        whatsappBtn: 'واتساب مباشر', callBtn: 'اتصال هاتفي',
      },
      en: {
        appName:'Smart Personal Coach',
        welcomeSubtitle:'Ready for a change? Your plan is tailored for you—precise execution, close follow-up, and tangible results.',
        startButtonText:'Start Now',
        userDataTitle:"Let's build your quick profile",
        userDataSubtitle:'Your name, age, and country to begin',
        nameLabel: 'Name', ageLabel: 'Age', countryLabel: 'Country',
        namePlaceholder:'Your name', agePlaceholder:'Your age', countryPlaceholder:'Your country',
        nextButtonText:'Start Conversation',
        inputPlaceholder:'Type your message...',
        emptyFields:'Please fill name, age and country to continue.',
        invalidAge: 'Please enter a valid age.',
        imageUpload:'Image received—analyzing now.',
        typing:'typing…',
        langTitle: 'Switch Language', themeTitle: 'Switch Theme',
        attachTitle: 'Image/File', micTitle: 'Press and hold to record', sendTitle: 'Send',
        recStart:'● Recording… release to copy',
        recDenied:'Microphone permission denied.', recTooShort:'Recording too short.', recSaved:'Transcript copied to the input—send manually.',
        copied:'Copied',
        ctaTitle: 'Ready for tangible results?',
        ctaSubtitle: 'Precise plan delivery + weekly follow-up + direct support.',
        ctaBadge: "Today's Offer", ctaButton: 'Get Your Plan Now',
        ctaNote: 'By clicking, you will open contact options. The starter package includes: detailed assessment, meal & workout plan, and first week follow-up.',
        replyingTo: 'Replying to:', cancelReply: 'Cancel',
        copyMsg: 'Copy message', replyMsg: 'Reply', copyBtn: 'Copy', replyBtn: 'Reply',
        contactModalTitle: 'Get your plan now with one click',
        contactModalSubtitle: 'Choose the best way to contact the coach directly.',
        contactModalNote: 'You can continue chatting if you have questions.',
        contactModalClose: 'Close',
        whatsappBtn: 'Direct WhatsApp', callBtn: 'Phone Call',
      }
    };

    function setLang(lang){
      LANG = lang;
      localStorage.setItem('lang', lang);
      const L = i18n[LANG];
      const isRTL = lang === 'ar';
      
      document.documentElement.lang = lang;
      document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
      
      const sendIcon = sendBtn.querySelector('svg');
      if (sendIcon) sendIcon.style.transform = isRTL ? 'rotate(180deg)' : 'rotate(0deg)';
      
      $('welcomeTitle').textContent = L.appName;
      $('welcomeSubtitle').textContent = L.welcomeSubtitle;
      $('startBtn').textContent = L.startButtonText;
      
      $('userDataTitle').textContent = L.userDataTitle;
      $('userDataSubtitle').textContent = L.userDataSubtitle;
      $('nameLabel').textContent = L.nameLabel;
      $('ageLabel').textContent = L.ageLabel;
      $('countryLabel').textContent = L.countryLabel;
      $('userName').placeholder = L.namePlaceholder;
      $('userAge').placeholder = L.agePlaceholder;
      $('userCountry').placeholder = L.countryPlaceholder;
      $('nextBtn').textContent = L.nextButtonText;
      
      $('chatTitle').textContent = L.appName;
      $('userInput').placeholder = L.inputPlaceholder;
      btnLang.textContent = isRTL ? 'EN' : 'AR';
      btnLang.title = L.langTitle;
      btnTheme.title = L.themeTitle;
      plusBtn.title = L.attachTitle;
      micBtn.title = L.micTitle;
      sendBtn.title = L.sendTitle;

      $('ctaTitle').textContent = L.ctaTitle;
      $('ctaSubtitle').textContent = L.ctaSubtitle;
      $('ctaBadge').textContent = L.ctaBadge;
      $('generatePlanBtn').textContent = L.ctaButton;
      $('planButtonNote').textContent = L.ctaNote;

      $('replyingToText').textContent = L.replyingTo;
      $('replyClear').title = L.cancelReply;

      $('contactModalTitle').textContent = L.contactModalTitle;
      $('contactModalSubtitle').textContent = L.contactModalSubtitle;
      $('contactModalNote').textContent = L.contactModalNote;
      $('closeContactBtn').title = L.contactModalClose;
      $('closeContactBtn').setAttribute('aria-label', L.contactModalClose);
      $('whatsappBtnText').textContent = L.whatsappBtn;
      $('callBtnText').textContent = L.callBtn;
      
      document.title = `${L.appName} | Smart Personal Coach`;
    }

    /* =========================
       Utilities
    ========================= */
    function normalizeNumerals(str) {
      if (!str || typeof str !== 'string') return '';
      const numeralMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
      return str.replace(/[\u0660-\u0669\u06F0-\u06F9]/g, m => numeralMap[m]);
    }

    function setTheme(){
      document.documentElement.classList.toggle('dark');
      btnTheme.textContent = document.documentElement.classList.contains('dark') ? '🌙' : '☀️';
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light')
    }
    function toast(msg){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.style.opacity=1,10);
      setTimeout(()=>{t.style.opacity=0; setTimeout(()=>t.remove(),400)},2400)
    }

    /* =========================
       Storage & History
    ========================= */
    const Storage = {
      KEY: 'smart-coach-history-v1',
      save(){
        const payload = { chatHistory, userState, lang: LANG, theme: document.documentElement.classList.contains('dark')?'dark':'light' };
        localStorage.setItem(this.KEY, JSON.stringify(payload));
      },
      load(){
        try{
          const raw = localStorage.getItem(this.KEY);
          if(!raw) return false;
          const { chatHistory: h=[], userState: s={}, lang, theme } = JSON.parse(raw);
          chatHistory = Array.isArray(h) ? h : [];
          userState = s || userState;
          if(lang) setLang(lang);
          if(theme==='dark'){ document.documentElement.classList.add('dark'); btnTheme.textContent='🌙' }
          return true;
        }catch{ return false }
      },
    };

    function compactHistory(){ if (chatHistory.length > MAX_TURNS) chatHistory = chatHistory.slice(-MAX_TURNS) }

    /* =========================
       Messages UI
    ========================= */
    function displayMessage(message, sender){
      const b=document.createElement('div'); b.classList.add('message-bubble', sender);
      const safe = (message && typeof message === 'string') ? message : '…';
      const html = marked.parse(safe);
      const L = i18n[LANG];

      b.innerHTML = `
        <div class="msg-content">${html}</div>
        <div class="msg-meta" role="group" aria-label="Message actions">
          <button class="meta-btn copy" title="${L.copyMsg}">${L.copyBtn}</button>
          <button class="meta-btn reply" title="${L.replyMsg}">${L.replyBtn}</button>
        </div>`;
      chatMessages.appendChild(b); chatMessages.scrollTop = chatMessages.scrollHeight;

      b.querySelector('.copy').onclick = async ()=>{ await navigator.clipboard.writeText(b.querySelector('.msg-content').innerText); toast(L.copied); };
      b.querySelector('.reply').onclick = ()=>{ UI.setReply(b.querySelector('.msg-content').innerText.slice(0,160)); };
      return b;
    }
    function showTyping(sender='ai'){
      const b=document.createElement('div'); b.classList.add('message-bubble', sender);
      b.innerHTML = `<span class="typing"><span>${i18n[LANG].typing}</span><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      chatMessages.appendChild(b); chatMessages.scrollTop=chatMessages.scrollHeight; return b
    }
    function removeNode(n){ if(n && n.parentNode) n.parentNode.removeChild(n) }

    const UI = {
      setReply(snippet){ replySnippet.textContent = snippet; replyBar.classList.add('show'); userInput.focus(); },
      clearReply(){ replySnippet.textContent = ''; replyBar.classList.remove('show'); }
    };
    replyClear.addEventListener('click', UI.clearReply);

    function togglePlanCTA(){ const ready = isDataComplete(); planButtonArea.classList.toggle('hidden', !ready); generatePlanBtn.disabled = !ready }
    function isDataComplete(){ return ['name','age','country'].every(k => !!userState.data[k]) }

    /* =========================
       Prompts & AI
    ========================= */
    function buildCoachSystemPrompt(){ return `You are a virtual assistant for an international coach. Your role is a professional personal trainer and nutritionist. You speak the user's language and dialect fluently. You must never mention the user's name. Your responses should be natural, professional, and ask only one question at a time if gathering data. For a complete plan, you need: Goal, Gender, Age, Height, Weight, Activity level, Workout location (gym/home), available days, food preferences/restrictions, number of meals, and any medical conditions/injuries.` }
    function buildImagePrompt(){ return `Analyze the image with concise points (3-5) without intros: 1. What you see. 2. Any visible text/values. 3. Practical health/fitness interpretation. 4. One suggested next step. Be direct.` }

    async function callAI(prompt, {images, audio} = {}){
      try{
        const payload = { prompt };
        if (images && images.length){
          payload.images = images.map(x => {
            if(typeof x === 'string' && x.startsWith('data:')){
              const [meta, b64] = x.split(',');
              const mime = meta.substring(5, meta.indexOf(';'));
              return { mime, data: b64, dataUrl: x };
            }
            return x;
          });
        }
        if (audio) payload.audio = audio;
        const res = await fetch('/.netlify/functions/gemini-proxy',{
          method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(!res.ok) throw new Error((data && (data.details || data.error)) || 'AI error');
        return data.text || '';
      }catch(e){ console.error(e); return '' }
    }


    /* =========================
       Voice to text
    ========================= */
    let recording=false, sttSession=0, recognition=null;
    const supportSpeechRecognition = ()=> ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window);
    function startRecording(){
      if(recording) return; recording=true;
      if(!supportSpeechRecognition()){
          toast('Speech recognition not supported in this browser.');
          recording = false;
          return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const sessionId = ++sttSession;
      recognition = new SR();
      recognition.lang = (LANG==='ar' ? 'ar-EG' : 'en-US');
      recognition.interimResults = true;
      recognition.onresult = (e)=>{
        if(sessionId !== sttSession) return;
        let final='';
        for(let i=e.resultIndex; i<e.results.length; i++){
          if(e.results[i].isFinal) final += e.results[i][0].transcript;
        }
        if(final){
            userInput.value = final;
            userInput.dispatchEvent(new Event('input'));
        }
      };
      recognition.start();
      micBtn.classList.add('mic-live');
      recHintWrap.classList.remove('hidden');
      $('recHint').textContent = i18n[LANG].recStart;
    }
    function stopRecording(){
      if(!recording) return; recording=false;
      if(recognition) recognition.stop();
      micBtn.classList.remove('mic-live');
      recHintWrap.classList.add('hidden');
    }

    /* =========================
       Conversation Engine
    ========================= */
    async function processAIResponse(message){
      const typingEl = showTyping('ai');
      compactHistory();

      let response = '';
      try{ response = await callAI(message); }catch(e){ console.error(e); }
      removeNode(typingEl);

      if(!response || !response.trim()){
        response = (LANG==='ar')
          ? 'عذراً، حدث خطأ ما. حاول مرة أخرى.'
          : 'Sorry, something went wrong. Please try again.';
      }
      chatHistory.push({role:'assistant', parts:[{text:response}]});
      displayMessage(response, 'ai');
      togglePlanCTA();
      Storage.save();
    }

    function sendMessage(){
      const raw=(userInput.value||'').trim(); if(!raw) return;
      
      let finalMsg = raw;
      if(replyBar.classList.contains('show')){
        finalMsg = `${i18n[LANG].replyingTo} "${replySnippet.textContent}"\n\n${raw}`;
        UI.clearReply();
      }

      displayMessage(finalMsg, 'user');
      chatHistory.push({role:'user', parts:[{text:finalMsg}]});
      processAIResponse(finalMsg);
      userInput.value='';
      userInput.dispatchEvent(new Event('input')); // This will trigger the listener to hide send and show mic
      Storage.save();
    }

    /* =========================
       Events
    ========================= */
    document.addEventListener('DOMContentLoaded',()=>{
      startBtn.addEventListener('click',()=>{ welcomeScreen.classList.add('hidden'); userDataScreen.classList.remove('hidden'); });

      nextBtn.addEventListener('click',()=>{
        const name = (userNameInput.value||'').trim();
        const age = normalizeNumerals((userAgeInput.value||'').trim());
        const country = (userCountryInput.value||'').trim();
        const L = i18n[LANG];
        
        if(!name || !age || !country){ toast(L.emptyFields); return; }
        if(isNaN(parseInt(age, 10))) { toast(L.invalidAge); return; }

        userState.data={...userState.data, name, age, country};
        userDataScreen.classList.add('hidden'); chatContainer.classList.remove('hidden');
        const welcomeMsg = (LANG==='ar' ? `مرحبًا ${name}.` : `Welcome ${name}.`);
        chatHistory.push({role:'assistant',parts:[{text:welcomeMsg}]});
        displayMessage(welcomeMsg,'ai');
        togglePlanCTA();
        Storage.save();
      });

      btnTheme.addEventListener('click', setTheme);
      btnLang.addEventListener('click',()=> setLang(LANG==='ar' ? 'en' : 'ar'));
      const savedTheme=localStorage.getItem('theme'); if(savedTheme==='dark'){ document.documentElement.classList.add('dark'); btnTheme.textContent='🌙' }
      setLang(localStorage.getItem('lang') || 'ar'); 

      function keyHandler(e){ if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
      sendBtn.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', keyHandler);
      
      // --- منطق زر الإرسال/الميكروفون المشابه لواتساب ---
      // هذه الدالة تتحقق من وجود نص في حقل الإدخال وتعرض الزر المناسب (إرسال أو ميكروفون)
      function updateActionButtons() {
        const hasText = userInput.value.trim().length > 0;

        // إذا كان هناك نص، أظهر زر الإرسال وأخفِ زر الميكروفون.
        if (hasText) {
          micBtn.classList.add('hidden');
          sendBtn.classList.remove('hidden');
        } 
        // غير ذلك، أظهر زر الميكروفون وأخفِ زر الإرسال.
        else {
          micBtn.classList.remove('hidden');
          sendBtn.classList.add('hidden');
        }
      }

      // إضافة مستمع حدث لحقل الإدخال
      // سيؤدي هذا إلى استدعاء الدالة في كل مرة يكتب فيها المستخدم
      userInput.addEventListener('input', updateActionButtons);

      // استدعاء الدالة مرة واحدة عند التحميل الأولي لضبط الحالة الصحيحة
      updateActionButtons();


      let pressTimer;
      plusBtn.addEventListener('mousedown', ()=>{ pressTimer = setTimeout(()=> fileInput.click(), 400) });
      plusBtn.addEventListener('mouseup', ()=>{ clearTimeout(pressTimer); imageInput.click(); });

      imageInput.addEventListener('change', async (e)=>{
        const file=e.target.files[0]; if(!file) return;
        const reader=new FileReader(); reader.onload= async (ev)=>{
          const dataUrl = ev.target.result;
          const imgHTML=`<img src="${dataUrl}" class="max-w-[220px] rounded-lg my-2" alt="uploaded image"/>`;
          displayMessage(imgHTML,'user'); toast(i18n[LANG].imageUpload);
          const typingEl = showTyping('ai');
          let aiResp = await callAI(buildImagePrompt(), { images: [dataUrl] });
          removeNode(typingEl);
          const reply = aiResp || (LANG==='ar'? 'لم أتمكن من تحليل الصورة.' : 'Could not analyze the image.');
          displayMessage(reply, 'ai');
          chatHistory.push({role:'user',parts:[{text:'[صورة مرفوعة]'}]});
          chatHistory.push({role:'assistant',parts:[{text:reply}]});
          togglePlanCTA(); Storage.save();
        };
        reader.readAsDataURL(file)
      });
      
      const startEvents = ['pointerdown','touchstart','mousedown'];
      const endEvents = ['pointerup','touchend','mouseup','mouseleave','pointercancel'];
      startEvents.forEach(ev => micBtn.addEventListener(ev, (e)=>{ e.preventDefault(); startRecording() }, {passive:false}));
      endEvents.forEach(ev => micBtn.addEventListener(ev, (e)=>{ e.preventDefault(); stopRecording() }, {passive:false}));

      generatePlanBtn.addEventListener('click', ()=>{ contactModal.classList.add('open'); contactModal.setAttribute('aria-hidden','false'); });
      closeContactBtn.addEventListener('click',()=>{ contactModal.classList.remove('open'); contactModal.setAttribute('aria-hidden','true') });
      contactModal.addEventListener('click', e=>{ if(e.target===contactModal){ contactModal.classList.remove('open'); } });

    });
  </script>
</body>
</html>


