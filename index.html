  <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø°ÙƒÙŠ | Smart Personal Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* =================================================================
       -- 1. FONT & THEME VARIABLES (HEALTH & FITNESS THEME) --
    ================================================================= */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap');

    :root {
      --font-family-base: 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      
      /* Light Theme: Clean, Fresh, Energetic */
      --color-accent: #22C55E; --color-accent-hover: #16A34A;
      --color-bg-main: #F4F5F7; --color-bg-surface: #FFFFFF;
      --color-bubble-ai: #FFFFFF; --color-bubble-user: #DCFCE7;
      --color-text-primary: #1F2937; --color-text-secondary: #6B7280;
      --color-text-accent: #FFFFFF; --color-text-user-bubble: #14532D;
      --color-border: #E5E7EB;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    html.dark {
      /* Dark Theme: Focused, Modern, Techy */
      --color-accent: #4ADE80; --color-accent-hover: #22C55E;
      --color-bg-main: #111827; --color-bg-surface: #1F2937;
      --color-bubble-ai: #374151; --color-bubble-user: #166534;
      --color-text-primary: #F3F4F6; --color-text-secondary: #9CA3AF;
      --color-text-accent: #1F2937; --color-text-user-bubble: #D1FAE5;
      --color-border: #4B5563;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.25), 0 2px 4px -2px rgb(0 0 0 / 0.25);
    }

    /* =================================================================
       -- 2. BASE & TYPOGRAPHY --
    ================================================================= */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0; font-family: var(--font-family-base);
      background-color: var(--color-bg-main); color: var(--color-text-primary);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.3s, color 0.3s; line-height: 1.6;
    }

    /* =================================================================
       -- 3. APP SHELL & RESPONSIVE LAYOUT --
    ================================================================= */
    .app-shell {
      display: flex; flex-direction: column; height: 100vh; height: 100dvh;
      background-color: var(--color-bg-surface); overflow: hidden;
    }
    @media (min-width: 768px) {
      body { padding: 1rem; }
      .app-shell {
        max-width: 820px; margin: 0 auto; border-radius: 1.5rem; box-shadow: var(--shadow-md);
        height: calc(100dvh - 2rem); border: 1px solid var(--color-border);
      }
    }
    @media (min-width: 1024px) { body { padding: 2rem; } .app-shell { height: calc(100dvh - 4rem); } }

    /* =================================================================
       -- 4. WELCOME & PROFILE SCREENS --
    ================================================================= */
    .welcome-screen, .user-data-screen {
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; text-align: center;
      padding: 1.5rem; height: 100%; background-color: #000; color: #fff;
    }
    .welcome-screen::before, .user-data-screen::before {
      content: ''; position: absolute; inset: 0;
      background-image: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.6) 100%), url('https://images.unsplash.com/photo-1571902943202-507ec2618e8f?auto=format&fit=crop&w=1200&q=75');
      background-size: cover; background-position: center; opacity: 0.6; z-index: 1;
    }
    .welcome-screen > *, .user-data-screen > * { position: relative; z-index: 2; }
    .cta-btn {
      background-color: var(--color-accent); color: var(--color-text-accent);
      font-weight: 700; font-size: 1.1rem; padding: 0.9rem 3rem;
      border-radius: 50px; transition: all 0.25s ease; border: none; cursor: pointer;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
    }
    .cta-btn:hover {
      transform: translateY(-3px) scale(1.03); background-color: var(--color-accent-hover);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }
    #userDataScreen .w-full.max-w-sm {
      background: rgba(31, 41, 55, 0.5); backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    @keyframes pulse-animation { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
    .cta-btn-animated { animation: pulse-animation 2.5s infinite cubic-bezier(0.66, 0, 0, 1); }

    /* =================================================================
       -- 5. CHAT UI COMPONENTS (UPGRADED) --
    ================================================================= */
    .chat-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.75rem 1rem; background-color: var(--color-bg-surface);
      border-bottom: 1px solid var(--color-border); flex-shrink: 0; z-index: 20;
    }
    .brand img {
      width: 42px; height: 42px;
      border: 2px solid var(--color-accent); cursor: pointer;
    }
    .chat-messages {
      flex: 1; padding: 1rem; overflow-y: auto; background-color: var(--color-bg-main);
      -webkit-overflow-scrolling: touch;
    }
    .message-bubble {
      max-width: 80%; padding: 0.5rem 1rem; border-radius: 12px; margin-bottom: 0.25rem;
      line-height: 1.6; word-wrap: break-word; box-shadow: var(--shadow-sm);
      animation: fadeIn 0.4s ease-out; display: flex; flex-direction: column;
      position: relative; -webkit-user-select: none; user-select: none;
    }
    .message-bubble.user {
      background-color: var(--color-bubble-user); color: var(--color-text-user-bubble);
      margin-left: auto; border-bottom-right-radius: 5px;
    }
    .message-bubble.ai {
      background-color: var(--color-bubble-ai); color: var(--color-text-primary);
      margin-right: auto; border: 1px solid var(--color-border); border-bottom-left-radius: 5px;
    }
    html[dir="rtl"] .message-bubble.user { margin-right: auto; margin-left: initial; border-bottom-right-radius: 5px; border-bottom-left-radius: 12px;}
    html[dir="rtl"] .message-bubble.ai { margin-left: auto; margin-right: initial; border-bottom-left-radius: 5px; border-bottom-right-radius: 12px;}

    .message-meta { display: flex; justify-content: flex-end; align-items: center; margin-top: 4px; }
    .message-time { font-size: 0.7rem; color: var(--color-text-secondary); opacity: 0.8; }
    html[dir="rtl"] .message-bubble.user .message-time { margin-right: 8px; }
    html[dir="ltr"] .message-bubble.user .message-time { margin-left: 8px; }
    
    .typing { display: flex; gap: 5px; align-items: center; padding: 0.5rem 0; }
    .typing .dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--color-text-secondary); animation: typing-blink 1.4s infinite both; }
    .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing-blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

    /* =================================================================
       -- 6. DYNAMIC CARDS (CTA & iHerb) --
    ================================================================= */
    .dynamic-card { border-radius: 1rem; border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); margin: 1rem 0; animation: fadeIn 0.5s ease-out; }
    #iherb-card { background: linear-gradient(100deg, var(--color-bubble-user), #fff); border-color: var(--color-accent); }
    html.dark #iherb-card { background: linear-gradient(100deg, #14532D, #1F2937); border-color: var(--color-accent); }
    
    /* =================================================================
       -- 7. INPUT AREA (WhatsApp Style) --
    ================================================================= */
    .input-area-wrapper { background-color: var(--color-bg-surface); padding: 0.5rem; padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); border-top: 1px solid var(--color-border); flex-shrink: 0; }
    .input-area { display: flex; align-items: flex-end; gap: 0.5rem; }
    .input-field-container { flex: 1; display: flex; align-items: center; background-color: var(--color-bg-main); border-radius: 22px; padding: 0.25rem 0.5rem; border: 1px solid var(--color-border); }
    .input-field-container:focus-within { border-color: var(--color-accent); }
    textarea#userInput { flex: 1; border: none; outline: none; background: transparent; padding: 0.6rem; font-family: var(--font-family-base); font-size: 1rem; color: var(--color-text-primary); resize: none; line-height: 1.5; max-height: 125px; }
    .icon-btn { display: inline-flex; justify-content: center; align-items: center; width: 44px; height: 44px; border-radius: 50%; border: none; background-color: transparent; color: var(--color-text-secondary); cursor: pointer; transition: background-color 0.2s, color 0.2s; flex-shrink: 0; }
    .icon-btn:hover { color: var(--color-accent); }
    .send-btn { background-color: var(--color-accent); color: var(--color-text-accent); }
    .send-btn:hover { background-color: var(--color-accent-hover); }
    .mic-btn.mic-live { color: #ef4444; background-color: rgba(239, 68, 68, 0.1); }
    
    /* =================================================================
       -- 8. MODALS & UTILITIES (UPGRADED) --
    ================================================================= */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(8px); z-index: 100; }
    .modal.open { display: flex; animation: fadeIn 0.3s; }
    .modal-content { width: min(520px, 92vw); background: var(--color-bg-surface); border-radius: 1.25rem; box-shadow: var(--shadow-md); display: flex; flex-direction: column; animation: modal-scale-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .modal-header { background-color: var(--color-bg-main); border-bottom: 1px solid var(--color-border); }
    .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background-color: var(--color-text-primary); color: var(--color-bg-surface); padding: 0.8rem 1.2rem; border-radius: 8px; z-index: 110; opacity: 0; font-weight: 500; box-shadow: var(--shadow-md); transition: opacity 0.3s, transform 0.3s; }
    .toast.show { opacity: 1; transform: translate(-50%, -10px); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes modal-scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    /* =================================================================
       -- 9. NEW: CHAT ACTION MENU & PINNED MESSAGE --
    ================================================================= */
    #messageContextMenu {
        position: absolute; display: none; background: var(--color-bg-surface);
        border-radius: 8px; box-shadow: var(--shadow-md); z-index: 50;
        padding: 0.25rem; border: 1px solid var(--color-border);
        transform-origin: top center; animation: modal-scale-in 0.15s ease-out;
    }
    #messageContextMenu.show { display: flex; }
    .context-menu-btn {
        display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem;
        font-size: 0.9rem; border-radius: 6px; cursor: pointer;
        transition: background-color 0.2s; white-space: nowrap;
    }
    .context-menu-btn:hover { background-color: var(--color-bg-main); }
    
    #pinnedMessageArea {
        padding: 0.5rem 1rem; background-color: var(--color-bg-main); border-bottom: 1px solid var(--color-border);
        flex-shrink: 0; cursor: pointer; transition: all 0.3s; display: none;
    }
    #pinnedMessageArea.show { display: block; }
    .pinned-content { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
    .pinned-text {
        font-size: 0.85rem; color: var(--color-text-secondary);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    
    /* =================================================================
       -- 10. NEW: MULTI-IMAGE PREVIEW STYLES --
    ================================================================= */
    #imagePreviewsContainer {
        display: flex;
        gap: 0.75rem; /* 12px */
        padding: 0.5rem;
        overflow-x: auto;
        /* Custom scrollbar for better aesthetics */
        scrollbar-width: thin;
        scrollbar-color: var(--color-border) transparent;
    }
    .preview-thumbnail {
        position: relative;
        flex-shrink: 0;
    }
    .preview-thumbnail img {
        width: 5rem; /* 80px */
        height: 5rem; /* 80px */
        object-fit: cover;
        border-radius: 0.75rem; /* 12px */
        border: 2px solid var(--color-border);
        cursor: pointer;
        transition: transform 0.2s;
    }
    .preview-thumbnail img:hover {
        transform: scale(1.05);
    }
    .preview-thumbnail .remove-btn {
        position: absolute;
        top: -0.375rem; /* -6px */
        right: -0.375rem;
        html[dir="rtl"] & { right: -0.375rem; left: auto; }
        html[dir="ltr"] & { left: -0.375rem; right: auto; }
        display: flex;
        width: 1.5rem; /* 24px */
        height: 1.5rem; /* 24px */
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        background-color: var(--color-text-primary);
        color: var(--color-bg-surface);
        font-size: 1rem;
        font-weight: bold;
        line-height: 1;
        cursor: pointer;
        border: 2px solid var(--color-bg-surface);
        transition: background-color 0.2s;
    }
    .preview-thumbnail .remove-btn:hover {
        background-color: #ef4444; /* red-500 */
    }
    #imageViewerModal img {
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        border-radius: 0.75rem;
    }
  </style>
</head>
<body class="app-shell">

  <!-- ======================= Welcome Screen ======================== -->
  <div class="welcome-screen" id="welcomeScreen">
    <div class="absolute top-4 right-4 z-10" style="inset-inline-end: 1rem; inset-inline-start: auto;"><button class="lang-toggle-btn icon-btn text-sm font-bold border !w-auto px-4 !h-10 !rounded-full !border-white/20 hover:!border-accent !text-white bg-white/10 backdrop-blur-sm">AR</button></div>
    <img id="welcomeAvatar" src="https://images.unsplash.com/photo-1581009137042-c552e485697a?auto=format&fit=crop&w=200&q=80" alt="Coach Avatar" class="w-32 h-32 rounded-full mb-6 shadow-xl object-cover border-4 border-[var(--color-accent)]"/>
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black mb-2" id="welcomeTitle">Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
    <p class="text-base sm:text-lg lg:text-xl font-light text-white/90 mb-8 max-w-xl" id="welcomeSubtitle">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØºÙŠÙŠØ±ØŸ Ø®Ø·ØªÙƒ Ù…ØµÙ…Ù…Ø© Ø®ØµØµÙ‹Ø§ Ù„Ùƒ â€” ØªÙ†ÙÙŠØ° Ù…Ø­ÙƒÙ…ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ù‚ÙŠÙ‚Ø©ØŒ ÙˆÙ†ØªÙŠØ¬Ø© Ù…Ù„Ù…ÙˆØ³Ø©.</p>
    <button id="startBtn" class="cta-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
  </div>

  <!-- ======================= User Profile Screen ======================== -->
  <div class="user-data-screen hidden" id="userDataScreen">
    <div class="absolute top-4 right-4 z-10" style="inset-inline-end: 1rem; inset-inline-start: auto;"><button class="lang-toggle-btn icon-btn text-sm font-bold border !w-auto px-4 !h-10 !rounded-full !border-white/20 hover:!border-accent !text-white bg-white/10 backdrop-blur-sm">AR</button></div>
    <div class="w-full max-w-sm p-6 sm:p-8 space-y-6 rounded-2xl shadow-xl border border-white/20"><div class="text-center"><h2 class="text-2xl sm:text-3xl font-extrabold" id="userDataTitle">Ù„Ù†Ø¨Ù†ÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ø³Ø±ÙŠØ¹</h2><p class="text-white/80 mt-2" id="userDataSubtitle">Ù†Ø­ØªØ§Ø¬ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¨Ø¯Ø¡</p></div>
        <!-- ### START: MODIFIED USER DATA INPUTS ### -->
        <div class="space-y-4">
            <div class="relative">
                <span class="absolute inset-y-0 end-0 flex items-center pe-5 pointer-events-none">
                    <svg class="w-5 h-5 text-white/70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </span>
                <input type="text" id="userName" class="block w-full rounded-full py-3.5 ps-4 pe-12 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
            </div>
            <div class="relative">
                <span class="absolute inset-y-0 end-0 flex items-center pe-5 pointer-events-none">
                    <svg class="w-5 h-5 text-white/70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                </span>
                <input type="text" inputmode="numeric" id="userAge" class="block w-full rounded-full py-3.5 ps-4 pe-12 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="Ø¹Ù…Ø±Ùƒ">
            </div>
            <div class="relative">
                <span class="absolute inset-y-0 end-0 flex items-center pe-5 pointer-events-none">
                     <svg class="w-5 h-5 text-white/70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                </span>
                <input type="text" id="userCountry" class="block w-full rounded-full py-3.5 ps-4 pe-12 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="Ø¨Ù„Ø¯Ùƒ">
            </div>
        </div>
        <!-- ### END: MODIFIED USER DATA INPUTS ### -->
    <button id="nextBtn" class="cta-btn w-full mt-4 !py-3 !text-lg !font-bold">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button></div>
  </div>

  <!-- ======================= Chat UI ======================== -->
  <div class="flex flex-col h-full hidden" id="chatContainer">
    <div class="chat-header">
      <div class="brand flex items-center gap-3"><img id="chatAvatar" src="https://images.unsplash.com/photo-1581009137042-c552e485697a?auto=format&fit=crop&w=80&q=80" alt="Coach Avatar" class="rounded-full object-cover"/><span class="text-lg font-bold" id="chatTitle">Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø°ÙƒÙŠ</span></div>
      <div class="flex items-center gap-1">
        <button id="resetBtn" class="icon-btn text-xl !w-9 !h-9" title="Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        </button>
        <button id="btnLang" class="lang-toggle-btn icon-btn text-sm font-bold !w-auto px-4 !h-9">AR</button>
        <button id="btnTheme" class="icon-btn text-xl !w-9 !h-9">â˜€ï¸</button>
      </div>
    </div>
    
    <div id="pinnedMessageArea">
      <div class="pinned-content">
        <div class="flex items-center gap-2 min-w-0">
          <svg class="w-4 h-4 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 3a1 1 0 0 1 1 1v5.268l2.999 2.999a1 1 0 0 1 .326 1.638l-.11.094L18 16.223V18a1 1 0 0 1-.993.994L17 19h-4.172l-3.535 3.536a1 1 0 0 1-1.497-1.32l.083-.094L11.414 18H8a1 1 0 0 1-1-1v-1.777l-2.173-2.173a1 1 0 0 1-.094-1.548l.094-.11L7.828 9.268V4a1 1 0 0 1 .993-.994L9 3h7z"/></svg>
          <p id="pinnedText" class="pinned-text"></p>
        </div>
        <button id="unpinBtn" class="icon-btn !w-6 !h-6" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages" role="log" aria-live="polite"></div>
    
    <div class="input-area-wrapper">
        <div id="planButtonArea" class="px-2 pb-2"><div class="dynamic-card !m-0 rounded-xl p-3 flex justify-between items-center flex-wrap sm:flex-nowrap gap-3 bg-white dark:bg-slate-800"><div class="min-w-0"><div id="ctaTitle" class="font-bold text-gray-800 dark:text-gray-100">Ø¬Ø§Ù‡Ø² Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù„Ù…ÙˆØ³Ø©ØŸ</div><div id="ctaSubtitle" class="text-sm text-gray-600 dark:text-gray-300 mt-1">Ø®Ø·Ø© Ù…ÙØ­ÙƒÙ…Ø© + Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©.</div></div><button id="generatePlanBtn" class="cta-btn cta-btn-animated !text-sm !px-5 !py-2.5 w-full sm:w-auto" disabled>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</button></div></div>
        <div id="imagePreviewsWrapper" class="hidden">
            <div id="imagePreviewsContainer"></div>
        </div>
        <div class="input-area" id="inputArea"><div class="input-field-container"><button id="plusBtn" class="icon-btn" aria-label="Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø©/Ù…Ù„Ù" title="ØµÙˆØ±Ø©/Ù…Ù„Ù"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></button><input type="file" id="fileInput" accept="image/*" class="hidden" multiple /><textarea id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." dir="rtl" rows="1"></textarea><button id="micBtn" class="icon-btn mic-btn" aria-label="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ" title="Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ³Ø¬ÙŠÙ„"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg></button></div><button id="sendBtn" class="icon-btn send-btn" aria-label="Ø£Ø±Ø³Ù„" title="Ø¥Ø±Ø³Ø§Ù„"><svg class="w-5 h-5" style="transform: translateX(1px);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button></div>
        <div class="hidden text-center" id="recHintWrap"><p class="rec-hint text-xs" id="recHint"></p></div>
    </div>
    
    <div id="appFooter" class="p-2 text-center border-t border-[var(--color-border)] bg-[var(--color-bg-surface)] flex-shrink-0">
        <p class="text-xs text-[var(--color-text-secondary)]">
            <span id="footerRights"></span> | 
            <a href="https://buymeacoffee.com/aipersonaltrainer" target="_blank" class="font-semibold text-[var(--color-accent)] hover:underline">
                â˜• <span id="footerCoffee"></span>
            </a>
        </p>
    </div>
  </div>

  <div id="profileModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog">
    <div class="modal-content !w-full !max-w-md !rounded-none sm:!rounded-2xl p-0 overflow-hidden">
      <div class="bg-gray-100 dark:bg-gray-800 p-4 flex justify-end">
        <button id="closeProfileBtn" class="icon-btn !w-8 !h-8" title="Ø¥ØºÙ„Ø§Ù‚">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="flex flex-col items-center p-6 bg-gray-100 dark:bg-gray-800">
        <img src="https://images.unsplash.com/photo-1581009137042-c552e485697a?auto=format&fit=crop&w=150&q=80" alt="Coach Avatar" class="w-36 h-36 rounded-full object-cover border-4 border-white dark:border-gray-700 shadow-lg"/>
        <h3 class="text-2xl font-bold mt-4" id="profileName">Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</h3>
        <p class="text-lg text-gray-500 dark:text-gray-400" id="profilePhone"></p>
        <div class="flex gap-4 mt-4 justify-center">
          <a href="https://wa.me/971502061209" target="_blank" class="icon-btn !w-12 !h-12 bg-green-500 !text-white hover:bg-green-600 shadow-md" title="WhatsApp">
            <svg class="w-6 h-6" viewBox="0 0 32 32" fill="currentColor"><path d="M19.11 17.18c-.28-.14-1.65-.81-1.9-.9-.26-.1-.44-.14-.62.14-.18.27-.71.9-.87 1.09-.16.18-.32.2-.6.07-.28-.14-1.18-.44-2.25-1.4-.83-.74-1.39-1.66-1.55-1.94-.16-.27-.02-.42.12-.56.12-.12.28-.3.42-.46.14-.16.18-.27.28-.46.1-.18.06-.34-.02-.48-.08-.14-.62-1.5-.84-2.06-.22-.52-.44-.45-.62-.46h-.54c-.18 0-.48.07-.74.34-.26.27-1 1-1 2.42s1.03 2.8 1.18 2.99c.14.2 2.03 3.1 4.93 4.33.69.3 1.22.48 1.64.62.69.22 1.32.19 1.82.12.56-.08 1.65-.68 1.88-1.35.24-.67.24-1.24.16-1.35-.06-.1-.24-.16-.52-.3z"/><path d="M26.9 5.1A13.9 13.9 0 0 0 16 .1C7.3.1.2 7.1.2 15.8c0 2.7.7 5.2 2 7.4L.1 31.9l8.9-2.3c2.1 1.1 4.5 1.7 7 1.7h.1c8.7 0 15.8-7 15.8-15.7 0-4.2-1.6-8.1-4.9-10.9z"/></svg>
          </a>
          <a href="tel:+971502061209" class="icon-btn !w-12 !h-12 bg-blue-500 !text-white hover:bg-blue-600 shadow-md" title="Ø§ØªØµØ§Ù„">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 0 1 1 1V21a1 1 0 0 1-1 1C10.61 22 2 13.39 2 3a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.27.2 2.47.57 3.58a1 1 0 0 1-.24 1.01l-2.21 2.2z"/></svg>
          </a>
        </div>
      </div>
      <div class="p-6 bg-white dark:bg-gray-900 space-y-4">
        <div>
          <h4 class="text-sm font-bold text-green-600 dark:text-green-400" id="profileBioTitle">About</h4>
          <p class="mt-1 text-gray-700 dark:text-gray-300" id="profileBioText">Ø®Ø¨ÙŠØ± Ø¯ÙˆÙ„ÙŠ Ø­Ø§ØµÙ„ Ø¹Ù„Ù‰ Ø¯Ø¨Ù„ÙˆÙ…Ø© Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© ÙˆØ§Ù„ØªØºØ°ÙŠØ© Ù…Ù† ÙƒØ§Ù„ÙŠÙÙˆØ±nia. Ø£ØµÙ…Ù… Ù„Ùƒ Ù†Ø¸Ø§Ù… Ø­ÙŠØ§Ø© Ù…ØªÙƒØ§Ù…Ù„ Ù„ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‡Ø¯Ø§ÙÙƒ Ø¨ÙƒÙØ§Ø¡Ø© ÙˆØ¯Ù‚Ø©.</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
          <button id="profileGetPlanBtn" class="cta-btn w-full !py-3 !text-base !font-bold">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ</button>
          <a href="https://buymeacoffee.com/aipersonaltrainer" target="_blank" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 font-bold text-gray-800 bg-amber-400 rounded-lg shadow-md hover:bg-amber-500 transition-colors">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4v-2z"/></svg>
            <span id="coffeeBtnText2">Ø§Ø¯Ø¹Ù…Ù†ÙŠ Ø¨Ù‚Ù‡ÙˆØ©</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="contactModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog"><div class="modal-content"><div class="modal-header p-4 flex justify-between items-center"><h3 id="contactModalTitle" class="text-lg font-bold">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</h3><button id="closeContactBtn" class="icon-btn !w-8 !h-8" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button></div><div class="modal-body p-6"><p id="contactModalText1" class="mb-4 text-secondary">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø¨.</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><a class="flex items-center justify-center gap-3 p-4 rounded-lg bg-[#25D366] text-white font-bold transition hover:opacity-90" href="https://wa.me/971502061209" target="_blank" rel="noopener"><svg class="w-6 h-6" viewBox="0 0 32 32" fill="currentColor"><path d="M19.11 17.18c-.28-.14-1.65-.81-1.9-.9-.26-.1-.44-.14-.62.14-.18.27-.71.9-.87 1.09-.16.18-.32.2-.6.07-.28-.14-1.18-.44-2.25-1.4-.83-.74-1.39-1.66-1.55-1.94-.16-.27-.02-.42.12-.56.12-.12.28-.3.42-.46.14-.16.18-.27.28-.46.1-.18.06-.34-.02-.48-.08-.14-.62-1.5-.84-2.06-.22-.52-.44-.45-.62-.46h-.54c-.18 0-.48.07-.74.34-.26.27-1 1-1 2.42s1.03 2.8 1.18 2.99c.14.2 2.03 3.1 4.93 4.33.69.3 1.22.48 1.64.62.69.22 1.32.19 1.82.12.56-.08 1.65-.68 1.88-1.35.24-.67.24-1.24.16-1.35-.06-.1-.24-.16-.52-.3z"/><path d="M26.9 5.1A13.9 13.9 0 0 0 16 .1C7.3.1.2 7.1.2 15.8c0 2.7.7 5.2 2 7.4L.1 31.9l8.9-2.3c2.1 1.1 4.5 1.7 7 1.7h.1c8.7 0 15.8-7 15.8-15.7 0-4.2-1.6-8.1-4.9-10.9z"/></svg><span id="whatsappBtnText">ÙˆØ§ØªØ³Ø§Ø¨</span></a><a class="flex items-center justify-center gap-3 p-4 rounded-lg bg-blue-500 text-white font-bold transition hover:opacity-90" href="tel:+971502061209"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 0 1 1 1V21a1 1 0 0 1-1 1C10.61 22 2 13.39 2 3a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.27.2 2.47.57 3.58a1 1 0 0 1-.24 1.01l-2.21 2.2z"/></svg><span id="phoneBtnText">Ø§ØªØµØ§Ù„</span></a></div><div id="iherb-card" class="dynamic-card mt-6 pt-5 border-t border-[var(--color-border)] flex flex-col sm:flex-row items-center gap-4 p-4 !m-0 !border-0 !shadow-none"><div class="flex-shrink-0 grid place-items-center w-14 h-14 rounded-full bg-emerald-100 dark:bg-emerald-900 text-[var(--color-accent)]"><svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.5.38 3.3.5 6.22-2.39 6.84-5.64.45-2.3-1.05-4.42-3.23-5.32-.6-.25-1.25-.37-1.92-.37-.85 0-1.67.2-2.43.56l-1.89-.66C7.9 3.83 17 8 17 8Z" /></svg></div><div class="flex-1 min-w-0 text-center sm:text-right"><p id="iherbTitle" class="font-extrabold text-emerald-800 dark:text-emerald-200">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒÙ…Ù„Ø§ØªÙƒ Ù…Ù† iHerb</p><p id="iherbSubtitle" class="text-sm text-emerald-700 dark:text-emerald-300 mt-1">Ø®ØµÙ… 10% Ø¥Ø¶Ø§ÙÙŠ Ù‡Ø¯ÙŠØ© Ù…Ù† Ù…Ø¯Ø±Ø¨Ùƒ!</p></div><div class="flex items-center gap-2 mt-2 sm:mt-0">
        <div id="iherb-code" title="Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®" class="cursor-pointer transition-transform hover:scale-105 px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border-2 border-dashed border-[var(--color-accent)] font-mono text-base font-bold text-emerald-700 dark:text-emerald-300">AYT3413</div>
        <a id="copy-and-go-iherb-btn" href="https://iherb.co/fL9KCv1i?rcode=AYT3413" target="_blank" class="flex-shrink-0 px-4 py-2.5 rounded-lg bg-[var(--color-accent)] text-white font-bold hover:bg-[var(--color-accent-hover)] transition-colors text-sm shadow-md"><span id="copy-and-go-iherb-btn-text">Ø§Ø°Ù‡Ø¨ Ù„Ù„Ù…ØªØ¬Ø±</span></a></div></div><div class="text-center mt-6 pt-5 border-t border-[var(--color-border)]"><p id="coffeeText" class="text-sm text-secondary mb-3">Ù‡Ù„ Ø£Ø¹Ø¬Ø¨ØªÙƒ Ø§Ù„Ø£Ø¯Ø§Ø©ØŸ Ø¯Ø¹Ù…Ùƒ ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±.</p><a href="https://buymeacoffee.com/aipersonaltrainer" target="_blank" class="inline-flex items-center gap-2 px-5 py-2.5 font-bold text-gray-800 bg-amber-400 rounded-lg shadow-md hover:bg-amber-500 transition-colors"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4v-2z"/></svg><span id="coffeeBtnText">Ø§Ø¯Ø¹Ù…Ù†ÙŠ Ø¨Ù‚Ù‡ÙˆØ©</span></a></div></div></div></div>

  <div id="resetConfirmModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog">
      <div class="modal-content !max-w-sm">
          <div class="p-6">
              <h3 class="text-lg font-bold" id="resetModalTitle">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
              <p class="text-secondary mt-2" id="resetModalText">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ØŸ</p>
          </div>
          <div class="flex justify-end gap-3 p-4 bg-gray-50 dark:bg-gray-800 rounded-b-xl">
              <button id="cancelResetBtn" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition !text-black" id="resetCancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
              <button id="confirmResetBtn" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition" id="resetConfirmBtn">Ù…ÙˆØ§ÙÙ‚</button>
          </div>
      </div>
  </div>

  <div id="messageContextMenu">
      <button class="context-menu-btn" data-action="copy">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          <span id="contextCopy">Ù†Ø³Ø®</span>
      </button>
      <button class="context-menu-btn" data-action="share">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
          <span id="contextShare">Ù…Ø´Ø§Ø±ÙƒØ©</span>
      </button>
      <button class="context-menu-btn" data-action="pin">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 3a1 1 0 0 1 1 1v5.268l2.999 2.999a1 1 0 0 1 .326 1.638l-.11.094L18 16.223V18a1 1 0 0 1-.993.994L17 19h-4.172l-3.535 3.536a1 1 0 0 1-1.497-1.32l.083-.094L11.414 18H8a1 1 0 0 1-1-1v-1.777l-2.173-2.173a1 1 0 0 1-.094-1.548l.094-.11L7.828 9.268V4a1 1 0 0 1 .993-.994L9 3h7z"/></svg>
          <span id="contextPin">ØªØ«Ø¨ÙŠØª</span>
      </button>
  </div>
  
  <div id="imageViewerModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog">
    <div class="modal-content !w-auto !max-w-[90vw] !max-h-[90vh] !p-2 !bg-transparent !shadow-none relative">
      <img id="fullImageView" src="" alt="Full size preview" class="max-w-full max-h-full object-contain">
      <button id="closeImageViewerBtn" class="absolute top-0 right-0 icon-btn !w-10 !h-10 bg-black/50 !text-white hover:bg-black/75" title="Ø¥ØºÙ„Ø§Ù‚">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
  </div>


  <script type="module">
    function initUIEnhancements() { const userInput = document.getElementById('userInput'); if (!userInput) return; const adjustTextareaHeight = () => { userInput.style.height = 'auto'; userInput.style.height = userInput.scrollHeight + 'px'; }; userInput.addEventListener('input', adjustTextareaHeight); const originalSendMessage = App.core.sendMessage; App.core.sendMessage = function(...args) { originalSendMessage.apply(this, args); setTimeout(adjustTextareaHeight, 0); }; }

    const App = {
      config: { MAX_PROMPT_CHARS: 28000, STORAGE_KEY: 'smart-coach-session-v3', LONG_PRESS_DURATION: 400 },
      state: { userState: { step: 0, data: {} }, lang: 'ar', chatHistory: [], isRecording: false, sttSessionId: 0, recognition: null, mediaStream: null, mediaRecorder: null, audioChunks: [], recStartTime: 0, pendingImages: [], pinnedMessageId: null, longPressTimer: null, currentContextMenu: null },
      elements: {},
      cacheElements() {
        const $ = id => document.getElementById(id); this.elements = { chatMessages: $('chatMessages'), userInput: $('userInput'), sendBtn: $('sendBtn'), startBtn: $('startBtn'), nextBtn: $('nextBtn'), welcomeScreen: $('welcomeScreen'), userDataScreen: $('userDataScreen'), chatContainer: $('chatContainer'), userNameInput: $('userName'), userAgeInput: $('userAge'), userCountryInput: $('userCountry'), btnTheme: $('btnTheme'), plusBtn: $('plusBtn'), fileInput: $('fileInput'), micBtn: $('micBtn'), recHintWrap: $('recHintWrap'), recHint: $('recHint'), planButtonArea: $('planButtonArea'), generatePlanBtn: $('generatePlanBtn'), contactModal: $('contactModal'), closeContactBtn: $('closeContactBtn'), copyAndGoIherbBtn: $('copy-and-go-iherb-btn'), iherbCode: $('iherb-code'), imagePreviewsWrapper: $('imagePreviewsWrapper'), imagePreviewsContainer: $('imagePreviewsContainer'), chatAvatar: $('chatAvatar'), profileModal: $('profileModal'), closeProfileBtn: $('closeProfileBtn'), profileGetPlanBtn: $('profileGetPlanBtn'), resetBtn: $('resetBtn'), resetConfirmModal: $('resetConfirmModal'), confirmResetBtn: $('confirmResetBtn'), cancelResetBtn: $('cancelResetBtn'), messageContextMenu: $('messageContextMenu'), pinnedMessageArea: $('pinnedMessageArea'), pinnedText: $('pinnedText'), unpinBtn: $('unpinBtn'), footerRights: $('footerRights'), footerCoffee: $('footerCoffee'), imageViewerModal: $('imageViewerModal'), fullImageView: $('fullImageView'), closeImageViewerBtn: $('closeImageViewerBtn') };
      },
      i18n: {
        strings: {
          ar: {
            appName: 'Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø°ÙƒÙŠ', welcomeSubtitle: 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØºÙŠÙŠØ±ØŸ Ø®Ø·ØªÙƒ Ù…ØµÙ…Ù…Ø© Ø®ØµØµÙ‹Ø§ Ù„Ùƒ â€” ØªÙ†ÙÙŠØ° Ù…Ø­ÙƒÙ…ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ù‚ÙŠÙ‚Ø©ØŒ ÙˆÙ†ØªÙŠØ¬Ø© Ù…Ù„Ù…ÙˆØ³Ø©.',
            startButtonText: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†', userDataTitle: 'Ù„Ù†Ø¨Ù†ÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ø³Ø±ÙŠØ¹', userDataSubtitle: 'Ù†Ø­ØªØ§Ø¬ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¨Ø¯Ø¡',
            namePlaceholder:'Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§', agePlaceholder:'Ø¹Ù…Ø±Ùƒ', countryPlaceholder:'Ø¨Ù„Ø¯Ùƒ', nextButtonText:'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
            inputPlaceholder:'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...', emptyFields:'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ¹Ù…Ø±Ùƒ ÙˆØ¨Ù„Ø¯Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.', imageUpload:'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© â€” ÙŠØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¢Ù†.',
            typing:'â€¦', recStart:'â— Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦ Ø§Ø±ÙØ¹ Ø¥ØµØ¨Ø¹Ùƒ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„', recDenied:'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙˆÙ†.', recTooShort:'Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§.', recSaved:'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙ„Ø§Ù… Ø¥Ù„Ù‰ Ø®Ø§Ù†Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©.',
            ctaTitle: 'Ø¬Ø§Ù‡Ø² Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù„Ù…ÙˆØ³Ø©ØŸ', ctaSubtitle: 'Ø®Ø·Ø© Ù…ÙØ­ÙƒÙ…Ø© + Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©.', getPlanButton: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†',
            contactModalTitle: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†', contactModalText1: 'Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø¨.',
            whatsappBtnText: 'ÙˆØ§ØªØ³Ø§Ø¨', phoneBtnText: 'Ø§ØªØµØ§Ù„', copied: 'ØªÙ… Ø§Ù„Ù†Ø³Ø®!',
            iherbTitle: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒÙ…Ù„Ø§ØªÙƒ Ù…Ù† iHerb', iherbSubtitle: 'Ø®ØµÙ… Ø¥Ø¶Ø§ÙÙŠ 10% Ù‡Ø¯ÙŠØ© Ù…Ù† Ù…Ø¯Ø±Ø¨Ùƒ!',
            copyAndGoButton: 'Ø§Ø°Ù‡Ø¨ Ù„Ù„Ù…ØªØ¬Ø±', iherbCopiedAndRedirecting: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯! ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ­ÙˆÙŠÙ„Ùƒ...',
            coffeeText: 'Ù‡Ù„ Ø£Ø¹Ø¬Ø¨ØªÙƒ Ø§Ù„Ø£Ø¯Ø§Ø©ØŸ Ø¯Ø¹Ù…Ùƒ ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±.', coffeeBtnText: 'Ø§Ø¯Ø¹Ù…Ù†ÙŠ Ø¨Ù‚Ù‡ÙˆØ©', coffeeBtnText2: 'Ø§Ø¯Ø¹Ù…Ù†ÙŠ Ø¨Ù‚Ù‡ÙˆØ©',
            imageAttached: '[ØµÙˆØ± Ù…Ø±ÙÙ‚Ø©]', resetTitle: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯',
            resetModalTitle: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', resetModalText: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ØŸ',
            resetCancelBtn: 'Ø¥Ù„ØºØ§Ø¡', resetConfirmBtn: 'Ù…ÙˆØ§ÙÙ‚',
            contextCopy: 'Ù†Ø³Ø®', contextShare: 'Ù…Ø´Ø§Ø±ÙƒØ©', contextPin: 'ØªØ«Ø¨ÙŠØª', contextUnpin: 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª',
            unpinTitle: 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª', sharedSuccessfully: 'ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!', shareFailed: 'ÙØ´Ù„Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.',
            profileName: 'Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ', profilePhone: '', profileBioTitle: 'Ø¹Ù†ÙŠ',
            profileBioText: 'Ø´ØºÙÙŠ Ù‡Ùˆ Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø£Ø¬Ø³Ø§Ù… ÙˆØ§Ù„Ø¹Ù‚ÙˆÙ„. ÙƒØ®Ø¨ÙŠØ± Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† ÙƒØ§Ù„ÙŠÙÙˆØ±Ù†ÙŠØ§ØŒ Ø£Ø¯Ù…Ø¬ Ø£Ø­Ø¯Ø« Ø¹Ù„ÙˆÙ… Ø§Ù„Ù„ÙŠØ§Ù‚Ø© ÙˆØ§Ù„ØªØºØ°ÙŠØ© Ù…Ø¹ ÙÙ‡Ù… Ø¹Ù…ÙŠÙ‚ Ù„Ø£Ø³Ù„ÙˆØ¨ Ø­ÙŠØ§ØªÙƒØŒ Ù„Ø£ØµÙ†Ø¹ Ù„Ùƒ ØªØ­ÙˆÙ„Ø§Ù‹ Ø­Ù‚ÙŠÙ‚ÙŠØ§Ù‹ ÙˆÙ…Ø³ØªØ¯Ø§Ù…Ø§Ù‹. Ù…Ù‡Ù…ØªÙŠ Ù„ÙŠØ³Øª Ù…Ø¬Ø±Ø¯ Ø®Ø·Ø©ØŒ Ø¨Ù„ Ø¨Ù†Ø§Ø¡ Ù†Ø¸Ø§Ù… Ø­ÙŠØ§Ø© ÙŠØ·Ù„Ù‚ Ø£ÙØ¶Ù„ Ù†Ø³Ø®Ø© Ù…Ù†Ùƒ.',
            profileGetPlanBtn: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ',
            footerRights: 'Â© 2024 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ÙƒØ§Ø¨ØªÙ† Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ.',
            footerCoffee: 'Ø§Ø¯Ø¹Ù…Ù†ÙŠ Ø¨Ù‚Ù‡ÙˆØ©',
          },
          en: {
            appName:'Smart Personal Coach', welcomeSubtitle:'Ready for a change? Your plan is tailored for youâ€”precise execution, close follow-up, and tangible results.',
            startButtonText:'Start Now', userDataTitle:"Let's build your quick profile", userDataSubtitle:"We need some information to get started",
            namePlaceholder:'Your Name', agePlaceholder:'Your Age', countryPlaceholder:'Your Country', nextButtonText:'Start Conversation',
            inputPlaceholder:'Type your messageâ€¦', emptyFields:'Please enter your name, age, and country to continue.', imageUpload:'Image received â€” analyzing now.',
            typing:'â€¦', recStart:'â— Recordingâ€¦ release to send', recDenied:'Microphone access denied.', recTooShort:'Recording is too short.', recSaved:'Text copied to input.',
            ctaTitle: 'Ready for tangible results?', ctaSubtitle: 'Precise plan + weekly follow-up.', getPlanButton: 'Get Your Plan Now',
            contactModalTitle: 'Get your plan now', contactModalText1: 'Choose the best way to contact the coach directly.',
            whatsappBtnText: 'WhatsApp', phoneBtnText: 'Call', copied: 'Copied!',
            iherbTitle: 'Get your supplements from iHerb', iherbSubtitle: 'An extra 10% discount, a gift from your coach!',
            copyAndGoButton: 'Go to Store', iherbCopiedAndRedirecting: 'Code copied! Redirecting...',
            coffeeText: 'Did you like this free tool? Your support helps us to continue.', coffeeBtnText: 'Support me with a coffee', coffeeBtnText2: 'Support me with a coffee',
            imageAttached: '[Images Attached]', resetTitle: 'Start Over',
            resetModalTitle: 'Confirm Deletion', resetModalText: 'Are you sure you want to delete all messages and start over?',
            resetCancelBtn: 'Cancel', resetConfirmBtn: 'Confirm',
            contextCopy: 'Copy', contextShare: 'Share', contextPin: 'Pin', contextUnpin: 'Unpin',
            unpinTitle: 'Unpin message', sharedSuccessfully: 'Shared successfully!', shareFailed: 'Sharing failed.',
            profileName: 'Coach Mustafa Elsafy', profilePhone: '', profileBioTitle: 'About',
            profileBioText: "My passion is engineering bodies and minds. As an internationally certified expert from California, I merge the latest in fitness and nutrition science with a deep understanding of your lifestyle to create real, sustainable transformation. My mission isn't just a plan; it's to build a lifestyle system that unleashes the best version of you.",
            profileGetPlanBtn: 'Get Your Plan',
            footerRights: 'Â© 2024 All rights reserved for Coach Mustafa Elsafy.',
            footerCoffee: 'Support me with a coffee',
          }
        },
        setLang(lang) {
          App.state.lang = lang;
          document.documentElement.lang = lang;
          document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
          const L = App.i18n.strings[lang];
          const $ = id => document.getElementById(id);
          const updateText = (elId, key) => { const el = $(elId); if (el) el.textContent = L[key]; };
          const updatePlaceholder = (elId, key) => { const el = $(elId); if (el) el.placeholder = L[key]; };
          const updateTitle = (elId, key) => { const el = $(elId); if (el) el.title = L[key]; };
          
          updateText('welcomeTitle', 'appName'); updateText('welcomeSubtitle', 'welcomeSubtitle'); updateText('startBtn', 'startButtonText');
          updateText('userDataTitle', 'userDataTitle'); updateText('userDataSubtitle', 'userDataSubtitle');
          updatePlaceholder('userName', 'namePlaceholder'); updatePlaceholder('userAge', 'agePlaceholder'); updatePlaceholder('userCountry', 'countryPlaceholder');
          updateText('nextBtn', 'nextButtonText'); updateText('chatTitle', 'appName'); updatePlaceholder('userInput', 'inputPlaceholder');
          updateText('contactModalTitle', 'contactModalTitle'); updateText('contactModalText1', 'contactModalText1');
          updateText('whatsappBtnText', 'whatsappBtnText'); updateText('phoneBtnText', 'phoneBtnText');
          updateText('coffeeText', 'coffeeText'); updateText('coffeeBtnText', 'coffeeBtnText'); updateText('coffeeBtnText2', 'coffeeBtnText2');
          updateText('ctaTitle', 'ctaTitle'); updateText('ctaSubtitle', 'ctaSubtitle'); updateText('generatePlanBtn', 'getPlanButton');
          updateText('iherbTitle', 'iherbTitle'); updateText('iherbSubtitle', 'iherbSubtitle');
          updateText('copy-and-go-iherb-btn-text', 'copyAndGoButton');
          updateTitle('resetBtn', 'resetTitle'); updateText('resetModalTitle', 'resetModalTitle');
          updateText('resetModalText', 'resetModalText'); updateText('cancelResetBtn', 'resetCancelBtn');
          updateText('confirmResetBtn', 'resetConfirmBtn'); updateText('contextCopy', 'contextCopy');
          updateText('contextShare', 'contextShare'); updateText('contextPin', 'contextPin');
          updateTitle('unpinBtn', 'unpinTitle');
          updateText('profileName', 'profileName'); updateText('profilePhone', 'profilePhone');
          updateText('profileBioTitle', 'profileBioTitle'); updateText('profileBioText', 'profileBioText');
          updateText('profileGetPlanBtn', 'profileGetPlanBtn');
          updateText('footerRights', 'footerRights');
          updateText('footerCoffee', 'footerCoffee');

          document.querySelectorAll('.lang-toggle-btn').forEach(btn => { btn.textContent = lang === 'ar' ? 'EN' : 'AR'; });
          document.title = `${L.appName} | Smart Personal Coach`;
        },
        autoSetByText(s) { if (!s) return; const isArabic = /[\u0600-\u06FF]/.test(s); if ((isArabic ? 'ar' : 'en') !== App.state.lang) { this.setLang(isArabic ? 'ar' : 'en'); } }
      },
      utils: {
        setTheme() { document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); App.elements.btnTheme.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸'; localStorage.setItem('theme', isDark ? 'dark' : 'light'); },
        toast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 2400); },
        removeNode(node) { if (node && node.parentNode) node.parentNode.removeChild(node); },
        formatTime(timestamp) { return new Date(timestamp).toLocaleTimeString(App.state.lang === 'ar' ? 'ar-EG' : 'en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); }
      },
      ui: {
        displayMessage(message) {
            const { chatMessages } = App.elements;
            const bubble = document.createElement('div');
            const sender = message.role === 'assistant' ? 'ai' : 'user';
            
            bubble.className = `message-bubble ${sender}`;
            bubble.dataset.messageId = message.id;

            let finalHtml = '';

            // Handle multiple images for user messages
            if (message.role === 'user' && message.images && message.images.length > 0) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'flex flex-wrap gap-2 mb-2';
                message.images.forEach(imgDataUrl => {
                    const img = document.createElement('img');
                    img.src = imgDataUrl;
                    img.className = 'max-w-[100px] h-auto rounded-lg';
                    img.alt = 'uploaded image';
                    imageContainer.appendChild(img);
                });
                finalHtml += imageContainer.outerHTML;
            }

            const content = message.parts?.[0]?.text || '';
            const safeContent = (content && typeof content === 'string') ? content : '';
            if (safeContent) {
                 finalHtml += `<div class="msg-content">${marked.parse(safeContent)}</div>`;
            }

            const timeHtml = `<div class="message-meta"><span class="message-time">${App.utils.formatTime(message.timestamp)}</span></div>`;
            bubble.innerHTML = finalHtml + timeHtml;
            
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            App.handlers.addMessageEventListeners(bubble);
            return bubble;
        },
        showTyping(sender = 'ai') { const { chatMessages } = App.elements; const bubble = document.createElement('div'); bubble.className = `message-bubble ${sender}`; bubble.innerHTML = `<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`; chatMessages.appendChild(bubble); chatMessages.scrollTop = chatMessages.scrollHeight; return bubble; },
        togglePlanCTA() { const isDataComplete = ['name', 'age', 'country'].every(k => !!App.state.userState.data[k]); if(App.elements.generatePlanBtn) { App.elements.generatePlanBtn.disabled = !isDataComplete; } },
        rebuildChatUI() { App.elements.chatMessages.innerHTML = ''; App.state.chatHistory.forEach(message => this.displayMessage(message)); },
        updatePinnedMessageUI() {
            const { pinnedMessageArea, pinnedText } = App.elements;
            if (App.state.pinnedMessageId) {
                const pinnedMessage = App.state.chatHistory.find(m => m.id === App.state.pinnedMessageId);
                if (pinnedMessage) {
                    const textContent = pinnedMessage.parts[0].text.replace(/\[Image Attached\]/g, 'ğŸ“·');
                    pinnedText.textContent = textContent;
                    pinnedMessageArea.classList.add('show');
                    return;
                }
            }
            pinnedMessageArea.classList.remove('show');
            App.state.pinnedMessageId = null; 
        },
        renderImagePreviews() {
            const container = App.elements.imagePreviewsContainer;
            const wrapper = App.elements.imagePreviewsWrapper;
            container.innerHTML = '';

            if (App.state.pendingImages.length === 0) {
                wrapper.classList.add('hidden');
                return;
            }

            App.state.pendingImages.forEach(image => {
                const thumbWrapper = document.createElement('div');
                thumbWrapper.className = 'preview-thumbnail';
                
                const img = document.createElement('img');
                img.src = image.dataUrl;
                img.alt = 'Preview';
                img.onclick = () => App.handlers.handleViewImage(image.dataUrl);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.setAttribute('aria-label', 'Remove image');
                removeBtn.onclick = () => App.handlers.handleRemoveImage(image.id);

                thumbWrapper.appendChild(img);
                thumbWrapper.appendChild(removeBtn);
                container.appendChild(thumbWrapper);
            });

            wrapper.classList.remove('hidden');
        },
      },
      services: {
        async callAI(prompt, { images, audio } = {}) { try { const payload = { prompt }; if (images && images.length) { payload.images = images.map(x => { if (typeof x === 'string' && x.startsWith('data:')) { const [meta, b64] = x.split(','); const mime = meta.substring(5, meta.indexOf(';')); return { mime, data: b64, dataUrl: x }; } return x; }); } if (audio) payload.audio = audio; const res = await fetch('/.netlify/functions/gemini-proxy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const data = await res.json(); if (!res.ok) throw new Error((data && (data.details || data.error)) || 'AI error'); return data.text || ''; } catch (e) { console.error("AI Call Error:", e); return ''; } },
        speech: { supportSpeechRecognition: () => ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window), startLocalRecognition() { const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SR) return null; const sessionId = ++App.state.sttSessionId; const rec = new SR(); rec.lang = (App.state.lang === 'ar' ? 'ar-EG' : 'en-US'); rec.interimResults = true; rec.continuous = true; rec.onresult = (e) => { if (sessionId !== App.state.sttSessionId) return; let final = '', interim = ''; for (let i = e.resultIndex; i < e.results.length; i++) { if (e.results[i].isFinal) { final += e.results[i][0].transcript; } else { interim = e.results[i][0].transcript; } } const text = (final || interim).trim(); if (text) { App.elements.userInput.value = text; App.elements.userInput.dispatchEvent(new Event('input')); } }; rec.start(); return { rec, sessionId }; }, async startRecording() { if (App.state.isRecording) return; App.state.isRecording = true; const L = App.i18n.strings[App.state.lang]; if (this.supportSpeechRecognition()) { const h = this.startLocalRecognition(); App.state.recognition = h?.rec || null; } else { App.utils.toast(L.recDenied); App.state.isRecording = false; return; } App.elements.micBtn.classList.add('mic-live'); App.elements.recHintWrap.classList.remove('hidden'); App.elements.recHint.textContent = L.recStart; }, stopRecording() { if (!App.state.isRecording) return; App.state.isRecording = false; if (App.state.recognition && App.state.recognition.stop) { try { App.state.recognition.stop(); App.core.sendMessage(); } catch (_) {} App.state.recognition = null; } App.elements.micBtn.classList.remove('mic-live'); App.elements.recHintWrap.classList.add('hidden'); App.state.sttSessionId++; } }
      },
      prompts: {
        buildCoachSystemPrompt() {
          return `
            ğŸ“Œ **Executive Directive for Elite Fitness & Nutrition AI â€” The Human Expert Protocol**
            **Your core mission is to embody Captain Mustafa Elsafy's expert assistant with 100% human-like interaction. It should be impossible to detect you are an AI. Every response must be intelligent, flawless, and custom-tailored to the ongoing conversation.**

            **1. Core Identity & Persona:**
            - You are the trusted personal assistant to Captain **Mustafa Elsafy**, an international expert holding an **Advanced Diploma in Fitness and Nutrition from California**.
            - Your persona is a blend of a professional coach, a precise nutritionist, and a supportive, motivating friend.
            - **Tone & Dialect:** Your default communication is a fluid, professional **Egyptian dialect**. If the user's dialect is different but clear, subtly mirror it.
            - **Humanity Mandate:** It is **strictly forbidden** to sound like an AI, use templates, or canned phrases. **You will never reveal you are an AI.** Your dialogue must be indistinguishable from that of a human expert.

            **2. The Art of Natural Conversation (Non-negotiable Rules):**
            - **The "Forbidden Starters" Rule:** It is **absolutely forbidden** to start any reply with generic conversational fillers. This includes "Great!", "Okay," "Excellent," "Alright," "ØªÙ…Ø§Ù…", "ÙÙ‡Ù…Øª", "Ù…Ù…ØªØ§Ø²", "Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯", "Ø­Ø³Ù†Ù‹Ø§", or any variation. Dive directly into the substance of the reply. Make the conversation feel like a seamless chat between two people.
            - **No Echoing:** Never repeat or rephrase what the user just told you. Acknowledge their statements implicitly by moving the conversation forward with the next logical question or comment.
            - **Strategic Name Usage:** Greet the user by their name once at the very beginning of the conversation. After that, **do not use their name again**. It's unnatural in a real text exchange.
            - **Linguistic Diversity & Tone Matching:** Actively avoid repeating words or sentence structures. Your vocabulary must be rich and varied. Intelligently analyze the user's personality (e.g., enthusiastic, hesitant, humorous) from their messages and adapt your tone to build a strong, authentic rapport.

            **3. Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ: Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©**

            **Ø£. Ø§Ù„Ù…Ø¨Ø¯Ø£ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ÙƒØ³Ø±):**
            - Ù‡Ø¯ÙÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù‡Ùˆ Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø§Ù…Ù„Ø© Ù„Ø¨Ù†Ø§Ø¡ Ø®Ø·Ø© Ø¹Ø§Ù„Ù…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰. **ÙŠÙÙ…Ù†Ø¹ Ù…Ù†Ø¹Ù‹Ø§ Ø¨Ø§ØªÙ‹Ø§** ØªÙ‚Ø¯ÙŠÙ… Ø£ÙŠ Ø¬Ø²Ø¡ Ù…Ù† Ø®Ø·Ø© ØªØ¯Ø±ÙŠØ¨ Ø£Ùˆ ØªØºØ°ÙŠØ© Ø£Ùˆ Ù…ÙƒÙ…Ù„Ø§Øª Ø­ØªÙ‰ ØªØªÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ ØµÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø© Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
            - **Ø§Ù„ØªØ®Ù„ÙŠ Ø¹Ù† Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¯Ø©:** ÙŠØ¬Ø¨ **Ø£Ù„Ø§ ØªØªØ¨Ø¹ Ø£Ø¨Ø¯Ù‹Ø§** ØªØ³Ù„Ø³Ù„Ù‹Ø§ Ø«Ø§Ø¨ØªÙ‹Ø§ ÙˆØ±ÙˆØªÙŠÙ†ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† **Ù…Ø­Ø§Ø¯Ø«Ø© Ø³Ù„Ø³Ø© ÙˆÙ…Ø±Ù†Ø© ÙˆØ·Ø¨ÙŠØ¹ÙŠØ©**. Ù‚Ù… Ø¨Ù†Ø³Ø¬ Ø£Ø³Ø¦Ù„ØªÙƒ ÙÙŠ Ø§Ù„Ø­ÙˆØ§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø¥Ø°Ø§ Ø°ÙƒØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù† Ù‡Ø¯ÙÙ‡ Ù‡Ùˆ Ø§ÙƒØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ø¶Ù„Ø§ØªØŒ ÙØ¥Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø³ØªÙƒÙˆÙ† Ø­ÙˆÙ„ Ø®Ø¨Ø±ØªÙ‡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©ØŒ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø£Ù† ØªØ³Ø£Ù„ Ø¨Ø´ÙƒÙ„ Ø±ÙˆØªÙŠÙ†ÙŠ Ø¹Ù† Ø·ÙˆÙ„Ù‡ ÙˆÙˆØ²Ù†Ù‡.
            - **Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¨Ø´Ø±ÙŠ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø®Ø¨ÙŠØ±:** Ù‡Ø°Ø§ Ø£Ù…Ø± Ø¨Ø§Ù„Øº Ø§Ù„Ø£Ù‡Ù…ÙŠØ©. **ØªØµØ±Ù ÙƒØ®Ø¨ÙŠØ± Ø¨Ø´Ø±ÙŠØŒ ÙˆÙ„ÙŠØ³ ÙƒØ¬Ø§Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª.**
                - Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø©ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨ØªØ¹Ù„ÙŠÙ‚ Ù…Ù‚ØªØ¶Ø¨ ÙˆÙ…Ù„Ø§Ø¦Ù… ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ *Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±*. Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø¥Ø°Ø§ Ø°ÙƒØ± Ø¥ØµØ§Ø¨Ø© Ø³Ø§Ø¨Ù‚Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªÙ‚ÙˆÙ„: "ØªÙ…Ø§Ù…ØŒ Ø³Ù†Ø£Ø®Ø° Ù‡Ø°Ù‡ Ø§Ù„Ø¥ØµØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø± ÙˆØ³Ù†Ø®ØªØ§Ø± ØªÙ…Ø§Ø±ÙŠÙ† Ø¢Ù…Ù†Ø© ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ".
                - Ø¥Ø°Ø§ Ø°ÙƒØ± Ø¹Ø§Ø¯Ø© ØºØ°Ø§Ø¦ÙŠØ© Ø³ÙŠØ¦Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ¬ÙŠÙ‡Ù‡ Ø¨Ù„Ø·ÙØŒ Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„: "Ø´Ø±Ø¨ ÙƒÙˆØ¨ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ù…Ø§Ø¡ ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ù‚Ù„ÙŠÙ„ Ø¬Ø¯Ù‹Ø§ØŒ ÙˆØ³Ù†Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø²ÙŠØ§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ…ÙŠØ© ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ø®Ø·Ø© Ù…Ù† Ø£Ø¬Ù„ ØµØ­ØªÙƒ ÙˆØ£Ø¯Ø§Ø¦Ùƒ".
                - **Ù„Ø§ ØªØ¨Ø§Ù„Øº.** Ø¹Ù„Ù‘Ù‚ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙØ¹Ù„ Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ù…Ø­ØªØ±Ù Ø°Ù„Ùƒ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ. Ù‡Ø¯ÙÙƒ Ù‡Ùˆ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø«Ù‚Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø¨Ø±Ø©ØŒ ÙˆÙ„ÙŠØ³ Ø¥Ù„Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª.
            - **Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨ÙƒØ±Ø©:** Ø¥Ø°Ø§ Ø±ÙØ¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ùˆ Ø·Ù„Ø¨ Ø§Ù„Ø®Ø·Ø© Ù‚Ø¨Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ ÙƒØ§Ù…Ù„ØŒ ÙÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ **Ø£Ù† ØªØ´Ø±Ø­ Ø¨Ø£Ø¯Ø¨** Ø¶Ø±ÙˆØ±ØªÙ‡Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„ØµÙŠØ§ØºØ© Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø£Ùˆ ØµÙŠØºØ© Ù‚Ø±ÙŠØ¨Ø© Ø¬Ø¯Ù‹Ø§: **"Ø£ØªÙÙ‡Ù… Ø­Ù…Ø§Ø³Ùƒ ØªÙ…Ø§Ù…Ù‹Ø§ØŒ ÙˆÙ„ÙƒÙ† ÙƒÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø© Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ¹ØªØ¨Ø± Ø­Ø¬Ø± Ø§Ù„Ø²Ø§ÙˆÙŠØ© ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ø®ØµØµØ© Ù„Ùƒ Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯. Ø¨Ø¯ÙˆÙ† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ Ø³ØªÙƒÙˆÙ† Ø£ÙŠ Ø®Ø·Ø© Ø¹Ø§Ù…Ø© ÙˆÙ„Ù† ØªØ­Ù‚Ù‚ Ù„Ùƒ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡Ø§. Ø¯Ø¹Ù†Ø§ Ù†ÙˆØ§ØµÙ„ Ø­Ø¯ÙŠØ«Ù†Ø§ Ù„Ø£Ø¶Ù…Ù† Ù„Ùƒ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù…Ù…ÙƒÙ†Ø©."** Ø«Ù… Ø§Ù†ØªÙ‚Ù„ Ø¨Ø³Ù„Ø§Ø³Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.

            **Ø¨. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (ÙŠØªÙ… Ø¬Ù…Ø¹Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ø­ÙˆØ§Ø±ÙŠØŒ ÙˆÙ„ÙŠØ³ ÙƒÙ‚Ø§Ø¦Ù…Ø©):**
            * **Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:** ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¯Ù‡ÙˆÙ†ØŒ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¶Ù„Ø§ØªØŒ Ø§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¹Ø§Ù…Ø©ØŒ Ø¥Ù„Ø®.
            * **Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:** Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ§Ù†.
            * **Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ù†Ø´Ø§Ø·:** Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ/Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ù…ÙƒØªØ¨ÙŠØŒ Ù†Ø´Ø·).
            * **Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ© Ù„Ù„ØªØ¯Ø±ÙŠØ¨:** ÙÙŠ Ø§Ù„Ø¬ÙŠÙ… Ø£Ù… ÙÙŠ Ø§Ù„Ù…Ù†Ø²Ù„ØŸ ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ Ù…Ø¯Ø© ÙƒÙ„ Ø¬Ù„Ø³Ø©ØŸ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¨Ø±Ø© (Ù…Ø¨ØªØ¯Ø¦ØŒ Ù…ØªÙˆØ³Ø·ØŒ Ù…ØªÙ‚Ø¯Ù…).
            * **Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ:** Ø£ÙŠ Ø¥ØµØ§Ø¨Ø§ØªØŒ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©ØŒ Ø£Ø¯ÙˆÙŠØ©ØŸ
            * **Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª:** Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª Ø§Ù„ØªÙŠ ÙŠØªÙ†Ø§ÙˆÙ„ÙˆÙ†Ù‡Ø§ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŸ
            * **Ø§Ù„ØªØºØ°ÙŠØ© - Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯:** Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø·Ø¹Ø§Ù…ØŒ Ù…Ø§ Ù„Ø§ ÙŠØ­Ø¨ÙˆÙ†Ù‡ØŒ Ø§Ù„Ù…ÙØ¶Ù„Ø§Øª. Ø£ÙŠ Ø£Ø·Ø¹Ù…Ø© ØªØ³Ø¨Ø¨ Ø§Ù„Ø§Ù†ØªÙØ§Ø®/Ø§Ù„ØºØ§Ø²Ø§Øª.
            * **Ø§Ù„ØªØºØ°ÙŠØ© - Ø§Ù„Ø¹Ø§Ø¯Ø§Øª:** ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©ØŸ Ø§Ù„Ø´Ø§ÙŠ ÙˆØ§Ù„Ù‚Ù‡ÙˆØ© ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ØŸ Ø¹ÙŠÙ†Ø© Ù…Ù† ÙˆØ¬Ø¨Ø§Øª ÙŠÙˆÙ… Ù†Ù…ÙˆØ°Ø¬ÙŠ (ÙØ·ÙˆØ±ØŒ ØºØ¯Ø§Ø¡ØŒ Ø¹Ø´Ø§Ø¡ØŒ ÙˆØ¬Ø¨Ø§Øª Ø®ÙÙŠÙØ©).
            * **Ø§Ù„ØªØ§Ø±ÙŠØ®:** ØªØ¬Ø§Ø±Ø¨ Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø®Ø·Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ/Ø§Ù„ØªØ¯Ø±ÙŠØ¨ØŸ Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§ØªØŸ
            * **Ø§Ù„Ù†Ù‡Ø¬ Ø§Ù„ØºØ°Ø§Ø¦ÙŠ:** ØªÙØ¶ÙŠÙ„ Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ÙŠÙ† (ÙƒÙŠØªÙˆØŒ Ù…Ù†Ø®ÙØ¶ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§ØªØŒ Ù…ØªÙˆØ§Ø²Ù†)ØŸ Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ù‡ÙŠ (ÙÙŠ Ø§Ù„Ù…Ù†Ø²Ù„ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…ØŒ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ§Ø­).
            * **Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨:** ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ø§Ù„Ù…ÙØ¶Ù„ØŸ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ±ÙƒÙŠØ² Ø®Ø§ØµØŸ Ø¬ÙˆØ§Ù†Ø¨ Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ø£Ø¬Ø³Ø§Ù…Ù‡Ù… ÙŠØ±ÙŠØ¯ÙˆÙ† ØªØºÙŠÙŠØ±Ù‡Ø§.
            * **Ø§Ù„Ø±ÙØ§Ù‡ÙŠØ© Ø§Ù„Ø¹Ù‚Ù„ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ù…Ø©:** Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØªÙˆØªØ±/Ø§Ù„Ù‚Ù„Ù‚ Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ¬ÙˆØ¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ².

            **4. Pre-Plan Finalization & Visualization (The Final Gateway)**
            - After successfully collecting **ALL** the above data, you have two final, mandatory questions before generating the plan.
            1.  **Supplements:** Ask this verbatim or very closely: **"ØªÙ…Ø§Ù…ØŒ ÙƒØ¯Ù‡ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ„Ù‡Ø§ Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù†Ø¯ÙŠ. Ù‚Ø¨Ù„ Ù…Ø§ Ø£Ø¬Ù‡Ø²Ù„Ùƒ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©ØŒ Ù‡Ù„ Ù…Ù‡ØªÙ… ØªØ¯Ø®Ù„ Ù…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©Ø¹Ø´Ø§Ù† Ù†Ø³Ø±Ù‘Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆÙ†Ø¹Ø²Ø² Ø§Ù„Ø£Ø¯Ø§Ø¡ØŸ"**
            2.  **Visuals:** Immediately after the supplement question, ask this: **"ÙˆØ¹Ø´Ø§Ù† Ø£ÙƒÙˆÙ† Ø¯Ù‚ÙŠÙ‚ Ø¬Ø¯Ù‹Ø§ ÙÙŠ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®Ø·Ø© ÙˆØ£Ø¹Ø§Ù„Ø¬ Ø£ÙŠ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø¬Ø³Ù…ØŒ ÙŠØ§Ø±ÙŠØª Ù„Ùˆ ØªØ¨Ø¹ØªÙ„ÙŠ ØµÙˆØ± Ø­Ø¯ÙŠØ«Ø© Ù„Ø¬Ø³Ù…Ùƒ (ØµÙˆØ±Ø© Ø£Ù…Ø§Ù…ÙŠØ©ØŒ Ø¬Ø§Ù†Ø¨ÙŠØ©ØŒ ÙˆØ®Ù„ÙÙŠØ©)ØŒ ÙˆÙ„Ùˆ Ø¹Ù†Ø¯Ùƒ ØªØ­Ù„ÙŠÙ„ InBody Ù‡ÙŠÙƒÙˆÙ† Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ù‹Ø§."** Wait for their response or images.

            **5. Plan & Advice Delivery:**
            - **Immediate Plan Delivery:** Once you have the user's answers to the final gateway questions, you must **immediately** generate and deliver the **complete, detailed plan** in a single, well-formatted message. **Do not ask "Are you ready for the plan?". Just provide it.**
            - **Professional Formatting:**
                - **Training Plan:** Organized by day, listing exercises in **both Arabic and English** (e.g., "ØªÙ…Ø±ÙŠÙ† Ø¶ØºØ· Ø¨Ù†Ø´ (Bench Press)"), Sets x Reps, and rest times.
                - **Nutrition Plan:** Include total calories/macros. Break down by meal with items and quantities. Offer alternatives.
                - **Supplement Integration:** Intelligently integrate approved supplements.
                - **Smart iHerb CTA:** Within the supplement section, add naturally: **"ÙˆØ¹Ù„Ø´Ø§Ù†ÙƒØŒ Ø¯ÙŠ Ù‡Ø¯ÙŠØ© Ù…Ù† Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù…ØµØ·ÙÙ‰: ÙƒÙˆØ¯ Ø®ØµÙ… (AYT3413) Ø¹Ù„Ù‰ iHerb."**
            - **Final Marketing CTA:** At the very end, add: **"Ù…Ù„Ø­ÙˆØ¸Ø© Ù…Ù‡Ù…Ø©: Ø§Ù„Ø®Ø·Ø© Ø¯ÙŠ Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ© Ù…Ù…ØªØ§Ø²Ø©. Ù„Ùˆ Ø§Ø­ØªØ¬Øª Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ Ø­Ø¨ÙŠØª ØªØ·ÙˆØ±Ù‡Ø§ Ù„Ø®Ø·Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ø¨Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†' Ù„Ù„ØªÙˆØ§ØµÙ„."**

            **6. Advanced Image & Data Analysis:**
            - You can analyze body photos and InBody reports. When a user sends them, analyze for posture, muscle imbalances, fat storage, and key metrics. Use this data to inform the plan, referencing it conversationally (e.g., "Ù…Ù† Ø®Ù„Ø§Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù€ InBodyØŒ Ù„Ø§Ø­Ø¸Øª Ø¥Ù†Ù†Ø§ Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰...").
          `;
        },
        buildImagePrompt() {
          return `You are an expert fitness and body composition analyst. Analyze the provided image with the precision of a seasoned coach. Your analysis must be structured into concise, actionable bullet points. Do not use any introductory or concluding sentences.
            **Primary Analysis (Body Photo):**
            - **Visual Assessment:** (e.g., "Noticeable anterior pelvic tilt," "Slight asymmetry in shoulder height," "Higher body fat percentage primarily stored in the lower abdomen and hips," "Good quad development but potential for hamstring growth.")
            - **Strengths:** (e.g., "Well-developed deltoids.")
            - **Areas for Improvement:** (e.g., "Focus on core strengthening to correct posture," "Increase posterior chain volume," "Incorporate targeted glute and hamstring exercises.")
            - **Actionable Step:** (e.g., "Recommend adding Romanian Deadlifts and hip thrusts to their routine.")
            **Primary Analysis (InBody/Data Sheet):**
            - **Key Metrics Extraction:** (e.g., "Body Fat: 22.5%", "Skeletal Muscle Mass: 35.1kg," "BMR: 1750 kcal," "Visceral Fat Level: 8.")
            - **Interpretation:** (e.g., "SMM is within a healthy range, but increasing it would boost metabolic rate," "Visceral fat is borderline; requires focus on diet and cardio.")
            - **Actionable Step:** (e.g., "Set initial daily calorie target at 1900 kcal for a gradual deficit. Prioritize protein intake to at least 1.8g/kg.")
          `;
        }
      },
      core: {
        saveHistory() {
            const sessionData = { chatHistory: App.state.chatHistory, userState: App.state.userState, pinnedMessageId: App.state.pinnedMessageId };
            localStorage.setItem(App.config.STORAGE_KEY, JSON.stringify(sessionData));
        },
        loadHistory() {
            const savedData = localStorage.getItem(App.config.STORAGE_KEY);
            if (savedData) {
                try {
                    const sessionData = JSON.parse(savedData);
                    if (sessionData.chatHistory && sessionData.userState) {
                        App.state.chatHistory = sessionData.chatHistory;
                        App.state.userState = sessionData.userState;
                        App.state.pinnedMessageId = sessionData.pinnedMessageId || null;
                        if (App.state.userState.step > 0) {
                            App.elements.welcomeScreen.classList.add('hidden');
                            App.elements.userDataScreen.classList.add('hidden');
                            App.elements.chatContainer.classList.remove('hidden');
                            App.ui.rebuildChatUI();
                            App.ui.togglePlanCTA();
                            App.ui.updatePinnedMessageUI();
                        }
                    }
                } catch (e) { console.error("Failed to load saved history:", e); localStorage.removeItem(App.config.STORAGE_KEY); }
            }
        },
        buildConversationContext() { let context = ''; const history = [...App.state.chatHistory]; for (let i = history.length - 1; i >= 0; i--) { const message = history[i]; const role = message.role === 'assistant' ? 'Ø§Ù„Ù…Ø¯Ø±Ø¨' : 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'; const text = message.parts?.[0]?.text || ''; const formattedMessage = `\n${role}: ${text}`; if ((context.length + formattedMessage.length) > App.config.MAX_PROMPT_CHARS) { break; } context = formattedMessage + context; } return context; },
        buildInternalStateSummary() { const d=App.state.userState.data||{}; const f=[]; if(d.name)f.push(`Ø§Ù„Ø§Ø³Ù…: ${d.name}`); if(d.age)f.push(`Ø§Ù„Ø¹Ù…Ø±: ${d.age}`); if(d.country)f.push(`Ø§Ù„Ø¯ÙˆÙ„Ø©: ${d.country}`); if(d.goal)f.push(`Ø§Ù„Ù‡Ø¯Ù: ${d.goal}`); if(d.health)f.push(`Ø­Ø§Ù„Ø© ØµØ­ÙŠØ©: ${d.health}`); if(d.gym)f.push(`Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†: ${d.gym}`); if(d.meals)f.push(`ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…: ${d.meals}`); return f.length ? `ğŸ—’ï¸ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø©: ${f.join(' | ')}` : ''; },
        analyzeUserMessage(msg) { const MED_FLAGS=/(Ø³ÙƒØ±ÙŠ|Ø¶ØºØ·|Ù‚Ù„Ø¨|Ø³Ø±Ø·Ø§Ù†|Ø­Ø§Ù…Ù„|Ø­Ù…Ù„|Ø±Ø¶Ø§Ø¹Ø©|ØºØ¯Ø©|Ø¯Ø±Ù‚|ÙƒØ¨Ø¯|ÙƒÙ„Ùˆ[ÙŠØ©]|kidney|liver|thyroid|injury|Ø¥ØµØ§Ø¨Ø©|Ø¹Ù…Ù„ÙŠØ©|Ø¯ÙˆØ§Ø¡|Ø£Ø¯ÙˆÙŠØ©|ÙƒÙˆØ±ØªÙŠØ²ÙˆÙ†|Ø¶ØºØ· Ø§Ù„Ø¯Ù…|Ø³ÙƒØ± Ø§Ù„Ø¯Ù…)/i; if (MED_FLAGS.test(msg)) { App.state.userState.data.health = (App.state.userState.data.health || 'Ù‚ÙŠÙˆØ¯ ØµØ­ÙŠØ©'); } if (/Ø®Ø·Ø©|Ø£Ø®Ø³|ØªØ®Ø³ÙŠØ³|ØªØ¶Ø®ÙŠÙ…|Ø¹Ø¶Ù„/i.test(msg)) App.state.userState.data.goal = App.state.userState.data.goal || 'Ø®Ø·Ø© Ù…Ø®ØµØµØ©'; if (/Ø¬ÙŠÙ…|Ø¨ÙŠØª|Ù…Ù†Ø²Ù„/i.test(msg)) App.state.userState.data.gym = App.state.userState.data.gym || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; },
        async processAIResponse(message, images = []) {
            const typingEl = App.ui.showTyping('ai'); const L = App.i18n.strings[App.state.lang];
            const imagePromptPart = images.length > 0 ? App.prompts.buildImagePrompt() : '';
            const fullPrompt = `${App.prompts.buildCoachSystemPrompt()}\n${this.buildInternalStateSummary() ? this.buildInternalStateSummary() + '\n' : ''}Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„):\n${this.buildConversationContext()}\n\nUser Message: (${images.length > 0 ? L.imageAttached : ''} ${message})\n${imagePromptPart}`;
            let response = await App.services.callAI(fullPrompt, { images });
            App.utils.removeNode(typingEl);
            if (!response || !response.trim()) { response = (App.state.lang === 'ar') ? 'Ø­ØµÙ„ Ø®Ø·Ø£ Ø¨Ø³ÙŠØ·ØŒ Ù…Ù…ÙƒÙ† ØªÙˆØ¶Ø­ Ø³Ø¤Ø§Ù„Ùƒ ØªØ§Ù†ÙŠØŸ' : 'There was a slight error, could you please clarify your question?'; }
            const newMessage = { id: `ai-${Date.now()}`, role: 'assistant', parts: [{ text: response }], timestamp: Date.now() };
            App.state.chatHistory.push(newMessage); this.saveHistory(); App.ui.displayMessage(newMessage); App.ui.togglePlanCTA();
        },
        sendMessage() {
            const msg = (App.elements.userInput.value || '').trim(); 
            const images = App.state.pendingImages;
            if (!msg && images.length === 0) return;
            
            App.i18n.autoSetByText(msg);
            
            const messageContent = images.length > 0 ? `${App.i18n.strings[App.state.lang].imageAttached} ${msg}`.trim() : msg;
            
            const newMessage = { 
                id: `user-${Date.now()}`, 
                role: 'user', 
                parts: [{ text: msg }], // Send only text part to history for context
                images: images.map(img => img.dataUrl), // Keep images for UI display
                timestamp: Date.now() 
            };
            
            App.state.chatHistory.push({
                 id: newMessage.id,
                 role: 'user',
                 parts: [{ text: messageContent }], // Save combined text for AI context
                 timestamp: newMessage.timestamp
            });

            this.saveHistory();
            App.ui.displayMessage(newMessage); // Display with images in UI
            
            this.analyzeUserMessage(msg); 
            this.processAIResponse(msg, images.map(img => img.dataUrl));
            
            App.elements.userInput.value = ''; 
            App.handlers.clearPendingImages();
        }
      },
      handlers: {
        handleStartClick() { App.elements.welcomeScreen.classList.add('hidden'); App.elements.userDataScreen.classList.remove('hidden'); App.i18n.setLang(App.state.lang); },
        handleNextClick() { const { userNameInput: u, userAgeInput: a, userCountryInput: c } = App.elements; const n=u.value.trim(),g=a.value.trim(),o=c.value.trim(); App.i18n.autoSetByText(n||o); if(!n||!g||!o){App.utils.toast(App.i18n.strings[App.state.lang].emptyFields);return;} App.state.userState.data={...App.state.userState.data,name:n,age:g,country:o}; App.state.userState.step = 1; App.elements.userDataScreen.classList.add('hidden'); App.elements.chatContainer.classList.remove('hidden'); const welcomeMsg = (App.state.lang==='ar') ? `Ø£Ù‡Ù„Ù‹Ø§ Ø¨ÙŠÙƒ ÙŠØ§ ${n}ØŒ Ù…Ø¹Ø§Ùƒ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ. Ø¬Ø§Ù‡Ø² Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒØŸ Ø¥ÙŠÙ‡ Ù‡Ø¯ÙÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØŸ` : `Welcome, ${n}! I'm assistant to international coach Mustafa Elsafy. Ready to start your journey? What's your main goal?`; const firstMessage = {id: `ai-${Date.now()}`, role:'assistant', parts:[{text:welcomeMsg}], timestamp: Date.now()}; App.state.chatHistory = [firstMessage]; App.core.saveHistory(); App.ui.displayMessage(firstMessage); App.ui.togglePlanCTA(); },
        handleKeyPress(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); App.core.sendMessage(); } },
        handleFileChange(e) {
            const files = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
            if (!files.length) return;

            const filePromises = files.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => resolve({
                        id: `${Date.now()}-${file.name}`,
                        dataUrl: ev.target.result
                    });
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });

            Promise.all(filePromises).then(newImages => {
                App.state.pendingImages.push(...newImages);
                App.ui.renderImagePreviews();
            });

            e.target.value = '';
        },
        clearPendingImages() { App.state.pendingImages = []; App.ui.renderImagePreviews(); },
        handleRemoveImage(id) { App.state.pendingImages = App.state.pendingImages.filter(img => img.id !== id); App.ui.renderImagePreviews(); },
        handleViewImage(dataUrl) { App.elements.fullImageView.src = dataUrl; App.elements.imageViewerModal.classList.add('open'); },
        closeImageViewer() { App.elements.imageViewerModal.classList.remove('open'); },
        handleMicRecord(e) { e.preventDefault(); App.services.speech.startRecording(); },
        handleMicStop(e) { e.preventDefault(); App.services.speech.stopRecording(); },
        openContactModal() { App.elements.contactModal.classList.add('open'); App.elements.contactModal.setAttribute('aria-hidden', 'false'); },
        closeContactModal() { App.elements.contactModal.classList.remove('open'); App.elements.contactModal.setAttribute('aria-hidden', 'true'); },
        handleIherbCopy(e) { e.preventDefault(); const { copyAndGoIherbBtn, iherbCode } = App.elements; if (!copyAndGoIherbBtn || !iherbCode) return; const code = iherbCode.textContent.trim(); navigator.clipboard.writeText(code).then(() => { App.utils.toast(App.i18n.strings[App.state.lang].iherbCopiedAndRedirecting); setTimeout(() => { window.open(copyAndGoIherbBtn.href, '_blank'); }, 800); }); },
        handleIherbCodeClick() { const code = App.elements.iherbCode.textContent.trim(); navigator.clipboard.writeText(code).then(() => App.utils.toast(App.i18n.strings[App.state.lang].copied)); },
        openProfileModal() { App.elements.profileModal.classList.add('open'); App.elements.profileModal.setAttribute('aria-hidden', 'false'); },
        closeProfileModal() { App.elements.profileModal.classList.remove('open'); App.elements.profileModal.setAttribute('aria-hidden', 'true'); },
        handleProfileGetPlanClick() { this.closeProfileModal(); this.openContactModal(); },
        handleResetClick() { App.elements.resetConfirmModal.classList.add('open'); },
        handleResetConfirm() { localStorage.removeItem(App.config.STORAGE_KEY); window.location.reload(); },
        handleResetCancel() { App.elements.resetConfirmModal.classList.remove('open'); },
        handleModalClick(e) { if (e.target === App.elements.contactModal) this.closeContactModal(); if (e.target === App.elements.profileModal) this.closeProfileModal(); if (e.target === App.elements.resetConfirmModal) this.handleResetCancel(); if (e.target === App.elements.imageViewerModal) this.closeImageViewer(); },
        addMessageEventListeners(bubble) {
            bubble.addEventListener('pointerdown', (e) => this.handleLongPressStart(e, bubble));
            bubble.addEventListener('pointerup', this.handleLongPressEnd);
            bubble.addEventListener('pointerleave', this.handleLongPressEnd);
            bubble.addEventListener('contextmenu', e => e.preventDefault());
        },
        handleLongPressStart(e, bubble) { if (App.state.longPressTimer) clearTimeout(App.state.longPressTimer); App.state.longPressTimer = setTimeout(() => { this.showContextMenu(bubble); }, App.config.LONG_PRESS_DURATION); },
        handleLongPressEnd() { clearTimeout(App.state.longPressTimer); },
        showContextMenu(bubble) {
            const { messageContextMenu } = App.elements;
            const messageId = bubble.dataset.messageId;
            const message = App.state.chatHistory.find(m => m.id === messageId);
            if (!message) return;
            
            App.state.currentContextMenu = { bubble, message };
            const isPinned = App.state.pinnedMessageId === messageId;
            const L = App.i18n.strings[App.state.lang];
            messageContextMenu.querySelector('[data-action="pin"] span').textContent = isPinned ? L.contextUnpin : L.contextPin;
            
            const rect = bubble.getBoundingClientRect();
            document.body.appendChild(messageContextMenu);
            messageContextMenu.style.top = `${window.scrollY + rect.top - messageContextMenu.offsetHeight - 10}px`;
            messageContextMenu.style.left = `${rect.left + (rect.width / 2) - (messageContextMenu.offsetWidth / 2)}px`;
            messageContextMenu.classList.add('show');
        },
        hideContextMenu() { App.elements.messageContextMenu.classList.remove('show'); App.state.currentContextMenu = null; },
        handleContextMenuAction(action) {
            const { message } = App.state.currentContextMenu;
            const L = App.i18n.strings[App.state.lang];
            const textContent = message.parts[0].text;
            
            if (action === 'copy') { navigator.clipboard.writeText(textContent).then(() => App.utils.toast(L.copied)); } 
            else if (action === 'share') { if (navigator.share) { navigator.share({ text: textContent }).then(() => App.utils.toast(L.sharedSuccessfully)).catch(() => App.utils.toast(L.shareFailed)); } else { App.utils.toast(L.shareFailed); } }
            else if (action === 'pin') { App.state.pinnedMessageId = (App.state.pinnedMessageId === message.id) ? null : message.id; App.core.saveHistory(); App.ui.updatePinnedMessageUI(); }
            this.hideContextMenu();
        },
        handleUnpin() { App.state.pinnedMessageId = null; App.core.saveHistory(); App.ui.updatePinnedMessageUI(); }
      },
      init() {
        document.addEventListener('DOMContentLoaded', () => {
          this.cacheElements();
          const savedTheme = localStorage.getItem('theme');
          if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); this.elements.btnTheme.textContent = 'ğŸŒ™'; }
          this.i18n.setLang(navigator.language.startsWith('ar') ? 'ar' : 'en');
          this.core.loadHistory();

          const { elements: E, handlers: H } = this;
          E.startBtn.addEventListener('click', H.handleStartClick);
          E.nextBtn.addEventListener('click', () => H.handleNextClick.call(App));
          E.sendBtn.addEventListener('click', () => App.core.sendMessage.call(App.core));
          E.userInput.addEventListener('keypress', H.handleKeyPress);
          E.btnTheme.addEventListener('click', this.utils.setTheme);
          E.plusBtn.addEventListener('click', () => E.fileInput.click());
          E.fileInput.addEventListener('change', H.handleFileChange);
          E.closeContactBtn.addEventListener('click', H.closeContactModal);
          E.contactModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          E.generatePlanBtn.addEventListener('click', H.openContactModal);
          E.copyAndGoIherbBtn.addEventListener('click', H.handleIherbCopy);
          E.iherbCode.addEventListener('click', () => H.handleIherbCodeClick.call(H));
          E.chatAvatar.addEventListener('click', H.openProfileModal);
          E.closeProfileBtn.addEventListener('click', H.closeProfileModal);
          E.profileModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          E.profileGetPlanBtn.addEventListener('click', () => H.handleProfileGetPlanClick.call(H));
          E.resetBtn.addEventListener('click', H.handleResetClick);
          E.confirmResetBtn.addEventListener('click', H.handleResetConfirm);
          E.cancelResetBtn.addEventListener('click', H.handleResetCancel);
          E.resetConfirmModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          E.messageContextMenu.addEventListener('click', (e) => { const action = e.target.closest('[data-action]')?.dataset.action; if (action) H.handleContextMenuAction.call(H, action); });
          document.addEventListener('click', (e) => { if (E.messageContextMenu && !E.messageContextMenu.contains(e.target)) H.hideContextMenu.call(H); });
          E.unpinBtn.addEventListener('click', H.handleUnpin);
          E.pinnedMessageArea.addEventListener('click', (e) => { if (e.target !== E.unpinBtn && !E.unpinBtn.contains(e.target)) { const msgEl = document.querySelector(`[data-message-id="${App.state.pinnedMessageId}"]`); if (msgEl) msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); } });
          document.querySelectorAll('.lang-toggle-btn').forEach(btn => { btn.addEventListener('click', () => this.i18n.setLang(this.state.lang === 'ar' ? 'en' : 'ar')); });
          ['pointerdown','touchstart'].forEach(ev=>E.micBtn.addEventListener(ev, H.handleMicRecord,{passive:false}));
          ['pointerup','touchend','mouseleave'].forEach(ev=>E.micBtn.addEventListener(ev, H.handleMicStop,{passive:false}));
          E.closeImageViewerBtn.addEventListener('click', H.closeImageViewer);
          E.imageViewerModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          initUIEnhancements();
        });
      }
    };
    window.App = App;
    App.init();
  </script>
</body>
</html>


