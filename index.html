<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>مدربك الصحي الذكي | Your Smart Health Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
    :root { --primary:#04364A; --secondary:#176B87; --accent:#64CCC5; --chat-bg:#F8F9FA; --bubble-user:#DCF8C6; --bubble-ai:#fff; --backdrop:rgba(2,6,23,.55); }
    html.dark { --primary:#1F2937; --secondary:#374151; --accent:#10B981; --chat-bg:#111827; --bubble-user:#4B5563; --bubble-ai:#374151; --backdrop:rgba(0,0,0,.7); }
    *{box-sizing:border-box}
    body{font-family:'Tajawal',sans-serif;background:var(--chat-bg);color:#333;transition:background-color .3s,color .3s}
    .dark body{color:#E5E7EB}

    /* Chat shell */
    .chat-container{max-width:720px;margin:0 auto;height:100vh;display:flex;flex-direction:column;background:var(--chat-bg);box-shadow:0 0 25px rgba(0,0,0,.08);border-radius:1rem;overflow:hidden}
    .chat-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:.875rem 1rem;position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center}
    .chat-messages{flex:1;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:6rem}
    .message-bubble{padding:.85rem 1.15rem;border-radius:1.25rem;max-width:82%;margin-bottom:.75rem;animation:fadeIn .25s ease-in-out}
    .message-bubble.user{background:var(--bubble-user);margin-left:auto;border-bottom-right-radius:.25rem}
    .message-bubble.ai{background:var(--bubble-ai);margin-right:auto;border-bottom-left-radius:.25rem}

    .input-area{display:flex;gap:.5rem;padding:.75rem;background:#F8F9FA;border-top:1px solid #E0E0E0;position:sticky;bottom:0;z-index:10;align-items:center}
    .dark .input-area{background:#1F2937;border-top-color:#374151}
    .input-area input[type=text]{flex:1;border-radius:2rem;padding:.75rem 1.2rem;border:1px solid #CCC;background:#fff}
    .dark .input-area input[type=text]{background:#374151;border-color:#4B5563;color:#E5E7EB}
    .input-area input[type=text]:focus{border-color:var(--accent)}
    .icon-btn{background:transparent;color:var(--secondary);border-radius:999px;width:44px;height:44px;display:grid;place-items:center;transition:.25s}
    .icon-btn:hover{background:rgba(0,0,0,.06)}
    .send-btn{background:var(--accent);color:#fff}

    .welcome-screen,.user-data-screen{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .cta-btn{background:var(--accent);font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.25);padding:1rem 2rem;border-radius:999px}

    .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:.85rem 1rem;border-radius:.5rem;z-index:60;opacity:0;transition:.4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* Plan Modal */
    .plan-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--backdrop);z-index:50}
    .plan-modal.open{display:flex}
    .plan-modal-content{width:min(920px,96vw);max-height:86vh;overflow:hidden;background:#fff;border-radius:1rem;box-shadow:0 20px 60px rgba(0,0,0,.25);display:flex;flex-direction:column}
    .dark .plan-modal-content{background:#0f172a;color:#E5E7EB}
    .plan-modal-header{display:flex;justify-content:space-between;align-items:center;padding:.85rem 1rem;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .plan-modal-body{padding:1rem 1rem .5rem;overflow-y:auto}
    .close-button{background:transparent;color:#fff;font-size:1.75rem;line-height:1;padding:0 .25rem}
    .skeleton{display:block;height:1rem;width:100%;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:shimmer 1.2s infinite;border-radius:.35rem}
    .dark .skeleton{background:linear-gradient(90deg,#374151,#4b5563,#374151)}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    .plan-actions{display:flex;gap:.5rem;padding:.85rem 1rem 1rem;border-top:1px solid #e5e7eb}
    .btn{padding:.6rem 1rem;border-radius:.6rem;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:#6B7280;color:#fff}

    .typewriter-text{font-size:1.05rem;font-weight:600;color:var(--primary)}
    .dark .typewriter-text{color:var(--accent)}

    /* Section cards */
    .section-card{border:1px solid #e5e7eb;border-radius:.75rem;overflow:hidden;margin-bottom:1rem}
    .section-head{display:flex;justify-content:space-between;align-items:center;background:#f9fafb;padding:.6rem .8rem;font-weight:800}
    .dark .section-head{background:#111827;color:#E5E7EB}
    .section-body{padding:.8rem}

    .footer{text-align:center;padding:.75rem;font-size:.9rem;color:#6b7280}
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">
  <!-- Welcome -->
  <div class="welcome-screen" id="welcomeScreen">
    <img src="https://placehold.co/150x150/ffffff/0D47A1?text=AI+Coach" alt="AI Coach Avatar" class="rounded-full mb-6 shadow-xl"/>
    <h1 class="text-4xl font-bold mb-2" id="welcomeTitle">مدربك الصحي الشخصي</h1>
    <p class="text-xl font-light text-white/90 mb-8" id="welcomeSubtitle">ابدأ رحلتك نحو الأفضل الآن</p>
    <button id="startBtn" class="cta-btn">ابدأ المحادثة</button>
  </div>

  <!-- Basic user data -->
  <div class="user-data-screen hidden" id="userDataScreen">
    <h2 class="text-3xl font-extrabold mb-4" id="userDataTitle">لنبدأ رحلتك</h2>
    <p class="text-white/90 mb-6" id="userDataSubtitle">أخبرنا عن نفسك لتبدأ</p>
    <div class="w-full max-w-sm">
      <input type="text" id="userName" class="block w-full mb-3 rounded-md px-4 py-3 text-right bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="اسمك" dir="rtl">
      <input type="number" id="userAge" class="block w-full mb-3 rounded-md px-4 py-3 text-left bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="عمرك" dir="ltr">
      <input type="text" id="userCountry" class="block w-full mb-3 rounded-md px-4 py-3 text-right bg-white/10 border border-white/30 text-white placeholder-white/60 focus:bg-white/20" placeholder="دولتك" dir="rtl">
      <button id="nextBtn" class="cta-btn w-full mt-2">التالي</button>
    </div>
  </div>

  <!-- Chat -->
  <div class="chat-container hidden" id="chatContainer">
    <div class="chat-header">
      <div class="flex items-center gap-2">
        <img src="https://placehold.co/40x40/ffffff/0D47A1?text=AI" alt="Coach AI Avatar" class="rounded-full"/>
        <span class="text-xl font-bold" id="chatTitle">Coach AI</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLang" class="icon-btn text-white border border-white/30 px-3 w-auto h-9 rounded-md">AR</button>
        <button id="btnTheme" class="icon-btn text-white border border-white/30 w-9 h-9 rounded-md">☀️</button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages" role="region" aria-label="Chat messages"></div>

    <!-- Smart CTA appears when data complete -->
    <div id="planButtonArea" class="px-4 py-3 hidden">
      <div class="rounded-xl bg-white shadow dark:bg-slate-800 p-3 flex items-center justify-between">
        <div class="typewriter-text"><span id="prepStatus">جاهز نبني خطتك المخصصة؟</span></div>
        <button id="generatePlanBtn" class="btn btn-primary" disabled>احصل على خطتك الآن</button>
      </div>
      <p id="planButtonNote" class="text-gray-500 text-sm mt-2">يمكنك الاستمرار في الحديث إذا كانت لديك أي استفسارات أخرى.</p>
    </div>

    <div class="input-area" id="inputArea">
      <input type="text" id="userInput" placeholder="اكتب رسالتك..." dir="rtl" />
      <input type="file" id="imageInput" accept="image/*" class="hidden" />
      <button id="plusBtn" class="icon-btn" aria-label="أرسل ملف">➕</button>
      <button id="sendBtn" class="icon-btn send-btn" aria-label="أرسل">📤</button>
    </div>
  </div>

  <!-- Plan Modal (overlay above chat) -->
  <div id="planModal" class="plan-modal" aria-modal="true" aria-hidden="true" role="dialog" aria-labelledby="planModalTitle">
    <div class="plan-modal-content">
      <div class="plan-modal-header">
        <h3 id="planModalTitle" class="text-lg font-extrabold">خطتك المخصصة</h3>
        <button id="closePlanBtn" class="close-button" title="إغلاق" aria-label="إغلاق">×</button>
      </div>
      <div id="planOutput" class="plan-modal-body">
        <!-- Progressive placeholder -->
        <div class="mb-4">
          <p class="typewriter-text">جارٍ تحضير الخطة قسمًا قسمًا…</p>
          <span class="skeleton" style="height:12px;width:85%"></span>
          <span class="skeleton mt-2" style="height:12px;width:92%"></span>
          <span class="skeleton mt-2" style="height:12px;width:75%"></span>
        </div>
      </div>
      <div class="plan-actions">
        <button id="printBtn" class="btn btn-primary">طباعة الخطة</button>
        <button id="expandAllBtn" class="btn btn-secondary">عرض كل الأقسام</button>
      </div>
    </div>
  </div>

  <footer class="footer">© 2025 مصطفى الصافي</footer>

  <script type="module">
    /* ==========================
       Elements & State
    ===========================*/
    const $ = id => document.getElementById(id);
    const chatMessages = $('chatMessages');
    const userInput = $('userInput');
    const sendBtn = $('sendBtn');
    const startBtn = $('startBtn');
    const nextBtn = $('nextBtn');
    const welcomeScreen = $('welcomeScreen');
    const userDataScreen = $('userDataScreen');
    const chatContainer = $('chatContainer');
    const userNameInput = $('userName');
    const userAgeInput = $('userAge');
    const userCountryInput = $('userCountry');
    const btnTheme = $('btnTheme');
    const btnLang = $('btnLang');
    const plusBtn = $('plusBtn');
    const imageInput = $('imageInput');
    const planButtonArea = $('planButtonArea');
    const generatePlanBtn = $('generatePlanBtn');
    const planModal = $('planModal');
    const closePlanBtn = $('closePlanBtn');
    const planOutput = $('planOutput');
    const printBtn = $('printBtn');
    const expandAllBtn = $('expandAllBtn');

    let userState = { step: 0, data: {} };
    let LANG = 'ar';
    let chatHistory = [];

    /* ==========================
       i18n
    ===========================*/
    const i18n = {
      ar: {
        welcomeTitle: 'مدربك الصحي الشخصي',
        welcomeSubtitle: 'ابدأ رحلتك نحو الأفضل الآن',
        startButtonText: 'ابدأ المحادثة',
        userDataTitle: 'لنبدأ رحلتك',
        userDataSubtitle: 'أخبرنا عن نفسك لتبدأ',
        namePlaceholder: 'اسمك', agePlaceholder: 'عمرك', countryPlaceholder: 'دولتك', nextButtonText: 'التالي',
        chatTitle: 'Coach AI', inputPlaceholder: 'اكتب رسالتك...',
        emptyFields: 'الرجاء إدخال اسمك وعمرك ودولتك للبدء.', imageUpload: 'تم استلام الصورة.',
        generationStart: 'جاري تجهيز الخطة… قسمًا قسمًا.', generationDone: 'الخطة جاهزة. لو محتاج تعديل، بلغني.',
        initialPrompt: 'أهلاً يا {name}. هنشتغل خطوة بخطوة لغاية ما نطلع خطة دقيقة ومناسبة لك.',
        planButtonText: 'احصل على خطتك الآن', planButtonNote: 'تقدر تكمل الحديث لو عندك أي استفسار.',
        planPreparingInModal: 'جاري تحضير الخطة في نافذة فوق المحادثة.'
      },
      en: {
        welcomeTitle: 'Your Personal Health Coach', welcomeSubtitle: 'Start your journey to a better you now', startButtonText: 'Start Chat',
        userDataTitle: 'Let’s start your journey', userDataSubtitle: 'Tell us about yourself to begin', namePlaceholder: 'Your Name', agePlaceholder: 'Your Age', countryPlaceholder: 'Your Country', nextButtonText: 'Next',
        chatTitle: 'Coach AI', inputPlaceholder: 'Type your message...', emptyFields: 'Please enter your name, age, and country to get started.', imageUpload: 'Image received.',
        generationStart: 'Preparing your plan… section by section.', generationDone: 'Plan is ready. If you need changes, tell me.',
        initialPrompt: 'Hi {name}. We’ll work step by step to build a precise plan that fits you.',
        planButtonText: 'Get Your Plan Now', planButtonNote: 'You can keep chatting if you have questions.', planPreparingInModal: 'Preparing the plan in a modal above the chat.'
      }
    };
    function setLang(lang){
      LANG = lang; document.documentElement.lang = lang; document.documentElement.dir = lang==='ar'?'rtl':'ltr';
      const L = i18n[LANG];
      $('welcomeTitle').textContent = L.welcomeTitle; $('welcomeSubtitle').textContent = L.welcomeSubtitle; $('userDataTitle').textContent = L.userDataTitle; $('userDataSubtitle').textContent = L.userDataSubtitle;
      $('userName').placeholder = L.namePlaceholder; $('userAge').placeholder = L.agePlaceholder; $('userCountry').placeholder = L.countryPlaceholder; $('nextBtn').textContent = L.nextButtonText;
      $('chatTitle').textContent = L.chatTitle; $('userInput').placeholder = L.inputPlaceholder; $('generatePlanBtn').textContent = L.planButtonText; $('planButtonNote').textContent = L.planButtonNote;
      btnLang.textContent = lang==='ar' ? 'AR' : 'EN';
    }

    /* ==========================
       Utilities
    ===========================*/
    function setTheme(){ document.documentElement.classList.toggle('dark'); btnTheme.textContent = document.documentElement.classList.contains('dark') ? '🌙' : '☀️'; localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light') }
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.style.opacity=1,10); setTimeout(()=>{t.style.opacity=0; setTimeout(()=>t.remove(),400)},2600) }
    function displayMessage(message, sender){ const b=document.createElement('div'); b.classList.add('message-bubble', sender); b.innerHTML = marked.parse(message); chatMessages.appendChild(b); chatMessages.scrollTop = chatMessages.scrollHeight }
    function isDataComplete(){ return ['name','age','country'].every(k => !!userState.data[k]) }
    function togglePlanCTA(){ const ready = isDataComplete(); planButtonArea.classList.toggle('hidden', !ready); generatePlanBtn.disabled = !ready }

    /* ==========================
       AI Prompts (Natural tone, no AI mentions)
    ===========================*/
    function buildCoachSystemPrompt(){
      return `
اكتب ردودًا طبيعية ومهنية دون مبالغة أو عبارات إنشائية، ولا تذكر أنظمة أو روبوتات.
الدور: مدرب صحي وأخصائي تغذية وطبيب.
المهمة: جمع البيانات تدريجيًا (حتى سؤالين في كل رسالة)، إبداء ملاحظات مختصرة عند ذكر أمراض/أدوية/إصابات، ثم تلخيص وطلب تأكيد قبل بناء الخطة.
`}

    function buildPlanJSONPrompt(){
      return `أعِد فقط JSON صالحًا بدون أي نص آخر أو أسوار كود.
{
  "analysis": string | string[],
  "allowed": { "allowed": string[], "forbidden": string[] } | string,
  "nutrition": [ { "day": number, "meals": [ { "name": string, "items": string[], "kcal": number, "protein_g": number } ] } ],
  "training": [ { "day": number, "session": [ { "exercise": string, "sets": number, "reps": string, "notes": string } ], "duration_min": number, "location": "gym"|"home", "equipment": string[] } ],
  "supplements": string | [ { "name": string, "dose": string, "timing": string, "notes": string } ],
  "safety": string[] | string,
  "closing": string
}
المحادثة:
${chatHistory.map(m=>`${m.role}: ${m.parts[0].text}`).join('\n')}`}

    function buildPlanMDPrompt(){
      return `اكتب خطة Markdown واضحة بالعناوين التالية فقط:
## التحليل
## المسموح والممنوع
## التغذية (7 أيام)
## التدريب (7 أيام)
## المكملات
## السلامة
## الختام

اعتمد على المحادثة التالية:
${chatHistory.map(m=>`${m.role}: ${m.parts[0].text}`).join('\n')}`}

    async function callAI(prompt){
      try{ const res = await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})}); const data = await res.json(); return data.text || '' }catch(e){ console.error(e); return '' }
    }

    /* ==========================
       Message analysis & triggers
    ===========================*/
    const MED_FLAGS = /(سكري|ضغط|قلب|سرطان|حامل|حمل|رضاعة|غدة|درق|كبد|كلو[ية]|kidney|liver|thyroid|injury|إصابة|عملية|دواء|أدوية|كورتيزون|ضغط الدم|سكر الدم)/i;
    function isPlanRequest(msg){ return /(الخطة|خطة|خطه|اعمل\s*خطة|جهز\s*الخطة|عايز\s*الخطة|generate\s*plan|my\s*plan)/i.test(msg) }
    function analyzeUserMessage(msg){ if(MED_FLAGS.test(msg)){ displayMessage('تم تسجيل ملاحظة صحية. سنأخذها في الاعتبار ونضيف احتياطات مناسبة. لو فيه تفاصيل إضافية اكتبها.', 'ai') } }

    /* ==========================
       Modal helpers
    ===========================*/
    function openPlanModal(){ planModal.classList.add('open'); planModal.setAttribute('aria-hidden','false') }
    function closePlanModal(){ planModal.classList.remove('open'); planModal.setAttribute('aria-hidden','true') }
    function lockInputs(state){ userInput.disabled = state; sendBtn.disabled = state; plusBtn.disabled = state; generatePlanBtn.disabled = state && !isDataComplete() }

    function sectionBlock(title, html=''){
      const s=document.createElement('section'); s.className='section-card';
      const h=document.createElement('div'); h.className='section-head'; h.innerHTML=`<span>${title}</span><span aria-hidden="true">−</span>`;
      const b=document.createElement('div'); b.className='section-body'; b.innerHTML=html||'<span class="skeleton" style="height:12px;width:90%"></span>';
      h.addEventListener('click',()=>{ const hidden=b.style.display==='none'; b.style.display=hidden?'block':'none'; h.lastElementChild.textContent=hidden?'−':'＋' });
      s.appendChild(h); s.appendChild(b); return {wrapper:s, body:b}
    }

    const toMD = v => Array.isArray(v) ? v.map(x=>`- ${x}`).join('\n') : (typeof v==='string' ? v : JSON.stringify(v,null,2));
    function buildNutritionMD(days){ if(!Array.isArray(days)) return toMD(days); return days.map((d,i)=>{ const meals=(d.meals||[]).map(m=>`- **${m.name||'وجبة'}**: ${(m.items||[]).join(', ')}${m.kcal?` — ${m.kcal} ك.س`:''}${m.protein_g?` | بروتين: ${m.protein_g}غ`:''}`).join('\n'); return `### اليوم ${d.day||i+1}\n${meals}` }).join('\n\n') }
    function buildTrainingMD(days){ if(!Array.isArray(days)) return toMD(days); return days.map((d,i)=>{ const exs=(d.session||[]).map(ex=>`- **${ex.exercise||'تمرين'}** — ${ex.sets||''}×${ex.reps||''}${ex.notes?` (${ex.notes})`:''}`).join('\n'); const meta=[]; if(d.duration_min) meta.push(`المدة: ${d.duration_min} د`); if(d.location) meta.push(`المكان: ${d.location}`); return `### اليوم ${d.day||i+1}${meta.length?` — ${meta.join(' | ')}`:''}\n${exs}` }).join('\n\n') }
    function buildSuppsMD(s){ if(Array.isArray(s)) return s.map(x=>`- **${x.name}** — ${x.dose}${x.timing?` (${x.timing})`:''}${x.notes?` — ${x.notes}`:''}`).join('\n'); return toMD(s) }

    async function fetchJSONPlan(){
      let raw = await callAI(buildPlanJSONPrompt()); if(!raw) return null; let txt = raw.trim();
      // strip code fences if present
      if(txt.startsWith('```')){ txt = txt.replace(/^```json/i,'').replace(/^```/i,''); if(txt.endsWith('```')) txt = txt.slice(0,-3); txt = txt.trim(); }
      try{ return JSON.parse(txt) }catch(_){ const s=txt.indexOf('{'); const e=txt.lastIndexOf('}'); if(s>-1 && e>-1 && e>s){ try{ return JSON.parse(txt.slice(s,e+1)) }catch(__){} } }
      return null;
    }

    async function generatePlanProgressive(){
      openPlanModal(); planOutput.innerHTML='';

      const sections = [
        { key:'analysis', title:'التحليل' },
        { key:'allowed', title:'المسموح والممنوع' },
        { key:'nutrition', title:'التغذية (7 أيام)' },
        { key:'training', title:'التدريب (7 أيام)' },
        { key:'supps', title:'المكملات' },
        { key:'safety', title:'السلامة' },
        { key:'closing', title:'الختام' }
      ];
      const blocks = sections.map(s=>sectionBlock(s.title)); blocks.forEach(b=>planOutput.appendChild(b.wrapper));
      const delay = ms => new Promise(r=>setTimeout(r,ms));

      // 1) Try JSON plan for reliability
      const plan = await fetchJSONPlan();
      if(plan){
        const allowedMD = (()=>{ if(typeof plan.allowed==='string') return plan.allowed; if(plan.allowed&&(plan.allowed.allowed||plan.allowed.forbidden)){ const a=toMD(plan.allowed.allowed||[]); const f=toMD(plan.allowed.forbidden||[]); return `**مسموح:**\n${a}\n\n**ممنوع:**\n${f}` } return toMD(plan.allowed||'') })();
        const mdMap = {
          analysis: toMD(plan.analysis||''),
          allowed: allowedMD,
          nutrition: buildNutritionMD(plan.nutrition||[]),
          training: buildTrainingMD(plan.training||[]),
          supps: buildSuppsMD(plan.supplements||''),
          safety: toMD(plan.safety||''),
          closing: toMD(plan.closing||'')
        };
        for(let i=0;i<sections.length;i++){ await delay(i===0?250:180); const k=sections[i].key; const b=blocks[i].body; const content=(mdMap[k]||'').trim()||'—'; b.innerHTML = marked.parse(content) }
        return; // done
      }

      // 2) Fallback: Markdown split with tolerant regex
      const mdFull = await callAI(buildPlanMDPrompt());
      if(!mdFull){ for(let i=0;i<blocks.length;i++){ blocks[i].body.innerHTML = i===0 ? '<p class="text-red-600">تعذر توليد الخطة الآن.</p>' : '<p>—</p>'; } return }

      const map = {
        analysis: /##\s*التحليل\b([\s\S]*?)(?=##\s*(?:المسموح\s*و?\s*الممنوع)|$)/,
        allowed: /##\s*المسموح\s*و?\s*الممنوع\b([\s\S]*?)(?=##\s*(?:التغذية|التدريب|المكملات|السلامة|الختام)|$)/,
        nutrition: /##\s*التغذية\s*(?:[-–]\s*)?(?:\(\s*7\s*أيام\s*\)|7\s*أيام)?\b([\s\S]*?)(?=##\s*(?:التدريب|المكملات|السلامة|الختام)|$)/,
        training: /##\s*التدريب\s*(?:[-–]\s*)?(?:\(\s*7\s*أيام\s*\)|7\s*أيام)?\b([\s\S]*?)(?=##\s*(?:المكملات|السلامة|الختام)|$)/,
        supps: /##\s*المكملات\b([\s\S]*?)(?=##\s*(?:السلامة|الختام)|$)/,
        safety: /##\s*السلامة\b([\s\S]*?)(?=##\s*الختام|$)/,
        closing: /##\s*الختام\b([\s\S]*$)/
      };

      let matched = 0;
      for(let i=0;i<sections.length;i++){
        const k = sections[i].key; const b = blocks[i].body; const m = mdFull.match(map[k]); await delay(i===0?250:180);
        if(m && m[1] && m[1].trim()){ matched++; b.innerHTML = marked.parse(m[1].trim()) } else { b.innerHTML = '<p>—</p>' }
      }
      if(!matched){ blocks[0].body.innerHTML = marked.parse(mdFull) }
    }

    /* ==========================
       Events
    ===========================*/
    document.addEventListener('DOMContentLoaded',()=>{
      startBtn.addEventListener('click',()=>{ welcomeScreen.classList.add('hidden'); userDataScreen.classList.remove('hidden'); setLang(LANG) })
      nextBtn.addEventListener('click',()=>{ const name=(userNameInput.value||'').trim(); const age=(userAgeInput.value||'').trim(); const country=(userCountryInput.value||'').trim(); if(!name||!age||!country){ toast(i18n[LANG].emptyFields); return } userState.data = { ...userState.data, name, age, country }; userDataScreen.classList.add('hidden'); chatContainer.classList.remove('hidden'); const welcomeMsg = i18n[LANG].initialPrompt.replace('{name}',name); chatHistory.push({role:'assistant',parts:[{text:welcomeMsg}]}); displayMessage(welcomeMsg,'ai'); togglePlanCTA() })

      btnTheme.addEventListener('click', setTheme); btnLang.addEventListener('click', ()=> setLang(LANG==='ar' ? 'en' : 'ar'))
      plusBtn.addEventListener('click', ()=> imageInput.click()); imageInput.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload = ev => { displayMessage(`<img src="${ev.target.result}" class="max-w-[180px] rounded-lg my-2" alt="uploaded"/>`,'user'); toast(i18n[LANG].imageUpload) }; r.readAsDataURL(f) })

      async function processAIResponse(message){ lockInputs(true); const coachPrompt = `${buildCoachSystemPrompt()}\n\nسجل المحادثة:\n${chatHistory.map(m=>`${m.role}: ${m.parts[0].text}`).join('\n')}\n\nرسالة المستخدم الأخيرة: ${message}`; const response = await callAI(coachPrompt); chatHistory.push({role:'assistant',parts:[{text:response}]}); displayMessage(response||'…','ai'); lockInputs(false); togglePlanCTA() }

      function sendMessage(){ const message=(userInput.value||'').trim(); if(!message) return; displayMessage(message,'user'); chatHistory.push({role:'user',parts:[{text:message}]}); analyzeUserMessage(message); if(isPlanRequest(message)){ displayMessage(i18n[LANG].planPreparingInModal,'ai'); generatePlanProgressive(); userInput.value=''; return } processAIResponse(message); userInput.value='' }
      sendBtn.addEventListener('click', sendMessage); userInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage() })

      generatePlanBtn.addEventListener('click', async()=>{ displayMessage(i18n[LANG].generationStart,'ai'); await generatePlanProgressive(); displayMessage(i18n[LANG].generationDone,'ai') })
      closePlanBtn.addEventListener('click', ()=> closePlanModal()); planModal.addEventListener('click', e=>{ if(e.target===planModal) closePlanModal() })
      printBtn.addEventListener('click', ()=> window.print()); expandAllBtn.addEventListener('click', ()=>{ planOutput.querySelectorAll('.section-body').forEach(d=>d.style.display='block'); planOutput.querySelectorAll('.section-head span:last-child').forEach(ic=>ic.textContent='−') })

      const savedTheme = localStorage.getItem('theme'); if(savedTheme==='dark'){ document.documentElement.classList.add('dark'); btnTheme.textContent='🌙' } setLang('ar')
    })
  </script>
</body>
</html>
