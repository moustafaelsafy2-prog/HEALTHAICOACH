<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>مدربك الشخصي الذكي | Smart Personal Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* =================================================================
      -- 1. FONT & THEME VARIABLES (HEALTH & FITNESS THEME) --
    ================================================================= */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap');

    :root {
      --font-family-base: 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      
      /* Light Theme: Clean, Fresh, Energetic */
      --color-accent: #22C55E; --color-accent-hover: #16A34A;
      --color-bg-main: #F4F5F7; --color-bg-surface: #FFFFFF;
      --color-bubble-ai: #FFFFFF; --color-bubble-user: #DCFCE7;
      --color-text-primary: #1F2937; --color-text-secondary: #6B7280;
      --color-text-accent: #FFFFFF; --color-text-user-bubble: #14532D;
      --color-border: #E5E7EB;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    html.dark {
      /* Dark Theme: Focused, Modern, Techy */
      --color-accent: #4ADE80; --color-accent-hover: #22C55E;
      --color-bg-main: #111827; --color-bg-surface: #1F2937;
      --color-bubble-ai: #374151; --color-bubble-user: #166534;
      --color-text-primary: #F3F4F6; --color-text-secondary: #9CA3AF;
      --color-text-accent: #1F2937; --color-text-user-bubble: #D1FAE5;
      --color-border: #4B5563;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.25), 0 2px 4px -2px rgb(0 0 0 / 0.25);
    }

    /* =================================================================
      -- 2. BASE & TYPOGRAPHY --
    ================================================================= */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0; font-family: var(--font-family-base);
      background-color: var(--color-bg-main); color: var(--color-text-primary);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.3s, color 0.3s; line-height: 1.6;
    }

    /* =================================================================
      -- 3. APP SHELL & RESPONSIVE LAYOUT --
    ================================================================= */
    .app-shell {
      display: flex; flex-direction: column; height: 100vh; height: 100dvh;
      background-color: var(--color-bg-surface); overflow: hidden;
    }
    @media (min-width: 768px) {
      body { padding: 1rem; }
      .app-shell {
        max-width: 820px; margin: 0 auto; border-radius: 1.5rem; box-shadow: var(--shadow-md);
        height: calc(100dvh - 2rem); border: 1px solid var(--color-border);
      }
    }
    @media (min-width: 1024px) { body { padding: 2rem; } .app-shell { height: calc(100dvh - 4rem); } }

    /* =================================================================
      -- 4. WELCOME & PROFILE SCREENS --
    ================================================================= */
    .welcome-screen, .user-data-screen {
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; text-align: center;
      padding: 1.5rem; height: 100%; background-color: #000; color: #fff;
    }
    .welcome-screen::before, .user-data-screen::before {
      content: ''; position: absolute; inset: 0;
      background-image: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.6) 100%), url('https://images.unsplash.com/photo-1571902943202-507ec2618e8f?auto=format&fit=crop&w=1200&q=75');
      background-size: cover; background-position: center; opacity: 0.6; z-index: 1;
    }
    .welcome-screen > *, .user-data-screen > * { position: relative; z-index: 2; }
    .cta-btn {
      background-color: var(--color-accent); color: var(--color-text-accent);
      font-weight: 700; font-size: 1.1rem; padding: 0.9rem 3rem;
      border-radius: 50px; transition: all 0.25s ease; border: none; cursor: pointer;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
    }
    .cta-btn:hover {
      transform: translateY(-3px) scale(1.03); background-color: var(--color-accent-hover);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }
    #userDataScreen .w-full.max-w-sm {
      background: rgba(31, 41, 55, 0.5); backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    @keyframes pulse-animation { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
    .cta-btn-animated { animation: pulse-animation 2.5s infinite cubic-bezier(0.66, 0, 0, 1); }

    /* =================================================================
      -- 5. CHAT UI COMPONENTS (UPGRADED) --
    ================================================================= */
    .chat-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.75rem 1rem; background-color: var(--color-bg-surface);
      border-bottom: 1px solid var(--color-border); flex-shrink: 0; z-index: 20;
    }
    .brand img {
      width: 42px; height: 42px;
      border: 2px solid var(--color-accent); cursor: pointer;
    }
    .chat-messages {
      flex: 1; padding: 1rem; overflow-y: auto; background-color: var(--color-bg-main);
      -webkit-overflow-scrolling: touch;
      position: relative; /* Needed for the scroll-to-bottom button */
    }
    .message-bubble {
      max-width: 80%; padding: 0.5rem 1rem; border-radius: 12px; margin-bottom: 0.25rem;
      line-height: 1.6; word-wrap: break-word; box-shadow: var(--shadow-sm);
      animation: fadeIn 0.4s ease-out; display: flex; flex-direction: column;
      position: relative; -webkit-user-select: none; user-select: none;
    }
    .message-bubble.user {
      background-color: var(--color-bubble-user); color: var(--color-text-user-bubble);
      margin-left: auto; border-bottom-right-radius: 5px;
    }
    .message-bubble.ai {
      background-color: var(--color-bubble-ai); color: var(--color-text-primary);
      margin-right: auto; border: 1px solid var(--color-border); border-bottom-left-radius: 5px;
    }
    html[dir="rtl"] .message-bubble.user { margin-right: auto; margin-left: initial; border-bottom-right-radius: 5px; border-bottom-left-radius: 12px;}
    html[dir="rtl"] .message-bubble.ai { margin-left: auto; margin-right: initial; border-bottom-left-radius: 5px; border-bottom-right-radius: 12px;}

    .message-meta { display: flex; justify-content: flex-end; align-items: center; margin-top: 4px; }
    .message-time { font-size: 0.7rem; color: var(--color-text-secondary); opacity: 0.8; }
    html[dir="rtl"] .message-bubble.user .message-time { margin-right: 8px; }
    html[dir="ltr"] .message-bubble.user .message-time { margin-left: 8px; }
    
    .typing { display: flex; gap: 5px; align-items: center; padding: 0.5rem 0; }
    .typing .dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--color-text-secondary); animation: typing-blink 1.4s infinite both; }
    .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing-blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

    /* =================================================================
      -- 6. DYNAMIC CARDS (CTA & iHerb) --
    ================================================================= */
    .dynamic-card { border-radius: 1rem; border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); margin: 1rem 0; animation: fadeIn 0.5s ease-out; }
    #iherb-card { background: linear-gradient(100deg, var(--color-bubble-user), #fff); border-color: var(--color-accent); }
    html.dark #iherb-card { background: linear-gradient(100deg, #14532D, #1F2937); border-color: var(--color-accent); }
    
    /* =================================================================
      -- 7. INPUT AREA (WhatsApp Style) --
    ================================================================= */
    .input-area-wrapper { background-color: var(--color-bg-surface); padding: 0.5rem; padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); border-top: 1px solid var(--color-border); flex-shrink: 0; }
    .input-area { display: flex; align-items: flex-end; gap: 0.5rem; }
    .input-field-container { flex: 1; display: flex; align-items: center; background-color: var(--color-bg-main); border-radius: 22px; padding: 0.25rem 0.5rem; border: 1px solid var(--color-border); }
    .input-field-container:focus-within { border-color: var(--color-accent); }
    textarea#userInput { flex: 1; border: none; outline: none; background: transparent; padding: 0.6rem; font-family: var(--font-family-base); font-size: 1rem; color: var(--color-text-primary); resize: none; line-height: 1.5; max-height: 125px; }
    .icon-btn { display: inline-flex; justify-content: center; align-items: center; width: 44px; height: 44px; border-radius: 50%; border: none; background-color: transparent; color: var(--color-text-secondary); cursor: pointer; transition: background-color 0.2s, color 0.2s; flex-shrink: 0; }
    .icon-btn:hover { color: var(--color-accent); }
    .send-btn { background-color: var(--color-accent); color: var(--color-text-accent); }
    .send-btn:hover { background-color: var(--color-accent-hover); }
    .mic-btn.mic-live { color: #ef4444; background-color: rgba(239, 68, 68, 0.1); }
    
    /* =================================================================
      -- 8. MODALS & UTILITIES (UPGRADED) --
    ================================================================= */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(8px); z-index: 100; }
    .modal.open { display: flex; animation: fadeIn 0.3s; }
    .modal-content { width: min(520px, 92vw); background: var(--color-bg-surface); border-radius: 1.25rem; box-shadow: var(--shadow-md); display: flex; flex-direction: column; animation: modal-scale-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .modal-header { background-color: var(--color-bg-main); border-bottom: 1px solid var(--color-border); }
    .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background-color: var(--color-text-primary); color: var(--color-bg-surface); padding: 0.8rem 1.2rem; border-radius: 8px; z-index: 110; opacity: 0; font-weight: 500; box-shadow: var(--shadow-md); transition: opacity 0.3s, transform 0.3s; }
    .toast.show { opacity: 1; transform: translate(-50%, -10px); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes modal-scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    /* =================================================================
      -- 9. CHAT ACTION MENU & PINNED MESSAGE --
    ================================================================= */
    #messageContextMenu {
        position: absolute; display: none; flex-direction: column; background: var(--color-bg-surface);
        border-radius: 12px; box-shadow: var(--shadow-md); z-index: 50;
        padding: 0.5rem; border: 1px solid var(--color-border);
        transform-origin: top center; animation: modal-scale-in 0.15s ease-out;
        gap: 2px;
    }
    #messageContextMenu.show { display: flex; }
    .context-menu-btn {
        display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0.85rem;
        font-size: 0.95rem; font-weight: 500; border-radius: 8px; cursor: pointer;
        transition: background-color 0.2s; white-space: nowrap;
    }
    .context-menu-btn:hover { background-color: var(--color-bg-main); }
    .context-menu-btn svg { color: var(--color-text-secondary); }
    .context-menu-btn[data-action="delete"] { color: #ef4444; }
    .context-menu-btn[data-action="delete"] svg { color: #ef4444; }
    .context-menu-separator {
        height: 1px; background-color: var(--color-border); margin: 0.25rem 0;
    }
    
    #pinnedMessageArea {
        padding: 0.5rem 1rem; background-color: var(--color-bg-main); border-bottom: 1px solid var(--color-border);
        flex-shrink: 0; cursor: pointer; transition: all 0.3s; display: none;
    }
    #pinnedMessageArea.show { display: block; }
    .pinned-content { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
    .pinned-text {
        font-size: 0.85rem; color: var(--color-text-secondary);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    
    /* =================================================================
      -- 10. MULTI-IMAGE PREVIEW STYLES --
    ================================================================= */
    #imagePreviewsContainer {
        display: flex;
        gap: 0.75rem; /* 12px */
        padding: 0.5rem;
        overflow-x: auto;
        /* Custom scrollbar for better aesthetics */
        scrollbar-width: thin;
        scrollbar-color: var(--color-border) transparent;
    }
    .preview-thumbnail {
        position: relative;
        flex-shrink: 0;
    }
    .preview-thumbnail img {
        width: 5rem; /* 80px */
        height: 5rem; /* 80px */
        object-fit: cover;
        border-radius: 0.75rem; /* 12px */
        border: 2px solid var(--color-border);
        cursor: pointer;
        transition: transform 0.2s;
    }
    .preview-thumbnail img:hover {
        transform: scale(1.05);
    }
    .preview-thumbnail .remove-btn {
        position: absolute;
        top: -0.375rem; /* -6px */
        right: -0.375rem;
        html[dir="rtl"] & { right: auto; left: -0.375rem; }
        html[dir="ltr"] & { left: auto; right: -0.375rem; }
        display: flex;
        width: 1.5rem; /* 24px */
        height: 1.5rem; /* 24px */
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        background-color: var(--color-text-primary);
        color: var(--color-bg-surface);
        font-size: 1rem;
        font-weight: bold;
        line-height: 1;
        cursor: pointer;
        border: 2px solid var(--color-bg-surface);
        transition: background-color 0.2s;
    }
    .preview-thumbnail .remove-btn:hover {
        background-color: #ef4444; /* red-500 */
    }
    #imageViewerModal img {
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        border-radius: 0.75rem;
    }

    /* --- New Styles for Error/Resend Bubble --- */
    .message-bubble.error {
        background-color: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FCA5A5;
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }
    html.dark .message-bubble.error {
        background-color: #7F1D1D;
        color: #FEE2E2;
        border: 1px solid #F87171;
    }

    .message-bubble.error .resend-btn {
        background-color: #EF4444;
        color: white;
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .message-bubble.error .resend-btn:hover {
        background-color: #DC2626;
    }

    /* --- New Styles for Scroll to Bottom Button --- */
    #scrollToBottomBtn {
        position: absolute;
        bottom: 7rem; /* Adjusted to be above the input area */
        inset-inline-end: 1rem;
        background-color: var(--color-bg-surface);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-md);
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: none;
        place-content: center;
        cursor: pointer;
        transition: opacity 0.3s, transform 0.3s;
        z-index: 10;
        opacity: 0.8;
    }

    #scrollToBottomBtn.show {
        display: grid;
    }
    
  </style>
</head>
<body class="app-shell">

  <!-- =================================================================
      -- SCREENS
      ================================================================= -->
  <!-- Welcome Screen -->
  <div class="welcome-screen" id="welcomeScreen">
    <div class="absolute top-4 right-4 z-10" style="inset-inline-end: 1rem; inset-inline-start: auto;"><button class="lang-toggle-btn icon-btn text-sm font-bold border !w-auto px-4 !h-10 !rounded-full !border-white/20 hover:!border-accent !text-white bg-white/10 backdrop-blur-sm">AR</button></div>
    <img id="welcomeAvatar" src="https://images.unsplash.com/photo-1581009137042-c552e485697a?auto=format&fit=crop&w=200&q=80" alt="Coach Avatar" class="w-32 h-32 rounded-full mb-6 shadow-xl object-cover border-4 border-[var(--color-accent)]"/>
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black mb-2" id="welcomeTitle">مدربك الشخصي الذكي</h1>
    <p class="text-base sm:text-lg lg:text-xl font-light text-white/90 mb-8 max-w-xl" id="welcomeSubtitle">جاهز للتغيير؟ خطتك مصممة خصصًا لك — تنفيذ محكم، متابعة دقيقة، ونتيجة ملموسة.</p>
    <button id="startBtn" class="cta-btn">ابدأ الآن</button>
  </div>

  <!-- User Profile Screen -->
  <div class="user-data-screen hidden" id="userDataScreen">
    <div class="absolute top-4 right-4 z-10" style="inset-inline-end: 1rem; inset-inline-start: auto;"><button class="lang-toggle-btn icon-btn text-sm font-bold border !w-auto px-4 !h-10 !rounded-full !border-white/20 hover:!border-accent !text-white bg-white/10 backdrop-blur-sm">AR</button></div>
    <div class="w-full max-w-sm p-6 sm:p-8 space-y-6 rounded-2xl shadow-xl border border-white/20"><div class="text-center"><h2 class="text-2xl sm:text-3xl font-extrabold" id="userDataTitle">لنبني ملفك السريع</h2><p class="text-white/80 mt-2" id="userDataSubtitle">نحتاج بعض المعلومات للبدء</p></div>
        <div class="space-y-4">
          <div class="relative">
            <span class="absolute inset-y-0 end-0 flex items-center pe-5 pointer-events-none">
              <svg class="w-5 h-5 text-white/70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </span>
            <input type="text" id="userName" class="block w-full rounded-full py-3.5 ps-4 pe-12 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="اكتب اسمك هنا">
          </div>
          <div class="relative">
            <span class="absolute inset-y-0 end-0 flex items-center pe-5 pointer-events-none">
              <svg class="w-5 h-5 text-white/70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            </span>
            <input type="text" inputmode="numeric" id="userAge" class="block w-full rounded-full py-3.5 ps-4 pe-12 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="عمرك">
          </div>
          <div class="relative">
            <span class="absolute inset-y-0 end-0 flex items-center pe-5 pointer-events-none">
              <svg class="w-5 h-5 text-white/70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
            </span>
            <input type="text" id="userCountry" class="block w-full rounded-full py-3.5 ps-4 pe-12 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="بلدك">
          </div>
        </div>
    <button id="nextBtn" class="cta-btn w-full mt-4 !py-3 !text-lg !font-bold">ابدأ المحادثة</button></div>
  </div>

  <!-- Chat UI Container -->
  <div class="flex flex-col h-full hidden" id="chatContainer">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="brand flex items-center gap-3"><img id="chatAvatar" src="https://images.unsplash.com/photo-1581009137042-c552e485697a?auto=format&fit=crop&w=80&q=80" alt="Coach Avatar" class="rounded-full object-cover"/><span class="text-lg font-bold" id="chatTitle">مدربك الشخصي الذكي</span></div>
      <div class="flex items-center gap-1">
        <button id="resetBtn" class="icon-btn text-xl !w-9 !h-9" title="ابدأ من جديد">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        </button>
        <button id="btnLang" class="lang-toggle-btn icon-btn text-sm font-bold !w-auto px-4 !h-9">AR</button>
        <button id="btnTheme" class="icon-btn text-xl !w-9 !h-9">☀️</button>
      </div>
    </div>
    
    <!-- Pinned Message -->
    <div id="pinnedMessageArea">
      <div class="pinned-content">
        <div class="flex items-center gap-2 min-w-0">
          <svg class="w-4 h-4 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 3a1 1 0 0 1 1 1v5.268l2.999 2.999a1 1 0 0 1 .326 1.638l-.11.094L18 16.223V18a1 1 0 0 1-.993.994L17 19h-4.172l-3.535 3.536a1 1 0 0 1-1.497-1.32l.083-.094L11.414 18H8a1 1 0 0 1-1-1v-1.777l-2.173-2.173a1 1 0 0 1-.094-1.548l.094-.11L7.828 9.268V4a1 1 0 0 1 .993-.994L9 3h7z"/></svg>
          <p id="pinnedText" class="pinned-text"></p>
        </div>
        <button id="unpinBtn" class="icon-btn !w-6 !h-6" title="إلغاء التثبيت">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-messages" id="chatMessages" role="log" aria-live="polite">
      <!-- New: Scroll to bottom button -->
      <button id="scrollToBottomBtn" class="!w-12 !h-12 text-gray-500 hover:text-[var(--color-accent)] transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8"><path d="M12 21l-7.7-7.7c-.5-.5-.7-1.3-.7-2.1V7c0-.8.2-1.6.7-2.1l7.7-7.7c.5-.5 1.3-.7 2.1-.7s1.6.2 2.1.7l7.7 7.7c.5.5.7 1.3.7 2.1V12c0 .8-.2 1.6-.7 2.1l-7.7 7.7c-.5.5-1.3.7-2.1.7s-1.6-.2-2.1-.7zM12 18.5V4h-.5V18.5L9 16l-1.5 1.5 4 4 4-4-1.5-1.5z"></path></svg>
      </button>
    </div>
    
    <!-- Input Area -->
    <div class="input-area-wrapper">
        <div id="planButtonArea" class="px-2 pb-2"><div class="dynamic-card !m-0 rounded-xl p-3 flex justify-between items-center flex-wrap sm:flex-nowrap gap-3 bg-white dark:bg-slate-800"><div class="min-w-0"><div id="ctaTitle" class="font-bold text-gray-800 dark:text-gray-100">جاهز لنتيجة ملموسة؟</div><div id="ctaSubtitle" class="text-sm text-gray-600 dark:text-gray-300 mt-1">خطة مُحكمة + متابعة أسبوعية.</div></div><button id="generatePlanBtn" class="cta-btn cta-btn-animated !text-sm !px-5 !py-2.5 w-full sm:w-auto" disabled>احصل على خطتك الآن</button></div></div>
        <div id="imagePreviewsWrapper" class="hidden">
          <div id="imagePreviewsContainer"></div>
        </div>
        <div class="input-area" id="inputArea"><div class="input-field-container"><button id="plusBtn" class="icon-btn" aria-label="أرسل صورة/ملف" title="صورة/ملف"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></button><input type="file" id="fileInput" accept="image/*" class="hidden" multiple /><textarea id="userInput" placeholder="اكتب رسالتك..." dir="rtl" rows="1"></textarea><button id="micBtn" class="icon-btn mic-btn" aria-label="تسجيل صوتي" title="اضغط مطولاً للتسجيل"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg></button></div><button id="sendBtn" class="icon-btn send-btn" aria-label="أرسل" title="إرسال"><svg class="w-5 h-5" style="transform: translateX(1px);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button></div>
        <div class="hidden text-center" id="recHintWrap"><p class="rec-hint text-xs" id="recHint"></p></div>
    </div>
    
    <!-- App Footer -->
    <div id="appFooter" class="p-2 text-center border-t border-[var(--color-border)] bg-[var(--color-bg-surface)] flex-shrink-0">
      <p class="text-xs text-[var(--color-text-secondary)]">
        <span id="footerRights"></span> |  
        <a href="https://buymeacoffee.com/aipersonaltrainer" target="_blank" class="font-semibold text-[var(--color-accent)] hover:underline">
          ☕ <span id="footerCoffee"></span>
        </a> | 
        <a href="#" id="howToUseLink" class="font-semibold underline hover:text-[var(--color-accent)] transition-colors">
          <span id="howToUseText"></span>
        </a>
      </p>
    </div>
  </div>

  <!-- =================================================================
      -- MODALS & OVERLAYS
      ================================================================= -->
  <!-- Profile Modal -->
  <div id="profileModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog">
    <div class="modal-content !w-full !max-w-md !rounded-none sm:!rounded-2xl p-0 overflow-hidden">
      <div class="bg-gray-100 dark:bg-gray-800 p-4 flex justify-end">
        <button id="closeProfileBtn" class="icon-btn !w-8 !h-8" title="إغلاق">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="flex flex-col items-center p-6 bg-gray-100 dark:bg-gray-800">
        <img src="https://images.unsplash.com/photo-1581009137042-c552e485697a?auto=format&fit=crop&w=150&q=80" alt="Coach Avatar" class="w-36 h-36 rounded-full object-cover border-4 border-white dark:border-gray-700 shadow-lg"/>
        <h3 class="text-2xl font-bold mt-4" id="profileName">الكابتن مصطفى الصافي</h3>
        <p class="text-lg text-gray-500 dark:text-gray-400" id="profilePhone"></p>
        <div class="flex gap-4 mt-4 justify-center">
          <a href="https://wa.me/971502061209" target="_blank" class="icon-btn !w-12 !h-12 bg-green-500 !text-white hover:bg-green-600 shadow-md" title="WhatsApp">
            <svg class="w-6 h-6" viewBox="0 0 32 32" fill="currentColor"><path d="M19.11 17.18c-.28-.14-1.65-.81-1.9-.9-.26-.1-.44-.14-.62.14-.18.27-.71.9-.87 1.09-.16.18-.32.2-.6.07-.28-.14-1.18-.44-2.25-1.4-.83-.74-1.39-1.66-1.55-1.94-.16-.27-.02-.42.12-.56.12-.12.28-.3.42-.46.14-.16.18-.27.28-.46.1-.18.06-.34-.02-.48-.08-.14-.62-1.5-.84-2.06-.22-.52-.44-.45-.62-.46h-.54c-.18 0-.48.07-.74.34-.26.27-1 1-1 2.42s1.03 2.8 1.18 2.99c.14.2 2.03 3.1 4.93 4.33.69.3 1.22.48 1.64.62.69.22 1.32.19 1.82.12.56-.08 1.65-.68 1.88-1.35.24-.67.24-1.24.16-1.35-.06-.1-.24-.16-.52-.3z"/><path d="M26.9 5.1A13.9 13.9 0 0 0 16 .1C7.3.1.2 7.1.2 15.8c0 2.7.7 5.2 2 7.4L.1 31.9l8.9-2.3c2.1 1.1 4.5 1.7 7 1.7h.1c8.7 0 15.8-7 15.8-15.7 0-4.2-1.6-8.1-4.9-10.9z"/></svg>
          </a>
          <a href="tel:+971502061209" class="icon-btn !w-12 !h-12 bg-blue-500 !text-white hover:bg-blue-600 shadow-md" title="اتصال">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 0 1 1 1V21a1 1 0 0 1-1 1C10.61 22 2 13.39 2 3a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.27.2 2.47.57 3.58a1 1 0 0 1-.24 1.01l-2.21 2.2z"/></svg>
          </a>
        </div>
      </div>
      <div class="p-6 bg-white dark:bg-gray-900 space-y-4">
        <div>
          <h4 class="text-sm font-bold text-green-600 dark:text-green-400" id="profileBioTitle">About</h4>
          <p class="mt-1 text-gray-700 dark:text-gray-300" id="profileBioText">خبير دولي حاصل على دبلومة متقدمة في اللياقة البدنية والتغذية من كاليفورnia. أصمم لك نظام حياة متكامل لتحقيق أهدافك بكفاءة ودقة.</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
          <button id="profileGetPlanBtn" class="cta-btn w-full !py-3 !text-base !font-bold">احصل على خطتك</button>
          <a href="https://buymeacoffee.com/aipersonaltrainer" target="_blank" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 font-bold text-gray-800 bg-amber-400 rounded-lg shadow-md hover:bg-amber-500 transition-colors">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4v-2z"/></svg>
            <span id="coffeeBtnText2">ادعمني بقهوة</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div id="contactModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog"><div class="modal-content"><div class="modal-header p-4 flex justify-between items-center"><h3 id="contactModalTitle" class="text-lg font-bold">احصل على خطتك الآن</h3><button id="closeContactBtn" class="icon-btn !w-8 !h-8" title="إغلاق">×</button></div><div class="modal-body p-6"><p id="contactModalText1" class="mb-4 text-secondary">اختر الطريقة المناسبة للتواصل المباشر مع المدرب.</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><a class="flex items-center justify-center gap-3 p-4 rounded-lg bg-[#25D366] text-white font-bold transition hover:opacity-90" href="https://wa.me/971502061209" target="_blank" rel="noopener"><svg class="w-6 h-6" viewBox="0 0 32 32" fill="currentColor"><path d="M19.11 17.18c-.28-.14-1.65-.81-1.9-.9-.26-.1-.44-.14-.62.14-.18.27-.71.9-.87 1.09-.16.18-.32.2-.6.07-.28-.14-1.18-.44-2.25-1.4-.83-.74-1.39-1.66-1.55-1.94-.16-.27-.02-.42.12-.56.12-.12.28-.3.42-.46.14-.16.18-.27.28-.46.1-.18.06-.34-.02-.48-.08-.14-.62-1.5-.84-2.06-.22-.52-.44-.45-.62-.46h-.54c-.18 0-.48.07-.74.34-.26.27-1 1-1 2.42s1.03 2.8 1.18 2.99c.14.2 2.03 3.1 4.93 4.33.69.3 1.22.48 1.64.62.69.22 1.32.19 1.82.12.56-.08 1.65-.68 1.88-1.35.24-.67.24-1.24.16-1.35-.06-.1-.24-.16-.52-.3z"/><path d="M26.9 5.1A13.9 13.9 0 0 0 16 .1C7.3.1.2 7.1.2 15.8c0 2.7.7 5.2 2 7.4L.1 31.9l8.9-2.3c2.1 1.1 4.5 1.7 7 1.7h.1c8.7 0 15.8-7 15.8-15.7 0-4.2-1.6-8.1-4.9-10.9z"/></svg><span id="whatsappBtnText">واتساب</span></a><a class="flex items-center justify-center gap-3 p-4 rounded-lg bg-blue-500 text-white font-bold transition hover:opacity-90" href="tel:+971502061209"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 0 1 1 1V21a1 1 0 0 1-1 1C10.61 22 2 13.39 2 3a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.27.2 2.47.57 3.58a1 1 0 0 1-.24 1.01l-2.21 2.2z"/></svg><span id="phoneBtnText">اتصال</span></a></div><div id="iherb-card" class="dynamic-card mt-6 pt-5 border-t border-[var(--color-border)] flex flex-col sm:flex-row items-center gap-4 p-4 !m-0 !border-0 !shadow-none"><div class="flex-shrink-0 grid place-items-center w-14 h-14 rounded-full bg-emerald-100 dark:bg-emerald-900 text-[var(--color-accent)]"><svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.5.38 3.3.5 6.22-2.39 6.84-5.64.45-2.3-1.05-4.42-3.23-5.32-.6-.25-1.25-.37-1.92-.37-.85 0-1.67.2-2.43.56l-1.89-.66C7.9 3.83 17 8 17 8Z" /></svg></div><div class="flex-1 min-w-0 text-center sm:text-right"><p id="iherbTitle" class="font-extrabold text-emerald-800 dark:text-emerald-200">احصل على مكملاتك من iHerb</p><p id="iherbSubtitle" class="text-sm text-emerald-700 dark:text-emerald-300 mt-1">خصم 10% إضافي هدية من مدربك!</p></div><div class="flex items-center gap-2 mt-2 sm:mt-0">
        <div id="iherb-code" title="اضغط للنسخ" class="cursor-pointer transition-transform hover:scale-105 px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border-2 border-dashed border-[var(--color-accent)] font-mono text-base font-bold text-emerald-700 dark:text-emerald-300">AYT3413</div>
        <a id="copy-and-go-iherb-btn" href="https://iherb.co/fL9KCv1i?rcode=AYT3413" target="_blank" class="flex-shrink-0 px-4 py-2.5 rounded-lg bg-[var(--color-accent)] text-white font-bold hover:bg-[var(--color-accent-hover)] transition-colors text-sm shadow-md"><span id="copy-and-go-iherb-btn-text">اذهب للمتجر</span></a></div></div><div class="text-center mt-6 pt-5 border-t border-[var(--color-border)]"><p id="coffeeText" class="text-sm text-secondary mb-3">هل أعجبتك الأداة؟ دعمك يساعدنا على الاستمرار.</p><a href="https://buymeacoffee.com/aipersonaltrainer" target="_blank" class="inline-flex items-center gap-2 px-5 py-2.5 font-bold text-gray-800 bg-amber-400 rounded-lg shadow-md hover:bg-amber-500 transition-colors"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4v-2z"/></svg><span id="coffeeBtnText">ادعمني بقهوة</span></a></div></div></div></div>

  <!-- Reset Confirmation Modal -->
  <div id="resetConfirmModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog">
      <div class="modal-content !max-w-sm">
          <div class="p-6">
              <h3 class="text-lg font-bold" id="resetModalTitle">تأكيد الحذف</h3>
              <p class="text-secondary mt-2" id="resetModalText">هل أنت متأكد أنك تريد حذف كل الرسائل والبدء من جديد؟</p>
          </div>
          <div class="flex justify-end gap-3 p-4 bg-gray-50 dark:bg-gray-800 rounded-b-xl">
              <button id="cancelResetBtn" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition !text-black" id="resetCancelBtn">إلغاء</button>
              <button id="confirmResetBtn" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition" id="resetConfirmBtn">موافق</button>
          </div>
      </div>
  </div>

  <!-- Message Context Menu -->
  <div id="messageContextMenu">
      <button class="context-menu-btn" data-action="copy">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          <span id="contextCopy">نسخ</span>
      </button>
      <button class="context-menu-btn" data-action="share">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
          <span id="contextShare">مشاركة</span>
      </button>
      <button class="context-menu-btn" data-action="pin">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 3a1 1 0 0 1 1 1v5.268l2.999 2.999a1 1 0 0 1 .326 1.638l-.11.094L18 16.223V18a1 1 0 0 1-.993.994L17 19h-4.172l-3.535 3.536a1 1 0 0 1-1.497-1.32l.083-.094L11.414 18H8a1 1 0 0 1-1-1v-1.777l-2.173-2.173a1 1 0 0 1-.094-1.548l.094-.11L7.828 9.268V4a1 1 0 0 1 .993-.994L9 3h7z"/></svg>
          <span id="contextPin">تثبيت</span>
      </button>
      <div class="context-menu-separator" data-role="separator"></div>
      <button class="context-menu-btn" data-action="edit" data-role="user-only">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          <span id="contextEdit">تعديل</span>
      </button>
      <button class="context-menu-btn" data-action="delete" data-role="user-only">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
          <span id="contextDelete">حذف</span>
      </button>
  </div>
  
  <!-- Image Viewer Modal -->
  <div id="imageViewerModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog">
    <div class="modal-content !w-auto !max-w-[90vw] !max-h-[90vh] !p-2 !bg-transparent !shadow-none relative">
      <img id="fullImageView" src="" alt="Full size preview" class="max-w-full max-h-full object-contain">
      <button id="closeImageViewerBtn" class="absolute top-0 right-0 icon-btn !w-10 !h-10 bg-black/50 !text-white hover:bg-black/75" title="إغلاق">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
  </div>

  <!-- "How to Use" Modal -->
  <div id="howToUseModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog">
    <div class="modal-content">
        <div class="modal-header p-4 flex justify-between items-center">
            <h3 id="howToUseTitle" class="text-lg font-bold"></h3>
            <button id="closeHowToUseBtn" class="icon-btn !w-8 !h-8" title="إغلاق">×</button>
        </div>
        <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]" id="howToUseContent">
            <!-- Content will be injected by JS -->
        </div>
    </div>
  </div>


  <script type="module">
    /**
     * =================================================================
     * Smart Personal Coach - Main Application Logic
     * =================================================================
     * This script encapsulates the entire functionality of the chat application.
     * It's structured as a single 'App' object with distinct modules
     * for configuration, state management, UI manipulation, services, etc.
     */

    // A small utility to enhance the textarea's auto-resize functionality.
    function initUIEnhancements() {
        const userInput = document.getElementById('userInput');
        if (!userInput) return;

        const adjustTextareaHeight = () => {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
        };

        userInput.addEventListener('input', adjustTextareaHeight);

        // Ensure textarea resizes after a message is sent and cleared.
        const originalSendMessage = App.core.sendMessage;
        App.core.sendMessage = function(...args) {
            originalSendMessage.apply(this, args);
            setTimeout(adjustTextareaHeight, 0);
        };
    }

    // Main Application Namespace
    const App = {
      /**
       * -----------------------------------------------------------------
       * 1. CONFIGURATION & STATE
       * -----------------------------------------------------------------
       */
      config: {
        MAX_PROMPT_CHARS: 28000,
        STORAGE_KEY: 'smart-coach-session-v3',
        LONG_PRESS_DURATION: 400,
        MAX_IMAGES: 5,
      },

      state: {
        userState: { step: 0, data: {} },
        lang: 'ar',
        chatHistory: [],
        isRecording: false,
        sttSessionId: 0,
        recognition: null,
        mediaStream: null,
        mediaRecorder: null,
        audioChunks: [],
        recStartTime: 0,
        pendingImages: [],
        pinnedMessageId: null,
        longPressTimer: null,
        currentContextMenu: null,
        isEditing: false,
        editingMessageId: null,
      },

      // Holds cached DOM elements for performance.
      elements: {},

      /**
       * -----------------------------------------------------------------
       * 2. INITIALIZATION & DOM CACHING
       * -----------------------------------------------------------------
       */
      cacheElements() {
        const $ = id => document.getElementById(id);
        this.elements = {
          // Screens
          welcomeScreen: $('welcomeScreen'),
          userDataScreen: $('userDataScreen'),
          chatContainer: $('chatContainer'),
          // Chat Area
          chatMessages: $('chatMessages'),
          userInput: $('userInput'),
          sendBtn: $('sendBtn'),
          plusBtn: $('plusBtn'),
          micBtn: $('micBtn'),
          chatAvatar: $('chatAvatar'),
          // User Data Form
          startBtn: $('startBtn'),
          nextBtn: $('nextBtn'),
          userNameInput: $('userName'),
          userAgeInput: $('userAge'),
          userCountryInput: $('userCountry'),
          // Controls & Buttons
          btnTheme: $('btnTheme'),
          fileInput: $('fileInput'),
          planButtonArea: $('planButtonArea'),
          generatePlanBtn: $('generatePlanBtn'),
          resetBtn: $('resetBtn'),
          // Modals
          contactModal: $('contactModal'),
          closeContactBtn: $('closeContactBtn'),
          profileModal: $('profileModal'),
          closeProfileBtn: $('closeProfileBtn'),
          profileGetPlanBtn: $('profileGetPlanBtn'),
          resetConfirmModal: $('resetConfirmModal'),
          confirmResetBtn: $('confirmResetBtn'),
          cancelResetBtn: $('cancelResetBtn'),
          imageViewerModal: $('imageViewerModal'),
          fullImageView: $('fullImageView'),
          closeImageViewerBtn: $('closeImageViewerBtn'),
          howToUseModal: $('howToUseModal'),
          closeHowToUseBtn: $('closeHowToUseBtn'),
          // iHerb & Support
          copyAndGoIherbBtn: $('copy-and-go-iherb-btn'),
          iherbCode: $('iherb-code'),
          // Image Previews
          imagePreviewsWrapper: $('imagePreviewsWrapper'),
          imagePreviewsContainer: $('imagePreviewsContainer'),
          // Context Menu & Pinning
          messageContextMenu: $('messageContextMenu'),
          pinnedMessageArea: $('pinnedMessageArea'),
          pinnedText: $('pinnedText'),
          unpinBtn: $('unpinBtn'),
          // Speech Recognition
          recHintWrap: $('recHintWrap'),
          recHint: $('recHint'),
          // Footer & Info
          footerRights: $('footerRights'),
          footerCoffee: $('footerCoffee'),
          howToUseLink: $('howToUseLink'),
          howToUseTitle: $('howToUseTitle'),
          howToUseContent: $('howToUseContent'),
          howToUseText: $('howToUseText'),
          // New: Scroll to bottom button
          scrollToBottomBtn: $('scrollToBottomBtn'),
        };
      },

      /**
       * -----------------------------------------------------------------
       * 3. I18N & LOCALIZATION MODULE
       * -----------------------------------------------------------------
       */
      i18n: {
        strings: {
          ar: {
            appName: 'مدربك الشخصي الذكي', welcomeSubtitle: 'جاهز للتغيير؟ خطتك مصممة خصصًا لك — تنفيذ محكم، متابعة دقيقة، ونتيجة ملموسة.',
            startButtonText: 'ابدأ الآن', userDataTitle: 'لنبني ملفك السريع', userDataSubtitle: 'نحتاج بعض المعلومات للبدء',
            namePlaceholder:'اكتب اسمك هنا', agePlaceholder:'عمرك', countryPlaceholder:'بلدك', nextButtonText:'ابدأ المحادثة',
            inputPlaceholder:'اكتب رسالتك...', emptyFields:'الرجاء إدخال اسمك وعمرك وبلدك للمتابعة.', imageUpload:'تم استلام الصورة — يتم التحليل الآن.',
            maxImagesReached: 'يا بطل، تقدر ترفع 5 صور بس في المرة الواحدة.',
            typing:'…', recStart:'● جاري التسجيل… ارفع إصبعك للإرسال', recDenied:'تعذّر الوصول للميكروفوون.', recTooShort:'التسجيل قصير جدًا.', recSaved:'تم نسخ الكلام إلى خانة الكتابة.',
            ctaTitle: 'جاهز لنتيجة ملموسة؟', ctaSubtitle: 'خطة مُحكمة + متابعة أسبوعية.', getPlanButton: 'احصل على خطتك الآن',
            contactModalTitle: 'احصل على خطتك الآن', contactModalText1: 'اختر الطريقة المناسبة للتواصل المباشر مع المدرب.',
            whatsappBtnText: 'واتساب', phoneBtnText: 'اتصال', copied: 'تم النسخ!',
            iherbTitle: 'احصل على مكملاتك من iHerb', iherbSubtitle: 'خصم إضافي 10% هدية من مدربك!',
            copyAndGoButton: 'اذهب للمتجر', iherbCopiedAndRedirecting: 'تم نسخ الكود! يتم الآن تحويلك...',
            coffeeText: 'هل أعجبتك الأداة؟ دعمك يساعدنا على الاستمرار.', coffeeBtnText: 'ادعمني بقهوة', coffeeBtnText2: 'ادعمني بقهوة',
            imageAttached: '[صور مرفقة]', resetTitle: 'ابدأ من جديد',
            resetModalTitle: 'تأكيد الحذف', resetModalText: 'هل أنت متأكد أنك تريد حذف كل الرسائل والبدء من جديد؟',
            resetCancelBtn: 'إلغاء', resetConfirmBtn: 'موافق',
            contextCopy: 'نسخ', contextShare: 'مشاركة', contextPin: 'تثبيت', contextUnpin: 'إلغاء التثبيت',
            contextEdit: 'تعديل', contextDelete: 'حذف', messageDeleted: 'تم حذف الرسالة.',
            unpinTitle: 'إلغاء التثبيت', sharedSuccessfully: 'تمت المشاركة بنجاح!', shareFailed: 'فشلت المشاركة.',
            profileName: 'الكابتن مصطفى الصافي', profilePhone: '', profileBioTitle: 'عني',
            profileBioText: 'شغفي هو هندسة الأجسام والعقول. كخبير دولي معتمد من كاليفورنيا، أدمج أحدث علوم اللياقة والتغذية مع فهم عميق لأسلوب حياتك، لأصنع لك تحولاً حقيقياً ومستداماً. مهمتي ليست مجرد خطة، بل بناء نظام حياة يطلق أفضل نسخة منك.',
            profileGetPlanBtn: 'احصل على خطتك',
            footerRights: '© 2024 جميع الحقوق محفوظة للكابتن مصطفى الصافي.',
            footerCoffee: 'ادعمني بقهوة',
            howToUseText: 'كيف تستخدم الخدمة',
            howToUseTitle: 'دليل استخدام المدرب الذكي',
            howToUseContent: `
                <div class='space-y-3 text-sm'>
                <p><strong>أهلاً بك في مساعدك التدريبي الذكي! إليك كيفية تحقيق أقصى استفادة:</strong></p>
                <ul class='list-disc list-inside space-y-2'>
                    <li><strong>بدء المحادثة:</strong> أدخل بياناتك الأولية لبدء حوار مخصص معك.</li>
                    <li><strong>إرسال الرسائل:</strong> اكتب استفسارك في مربع النص واضغط على زر الإرسال.</li>
                    <li><strong>إرفاق الصور:</strong> اضغط على أيقونة المشبك 📎 لإرفاق صورة واحدة أو عدة صور (حتى 5 صور) ليحللها المدرب. يمكنك إضافة نص مع الصور.</li>
                    <li><strong>الرسائل الصوتية:</strong> اضغط مطولاً على أيقونة الميكروفون 🎤 للتسجيل، ثم اترك إصبعك للإرسال.</li>
                    <li><strong>تعديل أو حذف رسالة:</strong> اضغط مطولاً على أي رسالة أرسلتها لتظهر قائمة خيارات. يمكنك من خلالها تعديل الرسالة أو حذفها.</li>
                    <li><strong>ملاحظة هامة عند التعديل:</strong> عند تعديل أي رسالة، سيتم حذف جميع الرسائل التي تليها (لك وللمدرب) وسيتم إرسال رد جديد بناءً على تعديلك.</li>
                    <li><strong>نسخ ومشاركة:</strong> يمكنك أيضاً من نفس القائمة نسخ نص الرسالة أو مشاركتها.</li>
                </ul>
                <p>نحن هنا لمساعدتك في كل خطوة نحو هدفك!</p>
                </div>
            `,
            welcomeMessage: 'أهلًا بيك يا {name}، معاك مساعد المدرب الدولي مصطفى الصافي. جاهز نبدأ رحلتك؟ إيه هدفك الأساسي؟',
            // New strings
            resendError: 'حصل خطأ في الإرسال. الرجاء إعادة الإرسال.',
          },
          en: {
            appName:'Smart Personal Coach', welcomeSubtitle:'Ready for a change? Your plan is tailored for you—precise execution, close follow-up, and tangible results.',
            startButtonText:'Start Now', userDataTitle:"Let's build your quick profile", userDataSubtitle:"We need some information to get started",
            namePlaceholder:'Your Name', agePlaceholder:'Your Age', countryPlaceholder:'Your Country', nextButtonText:'Start Conversation',
            inputPlaceholder:'Type your message…', emptyFields:'Please enter your name, age, and country to continue.', imageUpload:'Image received — analyzing now.',
            maxImagesReached: 'Heads up! You can only upload 5 images at a time.',
            typing:'…', recStart:'● Recording… release to send', recDenied:'Microphone access denied.', recTooShort:'Recording is too short.', recSaved:'Text copied to input.',
            ctaTitle: 'Ready for tangible results?', ctaSubtitle: 'Precise plan + weekly follow-up.', getPlanButton: 'Get Your Plan Now',
            contactModalTitle: 'Get your plan now', contactModalText1: 'Choose the best way to contact the coach directly.',
            whatsappBtnText: 'WhatsApp', phoneBtnText: 'Call', copied: 'Copied!',
            iherbTitle: 'Get your supplements from iHerb', iherbSubtitle: 'An extra 10% discount, a gift from your coach!',
            copyAndGoButton: 'Go to Store', iherbCopiedAndRedirecting: 'Code copied! Redirecting...',
            coffeeText: 'Did you like this free tool? Your support helps us to continue.', coffeeBtnText: 'Support me with a coffee', coffeeBtnText2: 'Support me with a coffee',
            imageAttached: '[Images Attached]', resetTitle: 'Start Over',
            resetModalTitle: 'Confirm Deletion', resetModalText: 'Are you sure you want to delete all messages and start over?',
            resetCancelBtn: 'Cancel', resetConfirmBtn: 'Confirm',
            contextCopy: 'Copy', contextShare: 'Share', contextPin: 'Pin', contextUnpin: 'Unpin',
            contextEdit: 'Edit', contextDelete: 'Delete', messageDeleted: 'Message deleted.',
            unpinTitle: 'Unpin message', sharedSuccessfully: 'Shared successfully!', shareFailed: 'Sharing failed.',
            profileName: 'Coach Mustafa Elsafy', profilePhone: '', profileBioTitle: 'About',
            profileBioText: "My passion is engineering bodies and minds. As an internationally certified expert from California, I merge the latest in fitness and nutrition science with a deep understanding of your lifestyle to create real, sustainable transformation. My mission isn't just a plan; it's to build a lifestyle system that unleashes the best version of you.",
            profileGetPlanBtn: 'Get Your Plan',
            footerRights: '© 2024 All rights reserved for Coach Mustafa Elsafy.',
            footerCoffee: 'Support me with a coffee',
            howToUseText: 'How to use',
            howToUseTitle: 'Smart Coach Guide',
            howToUseContent: `
                <div class='space-y-3 text-sm'>
                <p><strong>Welcome to your smart training assistant! Here's how to get the most out of it:</strong></p>
                <ul class='list-disc list-inside space-y-2'>
                    <li><strong>Start Conversation:</strong> Enter your initial data to begin a personalized chat.</li>
                    <li><strong>Send Messages:</strong> Type your query in the text box and press the send button.</li>
                    <li><strong>Attach Images:</strong> Click the paperclip icon 📎 to attach one or more images (up to 5) for the coach to analyze. You can add text with the images.</li>
                    <li><strong>Voice Messages:</strong> Press and hold the microphone icon 🎤 to record, then release to send.</li>
                    <li><strong>Edit or Delete a Message:</strong> Long-press on any message you've sent to bring up an options menu. From there, you can edit or delete the message.</li>
                    <li><strong>Important Note on Editing:</strong> When you edit a message, all subsequent messages (from both you and the coach) will be deleted, and a new response will be generated based on your edit.</li>
                    <li><strong>Copy & Share:</strong> From the same menu, you can also copy the message text or share it.</li>
                </ul>
                <p>We're here to help you every step of the way towards your goal!</p>
                </div>
            `,
            welcomeMessage: "Welcome, {name}! I'm assistant to international coach Mustafa Elsafy. Ready to start your journey? What's your main goal?",
            // New strings
            resendError: 'Sending failed. Please resend.',
          }
        },
        
        setLang(lang) {
          App.state.lang = lang;
          document.documentElement.lang = lang;
          document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
          
          const L = App.i18n.strings[lang];
          const $ = id => document.getElementById(id);
          const updateText = (elId, key) => { const el = $(elId); if (el) el.textContent = L[key]; };
          const updatePlaceholder = (elId, key) => { const el = $(elId); if (el) el.placeholder = L[key]; };
          const updateTitle = (elId, key) => { const el = $(elId); if (el) el.title = L[key]; };
          const updateHtml = (elId, key) => { const el = $(elId); if (el) el.innerHTML = L[key]; };
          
          // --- Update Welcome Screen ---
          updateText('welcomeTitle', 'appName'); updateText('welcomeSubtitle', 'welcomeSubtitle'); updateText('startBtn', 'startButtonText');
          
          // --- Update User Data Screen ---
          updateText('userDataTitle', 'userDataTitle'); updateText('userDataSubtitle', 'userDataSubtitle');
          updatePlaceholder('userName', 'namePlaceholder'); updatePlaceholder('userAge', 'agePlaceholder'); updatePlaceholder('userCountry', 'countryPlaceholder');
          updateText('nextBtn', 'nextButtonText');
          
          // --- Update Chat UI ---
          updateText('chatTitle', 'appName'); updatePlaceholder('userInput', 'inputPlaceholder');
          updateText('ctaTitle', 'ctaTitle'); updateText('ctaSubtitle', 'ctaSubtitle'); updateText('generatePlanBtn', 'getPlanButton');
          updateTitle('resetBtn', 'resetTitle');

          // --- Update Modals ---
          updateText('contactModalTitle', 'contactModalTitle'); updateText('contactModalText1', 'contactModalText1');
          updateText('whatsappBtnText', 'whatsappBtnText'); updateText('phoneBtnText', 'phoneBtnText');
          updateText('resetModalTitle', 'resetModalTitle');
          updateText('resetModalText', 'resetModalText'); updateText('cancelResetBtn', 'resetCancelBtn');
          updateText('confirmResetBtn', 'resetConfirmBtn');
          updateText('profileName', 'profileName'); updateText('profilePhone', 'profilePhone');
          updateText('profileBioTitle', 'profileBioTitle'); updateText('profileBioText', 'profileBioText');
          updateText('profileGetPlanBtn', 'profileGetPlanBtn');
          updateText('howToUseTitle', 'howToUseTitle');
          updateHtml('howToUseContent', 'howToUseContent');
          
          // --- Update Context Menu ---
          updateText('contextCopy', 'contextCopy'); updateText('contextShare', 'contextShare'); updateText('contextPin', 'contextPin');
          updateText('contextEdit', 'contextEdit'); updateText('contextDelete', 'contextDelete');
          updateTitle('unpinBtn', 'unpinTitle');
          
          // --- Update Cards & Footer ---
          updateText('iherbTitle', 'iherbTitle'); updateText('iherbSubtitle', 'iherbSubtitle');
          updateText('copy-and-go-iherb-btn-text', 'copyAndGoButton');
          updateText('coffeeText', 'coffeeText'); updateText('coffeeBtnText', 'coffeeBtnText'); updateText('coffeeBtnText2', 'coffeeBtnText2');
          updateText('footerRights', 'footerRights');
          updateText('footerCoffee', 'footerCoffee');
          updateText('howToUseText', 'howToUseText');

          // --- Global Elements ---
          document.querySelectorAll('.lang-toggle-btn').forEach(btn => { btn.textContent = lang === 'ar' ? 'EN' : 'AR'; });
          document.title = `${L.appName} | Smart Personal Coach`;
        },

        autoSetByText(s) {
          if (!s) return;
          const isArabic = /[\u0600-\u06FF]/.test(s);
          const newLang = isArabic ? 'ar' : 'en';
          if (newLang !== App.state.lang) {
            this.setLang(newLang);
          }
        }
      },

      /**
       * -----------------------------------------------------------------
       * 4. UTILITIES MODULE
       * -----------------------------------------------------------------
       */
      utils: {
        setTheme() {
          document.documentElement.classList.toggle('dark');
          const isDark = document.documentElement.classList.contains('dark');
          App.elements.btnTheme.textContent = isDark ? '🌙' : '☀️';
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        },
        toast(msg) {
          const t = document.createElement('div');
          t.className = 'toast';
          t.textContent = msg;
          document.body.appendChild(t);
          setTimeout(() => t.classList.add('show'), 10);
          setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 400);
          }, 2400);
        },
        removeNode(node) {
          if (node && node.parentNode) node.parentNode.removeChild(node);
        },
        formatTime(timestamp) {
          return new Date(timestamp).toLocaleTimeString(
            App.state.lang === 'ar' ? 'ar-EG' : 'en-US',
            { hour: 'numeric', minute: '2-digit', hour12: true }
          );
        }
      },

      /**
       * -----------------------------------------------------------------
       * 5. UI MANIPULATION MODULE
       * -----------------------------------------------------------------
       */
      ui: {
        displayMessage(message) {
          const { chatMessages } = App.elements;
          const bubble = document.createElement('div');
          let sender = message.role === 'assistant' ? 'ai' : 'user';

          // Handle error messages with a distinct style
          if (message.role === 'error') {
            sender = 'error';
            bubble.dataset.originalPrompt = JSON.stringify(message.originalPrompt);
            bubble.dataset.originalImages = JSON.stringify(message.originalImages);
            bubble.dataset.originalMessageId = message.originalMessageId;
          }

          bubble.className = `message-bubble ${sender}`;
          bubble.dataset.messageId = message.id;

          let finalHtml = '';

          if (message.role === 'user' && message.images && message.images.length > 0) {
              const imageContainer = document.createElement('div');
              imageContainer.className = 'flex flex-wrap gap-2 mb-2';
              message.images.forEach(imgDataUrl => {
                  const img = document.createElement('img');
                  img.src = imgDataUrl;
                  img.className = 'max-w-[100px] h-auto rounded-lg cursor-pointer';
                  img.alt = 'uploaded image';
                  img.onclick = () => App.handlers.handleViewImage(imgDataUrl);
                  imageContainer.appendChild(img);
              });
              finalHtml += imageContainer.outerHTML;
          }

          const content = message.parts?.[0]?.text || '';
          const safeContent = (content && typeof content === 'string') ? content : '';
          if (safeContent) {
              finalHtml += `<div class="msg-content">${marked.parse(safeContent)}</div>`;
          }

          const timeHtml = `<div class="message-meta"><span class="message-time">${App.utils.formatTime(message.timestamp)}</span></div>`;
          bubble.innerHTML = finalHtml + timeHtml;
          
          // Add a resend button for error messages
          if (message.role === 'error') {
            const resendBtn = document.createElement('button');
            resendBtn.className = 'resend-btn self-end';
            resendBtn.textContent = (App.state.lang === 'ar') ? 'إعادة الإرسال' : 'Resend';
            resendBtn.onclick = () => App.handlers.handleResend(bubble);
            bubble.appendChild(resendBtn);
          }
          
          chatMessages.appendChild(bubble);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          App.handlers.addMessageEventListeners(bubble);
          return bubble;
        },

        showTyping(sender = 'ai') {
          const { chatMessages } = App.elements;
          const bubble = document.createElement('div');
          bubble.className = `message-bubble ${sender}`;
          bubble.innerHTML = `<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
          chatMessages.appendChild(bubble);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          return bubble;
        },

        togglePlanCTA() {
          const isDataComplete = ['name', 'age', 'country'].every(k => !!App.state.userState.data[k]);
          if(App.elements.generatePlanBtn) {
            App.elements.generatePlanBtn.disabled = !isDataComplete;
          }
        },

        rebuildChatUI() {
          App.elements.chatMessages.innerHTML = '';
          App.state.chatHistory.forEach(message => this.displayMessage(message));
        },

        updatePinnedMessageUI() {
          const { pinnedMessageArea, pinnedText } = App.elements;
          if (App.state.pinnedMessageId) {
            const pinnedMessage = App.state.chatHistory.find(m => m.id === App.state.pinnedMessageId);
            if (pinnedMessage) {
              const textContent = pinnedMessage.parts[0].text.replace(/\[Image Attached\]/g, '📷');
              pinnedText.textContent = textContent;
              pinnedMessageArea.classList.add('show');
              return;
            }
          }
          pinnedMessageArea.classList.remove('show');
          App.state.pinnedMessageId = null;  
        },

        renderImagePreviews() {
          const container = App.elements.imagePreviewsContainer;
          const wrapper = App.elements.imagePreviewsWrapper;
          container.innerHTML = '';

          if (App.state.pendingImages.length === 0) {
              wrapper.classList.add('hidden');
              return;
          }

          App.state.pendingImages.forEach(image => {
              const thumbWrapper = document.createElement('div');
              thumbWrapper.className = 'preview-thumbnail';
              
              const img = document.createElement('img');
              img.src = image.dataUrl;
              img.alt = 'Preview';
              img.onclick = () => App.handlers.handleViewImage(image.dataUrl);

              const removeBtn = document.createElement('button');
              removeBtn.className = 'remove-btn';
              removeBtn.innerHTML = '×';
              removeBtn.setAttribute('aria-label', 'Remove image');
              removeBtn.onclick = () => App.handlers.handleRemoveImage(image.id);

              thumbWrapper.appendChild(img);
              thumbWrapper.appendChild(removeBtn);
              container.appendChild(thumbWrapper);
          });

          wrapper.classList.remove('hidden');
        },
        
        setLoading(isLoading) {
          const { userInput, sendBtn, plusBtn, micBtn } = App.elements;
          userInput.disabled = isLoading;
          sendBtn.disabled = isLoading;
          plusBtn.disabled = isLoading;
          micBtn.disabled = isLoading;
          
          if (isLoading) {
            sendBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>`;
          } else {
            this.setEditing(false); // Reset button icon on load finish
          }
        },
        
        setEditing(isEditing) {
          const { sendBtn } = App.elements;
          if(isEditing) {
            sendBtn.innerHTML = `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            sendBtn.classList.add('!bg-blue-500');
          } else {
            sendBtn.innerHTML = `<svg class="w-5 h-5" style="transform: translateX(1px);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>`;
            sendBtn.classList.remove('!bg-blue-500');
          }
        }
      },

      /**
       * -----------------------------------------------------------------
       * 6. SERVICES MODULE (API Calls, Speech Recognition)
       * -----------------------------------------------------------------
       */
      services: {
        async callAI(prompt, { images, audio } = {}) {
          try {
            const payload = { prompt };
            if (images && images.length) {
              payload.images = images.map(x => {
                if (typeof x === 'string' && x.startsWith('data:')) {
                  const [meta, b64] = x.split(',');
                  const mime = meta.substring(5, meta.indexOf(';'));
                  return { mime, data: b64, dataUrl: x };
                }
                return x;
              });
            }
            if (audio) payload.audio = audio;
            
            const res = await fetch('/.netlify/functions/gemini-proxy', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok) throw new Error((data && (data.details || data.error)) || 'AI error');
            return data.text || '';
          } catch (e) {
            console.error("AI Call Error:", e);
            // Handle error and add a dedicated error message to the history
            const errorMsg = App.i18n.strings[App.state.lang].resendError;
            const originalPrompt = { text: prompt, images: images };
            const errorObject = {
              id: `error-${Date.now()}`,
              role: 'error',
              parts: [{ text: errorMsg }],
              timestamp: Date.now(),
              originalPrompt: originalPrompt,
            };
            App.state.chatHistory.push(errorObject);
            App.core.saveHistory();
            App.ui.displayMessage(errorObject);
            return null; // Return null to indicate failure
          }
        },
        speech: {
          supportSpeechRecognition: () => ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window),
          startLocalRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return null;
            const sessionId = ++App.state.sttSessionId;
            const rec = new SR();
            rec.lang = (App.state.lang === 'ar' ? 'ar-EG' : 'en-US');
            rec.interimResults = true;
            rec.continuous = true;
            rec.onresult = (e) => {
              if (sessionId !== App.state.sttSessionId) return;
              let final = '', interim = '';
              for (let i = e.resultIndex; i < e.results.length; i++) {
                if (e.results[i].isFinal) { final += e.results[i][0].transcript; }
                else { interim = e.results[i][0].transcript; }
              }
              const text = (final || interim).trim();
              if (text) {
                App.elements.userInput.value = text;
                App.elements.userInput.dispatchEvent(new Event('input'));
              }
            };
            rec.start();
            return { rec, sessionId };
          },
          async startRecording() {
            if (App.state.isRecording) return;
            App.state.isRecording = true;
            const L = App.i18n.strings[App.state.lang];
            if (this.supportSpeechRecognition()) {
              const h = this.startLocalRecognition();
              App.state.recognition = h?.rec || null;
            } else {
              App.utils.toast(L.recDenied);
              App.state.isRecording = false;
              return;
            }
            App.elements.micBtn.classList.add('mic-live');
            App.elements.recHintWrap.classList.remove('hidden');
            App.elements.recHint.textContent = L.recStart;
          },
          stopRecording() {
            if (!App.state.isRecording) return;
            App.state.isRecording = false;
            if (App.state.recognition && App.state.recognition.stop) {
              try {
                App.state.recognition.stop();
                App.core.sendMessage();
              } catch (_) {}
              App.state.recognition = null;
            }
            App.elements.micBtn.classList.remove('mic-live');
            App.elements.recHintWrap.classList.add('hidden');
            App.state.sttSessionId++;
          }
        }
      },
      
      /**
       * -----------------------------------------------------------------
       * 7. PROMPTS MODULE
       * -----------------------------------------------------------------
       */
      prompts: {
        buildCoachSystemPrompt() {
          return `
          📌 التوجيه التنفيذي النهائي — مدرب عالمي × خبير تغذية × خبير مكملات
          ⸻
          🎯 المهمة الرئيسية
              • أن تكون المساعد الشخصي الاحترافي للعميل بالنيابة عن المدرب مصطفى الصافي، معكسًا أعلى مستويات الدقة والاحترافية لتعزيز الثقة في الأداة.
              • تقديم خدمة شاملة ومخصصة بنسبة 100% بعد جمع البيانات اللازمة تشمل:
              • إعداد خطط تدريب وتغذية دقيقة للغاية.
              • استخدام أدق الأدوات العلمية لحساب السعرات والماكروز: Mifflin-St Jeor, Harris-Benedict, Katch-McArdle.
              • استخدام أدوات التمرين المتقدمة مثل RPE و1RM Estimation (Epley, Brzycki) لضبط الأحمال والشدة.
              • ترشيح مكملات غذائية آمنة وفعّالة يتم اختيارها فقط بناءً على بيانات العميل (الأهداف، الأمراض، الحالة الصحية، نمط الحياة).
              • الرد على جميع الاستفسارات بأسلوب بشري طبيعي واحترافي دون أي طابع آلي.
          ⸻
          🧑‍🤝‍🧑 الهوية والشخصية
              • الأسلوب: مدرب عالمي + أخصائي تغذية + خبير مكملات .
              • اللهجة: مصريةإحترافية مع مرونة في التكيف حسب أسلوب.
              • الممنوعات:
              • عدم إظهار أنك ذكاء اصطناعي تحت أي ظرف.
              • عدم البدء بردود عامة أو سطحية.
              • عدم تكرار كلام العميل أو إعادة صياغته بنفس الشكل.
              •  عدم ذكر اسم العميل بشكل مستمرإطلاقًا  فقط اذا كان سياق الكلام يسمح بذلك.
              • تجنب العبارات الجاهزة مثل “هدف رائع” أو “ممتاز جدًا”.
              • الردود: قصيرة، قوية، متنوعة، طبيعية 100%، غنية بالمفردات، وتراعي سياق المحادثة.
          ⸻
          🔄 قواعد جمع البيانات
              • لا يتم إعداد أي خطة قبل اكتمال الملف البياني للعميل.
              • قاعدة صارمة: لا تسأل أكثر من سؤال واحد في كل مرة. استثناء: يمكن طرح سؤالين فقط إذا كانا مرتبطين ببعضهما البعض بشكل مباشر (مثال: ما هو وزنك وطولك؟).
              • عند ظهور أي شيء غير طبيعي أو سلوك خاطئ في الأكل أو النوم أو التدريب → يتم التعمق فيه بأسئلة إضافية وتحليل مفصل.
              • الهدف هو الفهم الكامل وليس مجرد جمع بيانات.
              • إذا تجاهل العميل سؤالًا، تتم إعادة صياغته وطرحه بلطف.
              • دائمًا يتم تذكّر ما قيل سابقًا وعدم إعادة نفس السؤال مرة أخرى.
          البيانات الأساسية المطلوبة:
              • الهدف الرئيسي + المدة الزمنية + مؤشرات النجاح.
              • الوزن، الطول، العمر، الجنس.
              • مستوى النشاط ونمط الحياة + متوسط الخطوات اليومية.
              • بيئة التدريب (جيم/منزل)، عدد الأيام، المدة، الخبرة، الأدوات المتاحة.
              • التاريخ الصحي (إصابات، أمراض، عمليات، أدوية).
              • اختياري قياسات الجسم + صور أو InBody .
              • المؤشرات الحيوية (ضغط، سكر، دهون الدم، وظائف الكبد والكُلى، فيتامينات).
              • جودة النوم ومواعيده.
              • مستوى الضغط النفسي، السفر المتكرر، طبيعة العمل.
              • العادات الغذائية (وجبات، ماء، كافيين…).
              • مشاكل الهضم والتحمل الغذائي.
              • التفضيلات والقيود الغذائية.
              • الميزانية للطعام والمكملات.
              • إمكانات المطبخ/الطهي.
              • طرق التتبع المفضلة (تطبيقات، موازين…).
              • التجارب السابقة مع الأنظمة.
              • الأولويات التدريبية.
              • اختياري خطة القياس والمتابعة (وزن، صور، قياسات أسبوعية).
          ⸻
          🗣️ السيناريو الإرشادي
              • افتتاحية طبيعية تناسب الموقف.
              • رد قصير محفز بعد كل إجابة.
              • التفرع المنطقي في الأسئلة حسب الحوار.
              • إعادة صياغة الأسئلة المهملة بطريقة لبقة.
              • إضافة أسئلة إضافية دائمًا حسب ما يكشفه الحوار (نوم، إصابات، عادات سيئة…).
              • الردود متغيرة دائمًا ولا تتبع نفس الأسلوب أو الترتيب.
          ⸻
          📊 مرحلة ما قبل إعداد الخطة
              • قبل تجهيز الخطة: يتم استرجاع كل البيانات في رسالة مراجعة شاملة تُكتب بأسلوب عبقري واحترافي، ويُطلب من العميل تأكيدها.
              • بعد التأكيد: تُستخدم جميع البيانات كما هي بالكامل ودون أي اختصار لتصميم الخطة.
          بعد جمع كل البيانات:
              • 1. سؤال عن المكملات:
              • تُرشّح المكملات بشكل مخصص 100% بناءً على البيانات (الأهداف، الأمراض، الحالة الصحية).
              • عند موافقة العميل على شراء من iHerb: يتم تقديم كود خصم AYT3413 مرة واحدة فقط، بأسلوب ذكي وغير مزعج.
              • 2. طلب صور أو تحليل InBody لزيادة الدقة اذا توفرت.
          ⸻
          📋 إعداد وتسليم الخطة
              • فورًا بعد تأكيد العميل على ملخص البيانات، يتم تقديم الخطة الكاملة دون أي تأخير.
              • الخطة التدريبية:
              • منظمة بالأيام.
              • التمارين بالعربية + الإنجليزية.
              • Sets × Reps × Rest محسوبة بدقة باستخدام RPE و1RM Estimation.
              • الخطة الغذائية:
              • سعرات وماكروز دقيقة جدًا باستخدام Mifflin-St Jeor, Harris-Benedict, Katch-McArdle.
              • وجبات يومية مفصلة بالكميات والبدائل.
              • المكملات:
              • مدمجة بذكاء بناءً على البيانات الصحية.
              • فوائدها موضحة مع ترك القرار النهائي للعميل.
              • إدراج كود الخصم AYT3413 مرة واحدة فقط وبأسلوب لبق وغير دعائي.
              • في نهاية الخطة:
              • اقتراح متابعة خاصة أسبوعية للتعديلات والتوجيه، عبر زر “احصل على خطتك الآن” — بأسلوب طبيعي غير مزعج.
          ⸻
          🔬 تحليل البيانات والصور
              • عندما يرسل المستخدم صورة (أو صورًا متعددة)، قم بتحليلها بدقة كمدرب خبير.
              • الهدف: استخلاص ملاحظات عملية حول تكوين الجسم، الوضعية، التوزيع العضلي والدهني، وتحديد نقاط القوة والمجالات التي تحتاج إلى تحسين.
              • إذا كانت هناك بيانات (مثل InBody)، استخرج المقاييس الرئيسية وفسرها.
              • **الأهم:** لا تقدم التحليل على شكل تقرير أو قائمة نقاط منفصلة. يجب دمج ملاحظاتك بسلاسة وطبيعية في صلب ردك الحواري. اجعل الأمر يبدو وكأنك مدرب حقيقي يعلق على الصور التي أمامه.
              • مثال للأسلوب المطلوب: "تمام شفت الصور، مبدئيًا عندك بناء عضلي كويس في منطقة الأكتاف وده هيدينا شكل V-shape ممتاز. بس محتاجين نركز الفترة الجاية على تقوية عضلات أسفل الظهر والـ core عشان نحسن من ميلان الحوض الأمامي البسيط اللي لاحظته. ده هيفرق معانا جدًا في الأداء والأمان في تمارين زي السكوات والديدلفت."
          ⸻
          📞 سيناريو التواصل والاشتراك
              • إذا سأل العميل عن كيفية التواصل المباشر مع المدرب مصطفى الصافي أو عن تفاصيل الاشتراك، يتم توجيه الرد كالتالي:
              • للتواصل المباشر مع الكابتن مصطفى وفريق العمل، يمكنك استخدام الرقم الموجود عند الضغط على زر 'احصل على خطتك الآن'. هذا سينقلك مباشرة للتواصل معهم."
              • لأنك مهتم فعلًا، فريقنا يقدم لك جلسة تقييم مجانية لتكتشف كيف يمكن لشراكة متكاملة مع خبراء يتابعون تقدمك ويعدّلون خطتك باستمرار ويدعمونك بلا توقف أن تحقق لك تحولًا جذريًا ومستدامًا، فلا تفوّت الفرصة ولحجز موعدك اضغط الآن على زر “احصل على خطتك .
              • إذا كان الطلب يتطلب تدخلًا بشريًا مباشرًا، وجّه المستخدم بالرد: “يُرجى التواصل مع فريق العمل لإتمام هذا الطلب.
          ⸻
          🔒 الخصوصية والتواصل مع المدرب
              • عندما يسأل المستخدم عن سرية بياناته أو هل المدرب يطلع عليها، يجب أن تكون الإجابة: "تأكد أن هذه المحادثة سرية تمامًا ولا يطلع عليها أي شخص آخر لضمان خصوصيتك الكاملة."
              • عندما يطلب المستخدم التواصل مع الفريق أو المدرب، يجب أن تكون الإجابة: "بالتأكيد، سأقوم بتجهيز كل البيانات التي زودتني بها في رسالة واحدة. يمكنك نسخها بسهولة وإرسالها مباشرة للمدرب."
              • عندما يؤكد المستخدم طلبه ("نعم، أرسلها" أو ما شابه)، قم فورًا بإرسال ملخص شامل ومنسق لجميع البيانات التي تم جمعها في رسالة واحدة. لا تسأل أي أسئلة أخرى، فقط أرسل البيانات.
          ⸻
          ⚡ مميزات النظام الإضافية
              • تخصيص كامل لكل خطة بنسبة 100%.
              • ذكاء في صياغة الأسئلة حسب سياق الحوار.
              • ردود بشرية طبيعية بلا أي طابع آلي.
              • استخدام أدوات ومعادلات دقيقة مثبتة علميًا.
              • ترشيحات مكملات مصممة بعناية بناءً على البيانات الصحية.
              • مراجعة ذاتية قبل كل رد للتأكد من الدقة.
              • تنويع الردود وعدم الالتزام بترتيب ثابت.
              • تسويق ذكي غير مزعج: الكود AYT3413 يُذكر مرة واحدة فقط في التوقيت المناسب.
          `;
        },
      },

      /**
       * -----------------------------------------------------------------
       * 8. CORE LOGIC MODULE
       * -----------------------------------------------------------------
       */
      core: {
        saveHistory() {
          const sessionData = {
            chatHistory: App.state.chatHistory,
            userState: App.state.userState,
            pinnedMessageId: App.state.pinnedMessageId
          };
          localStorage.setItem(App.config.STORAGE_KEY, JSON.stringify(sessionData));
        },

        loadHistory() {
          const savedData = localStorage.getItem(App.config.STORAGE_KEY);
          if (savedData) {
            try {
              const sessionData = JSON.parse(savedData);
              if (sessionData.chatHistory && sessionData.userState) {
                App.state.chatHistory = sessionData.chatHistory;
                App.state.userState = sessionData.userState;
                App.state.pinnedMessageId = sessionData.pinnedMessageId || null;
                if (App.state.userState.step > 0) {
                  App.elements.welcomeScreen.classList.add('hidden');
                  App.elements.userDataScreen.classList.add('hidden');
                  App.elements.chatContainer.classList.remove('hidden');
                  App.ui.rebuildChatUI();
                  App.ui.togglePlanCTA();
                  App.ui.updatePinnedMessageUI();
                }
              }
            } catch (e) {
              console.error("Failed to load saved history:", e);
              localStorage.removeItem(App.config.STORAGE_KEY);
            }
          }
        },

        buildConversationContext() {
          let context = '';
          const history = [...App.state.chatHistory];
          for (let i = history.length - 1; i >= 0; i--) {
            const message = history[i];
            const role = message.role === 'assistant' ? 'المدرب' : 'المستخدم';
            const text = message.parts?.[0]?.text || '';
            const formattedMessage = `\n${role}: ${text}`;
            if ((context.length + formattedMessage.length) > App.config.MAX_PROMPT_CHARS) {
              break;
            }
            context = formattedMessage + context;
          }
          return context;
        },

        buildInternalStateSummary() {
          const d = App.state.userState.data || {};
          const f = [];
          if(d.name) f.push(`الاسم: ${d.name}`);
          if(d.age) f.push(`العمر: ${d.age}`);
          if(d.country) f.push(`الدولة: ${d.country}`);
          if(d.goal) f.push(`الهدف: ${d.goal}`);
          if(d.health) f.push(`حالة صحية: ${d.health}`);
          if(d.gym) f.push(`مكان التمرين: ${d.gym}`);
          if(d.meals) f.push(`وجبات/اليوم: ${d.meals}`);
          return f.length ? `🗒️ ملخص الحالة: ${f.join(' | ')}` : '';
        },

        analyzeUserMessage(msg) {
          const MED_FLAGS = /(سكري|ضغط|قلب|سرطان|حامل|حمل|رضاعة|غدة|درق|كبد|كلو[ية]|kidney|liver|thyroid|injury|إصابة|عملية|دواء|أدوية|كورتيزون|ضغط الدم|سكر الدم)/i;
          if (MED_FLAGS.test(msg)) {
            App.state.userState.data.health = (App.state.userState.data.health || 'قيود صحية');
          }
          if (/خطة|أخس|تخسيس|تضخيم|عضل/i.test(msg)) App.state.userState.data.goal = App.state.userState.data.goal || 'خطة مخصصة';
          if (/جيم|بيت|منزل/i.test(msg)) App.state.userState.data.gym = App.state.userState.data.gym || 'غير محدد';
        },

        async processAIResponse(originalPrompt, images = []) {
          const typingEl = App.ui.showTyping('ai');
          
          const fullPrompt = `${App.prompts.buildCoachSystemPrompt()}\n${this.buildInternalStateSummary() ? this.buildInternalStateSummary() + '\n' : ''}سجل المحادثة الكامل (الأحدث في الأسفل):\n${this.buildConversationContext()}`;
          
          let response = await App.services.callAI(fullPrompt, { images });
          App.utils.removeNode(typingEl);
          
          if (!response) {
            App.ui.setLoading(false);
            return;
          }
          const newMessage = { id: `ai-${Date.now()}`, role: 'assistant', parts: [{ text: response }], timestamp: Date.now() };
          
          App.state.chatHistory.push(newMessage);  
          this.saveHistory();  
          App.ui.displayMessage(newMessage);  
          App.ui.togglePlanCTA();
          App.ui.setLoading(false);
        },

        sendMessage() {
          const msg = (App.elements.userInput.value || '').trim();  
          const images = App.state.pendingImages;

          // Handle message editing flow
          if (App.state.isEditing) {
            const editIndex = App.state.chatHistory.findIndex(m => m.id === App.state.editingMessageId);
            if (editIndex > -1) {
              // Remove all messages from the edited message onwards
              App.state.chatHistory.splice(editIndex);  
            }
            App.state.isEditing = false;
            App.state.editingMessageId = null;
            App.ui.setEditing(false);
          }

          if (!msg && images.length === 0) return;
          
          App.ui.setLoading(true);
          App.i18n.autoSetByText(msg);
          
          const messageContent = images.length > 0 ? `${App.i18n.strings[App.state.lang].imageAttached} ${msg}`.trim() : msg;
          
          const newMessageForUI = {  
              id: `user-${Date.now()}`,  
              role: 'user',  
              parts: [{ text: msg }], // UI part only has text
              images: images.map(img => img.dataUrl), // UI part has images for display
              timestamp: Date.now()  
          };
          
          // Push a clean version to history for the AI context
          App.state.chatHistory.push({
            id: newMessageForUI.id,
            role: 'user',
            parts: [{ text: messageContent }], // AI context has combined text
            timestamp: newMessageForUI.timestamp
          });

          this.saveHistory();
          App.ui.displayMessage(newMessageForUI);
          
          this.analyzeUserMessage(msg);  
          this.processAIResponse(msg, images.map(img => img.dataUrl));
          
          App.elements.userInput.value = '';  
          App.handlers.clearPendingImages();
        }
      },

      /**
       * -----------------------------------------------------------------
       * 9. EVENT HANDLERS MODULE
       * -----------------------------------------------------------------
       */
      handlers: {
        // --- Screen & Navigation Handlers ---
        handleStartClick() {
          App.elements.welcomeScreen.classList.add('hidden');
          App.elements.userDataScreen.classList.remove('hidden');
          App.i18n.setLang(App.state.lang);
        },
        handleNextClick() {  
          const { userNameInput: u, userAgeInput: a, userCountryInput: c } = App.elements;  
          const n=u.value.trim(),g=a.value.trim(),o=c.value.trim();  
          App.i18n.autoSetByText(n||o);  
          if(!n||!g||!o){ App.utils.toast(App.i18n.strings[App.state.lang].emptyFields); return; }  
          App.state.userState.data={...App.state.userState.data,name:n,age:g,country:o};  
          App.state.userState.step = 1;  
          App.elements.userDataScreen.classList.add('hidden');  
          App.elements.chatContainer.classList.remove('hidden');  
          
          const L = App.i18n.strings[App.state.lang];
          const welcomeMsg = L.welcomeMessage.replace('{name}', n);
          
          const firstMessage = {id: `ai-${Date.now()}`, role:'assistant', parts:[{text:welcomeMsg}], timestamp: Date.now()};  
          App.state.chatHistory = [firstMessage];  
          App.core.saveHistory();  
          App.ui.displayMessage(firstMessage);  
          App.ui.togglePlanCTA();  
        },

        // --- Input Area Handlers ---
        handleKeyPress(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            App.core.sendMessage();
          }
        },
        handleFileChange(e) {
          const L = App.i18n.strings[App.state.lang];
          const limit = App.config.MAX_IMAGES;
          let files = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
          
          if (!files.length) return;

          const currentCount = App.state.pendingImages.length;
          const canUploadCount = limit - currentCount;

          if (canUploadCount <= 0) {
              App.utils.toast(L.maxImagesReached);
              e.target.value = '';
              return;
          }

          if (files.length > canUploadCount) {
              App.utils.toast(L.maxImagesReached);
              files = files.slice(0, canUploadCount);
          }
          
          const filePromises = files.map(file => {
              return new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = (ev) => resolve({
                      id: `${Date.now()}-${file.name}`,
                      dataUrl: ev.target.result
                  });
                  reader.onerror = reject;
                  reader.readAsDataURL(file);
              });
          });

          Promise.all(filePromises).then(newImages => {
              App.state.pendingImages.push(...newImages);
              App.ui.renderImagePreviews();
          });

          e.target.value = '';
        },
        clearPendingImages() {
          App.state.pendingImages = [];
          App.ui.renderImagePreviews();
        },
        handleRemoveImage(id) {
          App.state.pendingImages = App.state.pendingImages.filter(img => img.id !== id);
          App.ui.renderImagePreviews();
        },
        handleMicRecord(e) {
          e.preventDefault();
          App.services.speech.startRecording();
        },
        handleMicStop(e) {
          e.preventDefault();
          App.services.speech.stopRecording();
        },

        // --- Modal Handlers ---
        openContactModal() {
          App.elements.contactModal.classList.add('open');
          App.elements.contactModal.setAttribute('aria-hidden', 'false');
        },
        closeContactModal() {
          App.elements.contactModal.classList.remove('open');
          App.elements.contactModal.setAttribute('aria-hidden', 'true');
        },
        openProfileModal() {
          App.elements.profileModal.classList.add('open');
          App.elements.profileModal.setAttribute('aria-hidden', 'false');
        },
        closeProfileModal() {
          App.elements.profileModal.classList.remove('open');
          App.elements.profileModal.setAttribute('aria-hidden', 'true');
        },
        handleProfileGetPlanClick() {
          this.closeProfileModal();
          this.openContactModal();
        },
        handleViewImage(dataUrl) {
          App.elements.fullImageView.src = dataUrl;
          App.elements.imageViewerModal.classList.add('open');
        },
        closeImageViewer() {
          App.elements.imageViewerModal.classList.remove('open');
        },
        openHowToUseModal() {
          App.elements.howToUseModal.classList.add('open');
        },
        closeHowToUseModal() {
          App.elements.howToUseModal.classList.remove('open');
        },
        handleModalClick(e) {
          if (e.target === App.elements.contactModal) this.closeContactModal();
          if (e.target === App.elements.profileModal) this.closeProfileModal();
          if (e.target === App.elements.resetConfirmModal) this.handleResetCancel();
          if (e.target === App.elements.imageViewerModal) this.closeImageViewer();
          if (e.target === App.elements.howToUseModal) this.closeHowToUseModal();
        },
        
        // --- Reset Handlers ---
        handleResetClick() {
          App.elements.resetConfirmModal.classList.add('open');
        },
        handleResetConfirm() {
          localStorage.removeItem(App.config.STORAGE_KEY);
          window.location.reload();
        },
        handleResetCancel() {
          App.elements.resetConfirmModal.classList.remove('open');
        },
        
        // --- Message Interaction Handlers ---
        addMessageEventListeners(bubble) {
          bubble.addEventListener('pointerdown', (e) => this.handleLongPressStart(e, bubble));
          bubble.addEventListener('pointerup', this.handleLongPressEnd);
          bubble.addEventListener('pointerleave', this.handleLongPressEnd);
          bubble.addEventListener('contextmenu', e => e.preventDefault());
        },
        handleLongPressStart(e, bubble) {
          if (App.state.longPressTimer) clearTimeout(App.state.longPressTimer);
          App.state.longPressTimer = setTimeout(() => { this.showContextMenu(bubble); }, App.config.LONG_PRESS_DURATION);
        },
        handleLongPressEnd() {
          clearTimeout(App.state.longPressTimer);
        },
        showContextMenu(bubble) {
          const { messageContextMenu } = App.elements;
          const messageId = bubble.dataset.messageId;
          const message = App.state.chatHistory.find(m => m.id === messageId);
          if (!message) return;
          
          App.state.currentContextMenu = { bubble, message };
          const isPinned = App.state.pinnedMessageId === messageId;
          const isUser = message.role === 'user';
          const L = App.i18n.strings[App.state.lang];
          
          messageContextMenu.querySelector('[data-action="pin"] span').textContent = isPinned ? L.contextUnpin : L.contextPin;
          
          messageContextMenu.querySelectorAll('[data-role="user-only"], [data-role="separator"]').forEach(el => {
            el.style.display = isUser ? '' : 'none';
          });

          const rect = bubble.getBoundingClientRect();
          document.body.appendChild(messageContextMenu);

          let top = window.scrollY + rect.top - messageContextMenu.offsetHeight - 10;
          if (top < window.scrollY + 10) {
            top = window.scrollY + rect.bottom + 10;
          }
          let left = rect.left + (rect.width / 2) - (messageContextMenu.offsetWidth / 2);
          left = Math.max(10, Math.min(left, window.innerWidth - messageContextMenu.offsetWidth - 10));

          messageContextMenu.style.top = `${top}px`;
          messageContextMenu.style.left = `${left}px`;
          messageContextMenu.classList.add('show');
        },
        hideContextMenu() {
          App.elements.messageContextMenu.classList.remove('show');
          App.state.currentContextMenu = null;
        },
        handleContextMenuAction(action) {
          const { message } = App.state.currentContextMenu;
          const L = App.i18n.strings[App.state.lang];
          const textContent = message.parts[0].text;
          
          if (action === 'copy') { navigator.clipboard.writeText(textContent).then(() => App.utils.toast(L.copied)); }  
          else if (action === 'share') { if (navigator.share) { navigator.share({ text: textContent }).then(() => App.utils.toast(L.sharedSuccessfully)).catch(() => App.utils.toast(L.shareFailed)); } else { App.utils.toast(L.shareFailed); } }
          else if (action === 'pin') { App.state.pinnedMessageId = (App.state.pinnedMessageId === message.id) ? null : message.id; App.core.saveHistory(); App.ui.updatePinnedMessageUI(); }
          else if (action === 'edit') { this.handleStartEdit(message); }
          else if (action === 'delete') { this.handleDelete(message); }

          this.hideContextMenu();
        },
        handleStartEdit(message) {
          const { userInput } = App.elements;
          const uiMessage = document.querySelector(`[data-message-id="${message.id}"]`);
          const msgContentDiv = uiMessage.querySelector('.msg-content');
          if (!msgContentDiv) return;

          App.state.isEditing = true;
          App.state.editingMessageId = message.id;
          App.ui.setEditing(true);

          userInput.value = msgContentDiv.innerText;
          userInput.focus();
          userInput.dispatchEvent(new Event('input')); // To trigger textarea resize
        },
        handleDelete(message) {
          const deleteIndex = App.state.chatHistory.findIndex(m => m.id === message.id);
          if (deleteIndex > -1) {
            App.state.chatHistory.splice(deleteIndex); // Remove this message and all subsequent ones
            App.ui.rebuildChatUI();
            App.core.saveHistory();
            App.utils.toast(App.i18n.strings[App.state.lang].messageDeleted);
          }
        },
        handleUnpin() {
          App.state.pinnedMessageId = null;
          App.core.saveHistory();
          App.ui.updatePinnedMessageUI();
        },
        // New: Resend Handler
        handleResend(errorBubble) {
            const originalPrompt = JSON.parse(errorBubble.dataset.originalPrompt);
            const originalImages = JSON.parse(errorBubble.dataset.originalImages);
            const originalMessageId = errorBubble.dataset.originalMessageId;

            // Remove the error message from the UI and history
            const errorIndex = App.state.chatHistory.findIndex(m => m.id === errorBubble.dataset.messageId);
            if (errorIndex > -1) {
                App.state.chatHistory.splice(errorIndex, 1);
            }
            errorBubble.remove();
            
            // Call processAIResponse again with the original data
            App.ui.setLoading(true);
            App.core.processAIResponse(originalPrompt.text, originalImages);
        },

        // New: Scroll to bottom handler
        handleScrollToBottom() {
          App.elements.chatMessages.scrollTop = App.elements.chatMessages.scrollHeight;
        },

        // New: Show/Hide scroll button
        handleChatScroll() {
          const chat = App.elements.chatMessages;
          const isAtBottom = chat.scrollHeight - chat.scrollTop <= chat.clientHeight + 50;
          if (isAtBottom) {
            App.elements.scrollToBottomBtn.style.display = 'none';
          } else {
            App.elements.scrollToBottomBtn.style.display = 'grid';
          }
        },


        // --- Misc Handlers ---
        handleIherbCopy(e) {
          e.preventDefault();
          const { copyAndGoIherbBtn, iherbCode } = App.elements;
          if (!copyAndGoIherbBtn || !iherbCode) return;
          const code = iherbCode.textContent.trim();
          navigator.clipboard.writeText(code).then(() => {
            App.utils.toast(App.i18n.strings[App.state.lang].iherbCopiedAndRedirecting);
            setTimeout(() => { window.open(copyAndGoIherbBtn.href, '_blank'); }, 800);
          });
        },
        handleIherbCodeClick() {
          const code = App.elements.iherbCode.textContent.trim();
          navigator.clipboard.writeText(code).then(() => App.utils.toast(App.i18n.strings[App.state.lang].copied));
        },
      },

      /**
       * -----------------------------------------------------------------
       * 10. APP INITIALIZATION
       * -----------------------------------------------------------------
       */
      init() {
        document.addEventListener('DOMContentLoaded', () => {
          this.cacheElements();
          
          // --- Initial Setup (Theme, Language, History) ---
          const savedTheme = localStorage.getItem('theme');
          if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            this.elements.btnTheme.textContent = '🌙';
          }
          this.i18n.setLang(navigator.language.startsWith('ar') ? 'ar' : 'en');
          this.core.loadHistory();

          // --- Bind Event Listeners ---
          const { elements: E, handlers: H, utils: U, core: C, i18n: I } = this;
          
          // Screen Navigation
          E.startBtn.addEventListener('click', H.handleStartClick);
          E.nextBtn.addEventListener('click', () => H.handleNextClick.call(App));

          // Main Chat UI
          E.chatAvatar.addEventListener('click', H.openProfileModal);
          E.btnTheme.addEventListener('click', U.setTheme);
          E.resetBtn.addEventListener('click', H.handleResetClick);
          document.querySelectorAll('.lang-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => I.setLang(this.state.lang === 'ar' ? 'en' : 'ar'));
          });
          
          // Input Area
          E.sendBtn.addEventListener('click', () => C.sendMessage.call(C));
          E.userInput.addEventListener('keypress', H.handleKeyPress);
          E.plusBtn.addEventListener('click', () => E.fileInput.click());
          E.fileInput.addEventListener('change', H.handleFileChange);
          ['pointerdown','touchstart'].forEach(ev => E.micBtn.addEventListener(ev, H.handleMicRecord, {passive:false}));
          ['pointerup','touchend','mouseleave'].forEach(ev => E.micBtn.addEventListener(ev, H.handleMicStop, {passive:false}));
          
          // Modals & Overlays
          E.generatePlanBtn.addEventListener('click', H.openContactModal);
          E.closeContactBtn.addEventListener('click', H.closeContactModal);
          E.contactModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          E.closeProfileBtn.addEventListener('click', H.closeProfileModal);
          E.profileModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          E.profileGetPlanBtn.addEventListener('click', () => H.handleProfileGetPlanClick.call(H));
          E.confirmResetBtn.addEventListener('click', H.handleResetConfirm);
          E.cancelResetBtn.addEventListener('click', H.handleResetCancel);
          E.resetConfirmModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          E.closeImageViewerBtn.addEventListener('click', H.closeImageViewer);
          E.imageViewerModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          E.howToUseLink.addEventListener('click', (e) => { e.preventDefault(); H.openHowToUseModal(); });
          E.closeHowToUseBtn.addEventListener('click', H.closeHowToUseModal);
          E.howToUseModal.addEventListener('click', (e) => H.handleModalClick.call(H, e));
          
          // Message Interactions
          E.messageContextMenu.addEventListener('click', (e) => {
            const action = e.target.closest('[data-action]')?.dataset.action;
            if (action) H.handleContextMenuAction.call(H, action);
          });
          document.addEventListener('click', (e) => {
            if (E.messageContextMenu.classList.contains('show') && !E.messageContextMenu.contains(e.target) && !e.target.closest('.message-bubble')) {
              H.hideContextMenu.call(H);
            }
          });
          E.unpinBtn.addEventListener('click', H.handleUnpin);
          E.pinnedMessageArea.addEventListener('click', (e) => {
            if (e.target !== E.unpinBtn && !E.unpinBtn.contains(e.target)) {
              const msgEl = document.querySelector(`[data-message-id="${App.state.pinnedMessageId}"]`);
              if (msgEl) msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });

          // New Event Listener for the scroll button
          E.scrollToBottomBtn.addEventListener('click', H.handleScrollToBottom);
          E.chatMessages.addEventListener('scroll', H.handleChatScroll);

          // Misc
          E.copyAndGoIherbBtn.addEventListener('click', H.handleIherbCopy);
          E.iherbCode.addEventListener('click', () => H.handleIherbCodeClick.call(H));

          initUIEnhancements();
        });
      }
    };

    // --- Start the application ---
    window.App = App;
    App.init();

  </script>
</body>
</html>
