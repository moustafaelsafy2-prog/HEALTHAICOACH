<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مدربك الصحي الذكي | Your Smart Health Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: #F8FAFC;
      color: #334155;
    }
    .hero-bg {
      background: linear-gradient(135deg, #1A237E 0%, #0D47A1 100%);
    }
    .chat-container {
      max-width: 600px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-image: url('https://placehold.co/600x400/ECE5DD/ECE5DD');
      background-size: cover;
      background-repeat: repeat;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      overflow: hidden;
    }
    .chat-header {
      background-color: #075E54;
      color: white;
      padding: 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-messages {
      flex-grow: 1;
      padding: 1rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 5rem;
    }
    .message-bubble {
      padding: 0.8rem 1.2rem;
      border-radius: 1.5rem;
      max-width: 80%;
      margin-bottom: 0.75rem;
      position: relative;
    }
    .message-bubble.user {
      background-color: #DCF8C6;
      margin-left: auto;
      border-bottom-left-radius: 0.2rem;
    }
    .message-bubble.ai {
      background-color: #FFFFFF;
      margin-right: auto;
      border-bottom-right-radius: 0.2rem;
    }
    .input-area {
      display: flex;
      padding: 0.5rem;
      background-color: #F0F0F0;
      border-top: 1px solid #ddd;
      position: sticky;
      bottom: 0;
      z-index: 10;
      align-items: flex-end;
    }
    .input-area input {
      flex-grow: 1;
      border-radius: 2rem;
      padding: 0.75rem 1.5rem;
      border: none;
      outline: none;
      background-color: #FFFFFF;
    }
    .input-area button {
      background-color: #075E54;
      color: white;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .message-bubble table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }
    .message-bubble th, .message-bubble td {
      border: 1px solid #e2e8f0;
      padding: 0.5rem;
      text-align: right;
    }
    .message-bubble th {
      background-color: #f1f5f9;
    }
    .summary-card {
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .welcome-screen, .user-data-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      background: linear-gradient(135deg, #075E54 0%, #128C7E 100%);
      color: white;
    }
    .cta-btn {
      background: #25D366;
      transition: all 0.3s ease;
    }
    .cta-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 15px rgba(37, 211, 102, 0.4);
    }
    .lang-switcher button, .theme-toggle button {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: bold;
        transition: all 0.3s;
    }
    .lang-switcher button.active, .theme-toggle button:hover {
        background-color: white;
        color: #075E54;
    }
    .user-data-screen input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      width: 100%;
      margin-bottom: 1rem;
    }
    .user-data-screen input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      text-align: center;
      padding: 0.5rem;
      font-size: 0.75rem;
      color: #6B7280;
      background-color: #F8FAFC;
    }
    .input-icons button {
        background: transparent;
        box-shadow: none;
        color: #6B7280;
    }
    .plan-actions-container {
      position: fixed;
      bottom: 5.5rem;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 600px;
      padding: 1rem;
      box-sizing: border-box;
      background-color: #F8FAFC;
      border-top: 1px solid #CBD5E1;
      text-align: center;
    }
    .dark .plan-actions-container {
      background-color: #1A1A1A;
      border-top-color: #2D3748;
    }
    
    .wave-container {
        flex-grow: 1;
        height: 40px;
        display: flex;
        align-items: center;
        gap: 2px;
        direction: ltr;
    }

    .wave-bar {
        background-color: #128C7E;
        height: 2px;
        width: 2px;
        transition: height 0.3s ease;
    }
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">
  <div class="welcome-screen" id="welcomeScreen">
    <img src="https://placehold.co/150x150/ffffff/0D47A1?text=AI+Coach" alt="AI Coach Avatar" class="rounded-full mb-6 shadow-xl"/>
    <h1 class="text-4xl font-bold mb-2" id="welcomeTitle">مدربك الصحي الشخصي</h1>
    <p class="text-xl font-light text-white/90 mb-8" id="welcomeSubtitle">ابدأ رحلتك نحو الأفضل الآن</p>
    <button id="startBtn" class="cta-btn text-white font-bold py-4 px-8 rounded-full shadow-lg hover:shadow-2xl transition-all duration-300" id="startButtonText">
      ابدأ المحادثة
    </button>
  </div>

  <div class="user-data-screen hidden" id="userDataScreen">
    <h2 class="text-3xl font-bold mb-4" id="userDataTitle">لنبدأ رحلتك</h2>
    <p class="text-lg font-light text-white/90 mb-6" id="userDataSubtitle">أخبرنا عن نفسك لتبدأ</p>
    <div class="w-full max-w-xs">
      <input type="text" id="userName" placeholder="اسمك" dir="rtl">
      <input type="number" id="userAge" placeholder="عمرك" dir="ltr">
      <input type="text" id="userCountry" placeholder="دولتك" dir="rtl">
      <button id="nextBtn" class="cta-btn w-full text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-2xl transition-all duration-300 mt-4">
        التالي
      </button>
    </div>
  </div>

  <div class="chat-container hidden" id="chatContainer">
    <div class="chat-header">
      <span class="text-xl font-bold" id="chatTitle">Coach AI</span>
      <div class="flex items-center space-x-2 space-x-reverse">
        <div class="lang-switcher flex">
          <button id="btnAr">عربي</button>
          <button id="btnEn">EN</button>
        </div>
        <div class="theme-toggle">
          <button id="btnTheme">☀️</button>
        </div>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages" role="region" aria-label="Chat messages"></div>
    <div class="input-area" id="inputArea">
        <button id="plusBtn" aria-label="أرسل ملف" class="mr-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
        </button>
        <div class="flex-1 relative">
            <input type="text" id="userInput" placeholder="اكتب رسالتك..." dir="rtl" class="w-full"/>
            <button id="voiceBtn" aria-label="تسجيل صوتي" class="absolute left-2 top-1/2 -translate-y-1/2 rounded-full p-2 bg-transparent text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
            </button>
        </div>
        <button id="sendBtn" aria-label="أرسل" class="ml-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
    </div>
    <div class="recording-area hidden" id="recordingArea">
      <button id="cancelVoiceBtn" aria-label="إلغاء">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      </button>
      <div class="flex items-center gap-2 flex-grow mx-4">
        <span class="timer font-medium" id="recordingTimer">00:00</span>
        <div class="wave-container" id="waveContainer"></div>
      </div>
      <button id="sendVoiceBtn" class="cta-btn text-white p-2 rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </button>
    </div>
    <div class="plan-actions-container hidden" id="planActions">
      <button id="generatePlanBtn" class="cta-btn w-full text-white font-bold py-3 px-6 rounded-full shadow-lg">
        يمكنك بدء خطتك الآن اضغط هنا
      </button>
      <p class="text-xs text-slate-500 mt-2" id="planActionsMessage">
        يمكنك أيضاً الاستمرار في المحادثة مع المدرب إذا كانت لديك أي استفسارات أو بيانات إضافية.
      </p>
    </div>
  </div>

  <footer class="footer">
    © 2024 مصطفى الصافي
  </footer>

  <script>
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const userDataScreen = document.getElementById('userDataScreen');
    const chatContainer = document.getElementById('chatContainer');
    const userNameInput = document.getElementById('userName');
    const userAgeInput = document.getElementById('userAge');
    const userCountryInput = document.getElementById('userCountry');
    const btnAr = document.getElementById('btnAr');
    const btnEn = document.getElementById('btnEn');
    const btnTheme = document.getElementById('btnTheme');
    const plusBtn = document.getElementById('plusBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const fileInput = document.getElementById('fileInput');
    const recordingArea = document.getElementById('recordingArea');
    const cancelVoiceBtn = document.getElementById('cancelVoiceBtn');
    const sendVoiceBtn = document.getElementById('sendVoiceBtn');
    const recordingTimer = document.getElementById('recordingTimer');
    const planActionsContainer = document.getElementById('planActions');
    const generatePlanBtn = document.getElementById('generatePlanBtn');
    const waveContainer = document.getElementById('waveContainer');

    let userState = { step: -1, data: {} };
    let LANG = 'ar';
    let isRecording = false;
    let recordingInterval;
    let seconds = 0;
    let mediaRecorder;
    let audioChunks = [];
    
    const i18n = {
      ar: {
        welcomeTitle: 'مدربك الصحي الشخصي',
        welcomeSubtitle: 'ابدأ رحلتك نحو الأفضل الآن',
        startButtonText: 'ابدأ المحادثة',
        userDataTitle: 'لنبدأ رحلتك',
        userDataSubtitle: 'أخبرنا عن نفسك لتبدأ',
        namePlaceholder: 'اسمك',
        agePlaceholder: 'عمرك',
        countryPlaceholder: 'دولتك',
        nextButtonText: 'التالي',
        chatTitle: 'Coach AI',
        inputPlaceholder: 'اكتب رسالتك...',
        prompts: [
            "أهلاً بك يا {name}! أنا هنا لمساعدتك. كن مستعداً لرحلة تحويلية، فنحن نعدك بخطة دقيقة 100%، مصممة خصيصاً لك. كل ما عليك هو التحدث مع مدربك مصطفى الصافي هنا.",
            "تمام، علشان أقدر أخصص الخطة ليك بالظبط، ممكن تقولي كام عمرك وجنسك (ذكر/أنثى) وطولك ووزنك؟",
            "تمام يا بطل. لو عندك أي فكرة عن نسبة الدهون أو محيط الخصر، ممكن تقول لي؟ لو لأ، مافيش مشكلة.",
            "عظيم. علشان أكون دقيق أكتر، كام يوم في الأسبوع ناوي تتمرن؟ ومدة الجلسة بتكون في حدود كام ساعة؟",
            "تمام. فين بتفضل تتمرن؟ في **البيت** ولا **الجيم**؟ وقول لي كمان إيه هي المعدات المتاحة عندك.",
            "عظيم! بالنسبة لنظامك الغذائي، بتفضل نظام معين؟ زي مثلاً **نظام متوازن**، أو **قليل الكربوهيدرات**، أو أي نظام تاني؟ وكم وجبة في اليوم بتكون مناسبة ليك؟",
            "تمام. هل عندك أي حساسية تجاه أي نوع من الأكل؟ (مثلاً: جلوتين، لاكتوز، فول سوداني، بيض، إلخ).",
            "تمام يا بطل. إيه أهم التحديات اللي بتواجهها عادةً في الأنظمة الغذائية أو الرياضية؟ (مثلاً: جوع، ضغط الوقت، سفر، إلخ).",
            "تمام. خلينا نشوف نمط حياتك. ممكن توصف لي نشاطك في الشغل؟ (مثلاً: مكتبي، خفيف، متوسط، ثقيل) وكم خطوة بتمشيها تقريباً في اليوم؟",
            "عظيم. وبتنام كام ساعة في اليوم تقريباً، ومستوى التوتر عندك عامل إزاي؟ (منخفض، متوسط، مرتفع)",
            "تمام. هل عندك أي إصابات حالية أو قيود طبية؟ وهل بتاخد أي أدوية أو مكملات غذائية في الوقت الحالي؟",
            "ممتاز. آخر سؤال، هل فيه عضلات معينة بتحس إنها محتاجة تركيز خاص في التمرين؟ (زي الصدر، الظهر، الأكتاف، إلخ).",
        ],
        summaryTitle: '**ملخص بياناتك:**',
        confirmMessage: 'هل كل حاجة تمام؟ نولّد الخطة؟ (جاوب بـ "أيوه" أو "عدّل البيانات")',
        editPrompt: 'تمام. ايه اللي محتاج نعدله في البيانات دي؟',
        badInput: "يا ريت لو ممكن تديني العمر والجنس والطول والوزن بالترتيب ده، علشان أقدر أظبط الخطة.",
        weirdWeight: "الوزن ده غريب شوية. ممكن تتأكد من الوزن اللي دخلته؟",
        emptyFields: "الرجاء إدخال اسمك وعمرك ودولتك للبدء.",
        imageUpload: 'تم إرسال الصورة. المدرب بيحللها دلوقتي...',
        generationStart: 'تمام يا بطل، لحظات وهتكون خطتك جاهزة. أنا بجهزها الآن.',
        generationDone: 'تم يا بطل! الخطة كاملة عندك. لو فيه أي تعديل أو سؤال، أنا موجود.',
        editPart: 'أنا أقدر أعدل أي جزء. قول لي إيه اللي محتاج يتغير في الخطة.',
        selectDay: 'حدد اليوم اللي عايز تعدله عشان أقدر أساعدك.',
        planActionMessage: "يمكنك أيضاً الاستمرار في المحادثة مع المدرب إذا كانت لديك أي استفسارات أو بيانات إضافية."
      },
      en: {
        welcomeTitle: 'Your Personal Health Coach',
        welcomeSubtitle: 'Start your journey to a better you now',
        startButtonText: 'Start Chat',
        userDataTitle: 'Let’s start your journey',
        userDataSubtitle: 'Tell us about yourself to begin',
        namePlaceholder: 'Your Name',
        agePlaceholder: 'Your Age',
        countryPlaceholder: 'Your Country',
        nextButtonText: 'Next',
        chatTitle: 'Coach AI',
        inputPlaceholder: 'Type your message...',
        prompts: [
          "Hello, {name}! I'm here to help you. Get ready for a transformative journey; we promise you a 100% accurate plan, tailored specifically for you. All you have to do is talk to your coach Mustafa Elsafy here.",
          "Okay, to fully customize your plan, could you tell me your age, gender (Male/Female), height, and weight?",
          "Great, champ. If you have any idea about your body fat percentage or waist circumference, could you share them? If not, no problem.",
          "Awesome. To be more precise, how many days a week do you plan to work out? And what's the session length in hours?",
          "Okay. Where do you prefer to train? At **home** or at the **gym**? And tell me what equipment you have available.",
          "Awesome! Regarding your diet, do you have a preferred style? For example, a **balanced diet**, or **low-carb**, or any other? And how many meals a day would be suitable for you?",
          "Okay. Do you have any allergies to any type of food? (e.g., gluten, lactose, peanuts, eggs, etc.).",
          "Okay, champ. What are the main challenges you usually face with diet or workout plans? (e.g., hunger, time pressure, travel, etc.).",
          "Okay. Let's look at your lifestyle. Could you describe your work activity? (e.g., sedentary, light, moderate, heavy) and approximately how many steps you take per day?",
          "Great. And how many hours do you sleep per day, and what's your stress level? (low, moderate, high)",
          "Okay. Do you have any current injuries or medical conditions? And are you currently taking any medications or supplements?",
          "Excellent. Last question, are there any specific muscles you feel need special focus in your workout? (like chest, back, shoulders, etc.).",
        ],
        summaryTitle: '**Your Data Summary:**',
        confirmMessage: 'Is everything correct? Shall we generate the plan? (Reply with "yes" or "edit data")',
        editPrompt: 'Okay. What do you need to change in the data?',
        badInput: "Could you please provide your age, gender, height, and weight in that order to help me tailor the plan?",
        weirdWeight: "That weight seems a bit odd. Could you please double-check the weight you entered?",
        emptyFields: "Please enter your name, age, and country to get started.",
        imageUpload: 'Image sent. The coach is analyzing it now...',
        generationStart: 'Okay, champ! Your plan will be ready in a few moments. I\'m preparing it now.',
        generationDone: 'Done, champ! Your complete plan is ready. If you have any questions or need to make changes, I\'m here for you.',
        editPart: 'I can edit any part. Tell me what needs to be changed in the plan.',
        selectDay: 'Please specify the day you want to edit so I can help you.',
        planActionMessage: "You can also continue the conversation with the coach if you have any questions or want to provide additional data."
      },
    };
    
    function setLang(lang) {
      LANG = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      
      const L = i18n[LANG];
      
      const welcomeTitle = document.getElementById('welcomeTitle');
      if (welcomeTitle) welcomeTitle.textContent = L.welcomeTitle;
      const welcomeSubtitle = document.getElementById('welcomeSubtitle');
      if (welcomeSubtitle) welcomeSubtitle.textContent = L.welcomeSubtitle;
      const startButtonText = document.getElementById('startButtonText');
      if (startButtonText) startButtonText.textContent = L.startButtonText;

      const userDataTitle = document.getElementById('userDataTitle');
      if (userDataTitle) userDataTitle.textContent = L.userDataTitle;
      const userDataSubtitle = document.getElementById('userDataSubtitle');
      if (userDataSubtitle) userDataSubtitle.textContent = L.userDataSubtitle;
      const userName = document.getElementById('userName');
      if (userName) userName.placeholder = L.namePlaceholder;
      const userAge = document.getElementById('userAge');
      if (userAge) userAge.placeholder = L.agePlaceholder;
      const userCountry = document.getElementById('userCountry');
      if (userCountry) userCountry.placeholder = L.countryPlaceholder;
      const nextBtn = document.getElementById('nextBtn');
      if (nextBtn) nextBtn.textContent = L.nextButtonText;

      const chatTitle = document.getElementById('chatTitle');
      if (chatTitle) chatTitle.textContent = L.chatTitle;
      const userInput = document.getElementById('userInput');
      if (userInput) userInput.placeholder = L.inputPlaceholder;
      const btnAr = document.getElementById('btnAr');
      if (btnAr) btnAr.classList.toggle('active', LANG === 'ar');
      const btnEn = document.getElementById('btnEn');
      if (btnEn) btnEn.classList.toggle('active', LANG === 'en');
      const planActionsMessage = document.getElementById('planActionsMessage');
      if(planActionsMessage) planActionsMessage.textContent = L.planActionMessage;
    }

    function setTheme() {
      document.body.classList.toggle('dark');
      const isDarkMode = document.body.classList.contains('dark');
      btnTheme.textContent = isDarkMode ? '🌙' : '☀️';
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    function showToast(msg) {
        const t = document.createElement('div');
        t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-lg text-sm z-50';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function displayMessage(message, sender) {
      const bubble = document.createElement('div');
      bubble.classList.add('message-bubble', sender);
      bubble.innerHTML = marked.parse(message);
      chatMessages.appendChild(bubble);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Main function to send prompt to AI
    async function sendPromptToAI(prompt) {
        // Here we construct a comprehensive prompt for the AI
        const L = i18n[LANG];
        const fullPrompt = `
        You are Coach Mustafa Elsafy, a top-level health coach, nutritionist, and doctor.
        User's profile: Name: ${userState.data.name}, Age: ${userState.data.age}, Country: ${userState.data.country}.
        User's goals: ${userState.data.goals}.
        User's lifestyle: Work activity: ${userState.data.workActivity}, Daily steps: ${userState.data.dailySteps}.
        Health and constraints: Allergies: ${userState.data.allergies}, Medical conditions: ${userState.data.injuries}.

        Task: Generate a complete health plan for the user, acting as a coach, nutritionist, and doctor. The plan should be presented in a friendly, conversational tone and include a detailed meal plan, workout routine, and medical safety advice. The response must be in Markdown.
        `;
        
        // This part is a mock for Gemini API call
        // In a real app, this would be a fetch() call to a serverless function
        // that handles the actual API call to Gemini, for example:
        // const response = await fetch('/.netlify/functions/gemini-proxy', {
        //     method: 'POST',
        //     body: JSON.stringify({ prompt: fullPrompt })
        // });
        // const data = await response.json();
        // displayMessage(data.text, 'ai');

        // For this demo, we'll use a mock response based on a simple prompt check.
        // This section needs to be replaced with a real API call for true AI capabilities.
        const mockResponse = getMockAIResponse(prompt, L);
        displayMessage(mockResponse, 'ai');
    }

    function getMockAIResponse(prompt, L) {
        if (prompt.includes('خطة')) {
            return getMockPlanData(userState.data);
        } else if (prompt.includes('أهلاً')) {
            return `أهلاً بك يا ${userState.data.name}! أنا في خدمتك.`;
        } else if (prompt.includes('السعرات')) {
            return 'بناءً على بياناتك، السعرات الحرارية المقترحة لك هي حوالي 2200 سعر حراري في اليوم.';
        } else if (prompt.includes('غير واضح')) {
            return 'أنا آسف، لم أفهم ما تقصده. هل يمكنك توضيح طلبك بشكل أفضل؟';
        } else {
            return 'تمام. أنا أحلل طلبك الآن.';
        }
    }
    
    // Hardcoded data for demonstration
    const getMockPlanData = (data) => {
        return `
    **أهلاً بك يا بطل!**

    أنا متحمس جداً لبداية رحلتك معي. بناءً على المعلومات اللي شاركتها، أنا وفريقي من الخبراء جهزنا لك خطة متكاملة ومخصصة بنسبة 100% عشان تحقق كل أهدافك.

    ---
    ### **تحليل بياناتك**

    * **الهدف الأساسي:** خسارة الدهون
    * **السعرات الحرارية اليومية:** 2,200 سعرة حرارية. تم حسابها بناءً على عمرك ووزنك وطولك ومستوى نشاطك.
    * **الماكروز (البروتين/الدهون/الكربوهيدرات):**
        * **البروتين:** 160 جرام. أساسي للحفاظ على الكتلة العضلية أثناء خسارة الدهون.
        * **الدهون:** 65 جرام. ضرورية لصحة الهرمونات ووظائف الجسم.
        * **الكربوهيدرات:** 230 جرام. مصدر الطاقة الرئيسي للجسم، خاصة للتمارين.
    * **القيود:** تم مراعاة حساسيتك من اللاكتوز وتحدي الجوع الذي واجهته سابقاً.

    ---
    ### **برنامج التغذية (7 أيام)**

    تم تصميم نظامك الغذائي ليكون سهل التحضير (أقل من 30 دقيقة) ويساعدك على الشعور بالشبع.

    | الوجبة | المكونات | السعرات (kcal) | البروتين (g) | الدهون (g) | الكربوهيدرات (g) |
    |---|---|---|---|---|---|
    | **اليوم 1** | | | | | |
    | الفطور | 3 بيضات مخفوقة مع السبانخ، 1 شريحة خبز محمص من الحبوب الكاملة | 450 | 25 | 25 | 30 |
    | الغداء | 150 جرام صدر دجاج مشوي، كوب أرز بسمتي، سلطة خضراء كبيرة | 600 | 45 | 10 | 80 |
    | العشاء | 200 جرام سمك السلمون المشوي، خضار مشوية (بروكلي، فلفل) | 550 | 40 | 30 | 25 |
    | **المجموع** | | 1600 | 110 | 65 | 135 |

    ---
    ### **برنامج التدريب (3 أيام)**

    تم تصميم برنامجك لـ 3 أيام أسبوعياً مع التركيز على تقوية عضلات الظهر والأكتاف.

    | اليوم | التمرين | المجموعات | التكرارات | الراحة (ثانية) |
    |---|---|---|---|---|
    | **اليوم 1** | | | | |
    | الإحماء | 5 دقائق مشي سريع على السير | | | |
    | تمرين 1 | سحب البار (Barbell Rows) | 3 | 10-12 | 90 |
    | تمرين 2 | تمرين الضغط (Push-ups) | 3 | 8-10 | 60 |
    | تمرين 3 | الرفعة المميتة (Deadlifts) | 3 | 6-8 | 120 |
    | الإطالة | إطالة الظهر وأوتار الركبة | 5 دقائق | | |

    ---
    ### **المكملات الغذائية**

    لتحقيق أهدافك بشكل أسرع، إليك بعض المكملات الأساسية:
    * **الكرياتين:** 5 جرام يومياً. يساعد على زيادة القوة والأداء.
    * **البروتين:** 30 جرام بعد التمرين مباشرة. يعزز تعافي العضلات.

    ---
    ### **ملاحظات الطبيب**

    بناءً على ملفك، لا توجد أي حالات طبية تستدعي قلقاً. ومع ذلك، نوصي بالآتي:
    * **الترطيب:** اشرب 3-4 لتر من الماء يومياً.
    * **النوم:** احرص على النوم 7-8 ساعات يومياً لضمان تعافي الجسم بشكل كامل.
    * **إشارات الجسم:** انتبه لأي ألم حاد أو شعور بالإرهاق. لو شعرت بأي شيء غير طبيعي، خذ يوم راحة إضافي.

    ---
    **أتمنى لك رحلة موفقة يا ${data.name}! أنا هنا في أي وقت لو احتجت أي مساعدة.**

    **المدرب مصطفى الصافي**
    `;
    }
    
    // Event listeners
    startBtn.addEventListener('click', () => {
      welcomeScreen.classList.add('hidden');
      userDataScreen.classList.remove('hidden');
      setLang(localStorage.getItem('lang') || 'ar');
    });

    nextBtn.addEventListener('click', () => {
      const name = userNameInput.value.trim();
      const age = userAgeInput.value.trim();
      const country = userCountryInput.value.trim();
      
      if (!name || !age || !country) {
        showToast(i18n[LANG].emptyFields);
        return;
      }
      
      userState.data.name = name;
      userState.data.age = age;
      userState.data.country = country;
      
      userDataScreen.classList.add('hidden');
      chatContainer.classList.remove('hidden');
      
      const firstPrompt = i18n[LANG].prompts[0].replace('{name}', userState.data.name);
      displayMessage(firstPrompt, 'ai');
      userState.step = 1;
    });
    
    // Attach other listeners after the main UI is loaded
    window.addEventListener('load', () => {
      sendBtn.addEventListener('click', () => {
        const message = userInput.value.trim();
        if (message) {
            displayMessage(message, 'user');
            sendPromptToAI(message);
            userInput.value = '';
        }
      });
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendBtn.click();
        }
      });
      plusBtn.addEventListener('click', () => {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.multiple = true;
          fileInput.classList.add('hidden');
          fileInput.addEventListener('change', (e) => {
              const files = e.target.files;
              if (files.length > 0) {
                  // This is where you'd handle file upload
                  displayMessage(i18n[LANG].imageUpload, 'ai');
              }
          });
          document.body.appendChild(fileInput);
          fileInput.click();
      });
      
      btnAr.addEventListener('click', () => setLang('ar'));
      btnEn.addEventListener('click', () => setLang('en'));
      btnTheme.addEventListener('click', setTheme);
      if(generatePlanBtn) {
          generatePlanBtn.addEventListener('click', () => {
              const fullPrompt = `You are Coach Mustafa Elsafy, a top-level health coach, nutritionist, and doctor. User's profile: Name: ${userState.data.name}, Age: ${userState.data.age}, Country: ${userState.data.country}. User's goals: ${userState.data.goals}. User's lifestyle: Work activity: ${userState.data.workActivity}, Daily steps: ${userState.data.dailySteps}. Health and constraints: Allergies: ${userState.data.allergies}, Medical conditions: ${userState.data.injuries}. Task: Generate a complete health plan for the user, acting as a coach, nutritionist, and doctor. The plan should be presented in a friendly, conversational tone and include a detailed meal plan, workout routine, and medical safety advice. The response must be in Markdown.`;
              sendPromptToAI(fullPrompt);
          });
      }
      
      const savedLang = localStorage.getItem('lang') || 'ar';
      setLang(savedLang);
      
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.body.classList.add('dark');
        btnTheme.textContent = '🌙';
      }
    });
  </script>
</body>
</html>
