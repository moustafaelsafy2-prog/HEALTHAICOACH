<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>مدربك الشخصي الذكي | Smart Personal Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* -- Font Import -- */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;700;800;900&display=swap');

    /* -- Theme Variables (Light & Dark) -- */
    :root {
      --primary: #1B4332;      /* Deep Forest Green */
      --secondary: #2D6A4F;    /* Medium Sea Green */
      --accent: #FF7B54;       /* Vibrant Coral */
      --chat-bg: #F7F9F7;      /* Off-white with a hint of green */
      --bubble-user: #FFEADD;  /* Light Coral */
      --bubble-ai: #FFFFFF;
      --backdrop: rgba(27, 67, 50, 0.6);
      --text: #0D1B13;
      --muted: #556B5F;
      --surface: #FFFFFF;
      --border: #D8E0DA;
    }

    html.dark {
      --primary: #0D2119;
      --secondary: #1B4332;
      --accent: #FF8A65;
      --chat-bg: #101814;
      --bubble-user: #4A2C21;
      --bubble-ai: #1A2D24;
      --backdrop: rgba(0, 0, 0, 0.7);
      --text: #E0E0E0;
      --muted: #8A9E94;
      --surface: #0D2119;
      --border: #2D6A4F;
    }

    /* -- Base & Typography -- */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: var(--chat-bg);
      color: var(--text);
      transition: background-color .3s, color .3s;
      line-height: 1.7; /* Added for better spacing */
    }

    /* -- App Shell -- */
    .chat-container {
      max-width: 820px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
      border-radius: 1.5rem;
      overflow: hidden;
    }
    @supports (height: 100dvh) { .chat-container { height: 100dvh; } }
    @media (max-width: 768px) { 
      .chat-container { 
        border-radius: 0; 
        box-shadow: none;
        height: 100%; /* Ensure full height on mobile */
      } 
    }

    /* -- Header -- */
    .chat-header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      color: var(--text);
      padding: .875rem 1.25rem;
      position: sticky; top: 0; z-index: 10;
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0; /* Prevent header from shrinking */
    }
    .brand { display: flex; align-items: center; gap: .75rem; }
    .brand img {
      width: 44px; height: 44px;
      border-radius: 999px; object-fit: cover;
      border: 2px solid var(--accent);
    }
    .brand span { font-weight: 800; }
    @media (max-width: 420px) { .brand span { display: none; } }

    /* -- Chat Area -- */
    .chat-messages {
      flex: 1; padding: 1.25rem;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      padding-bottom: 7rem;
      background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.03) 1px, transparent 0);
      background-size: 25px 25px;
    }
    html.dark .chat-messages {
       background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.04) 1px, transparent 0);
    }

    /* -- Message Bubbles -- */
    .message-bubble {
      padding: .85rem 1.2rem;
      border-radius: 1.25rem; max-width: 85%;
      margin-bottom: .85rem; animation: fadeIn .3s ease-out;
      position: relative; line-height: 1.75;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      word-wrap: break-word; /* Ensure long words don't overflow */
    }
    .message-bubble.user {
      background: var(--bubble-user);
      color: #3D1E11; margin-left: auto;
      border-bottom-right-radius: .35rem;
    }
    .message-bubble.ai {
      background: var(--bubble-ai);
      color: var(--text); margin-right: auto;
      border: 1px solid var(--border);
      border-bottom-left-radius: .35rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }
    .message-bubble strong { color: var(--primary); }
    html.dark .message-bubble strong { color: var(--accent); }

    .msg-meta {
      display: flex; gap: .35rem; opacity: 0;
      transition: .2s; position: absolute;
      bottom: .35rem; inset-inline-end: .6rem;
    }
    .message-bubble:hover .msg-meta { opacity: .95; }
    .meta-btn {
      background: transparent; border: none; font-size: .85rem;
      cursor: pointer; color: var(--muted);
      padding: .15rem .35rem; border-radius: .35rem;
    }
    .meta-btn:hover { color: var(--accent); background: rgba(0,0,0,.05); }

    /* -- Input Area -- */
    .input-area {
      display: flex; gap: .5rem; padding: .75rem;
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      border-top: 1px solid var(--border);
      position: sticky; bottom: 0; z-index: 10;
      align-items: center; backdrop-filter: saturate(160%) blur(8px);
      padding-bottom: calc(.75rem + env(safe-area-inset-bottom));
      flex-shrink: 0; /* Prevent input from shrinking */
    }
    .input-area input[type=text] {
      flex: 1; border-radius: 999px;
      padding: .85rem 1.25rem; border: 1px solid var(--border);
      background: var(--surface); color: var(--text);
      font-family: 'Cairo', sans-serif; font-size: 1rem;
      min-width: 50px; /* Prevent input from becoming too small */
    }
    .input-area input[type=text]::placeholder { color: var(--muted); }
    .input-area input[type=text]:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
    }
    .icon-btn {
      background: transparent; color: var(--secondary);
      border-radius: 999px; width: 48px; height: 48px;
      display: grid; place-items: center; transition: .25s;
      border: 1px solid transparent;
      flex-shrink: 0; /* Prevent buttons from shrinking */
    }
    html.dark .icon-btn { color: var(--muted); }
    .icon-btn:hover {
      color: var(--accent);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
    }
    .send-btn {
      background: var(--accent); color: #fff;
    }
    .send-btn:hover { background: color-mix(in srgb, var(--accent) 90%, black); }
    html[dir="rtl"] .input-area { flex-direction: row-reverse; }
    html[dir="rtl"] #userInput { text-align: right; }
    html[dir="ltr"] #userInput { text-align: left; }

    /* -- Welcome & Profile Screens -- */
    .welcome-screen, .user-data-screen {
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; height: 100vh; text-align: center;
      background-color: var(--primary); color: #fff;
      padding: 1rem;
      position: relative;
    }
     @supports (height: 100dvh) { .welcome-screen, .user-data-screen { height: 100dvh; } }
    .welcome-screen::before, .user-data-screen::before {
      content: '';
      position: absolute; inset: 0; z-index: 1;
      background: linear-gradient(135deg, rgba(27, 67, 50, 0.9), rgba(45, 106, 79, 0.8)), 
                  url('https://images.unsplash.com/photo-1549060279-7e168fcee0c2?auto=format&fit=crop&w=1200&q=70') center/cover;
      opacity: 0.8;
    }
    .welcome-screen > *, .user-data-screen > * {
      position: relative; z-index: 2;
    }
    .welcome-screen p { line-height: 1.8; }
    .cta-btn {
      background: var(--accent); font-weight: 800;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      padding: 1rem 2.5rem; border-radius: .75rem;
      transition: all .25s ease-out;
      border: 2px solid transparent;
    }
    .cta-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(0,0,0,.3);
      background: color-mix(in srgb, var(--accent) 90%, black);
    }
    .cta-btn:active {
      transform: translateY(0);
    }
    
    #userDataScreen .w-full.max-w-sm {
        background: rgba(13, 33, 25, 0.4);
        backdrop-filter: blur(10px);
    }
    #userDataScreen input {
        border-radius: 0.75rem !important;
        font-family: 'Cairo', sans-serif;
    }

    /* -- Misc & Animations -- */
    .toast {
      position: fixed; bottom: 1.2rem; left: 50%; transform: translateX(-50%);
      background: #111827; color: #fff; padding: .8rem 1.2rem;
      border-radius: .75rem; z-index: 60; opacity: 0;
      transition: .35s; font-weight: 500;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .typing { display: inline-flex; gap: 6px; align-items: center; }
    .dot {
      width: 7px; height: 7px; border-radius: 999px;
      background: var(--muted); animation: blink 1.2s infinite;
    }
    .dot:nth-child(2) { animation-delay: .2s; }
    .dot:nth-child(3) { animation-delay: .4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: .2; } 40% { opacity: 1; } }

    .mic-btn.mic-live {
      background: color-mix(in srgb, #ef4444 15%, transparent);
      color: #ef4444;
    }
    .mic-live::after {
      content: ''; position: absolute; inset: -3px;
      border: 2px solid #ef4444; border-radius: 999px;
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(.95); opacity: .9; }
      70% { transform: scale(1.08); opacity: .2; }
      100% { transform: scale(.95); opacity: .9; }
    }
    .rec-hint { font-size: .8rem; color: #ef4444; margin-inline-end: .35rem; }

    /* -- Modal -- */
    .modal {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: var(--backdrop); z-index: 50;
    }
    .modal.open { display: flex; }
    .modal-content {
      width: min(560px, 96vw); max-height: 86vh; overflow: hidden;
      background: var(--surface); border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      display: flex; flex-direction: column;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: .85rem 1.25rem; border-bottom: 1px solid var(--border);
      background: var(--secondary); color: #fff;
    }
    .modal-body { padding: 1.5rem; overflow-y: auto; }
     .modal-body p { line-height: 1.8; }
    .close-button {
      background: transparent; color: #fff;
      font-size: 1.75rem; line-height: 1; padding: 0 .25rem;
      opacity: 0.8; transition: opacity .2s;
    }
    .close-button:hover { opacity: 1; }
    .contact-actions { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 520px) { .contact-actions { grid-template-columns: 1fr 1fr; } }
    .contact-btn {
      display: flex; align-items: center; gap: .75rem;
      padding: 1rem; border-radius: .75rem; font-weight: 800;
      justify-content: center; transition: all .2s;
    }
    .contact-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,.15); }
    .contact-btn svg { width: 24px; height: 24px; }
    .contact-whatsapp { background: #25D366; color: #fff; }
    .contact-phone { background: #0ea5e9; color: #fff; }

    /* -- Footer -- */
    .footer {
      text-align: center; padding: .75rem;
      font-size: .9rem; color: var(--muted);
      padding-bottom: calc(.75rem + env(safe-area-inset-bottom));
      background: var(--surface);
      flex-shrink: 0;
    }

    /* -- Reply Bar -- */
    .reply-bar {
      display: none; align-items: center; gap: .5rem;
      padding: .5rem .75rem;
      border: 1px dashed var(--border);
      border-radius: .6rem; margin: .25rem .75rem 0;
      background: color-mix(in srgb, var(--accent) 5%, transparent);
    }
    .reply-bar.show { display: flex; }
    .reply-bar .x {
      margin-inline-start: auto; background: transparent;
      border: none; font-size: 1.1rem;
      color: var(--muted);
    }
    .reply-bar .x:hover { color: var(--accent); }

    /* -- CTA Card -- */
    .card-cta {
      display: flex; align-items: center; gap: .75rem;
      background: var(--surface);
      border: 1px solid var(--border);
    }
    .badge {
      font-size: .75rem; padding: .2rem .6rem; border-radius: .5rem;
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      color: color-mix(in srgb, var(--accent) 90%, black);
      font-weight: 700;
      flex-shrink: 0;
    }
    html.dark .badge {
        color: var(--text);
    }
    #generatePlanBtn {
        font-weight: 700;
        transition: all .2s;
        flex-shrink: 0;
    }
    #generatePlanBtn:hover:not(:disabled) {
        transform: scale(1.03);
    }
    #generatePlanBtn:disabled {
        background-color: var(--muted);
        cursor: not-allowed;
    }

    /* -- Responsive Enhancements -- */
    @media (max-width: 480px) {
      /* Tighter spacing for small mobile screens */
      .chat-header {
        padding: .5rem .75rem;
      }
      .input-area {
        padding: .5rem;
        gap: .25rem;
      }
      .icon-btn {
        width: 44px;
        height: 44px;
      }
      .chat-messages {
        padding: .75rem;
      }
      .cta-btn {
        padding: .8rem 1.5rem;
        font-size: .9rem;
      }
    }
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

  <!-- Welcome -->
  <div class="welcome-screen" id="welcomeScreen">
    <img id="welcomeAvatar" src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?auto=format&fit=crop&w=200&q=80" alt="Coach Avatar" class="w-32 h-32 rounded-full mb-6 shadow-xl object-cover border-4 border-white/50"/>
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black mb-2" id="welcomeTitle">مدربك الشخصي الذكي</h1>
    <p class="text-base sm:text-lg lg:text-xl font-light text-white/90 mb-8 max-w-xl" id="welcomeSubtitle">جاهز للتغيير؟ خطتك مصممة خصيصًا لك — تنفيذ محكم، متابعة دقيقة، ونتيجة ملموسة.</p>
    <button id="startBtn" class="cta-btn">ابدأ الآن</button>
  </div>

  <!-- Profile -->
  <div class="user-data-screen hidden" id="userDataScreen">
    <div class="w-full max-w-sm p-6 sm:p-8 space-y-6 rounded-2xl shadow-xl border border-white/20">
      <div class="text-center">
        <h2 class="text-2xl sm:text-3xl font-extrabold" id="userDataTitle">لنبني ملفك السريع</h2>
        <p class="text-white/80 mt-2" id="userDataSubtitle">نحتاج بعض المعلومات للبدء</p>
      </div>
      <div class="space-y-4">
        <!-- Name Input with Icon -->
        <div class="relative flex items-center">
          <span class="absolute inset-y-0 flex items-center pointer-events-none" style="inset-inline-start: 1rem;">
            <svg class="w-5 h-5 text-white/60" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 5.5 5.5c0 1.57-.67 3-1.75 3.98-1.25.9-2.88 1.32-4.25.26-.7-.54-1.12-1.39-1.12-2.31 0-1.63 1.3-2.95 2.92-2.95.42 0 .81.09 1.18.25a3.47 3.47 0 0 0-3.5-3.5c-1.93 0-3.5 1.57-3.5 3.5 0 .92.35 1.77 1.12 2.31-1.37 1.06-3 .64-4.25-.26C2.17 11 1.5 9.57 1.5 8a5.5 5.5 0 0 1 5.5-5.5C8.83 2.5 10.37 3.4 12 2.5zm6.53 9.78c-1.2-1.03-2.6-1.55-4.2-1.55-1.93 0-3.6.86-4.83 2.22-.6.67-1.13 1.4-1.57 2.18-.5.9-.9 1.87-1.15 2.87-.21.84-.3 1.7-.27 2.55.03.88.2 1.75.47 2.6.27.8.64 1.55 1.1 2.25.5.75 1.1 1.44 1.8 2.02.8.63 1.7.97 2.7.97s1.9-.34 2.7-.97c.7-.58 1.3-1.27 1.8-2.02.46-.7.83-1.45 1.1-2.25.27-.85.44-1.72.47-2.6.03-.85-.06-1.71-.27-2.55-.25-1-.65-1.97-1.15-2.87-.44-.78-.97-1.51-1.57-2.18z"/></svg>
          </span>
          <input type="text" id="userName" class="block w-full rounded-full py-3 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="اكتب اسمك هنا" dir="auto" style="padding-inline-start: 3.25rem; padding-inline-end: 1.25rem;">
        </div>

        <!-- Age Input with Icon -->
        <div class="relative flex items-center">
          <span class="absolute inset-y-0 flex items-center pointer-events-none" style="inset-inline-start: 1rem;">
            <svg class="w-5 h-5 text-white/60" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm-1-8h2v5h-2zm0-2h2v2h-2z"/></svg>
          </span>
          <input type="text" inputmode="numeric" id="userAge" class="block w-full rounded-full py-3 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="عمرك" dir="ltr" style="padding-inline-start: 3.25rem; padding-inline-end: 1.25rem;">
        </div>

        <!-- Country Input with Icon -->
        <div class="relative flex items-center">
          <span class="absolute inset-y-0 flex items-center pointer-events-none" style="inset-inline-start: 1rem;">
            <svg class="w-5 h-5 text-white/60" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1h-2v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
          </span>
          <input type="text" id="userCountry" class="block w-full rounded-full py-3 bg-white/10 border-2 border-transparent text-white placeholder-white/70 focus:bg-white/20 focus:border-accent focus:ring-0 outline-none transition" placeholder="بلدك" dir="auto" style="padding-inline-start: 3.25rem; padding-inline-end: 1.25rem;">
        </div>
      </div>
      <button id="nextBtn" class="cta-btn w-full mt-4 !py-3 !text-lg !font-bold">ابدأ المحادثة</button>
    </div>
  </div>

  <!-- Chat -->
  <div class="chat-container hidden" id="chatContainer">
    <div class="chat-header">
      <div class="brand">
        <img id="chatAvatar" src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?auto=format&fit=crop&w=80&q=80" alt="Coach Avatar"/>
        <span class="text-xl font-bold" id="chatTitle">مدربك الشخصي الذكي</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLang" class="icon-btn text-sm font-bold border !w-auto px-3 !h-9 rounded-lg !border-border hover:!border-accent">AR</button>
        <button id="btnTheme" class="icon-btn text-xl border !w-9 !h-9 rounded-lg !border-border hover:!border-accent">☀️</button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages" role="region" aria-label="Chat messages" aria-live="polite"></div>

    <!-- CTA: opens contact modal -->
    <div id="planButtonArea" class="px-4 py-3 hidden">
      <div class="rounded-xl p-3 card-cta justify-between flex-wrap sm:flex-nowrap gap-y-2">
        <div class="min-w-0">
          <div id="ctaTitle" class="text-[.98rem] font-bold text-slate-800 dark:text-slate-100 truncate">جاهز لنتيجة ملموسة؟</div>
          <div id="ctaSubtitle" class="text-sm text-slate-600 dark:text-slate-300 mt-1">تسليم خطة مُحكمة + متابعة أسبوعية.</div>
        </div>
        <div class="flex items-center gap-2">
          <span id="ctaBadge" class="badge">خصم اليوم</span>
          <button id="generatePlanBtn" class="send-btn font-bold px-4 py-2 rounded-lg" disabled>احصل على خطتك</button>
        </div>
      </div>
      <p id="planButtonNote" class="text-gray-700 dark:text-gray-300 text-xs mt-2 px-2">بالضغط، ستفتح طرق التواصل. باقة البدء تشمل: تقييم دقيق، خطة وجبات وتمرين، متابعة أول أسبوع.</p>
    </div>

    <!-- Reply bar -->
    <div id="replyBar" class="reply-bar" aria-live="polite">
      <strong id="replyBarLabel">رد على:</strong>
      <span id="replySnippet" class="truncate"></span>
      <button id="replyClear" class="x" title="إلغاء">×</button>
    </div>

    <div class="input-area" id="inputArea">
      <input type="text" id="userInput" placeholder="اكتب رسالتك..." dir="rtl"
             autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" />
      <input type="file" id="fileInput" accept="image/*,.txt,.csv,application/pdf" class="hidden" />
      <button id="plusBtn" class="icon-btn" aria-label="أرسل صورة/ملف" title="صورة/ملف">
        <svg class="w-6 h-6 -rotate-45" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
      </button>
      <button id="micBtn" class="icon-btn mic-btn" aria-label="تسجيل صوتي" title="اضغط مطولاً للتسجيل">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
      </button>
      <button id="sendBtn" class="icon-btn send-btn" aria-label="أرسل" title="إرسال">
        <svg class="w-5 h-5 pl-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
      </button>
    </div>
    <div class="px-4 pb-2 -mt-2 hidden" id="recHintWrap"><span class="rec-hint" id="recHint">● جاري التسجيل… ارفع إصبعك للنسخ إلى خانة الكتابة</span></div>
  </div>

  <!-- Contact Modal -->
  <div id="contactModal" class="modal" aria-modal="true" aria-hidden="true" role="dialog" aria-labelledby="contactModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="contactModalTitle" class="text-lg font-extrabold">احصل على خطتك الآن بضغطة زر</h3>
        <button id="closeContactBtn" class="close-button" title="إغلاق" aria-label="إغلاق">×</button>
      </div>
      <div class="modal-body">
        <p id="contactModalText1" class="mb-3 text-sm text-gray-600 dark:text-gray-300">اختر الطريقة المناسبة للتواصل المباشر مع المدرب.
          <span id="contactModalText2" class="block mt-2 text-[12px] text-gray-500">يمكنك الاستمرار في الحديث إذا كانت لديك أسئلة.</span>
        </p>
        <div class="contact-actions">
          <a class="contact-btn contact-whatsapp" href="https://wa.me/971502061209" target="_blank" rel="noopener" title="واتساب مباشر">
            <svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M19.11 17.18c-.28-.14-1.65-.81-1.9-.9-.26-.1-.44-.14-.62.14-.18.27-.71.9-.87 1.09-.16.18-.32.2-.6.07-.28-.14-1.18-.44-2.25-1.4-.83-.74-1.39-1.66-1.55-1.94-.16-.27-.02-.42.12-.56.12-.12.28-.3.42-.46.14-.16.18-.27.28-.46.1-.18.06-.34-.02-.48-.08-.14-.62-1.5-.84-2.06-.22-.52-.44-.45-.62-.46h-.54c-.18 0-.48.07-.74.34-.26.27-1 1-1 2.42s1.03 2.8 1.18 2.99c.14.2 2.03 3.1 4.93 4.33.69.3 1.22.48 1.64.62.69.22 1.32.19 1.82.12.56-.08 1.65-.68 1.88-1.35.24-.67.24-1.24.16-1.35-.06-.1-.24-.16-.52-.3z"/><path d="M26.9 5.1A13.9 13.9 0 0 0 16 .1C7.3.1.2 7.1.2 15.8c0 2.7.7 5.2 2 7.4L.1 31.9l8.9-2.3c2.1 1.1 4.5 1.7 7 1.7h.1c8.7 0 15.8-7 15.8-15.7 0-4.2-1.6-8.1-4.9-10.9z"/></svg>
            <span id="whatsappBtnText">واتساب مباشر</span>
          </a>
          <a class="contact-btn contact-phone" href="tel:+971502061209" title="اتصال هاتفي">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 0 1 1 1V21a1 1 0 0 1-1 1C10.61 22 2 13.39 2 3a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.27.2 2.47.57 3.58a1 1 0 0 1-.24 1.01l-2.21 2.2z"/></svg>
            <span id="phoneBtnText">اتصال هاتفي</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer" id="pageFooter">© Powered by Mustafa Elsafy | مصطفى الصافي</footer>

  <script type="module">
    /* =========================
       Elements
    ========================= */
    const $ = id => document.getElementById(id);
    const chatMessages = $('chatMessages');
    const userInput = $('userInput');
    const sendBtn = $('sendBtn');
    const startBtn = $('startBtn');
    const nextBtn = $('nextBtn');
    const welcomeScreen = $('welcomeScreen');
    const userDataScreen = $('userDataScreen');
    const chatContainer = $('chatContainer');
    const userNameInput = $('userName');
    const userAgeInput = $('userAge');
    const userCountryInput = $('userCountry');
    const btnTheme = $('btnTheme');
    const btnLang = $('btnLang');
    const plusBtn = $('plusBtn');
    const fileInput = $('fileInput');
    const micBtn = $('micBtn');
    const recHintWrap = $('recHintWrap');
    const planButtonArea = $('planButtonArea');
    const generatePlanBtn = $('generatePlanBtn');
    const contactModal = $('contactModal');
    const closeContactBtn = $('closeContactBtn');
    const replyBar = $('replyBar');
    const replySnippet = $('replySnippet');
    const replyClear = $('replyClear');

    /* =========================
       State
    ========================= */
    let userState = { step: 0, data: {}, persona:'neutral' };
    let LANG = 'ar';
    let chatHistory = [];
    const MAX_TURNS = 12;
    const MAX_PROMPT_CHARS = 14000;

    /* =========================
       i18n
    ========================= */
    const i18n = {
      ar: {
        appName: 'مدربك الشخصي الذكي',
        welcomeSubtitle: 'جاهز للتغيير؟ خطتك مصممة خصيصًا لك — تنفيذ محكم، متابعة دقيقة، ونتيجة ملموسة.',
        startButtonText: 'ابدأ الآن',
        userDataTitle: 'لنبني ملفك السريع',
        userDataSubtitle: 'اسمك وعُمرك ودولتك كبداية',
        namePlaceholder:'اسمك', agePlaceholder:'عمرك', countryPlaceholder:'دولتك', nextButtonText:'ابدأ المحادثة',
        inputPlaceholder:'اكتب رسالتك...', emptyFields:'أدخل الاسم والعمر والدولة للمتابعة.', imageUpload:'تم استلام الصورة — يتم التحليل الآن.',
        typing:'… يتم الرد الآن',
        recStart:'● جاري التسجيل… ارفع إصبعك للنسخ', recDenied:'تعذّر الوصول للميكروفوون.', recTooShort:'التسجيل قصير جدًا.', recSaved:'تم نسخ الكلام إلى خانة الكتابة — أرسله يدويًا.',
        ctaTitle: 'جاهز لنتيجة ملموسة؟',
        ctaSubtitle: 'تسليم خطة مُحكمة + متابعة أسبوعية + دعم مباشر.',
        ctaBadge: 'خصم اليوم',
        getPlanButton: 'احصل على خطتك الآن',
        planButtonNote: 'بالضغط، ستفتح طرق التواصل. باقة البدء تشمل: تقييم دقيق، خطة وجبات وتمرين، متابعة أول أسبوع.',
        contactModalTitle: 'احصل على خطتك الآن بضغطة زر',
        contactModalText1: 'اختر الطريقة المناسبة للتواصل المباشر مع المدرب.',
        contactModalText2: 'يمكنك الاستمرار في الحديث إذا كانت لديك أسئلة.',
        whatsappBtnText: 'واتساب مباشر',
        phoneBtnText: 'اتصال هاتفي',
        replyBarLabel: 'رد على:',
        footerText: '© Powered by Mustafa Elsafy | مصطفى الصافي',
        messageToolsLabel: 'أدوات الرسالة',
        copyBtnText: 'نسخ',
        replyBtnText: 'رد',
        copyBtnTitle: 'نسخ الرسالة',
        replyBtnTitle: 'رد',
        cancelReplyTitle: 'إلغاء',
        attachFileTitle: 'صورة/ملف',
        recordAudioTitle: 'اضغط مطولاً للتسجيل',
        sendTitle: 'إرسال',
        closeModalTitle: 'إغلاق',
        copied: 'تم النسخ!'
      },
      en: {
        appName:'Smart Personal Coach',
        welcomeSubtitle:'Ready for a change? Your plan is tailored for you—precise execution, close follow-up, and tangible results.',
        startButtonText:'Start Now',
        userDataTitle:"Let's create your quick profile",
        userDataSubtitle:'We need some info to start',
        namePlaceholder:'Your Name', agePlaceholder:'Your Age', countryPlaceholder:'Your Country', nextButtonText:'Start Conversation',
        inputPlaceholder:'Type your message…', emptyFields:'Please enter your name, age, and country to continue.', imageUpload:'Image received — analyzing now.',
        typing:'… typing now',
        recStart:'● Recording… release to copy', recDenied:'Microphone access denied.', recTooShort:'Recording is too short.', recSaved:'Text copied to input — send manually.',
        ctaTitle: 'Ready for tangible results?',
        ctaSubtitle: 'Precise plan + weekly follow-up + direct support.',
        ctaBadge: "Today's Offer",
        getPlanButton: 'Get Your Plan Now',
        planButtonNote: 'By clicking, contact options will open. The starter package includes: detailed assessment, meal & workout plan, and first week follow-up.',
        contactModalTitle: 'Get your plan now with one click',
        contactModalText1: 'Choose the best way to contact the coach directly.',
        contactModalText2: 'You can continue chatting if you have questions.',
        whatsappBtnText: 'Direct WhatsApp',
        phoneBtnText: 'Phone Call',
        replyBarLabel: 'Reply to:',
        footerText: '© Powered by Mustafa Elsafy',
        messageToolsLabel: 'Message Tools',
        copyBtnText: 'Copy',
        replyBtnText: 'Reply',
        copyBtnTitle: 'Copy Message',
        replyBtnTitle: 'Reply',
        cancelReplyTitle: 'Cancel',
        attachFileTitle: 'Image/File',
        recordAudioTitle: 'Press and hold to record',
        sendTitle: 'Send',
        closeModalTitle: 'Close',
        copied: 'Copied!'
      }
    };

    function setLang(lang){
      LANG = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = lang==='ar'?'rtl':'ltr';
      const L = i18n[LANG];
      
      $('welcomeTitle').textContent = L.appName;
      $('welcomeSubtitle').textContent = L.welcomeSubtitle;
      $('startBtn').textContent = L.startButtonText;
      $('userDataTitle').textContent = L.userDataTitle;
      $('userDataSubtitle').textContent = L.userDataSubtitle;
      $('userName').placeholder = L.namePlaceholder;
      $('userAge').placeholder = L.agePlaceholder;
      $('userCountry').placeholder = L.countryPlaceholder;
      $('nextBtn').textContent = L.nextButtonText;
      $('chatTitle').textContent = L.appName;
      $('userInput').placeholder = L.inputPlaceholder;
      $('ctaTitle').textContent = L.ctaTitle;
      $('generatePlanBtn').textContent = L.getPlanButton;
      $('planButtonNote').textContent = L.planButtonNote;
      $('replyBarLabel').textContent = L.replyBarLabel;
      $('replyClear').title = L.cancelReplyTitle;
      $('plusBtn').title = L.attachFileTitle;
      $('micBtn').title = L.recordAudioTitle;
      $('sendBtn').title = L.sendTitle;
      $('contactModalTitle').textContent = L.contactModalTitle;
      $('closeContactBtn').title = L.closeModalTitle;
      $('closeContactBtn').setAttribute('aria-label', L.closeModalTitle);
      $('contactModalText1').firstChild.nodeValue = L.contactModalText1 + ' ';
      $('contactModalText2').textContent = L.contactModalText2;
      $('whatsappBtnText').textContent = L.whatsappBtnText;
      $('phoneBtnText').textContent = L.phoneBtnText;
      $('pageFooter').textContent = L.footerText;
      btnLang.textContent = lang==='ar' ? 'EN' : 'AR';
      document.title = `${L.appName} | Smart Personal Coach`;

      // Update CTA Subtitle and Badge dynamically based on language
      if (lang === 'ar') {
        $('ctaSubtitle').textContent = 'تسليم خطة مُحكمة + متابعة أسبوعية.';
        $('ctaBadge').textContent = 'خصم اليوم';
      } else {
        $('ctaSubtitle').textContent = 'Precise plan + weekly follow-up.';
        $('ctaBadge').textContent = "Today's Offer";
      }
    }

    /* =========================
       Utilities
    ========================= */
    function setTheme(){
      document.documentElement.classList.toggle('dark');
      btnTheme.textContent = document.documentElement.classList.contains('dark') ? '🌙' : '☀️';
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light')
    }
    function toast(msg){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.style.opacity=1,10);
      setTimeout(()=>{t.style.opacity=0; setTimeout(()=>t.remove(),400)},2400)
    }

    /* =========================
       Language helper
    ========================= */
    const Lang = {
      isArabic(s){ return /[\u0600-\u06FF]/.test(s) },
      autoSetByText(s){
        if(!s) return;
        const target = this.isArabic(s) ? 'ar' : 'en';
        if(target!==LANG) setLang(target);
      }
    };

    /* =========================
       Storage / History
    ========================= */
    const Storage = {
      KEY: 'smart-coach-history-v1',
      save(){}, load(){ return false; }, clear(){}, export(){}, async import(file){}
    };

    function compactHistory(){ if (chatHistory.length > MAX_TURNS) chatHistory = chatHistory.slice(-MAX_TURNS) }

    /* =========================
       Messages UI
    ========================= */
    function displayMessage(message, sender){
      const b=document.createElement('div'); b.classList.add('message-bubble', sender);
      const safe = (message && typeof message === 'string') ? message : '…';
      const html = marked.parse(safe);
      const L = i18n[LANG];
      
      b.innerHTML = `
        <div class="msg-content">${html}</div>
        <div class="msg-meta" role="group" aria-label="${L.messageToolsLabel}">
          <button class="meta-btn copy" title="${L.copyBtnTitle}">${L.copyBtnText}</button>
          <button class="meta-btn reply" title="${L.replyBtnTitle}">${L.replyBtnText}</button>
        </div>`;
      chatMessages.appendChild(b); chatMessages.scrollTop = chatMessages.scrollHeight;

      b.querySelector('.copy').onclick = async ()=>{
        const txt = b.querySelector('.msg-content').innerText;
        await navigator.clipboard.writeText(txt);
        toast(i18n[LANG].copied);
      };
      b.querySelector('.reply').onclick = ()=>{
        UI.setReply(b.querySelector('.msg-content').innerText.slice(0,160));
      };
      return b;
    }
    function showTyping(sender='ai'){
      const b=document.createElement('div'); b.classList.add('message-bubble', sender);
      b.innerHTML = `<span class="typing"><span>${i18n[LANG].typing}</span><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      chatMessages.appendChild(b); chatMessages.scrollTop=chatMessages.scrollHeight; return b
    }
    function removeNode(n){ if(n && n.parentNode) n.parentNode.removeChild(n) }

    const UI = {
      setReply(snippet){ replySnippet.textContent = snippet; replyBar.classList.add('show'); userInput.focus(); },
      clearReply(){ replySnippet.textContent = ''; replyBar.classList.remove('show'); }
    };
    replyClear.addEventListener('click', UI.clearReply);

    /* =========================
       i18n injection
    ========================= */
    function togglePlanCTA(){ const ready = isDataComplete(); planButtonArea.classList.toggle('hidden', !ready); generatePlanBtn.disabled = !ready }
    function isDataComplete(){ return ['name','age','country'].every(k => !!userState.data[k]) }

    /* =========================
       Prompts
    ========================= */
    function buildCoachSystemPrompt(){ return `
📌 التوجيه التنفيذي الشامل للمساعد الرياضي/الغذائي — نسخة مُحسّنة لضمان سلاسة بشرية 100%
【١) الهوية والدور】
- إنت المساعد الافتراضي للمدرّب الدولي **مصطفى الصافي**.
- الدور: مدرّب شخصي وأخصائي تغذية محترف؛ تفهم الرسالة، تحللها سريعًا، وتقدّم حلًا عمليًا مبنيًا على العلم.
- تتكلم تلقائيًا بنفس لغة ولهجة المستخدم (مرآة لغوية). لو اللهجة غير واضحة، استخدم **مصري بروفيشنال** واضح ومحترم.
- **ممنوع نهائيًا** ذكر اسم المستخدم داخل الردود.
【٢) سلاسة بشرية بلا لغة آلية (ينطبق على كل الردود بالكامل)】
- الردود يجب أن تبدو طبيعية ومتنوعة كأن إنسان محترف يكتبها، دون أي عبارات قوالب أو افتتاحيات مكررة.
- **ممنوع** بدء أي رد أو أي فقرة داخل الرد بـ: (تمام/ممتاز/طيب/عشان نكمل/علشان أقدر أساعدك/خلّينا/أوك/أولًا/ثانيًا…).
- **ممنوع** شرح سبب السؤال أو تبريره. اسأل السؤال مباشرة بلا تمهيد.
- لا تعيد صياغة أو تأكيد كلام العميل قبل الإجابة. انتقل للإجابة أو للسؤال التالي مباشرة.
- نوّع الجُمل واستخدم تراكيب مختلفة؛ تجنّب التكرار اللفظي وأي نبرة ميكانيكية.
【٣) أسلوب المحادثة والسلوك】
- التحية مرة واحدة فقط في بداية المحادثة.
- **سؤال واحد فقط** في كل رسالة (أو سؤالان مرتبطان جدًا).
- الردود مركّزة، مشجّعة بدون مبالغة.
- لو بدأ المستخدم بدون هدف واضح: عرّف نفسك باقتضاب كمساعد مصطفى الصافي، ثم اسأله: «تحب نبدأ بهدفك الحالي ولا عندك استفسار معيّن؟».
【٤) إدارة السياق والذاكرة الداخلية】
- خزّن داخليًا: الهدف، الأساسيات (العمر، الجنس، الطول، الوزن...)، شخصية المستخدم، آخر إجابات، تحذيرات صحية.  
- **مراجعة صامتة قبل كل رد**: لا تكرار لأسئلة مُجاب عنها، توافق مع الهدف، أسلوب مناسب للشخصية، ونبرة بشرية.
【٥) جمع البيانات عند طلب خطة (تدريجي بلا تبرير)】
- الهدف: جمع **الحد الأدنى الكافي** لبناء خطة دقيقة.
- المطلوب: الهدف، الجنس/العمر، الطول/الوزن، النشاط، مكان التمرين/الأيام، تفضيلات الأكل، أمراض/إصابات.  
- عند اكتمال الحد الأدنى: **قدّم الخطة كاملة فورًا** في رسالة واحدة.
【٦) سياسة تقديم الخطة والطلبات الجزئية】
- بعد اكتمال البيانات: رسالة واحدة شاملة بالخطة.
- لو نقطة صغيرة ناقصة: افترض اختيارًا منطقيًا، واذكره.
- لو طلب المستخدم جزءًا محددًا (يوم غذائي/تمرين): اسأل دفعة واحدة عن الحد الأدنى اللازم، ثم قدّم الطلب.
【٧) الدقّة العلمية والاحتياطات】
- التدريب: تدرّج أحمال، راحة، بدائل آمنة للإصابات.  
- التغذية: سعرات وماكروز محسوبة، مقادير دقيقة، بدائل واقعية.  
- الحالات الصحية: تعديل فوري في الخطة + تحذير مختصر.  
- طلب "تحول جذري سريع": أشِر باقتضاب أنه قاسٍ، ولو أصرّ المستخدم → قدّم الخطة مع **تنبيه واضح وإخلاء مسؤولية**.
【٨) تحليل الوسائط (بدون طلب مسبق)】
- **حلّل تلقائيًا أي صور/ملفات تصل**.  
- صور الجسم: بنية، توزيع دهون/عضل، ملاحظات وضعية.  
- InBody: استخرج الأرقام وقدم تعليقًا عمليًا.  
- صور الوجبات: مكونات وسعرات تقديرية، نصائح تحسين.  
- ملفات نصية: استخرج المهم وادمجه في التوصيات.
【٩) تنسيقات مُلزمة للإخراج】
أ) **خطة تدريب كاملة**: الهدف، الأسبوع (أيام، Gym/Home)، إرشادات، خطة الأيام (التمرين، المجموعاتxالتكرارات، الراحة)، تقدّم أسبوعي، بدائل.
ب) **خطة تغذية كاملة**: السعرات، الماكروز، عدد الوجبات، يوم كامل بالمقادير (الوجبة، المكونات، السعرات/الماكروز، بدائل)، سوائل وتعديلات.
ج) **وصفة وجبة**: الاسم، المكونات، الخطوات، السعرات/الماكروز، نصائح.
د) **رد استشاري قصير**: ملخص، حل عملي، سؤال مكمل واحد (إن لزم).
【١٠) ضمان الجودة قبل الإرسال (Checklist)】
- لا تكرار لأسئلة/معلومات. لا ذكر لاسم المستخدم. لا عبارات آلية. اللغة مطابقة. الرد مباشر ومنسّق.
` }
    function buildImagePrompt(){
      return `حلّل الصورة بنقاط تنفيذية مختصرة فقط (3-5 نقاط) بدون أي مقدمات:
- ماذا ترى (مختصر محدد).
- أي نص/قيم ظاهرة إن وُجدت.
- التفسير الصحي/الرياضي العملي.
- خطوة واحدة مقترحة الآن.
لا تكتب جُمل عامة.`;
    }

    /* =========================
       AI Call (proxy)
    ========================= */
    async function callAI(prompt, {images, audio} = {}){
      try{
        const payload = { prompt };
        if (images && images.length){
          payload.images = images.map(x => {
            if(typeof x === 'string' && x.startsWith('data:')){
              const [meta, b64] = x.split(',');
              const mime = meta.substring(5, meta.indexOf(';'));
              return { mime, data: b64, dataUrl: x };
            }
            return x;
          });
        }
        if (audio) payload.audio = audio;
        // This function would typically point to a serverless function endpoint
        // For local dev, you might mock this or point to a local server
        const res = await fetch('/.netlify/functions/gemini-proxy',{
          method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(!res.ok) throw new Error((data && (data.details || data.error)) || 'AI error');
        return data.text || '';
      }catch(e){ console.error("AI Call Error:", e); return '' }
    }

    /* =========================
       Health flags
    ========================= */
    const MED_FLAGS=/(سكري|ضغط|قلب|سرطان|حامل|حمل|رضاعة|غدة|درق|كبد|كلو[ية]|kidney|liver|thyroid|injury|إصابة|عملية|دواء|أدوية|كورتيزون|ضغط الدم|سكر الدم)/i;
    function analyzeUserMessage(msg){ if(MED_FLAGS.test(msg)){ displayMessage('تم رصد حالة صحية — سنضيف احتياطات مناسبة. اذكر تفاصيل الدواء/الجرعة أو التشخيص إن وُجد.', 'ai') } }

    /* =========================
       Internal State
    ========================= */
    function compactAndSnippet(){
      compactHistory();
      const lines = chatHistory.map(m=>{
        const role = m.role === 'assistant' ? 'المدرب' : 'المستخدم';
        const txt  = (m.parts?.[0]?.text || '').replace(/\s+/g,' ').slice(0,1200);
        return `${role}: ${txt}`;
      });
      return lines.join('\n').slice(0, MAX_PROMPT_CHARS);
    }
    function buildInternalStateSummary(){
      const d = userState.data || {};
      const fields = [];
      if (d.name)    fields.push(`الاسم: ${d.name}`);
      if (d.age)     fields.push(`العمر: ${d.age}`);
      if (d.country) fields.push(`الدولة: ${d.country}`);
      if (d.goal)    fields.push(`الهدف: ${d.goal}`);
      if (d.health)  fields.push(`حالة صحية: ${d.health}`);
      if (d.gym)     fields.push(`مكان التمرين: ${d.gym}`);
      if (d.meals)   fields.push(`وجبات/اليوم: ${d.meals}`);
      return fields.length ? `🗒️ ملخص الحالة: ${fields.join(' | ')}` : '';
    }

    /* =========================
       Voice to text
    ========================= */
    let recording=false; let sttSession=0; let recognition=null; let mediaStream=null; let mediaRecorder=null; let audioChunks=[]; let recStartTime=0;
    const supportSpeechRecognition = ()=> ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window);
    function startLocalRecognition(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(!SR) return null;
      const sessionId = ++sttSession;
      const rec = new SR();
      rec.lang = (LANG==='ar' ? 'ar-EG' : 'en-US');
      rec.interimResults = true; rec.continuous = true;
      rec.onresult = (e)=>{
        if(sessionId !== sttSession) return;
        let final=''; let interim='';
        for(let i=e.resultIndex;i<e.results.length;i++){
          const r=e.results[i];
          if(r.isFinal){ final += r[0].transcript } else { interim = r[0].transcript }
        }
        const text = (final || interim).trim();
        if(text){ userInput.value = text; userInput.focus(); }
      };
      rec.onerror = ()=>{}; rec.onend = ()=>{};
      rec.start();
      return { rec, sessionId };
    }
    async function startRecording(){
      if(recording) return; recording=true;
      if(supportSpeechRecognition()){
        const h = startLocalRecognition();
        recognition = h?.rec || null;
        micBtn.classList.add('mic-live'); recHintWrap.classList.remove('hidden'); $('recHint').textContent = i18n[LANG].recStart;
        return;
      }
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
        const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : (MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg');
        mediaRecorder = new MediaRecorder(mediaStream, {mimeType: mime});
        audioChunks = []; recStartTime = Date.now();
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) audioChunks.push(e.data) };
        mediaRecorder.onstop = handleRecordingStopFallback;
        mediaRecorder.start();
        micBtn.classList.add('mic-live'); recHintWrap.classList.remove('hidden'); $('recHint').textContent = i18n[LANG].recStart;
      }catch(e){ toast(i18n[LANG].recDenied); recording=false; }
    }
    function stopRecording(){
      if(!recording) return; recording=false;
      if(recognition && recognition.stop){ try{ recognition.stop(); }catch(_){}; recognition=null; }
      try{ mediaRecorder && mediaRecorder.state!=='inactive' && mediaRecorder.stop(); }catch(_){}
      try{ mediaStream && mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
      micBtn.classList.remove('mic-live'); recHintWrap.classList.add('hidden');
      sttSession++;
    }
    async function handleRecordingStopFallback(){
      const duration = (Date.now()-recStartTime)/1000; if(duration < 0.6){ toast(i18n[LANG].recTooShort); return }
      const blob = new Blob(audioChunks, {type: mediaRecorder.mimeType});
      const reader = new FileReader(); reader.onload = async () => {
        const base64 = reader.result.split(',')[1];
        const sttPrompt = `أعد فقط JSON صالح بهذا الشكل بدون أي كلام آخر:
{"transcript": "..."}`;
        const raw = await callAI(sttPrompt, { audio: { mime: blob.type, data: base64 } });
        let transcript=''; try{ const s=raw.indexOf('{'); const e=raw.lastIndexOf('}'); const j = JSON.parse(raw.slice(s,e+1)); transcript = (j.transcript||'').trim(); }catch(_){ transcript='' }
        if(transcript){ userInput.value = transcript; userInput.focus(); toast(i18n[LANG].recSaved) }
      };
      reader.readAsDataURL(blob);
    }

    /* =========================
       Files: TXT/CSV/PDF + Images
    ========================= */
    const Files = {
      async handleFile(file){
        const name = (file.name||'').toLowerCase();
        if(name.endsWith('.txt')||name.endsWith('.csv')){
          const text = await file.text();
          displayMessage(`**تم استلام ملف:** ${file.name}\n\n\`\`\`\n${text.slice(0,1200)}\n\`\`\`\n`, 'user');
          await Files.analyzeText(text);
        }else if(name.endsWith('.pdf')){
          await Files.extractPdfText(file);
        }else{
          toast(LANG==='ar'?'نوع الملف غير مدعوم هنا — ارفع صورة أو PDF/CSV/TXT':'Unsupported file type');
        }
      },
      async analyzeText(text){
        const typingEl = showTyping('ai');
        const prompt = `استخرج أهم البيانات من النص التالي وقدّم خلاصة تنفيذية من 5-7 نقاط ثم توصية عملية واحدة:\n\n${text.slice(0,12000)}`;
        const aiResp = await callAI(prompt);
        removeNode(typingEl);
        const reply = aiResp || (LANG==='ar'?'تمت القراءة.':'Read.');
        displayMessage(reply,'ai');
        chatHistory.push({role:'assistant',parts:[{text:reply}]});
      },
      async extractPdfText(file){
        displayMessage(`**تم استلام PDF:** ${file.name}`,'user');
        if(!window.pdfjsLib){
          await new Promise((res,rej)=>{
            const s=document.createElement('script');
            s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js';
            s.onload=res; s.onerror=rej; document.head.appendChild(s);
          });
          pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js`;
        }
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data:buf}).promise;
        let text=''; 
        for(let p=1;p<=Math.min(pdf.numPages,20);p++){
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          text += content.items.map(i=>i.str).join(' ') + '\n';
          if(text.length>12000) break;
        }
        await Files.analyzeText(text);
      }
    };

    /* =========================
       Conversation Engine
    ========================= */
    function analyzeMsgForState(message){
      if (/خطة|أخس|تخسيس|تضخيم|عضل/i.test(message)) userState.data.goal = userState.data.goal || 'خطة مخصصة';
      if (/جيم|بيت|منزل/i.test(message)) userState.data.gym = userState.data.gym || 'غير محدد';
      if (MED_FLAGS.test(message)) userState.data.health = (userState.data.health || 'قيود صحية');
    }

    async function processAIResponse(message){
      const typingEl = showTyping('ai');
      analyzeMsgForState(message);
      const state = buildInternalStateSummary();
      const convo = compactAndSnippet();

      const coachPrompt =
`${buildCoachSystemPrompt()}
${state ? state + '\n' : ''}
سجل مختصر (آخر الرسائل):
${convo}

رد كمدرّب محترف على رسالة المستخدم الأخيرة فقط، والتزم بسؤال واحد كحد أقصى لو لزم:
رسالة المستخدم الأخيرة: ${message}`;

      let response = '';
      try{ response = await callAI(coachPrompt); }catch(e){ console.error(e); }

      removeNode(typingEl);

      if(!response || !response.trim()){
        response = (LANG==='ar')
          ? 'خلّينا نكمل بخطوة عملية سريعة: امشِ 15–20 دقيقة النهارده، ولو عندك هدف محدد سبّهولي نثبّته ونبني عليه.'
          : 'Let’s keep momentum: take a 15–20 min walk today. Share your main goal and we’ll lock it.';
      }

      chatHistory.push({role:'assistant',parts:[{text:response}]});
      displayMessage(response,'ai');
      togglePlanCTA();
    }

    function sendMessage(){
      const raw=(userInput.value||'').trim(); if(!raw) return;
      Lang.autoSetByText(raw);
      let finalMsg = raw;
      if(replyBar.classList.contains('show')){
        finalMsg = `> ${replySnippet.textContent}\n\n${raw}`;
        UI.clearReply();
      }

      displayMessage(finalMsg,'user');
      chatHistory.push({role:'user',parts:[{text:finalMsg}]});
      analyzeUserMessage(finalMsg);
      processAIResponse(finalMsg);
      userInput.value='';
    }

    /* =========================
       Events
    ========================= */
    document.addEventListener('DOMContentLoaded',()=>{
      startBtn.addEventListener('click',()=>{ welcomeScreen.classList.add('hidden'); userDataScreen.classList.remove('hidden'); setLang(LANG) });
      nextBtn.addEventListener('click',()=>{
        const name=(userNameInput.value||'').trim();
        const age=(userAgeInput.value||'').trim();
        const country=(userCountryInput.value||'').trim();
        Lang.autoSetByText(name || country);
        if(!name||!age||!country){ toast(i18n[LANG].emptyFields); return }
        userState.data={...userState.data,name,age,country};
        userDataScreen.classList.add('hidden'); chatContainer.classList.remove('hidden');
        const welcomeMsg = (LANG==='ar')
          ? `مرحبًا، معك مساعد المدرب الدولي مصطفى الصافي للتدريب والتغذية. كيف أقدر أساعدك النهاردة؟`
          : `Hi, I'm the assistant to international coach Mustafa Elsafy. How can I help you today?`;
        chatHistory.push({role:'assistant',parts:[{text:welcomeMsg}]}); displayMessage(welcomeMsg,'ai'); togglePlanCTA();
      });

      btnTheme.addEventListener('click', setTheme);
      btnLang.addEventListener('click',()=> setLang(LANG==='ar' ? 'en' : 'ar'));
      const savedTheme=localStorage.getItem('theme'); if(savedTheme==='dark'){ document.documentElement.classList.add('dark'); btnTheme.textContent='🌙' }
      setLang('ar');

      function keyHandler(e){ if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
      sendBtn.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', keyHandler);

      plusBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const dataUrl = ev.target.result;
                const imgHTML = `<img src="${dataUrl}" class="max-w-[220px] rounded-lg my-2" alt="uploaded image"/>`;
                displayMessage(imgHTML, 'user');
                toast(i18n[LANG].imageUpload);
                const typingEl = showTyping('ai');
                let aiResp = await callAI(buildImagePrompt(), { images: [dataUrl] });
                removeNode(typingEl);
                const bad = /قدّم|provide|يرجى تقديم|please provide|لا أستطيع رؤية الصورة/i.test(aiResp || '');
                const reply = bad || !aiResp ? (LANG === 'ar' ? 'تم استلام الصورة ومعالجتها. لنتيجة أوضح، أرسل صورة أوضح وسأحلّلها بدقة.' : 'Image received and processed. For clearer results, upload a sharper image.') : aiResp;
                displayMessage(reply, 'ai');
                chatHistory.push({ role: 'user', parts: [{ text: '[صورة مرفوعة]' }] });
                chatHistory.push({ role: 'assistant', parts: [{ text: reply }] });
                togglePlanCTA();
            };
            reader.readAsDataURL(file);
        } else {
            await Files.handleFile(file);
        }
        e.target.value = '';
      });

      const startEvents = ['pointerdown','touchstart','mousedown'];
      const endEvents = ['pointerup','touchend','mouseup','mouseleave','pointercancel'];
      startEvents.forEach(ev => micBtn.addEventListener(ev, (e)=>{ e.preventDefault(); startRecording() }, {passive:false}));
      endEvents.forEach(ev => micBtn.addEventListener(ev, (e)=>{ e.preventDefault(); stopRecording() }, {passive:false}));

      generatePlanBtn.addEventListener('click', ()=>{
        contactModal.classList.add('open'); contactModal.setAttribute('aria-hidden','false');
      });
      closeContactBtn.addEventListener('click',()=>{ contactModal.classList.remove('open'); contactModal.setAttribute('aria-hidden','true') });
      contactModal.addEventListener('click', e=>{ if(e.target===contactModal){ contactModal.classList.remove('open'); contactModal.setAttribute('aria-hidden','true') } });
    });
  </script>
</body>
</html>



